
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Extending Your Existing Python Tool for Use with Bluesky-Adaptive &#8212; bluesky-adaptive  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'how-to/extend-my-tool';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Developing Agent/Recommender Algorithms" href="dev-agent-brains.html" />
    <link rel="prev" title="Running Your Agent as a Service with Bluesky Adaptive" href="use-service.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">bluesky-adaptive  documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../explanations/index.html">
                        Explanations
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        How-to Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials/index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://blueskyproject.io">
                    Bluesky Project
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky-adaptive" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky-adaptive" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://blueskyproject.io/mattermost/" title="Community" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-person-circle-question fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Community</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../explanations/index.html">
                        Explanations
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        How-to Guides
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../tutorials/index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://blueskyproject.io">
                    Bluesky Project
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky-adaptive" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky-adaptive" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://blueskyproject.io/mattermost/" title="Community" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-person-circle-question fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Community</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">How-to Guides</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="use-service.html">Running Your Agent as a Service with Bluesky Adaptive</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Extending Your Existing Python Tool for Use with Bluesky-Adaptive</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-agent-brains.html">Developing Agent/Recommender Algorithms</a></li>
<li class="toctree-l1"><a class="reference internal" href="dev-agent-comms.html">Developing Communication Between an Asynchronous Agent and Experiment</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">How-to Guides</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Extending...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="extending-your-existing-python-tool-for-use-with-bluesky-adaptive">
<h1>Extending Your Existing Python Tool for Use with Bluesky-Adaptive<a class="headerlink" href="#extending-your-existing-python-tool-for-use-with-bluesky-adaptive" title="Link to this heading">#</a></h1>
<p>So you already have a python tool that works with some experiments elsewhere or not using the Bluesky stack.
Whether you need to synchronize your tool’s operations with the experiment’s execution or allow your tool to operate asynchronously, Bluesky-Adaptive provides the necessary tools and frameworks to achieve seamless integration.
This guide is divided into two main approaches: the lockstep approach for synchronous operations and the asynchronous approach for more distributed and flexible integration.</p>
<section id="lockstep-approach-with-bluesky-adaptive">
<h2>Lockstep Approach with Bluesky-Adaptive<a class="headerlink" href="#lockstep-approach-with-bluesky-adaptive" title="Link to this heading">#</a></h2>
<p>The lockstep approach involves synchronizing your tool’s operations with the execution of experiments in a way that each step waits for the previous one to complete before proceeding.
This method is ideal for experiments where real-time decision-making based on the latest available data is crucial.
While there are fewer moving parts in this approach, it requires tighter integration between your tool and the <code class="docutils literal notranslate"><span class="pre">RunEngine</span></code>.</p>
<section id="steps-to-integrate-using-lockstep-approach">
<h3>Steps to Integrate Using Lockstep Approach<a class="headerlink" href="#steps-to-integrate-using-lockstep-approach" title="Link to this heading">#</a></h3>
<ol class="arabic">
<li><p><strong>Identify the Decision Rate</strong>: Determine how frequently your tool needs to analyze data and make decisions.
This will help you decide where to insert your tool’s functionality in the workflow.
Some of this depends on how the experimental plans are structured. There is <a class="reference internal" href="../reference/lock-step.html"><span class="std std-doc">reference material</span></a> describing the distinctions between
per-event and per-run decision making.</p></li>
<li><p><strong>Identify Decision Relevant Data</strong>: First, identify points in your experimental workflow where decisions based on real-time data could optimize the experimental outcomes. Namely, choose your independent and dependent varaiables.
The “reccomender factories” take arguments that specify the independent and dependent variables as keys to be extracted from their document stream (start/event/stop).</p></li>
<li><p><strong>Identify the plan to take a reading</strong>: The adaptive plans need to know how to take a reading.
This is done by specifying a plan that takes a reading and the detectors to be read.</p></li>
<li><p><strong>Define Agent Methods</strong>: Your object requires some notion of <code class="docutils literal notranslate"><span class="pre">ask</span></code> and <code class="docutils literal notranslate"><span class="pre">tell</span></code> methods. <code class="docutils literal notranslate"><span class="pre">report</span></code> is optional and not implemented in the lockstep case.
These methods are used by the <code class="docutils literal notranslate"><span class="pre">reccomender_factory</span></code> to interact with your agent.
Currently, there is no abstract base class to enforce these methods, because there are only two methods to implement.
The <code class="docutils literal notranslate"><span class="pre">tell</span></code> method should be fast, and is often a caching operation, e.g., updating the arrays your agent uses to make decisions.
For lockstep agents, a <code class="docutils literal notranslate"><span class="pre">tell_many</span></code> method is also provided, which is called with a list of x and y values. This is necessary for event_pages, with a simple default shown below.
The <code class="docutils literal notranslate"><span class="pre">ask</span></code> method can then be used to trigger your existing logic to make a decision and return the next points to measure (in independent variable space from step 2).
This method consumes a batch size, but for lockstep agents, the batchsize is necessarily 1.  It should return a list of values corresponding to the list of independent keys. (Even if there is only one independent key, it should return a list of length 1.)
Unlike the asynchronous case, in the lockstep case, neither of these methods currently return documents, but this may change in the future.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">YourAgent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="c1"># Initialization code for your tool</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">):</span>
        <span class="c1"># Process new data</span>
        <span class="k">pass</span>

    <span class="k">def</span> <span class="nf">tell_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ys</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">):</span>
        <span class="c1"># Process multiple new data points</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]:</span>
        <span class="c1"># Decide on the next experiment step</span>
        <span class="c1"># Here you should call your tools pre-existing logic to make a choice.</span>
        <span class="n">next_step</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">your_existing_logic</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">next_step</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p><strong>Execute with RunEngine</strong>: Execute your custom adaptive measurement plan with the Bluesky RunEngine, ensuring real-time data analysis and adaptive decision-making.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">({})</span>
<span class="n">reccomender</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">reccomender_factory</span><span class="p">(</span><span class="n">your_agent</span><span class="p">,</span> <span class="n">independent_keys</span><span class="p">,</span> <span class="n">dependent_keys</span><span class="p">)</span>
<span class="n">your_adaptive_plan</span> <span class="o">=</span> <span class="n">adaptive_plan</span><span class="p">(</span><span class="n">dets</span><span class="p">,</span> <span class="n">first_point</span><span class="p">,</span> <span class="n">to_reccomender</span><span class="o">=</span><span class="n">reccomender</span><span class="p">,</span> <span class="n">from_reccomender</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
<span class="n">RE</span><span class="p">(</span><span class="n">your_adaptive_plan</span><span class="p">)</span>
</pre></div>
</div>
</li>
</ol>
</section>
</section>
<section id="asynchronous-approach-with-bluesky-adaptive">
<h2>Asynchronous Approach with Bluesky-Adaptive<a class="headerlink" href="#asynchronous-approach-with-bluesky-adaptive" title="Link to this heading">#</a></h2>
<p>The asynchronous approach allows your tool to operate independently from the experiment’s main execution thread, making decisions and suggesting actions without blocking ongoing measurements.
This method is suited for more complex experimental setups where multiple sources of data or decision-making agents are involved.
It does involve more moving parts, which may require additional infrastructure to manage (e.g., Kafka, QueueServer, etc.).</p>
<section id="steps-to-integrate-using-asynchronous-approach">
<h3>Steps to Integrate Using Asynchronous Approach<a class="headerlink" href="#steps-to-integrate-using-asynchronous-approach" title="Link to this heading">#</a></h3>
<ol class="arabic">
<li><p><strong>Inherit from Base Agent Class</strong>: Your tool should inherit from <code class="docutils literal notranslate"><span class="pre">bluesky_adaptive.agents.base.Agent</span></code>, implementing the required methods such as <code class="docutils literal notranslate"><span class="pre">ask</span></code>, <code class="docutils literal notranslate"><span class="pre">tell</span></code>, and <code class="docutils literal notranslate"><span class="pre">report</span></code>.
An abstract base class like <code class="docutils literal notranslate"><span class="pre">base.Agent</span></code> will protect you at runtime from missing any of the required methods.
This allows your tool to receive data, make decisions, and suggest future actions.
The instructions here are the same as above, but the agent specific methods should also return a dictionary that is stored as an event document in the Bluesky document model. The values of this dictionary should be arrays or scalars that do not change shape throughout the experiment, and the keys should be strings.
Again, the <code class="docutils literal notranslate"><span class="pre">tell</span></code> method should be fast, as this happens every time a new event is emitted. <code class="docutils literal notranslate"><span class="pre">tell_many</span></code> does not need to be implemented here, as the ABC holds a default, but if vectorized operations are possible, it is recommended to implement it.
The <code class="docutils literal notranslate"><span class="pre">ask</span></code> and <code class="docutils literal notranslate"><span class="pre">report</span></code> have no obligation to be quick, as they are not necessarily called in the same tight loop.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">YourAsyncAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Initialization code for your tool</span>

    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">,</span> <span class="n">y</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># Process new data</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">def</span> <span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]],</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">]]:</span>
        <span class="c1"># Decide on the next experiment step</span>
        <span class="k">return</span> <span class="p">[{</span><span class="o">...</span><span class="p">}</span> <span class="k">for</span> <span class="n">next_step</span> <span class="ow">in</span> <span class="n">next_steps</span><span class="p">],</span> <span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">next_step</span><span class="p">)</span> <span class="k">for</span> <span class="n">next_step</span> <span class="ow">in</span> <span class="n">next_steps</span><span class="p">]</span>

    <span class="k">def</span> <span class="nf">report</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">dict</span><span class="p">:</span>
        <span class="c1"># Generate a report of the agent&#39;s current state</span>
        <span class="k">return</span> <span class="p">{}</span>
</pre></div>
</div>
</li>
<li><p><strong>Define experiment specific methods</strong>: The other methods detailed in <a class="reference internal" href="../reference/agent-api.html"><span class="std std-doc">the reference section</span></a> solve the same problems as declaring independent and dependent “keys” in the lockstep case.
These allow for more sophisticated interactions between the agent, data, and orchestration.
Required methods here are:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">unpack_run</span></code>: Which extracts the independent and dependent variables from a <code class="docutils literal notranslate"><span class="pre">BlueskyRun</span></code> read from Tiled.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">measurement_plan</span></code>: Consumes the next point (independent variable) provided by the agent decision making, and converts this into a plan name, arguments, and keyword arguments. This returns a <code class="docutils literal notranslate"><span class="pre">string</span></code> (plan name), <code class="docutils literal notranslate"><span class="pre">list</span></code> (args), and <code class="docutils literal notranslate"><span class="pre">dict</span></code> (kwargs).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">trigger_condition</span></code>: Which determines whether or not a <code class="docutils literal notranslate"><span class="pre">BlueskyRun</span></code> is relevant to agent. This is useful in settings where some measurements are background, or ancilary from an agent’s perspective. If not imlpemented, the agent will be triggered by all runs.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">YourAsyncAgent</span><span class="p">(</span><span class="n">Agent</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">unpack_run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">BlueskyRun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="n">ArrayLike</span><span class="p">,</span> <span class="n">ArrayLike</span><span class="p">]:</span>
        <span class="c1"># Extract independent and dependent variables from the run</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span>
    
    <span class="k">def</span> <span class="nf">measurement_plan</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">next_step</span><span class="p">:</span> <span class="n">ArrayLike</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Tuple</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">]:</span>
        <span class="c1"># Convert the next step into a plan name, args, and kwargs</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="n">plan_name</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span>

    <span class="k">def</span> <span class="nf">trigger_condition</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">run</span><span class="p">:</span> <span class="n">BlueskyRun</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
        <span class="c1"># Determine if the run is relevant to the agent</span>
        <span class="o">...</span>
        <span class="k">return</span> <span class="kc">True</span>
</pre></div>
</div>
</li>
<li><p><strong>Deploy the Required Stack</strong>: To use the asynchronous agents, the following stack is required during the experiment.</p>
<ul class="simple">
<li><p><strong>Kafka</strong>: To communicate between the agent and the experiment.</p></li>
<li><p><strong>QueueServer</strong>: To manage the agent’s responses and experimental orchestration.</p></li>
<li><p><strong>Tiled</strong>: For storing the data and metadata from the experiment and agent processes.</p></li>
</ul>
</li>
<li><p><strong>Test the agent in Python</strong>: Test your agent in Python to ensure that it can communicate with the experiment and make decisions based on the data received.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span> <span class="o">=</span> <span class="n">YourAsyncAgent</span><span class="p">()</span>
<span class="n">agent</span><span class="o">.</span><span class="n">tell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>
<span class="n">next_step</span><span class="p">,</span> <span class="n">report</span> <span class="o">=</span> <span class="n">agent</span><span class="o">.</span><span class="n">ask</span><span class="p">()</span>
</pre></div>
</div>
<p>You can also start the agent in a separate process to ensure it can communicate via Kafka messages. This will start a Kafka subscriber and block the process until the agent is stopped.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">agent</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>
</pre></div>
</div>
</li>
<li><p><strong>Deploy Agent as a Service</strong>: Deploy your agent as a service to run in parallel with the experiment. This can be done using the <code class="docutils literal notranslate"><span class="pre">bluesky_adaptive.server</span></code> and <code class="docutils literal notranslate"><span class="pre">uvicorn</span></code> as shown in the <a class="reference internal" href="use-service.html"><span class="std std-doc">how-to</span></a>.</p></li>
</ol>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="use-service.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Running Your Agent as a Service with Bluesky Adaptive</p>
      </div>
    </a>
    <a class="right-next"
       href="dev-agent-brains.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Developing Agent/Recommender Algorithms</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#lockstep-approach-with-bluesky-adaptive">Lockstep Approach with Bluesky-Adaptive</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-to-integrate-using-lockstep-approach">Steps to Integrate Using Lockstep Approach</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#asynchronous-approach-with-bluesky-adaptive">Asynchronous Approach with Bluesky-Adaptive</a><ul class="visible nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#steps-to-integrate-using-asynchronous-approach">Steps to Integrate Using Asynchronous Approach</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/bluesky/bluesky-adaptive/edit/main/docs/src/how-to/extend-my-tool.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/how-to/extend-my-tool.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2020, NSLS-II.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>