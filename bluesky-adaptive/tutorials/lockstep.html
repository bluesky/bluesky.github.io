
<!DOCTYPE html>


<html lang="en" data-content_root="../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>Lockstep Agent Tutorial &#8212; bluesky-adaptive  documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=fa44fd50" />
    <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
    <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />
    <link rel="stylesheet" type="text/css" href="../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../_static/documentation_options.js?v=5929fcd5"></script>
    <script src="../_static/doctools.js?v=888ff710"></script>
    <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
    <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/design-tabs.js?v=36754332"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'tutorials/lockstep';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Async Agent Tutorial" href="async.html" />
    <link rel="prev" title="Getting Started" href="getting-started.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">bluesky-adaptive  documentation</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../explanations/index.html">
                        Explanations
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../how-to/index.html">
                        How-to Guides
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://blueskyproject.io">
                    Bluesky Project
                  </a>
                </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
        <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky-adaptive" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky-adaptive" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://blueskyproject.io/mattermost/" title="Community" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-person-circle-question fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Community</span></a>
        </li>
</ul></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../explanations/index.html">
                        Explanations
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../how-to/index.html">
                        How-to Guides
                      </a>
                    </li>
                

                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="index.html">
                        Tutorials
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../reference/index.html">
                        Reference
                      </a>
                    </li>
                

                <li class="nav-item">
                  <a class="nav-link nav-external" href="https://blueskyproject.io">
                    Bluesky Project
                  </a>
                </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
          <div class="navbar-item"><ul class="navbar-icon-links navbar-nav"
    aria-label="Icon Links">
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://github.com/bluesky/bluesky-adaptive" title="GitHub" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fa-brands fa-square-github fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">GitHub</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://pypi.org/project/bluesky-adaptive" title="PyPI" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-cube fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">PyPI</span></a>
        </li>
        <li class="nav-item">
          
          
          
          
          
          
          
          
          <a href="https://blueskyproject.io/mattermost/" title="Community" class="nav-link" rel="noopener" target="_blank" data-bs-toggle="tooltip" data-bs-placement="bottom"><span><i class="fas fa-person-circle-question fa-lg" aria-hidden="true"></i></span>
            <span class="sr-only">Community</span></a>
        </li>
</ul></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><p aria-level="2" class="caption" role="heading"><span class="caption-text">Available Tutorials</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="getting-started.html">Getting Started</a></li>
<li class="toctree-l1 current active"><a class="current reference internal" href="#">Lockstep Agent Tutorial</a></li>
<li class="toctree-l1"><a class="reference internal" href="async.html">Async Agent Tutorial</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="index.html" class="nav-link">Tutorials</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">Lockstep...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="lockstep-agent-tutorial">
<h1>Lockstep Agent Tutorial<a class="headerlink" href="#lockstep-agent-tutorial" title="Link to this heading">#</a></h1>
<p>This tutorial depends on starting the Bluesky stack in a pod as shown in <a class="reference internal" href="getting-started.html"><span class="std std-doc">Getting Started Tutorial</span></a>.
The tutorial covers:</p>
<ul class="simple">
<li><p><a class="reference internal" href="#lockstep-agent-tutorial"><span class="xref myst">Lockstep Agent Tutorial</span></a></p>
<ul>
<li><p><a class="reference internal" href="#start-bsui"><span class="xref myst">Start BSUI</span></a></p></li>
<li><p><a class="reference internal" href="#explore-the-devices-available"><span class="xref myst">Explore the devices available</span></a></p></li>
<li><p><a class="reference internal" href="#standard-plan"><span class="xref myst">Standard Plan</span></a></p></li>
<li><p><a class="reference internal" href="#inspecting-the-data-model"><span class="xref myst">Inspecting the data model</span></a></p></li>
<li><p><a class="reference internal" href="#building-a-lockstep-agent"><span class="xref myst">Building a Lockstep Agent</span></a></p></li>
<li><p><a class="reference internal" href="#adding-comlpexity-with-multiple-signals"><span class="xref myst">Adding comlpexity with multiple signals</span></a></p></li>
</ul>
</li>
</ul>
<section id="start-bsui">
<h2>Start BSUI<a class="headerlink" href="#start-bsui" title="Link to this heading">#</a></h2>
<p>Firstly, we need to start an ipython session in the same environment as our experiment stack.
Assuming you have cloned the bluesky-pods repository and started the pod as shown in the <a class="reference internal" href="getting-started.html"><span class="std std-doc">Getting Started Tutorial</span></a>, we can start the BSUI by running the following command in the same terminal as the pod:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>bluesky-pods/compose/acq-pod
bash<span class="w"> </span>launch_bluesky.sh
</pre></div>
</div>
</section>
<section id="explore-the-devices-available">
<h2>Explore the devices available<a class="headerlink" href="#explore-the-devices-available" title="Link to this heading">#</a></h2>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">user_ns</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
<p>Will list a set of python objects that are available in the current session.
Some of these are directly from the Bluesky tutorials, such as <code class="docutils literal notranslate"><span class="pre">RE</span></code>, <code class="docutils literal notranslate"><span class="pre">motor</span></code>, <code class="docutils literal notranslate"><span class="pre">random_walk</span></code>.
We can inspect the devices of interest by just typing their name in the ipython session.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="n">RE</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span> <span class="o">&lt;</span><span class="n">bluesky</span><span class="o">.</span><span class="n">run_engine</span><span class="o">.</span><span class="n">RunEngine</span> <span class="n">at</span> <span class="mh">0xffff95c10200</span><span class="o">&gt;</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">motor</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">2</span><span class="p">]:</span> <span class="n">SynAxisNoPosition</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;motor&#39;</span><span class="p">,</span> <span class="n">read_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;readback&#39;</span><span class="p">,</span> <span class="s1">&#39;setpoint&#39;</span><span class="p">],</span> <span class="n">configuration_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;velocity&#39;</span><span class="p">,</span> <span class="s1">&#39;acceleration&#39;</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">random_walk</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">3</span><span class="p">]:</span> <span class="n">RandomWalk</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;random_walk:&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;random_walk&#39;</span><span class="p">,</span> <span class="n">read_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">],</span> <span class="n">configuration_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;dt&#39;</span><span class="p">])</span>

<span class="n">In</span> <span class="p">[</span><span class="mi">4</span><span class="p">]:</span> <span class="n">det</span>
<span class="n">Out</span><span class="p">[</span><span class="mi">5</span><span class="p">]:</span> <span class="n">DetWithCountTime</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;det&#39;</span><span class="p">,</span> <span class="n">read_attrs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;intensity&#39;</span><span class="p">,</span> <span class="s1">&#39;count_time&#39;</span><span class="p">],</span> <span class="n">configuration_attrs</span><span class="o">=</span><span class="p">[])</span>
</pre></div>
</div>
</section>
<section id="standard-plan">
<h2>Standard Plan<a class="headerlink" href="#standard-plan" title="Link to this heading">#</a></h2>
<p>We can start by using these devices and our <code class="docutils literal notranslate"><span class="pre">RunEngine</span></code> to run a standard plan.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>This wasn’t very interesting, since this detector only produces a fixed value.
Let’s grab a random detector from Ophyd Simulated Devices with multiple signals.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">ophyd.sim</span> <span class="kn">import</span> <span class="n">ABDetector</span>
<span class="n">ab_det</span> <span class="o">=</span> <span class="n">ABDetector</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;ab_det&quot;</span><span class="p">)</span>
<span class="n">ab_det</span><span class="o">.</span><span class="n">read</span><span class="p">()</span> <span class="c1"># To get a feeling for the signals available</span>
<span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">ab_det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
<p>If you have X11 forwarding enabled, you should see a plot of the random data produced by the scan. (The “ab_det_a” data against the motor value since only the “a” signal is “hinted”).</p>
</section>
<section id="inspecting-the-data-model">
<h2>Inspecting the data model<a class="headerlink" href="#inspecting-the-data-model" title="Link to this heading">#</a></h2>
<p>A lockstep agent needs to be aware of the keys that it will be receiving from the detector.
Without diving into the bluesky document model, we can infer this information from the data at storage time.
Let’s run a fresh scan inspect our most recent <code class="docutils literal notranslate"><span class="pre">BlueskyRun</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">scan</span><span class="p">([</span><span class="n">ab_det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
<span class="n">run</span> <span class="o">=</span> <span class="n">db</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="n">run</span><span class="o">.</span><span class="n">primary</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

<span class="o">&gt;</span> <span class="o">&lt;</span><span class="n">xarray</span><span class="o">.</span><span class="n">Dataset</span><span class="o">&gt;</span> <span class="n">Size</span><span class="p">:</span> <span class="mi">400</span><span class="n">B</span>
<span class="o">&gt;</span> <span class="n">Dimensions</span><span class="p">:</span>         <span class="p">(</span><span class="n">time</span><span class="p">:</span> <span class="mi">10</span><span class="p">)</span>
<span class="o">&gt;</span> <span class="n">Coordinates</span><span class="p">:</span>
<span class="o">&gt;</span>   <span class="o">*</span> <span class="n">time</span>            <span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="n">float64</span> <span class="mi">80</span><span class="n">B</span> <span class="mf">1.712e+09</span> <span class="mf">1.712e+09</span> <span class="o">...</span> <span class="mf">1.712e+09</span>
<span class="o">&gt;</span> <span class="n">Data</span> <span class="n">variables</span><span class="p">:</span>
<span class="o">&gt;</span>     <span class="n">motor</span>           <span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="n">float64</span> <span class="mi">80</span><span class="n">B</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">-</span><span class="mf">0.7778</span> <span class="o">-</span><span class="mf">0.5556</span> <span class="o">...</span> <span class="mf">0.7778</span> <span class="mf">1.0</span>
<span class="o">&gt;</span>     <span class="n">motor_setpoint</span>  <span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="n">float64</span> <span class="mi">80</span><span class="n">B</span> <span class="o">-</span><span class="mf">1.0</span> <span class="o">-</span><span class="mf">0.7778</span> <span class="o">-</span><span class="mf">0.5556</span> <span class="o">...</span> <span class="mf">0.7778</span> <span class="mf">1.0</span>
<span class="o">&gt;</span>     <span class="n">ab_det_a</span>        <span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="n">float64</span> <span class="mi">80</span><span class="n">B</span> <span class="mf">0.4206</span> <span class="mf">0.2793</span> <span class="mf">0.8471</span> <span class="o">...</span> <span class="mf">0.695</span> <span class="mf">0.6514</span>
<span class="o">&gt;</span>     <span class="n">ab_det_b</span>        <span class="p">(</span><span class="n">time</span><span class="p">)</span> <span class="n">float64</span> <span class="mi">80</span><span class="n">B</span> <span class="mf">0.1539</span> <span class="mf">0.8972</span> <span class="mf">0.4957</span> <span class="o">...</span> <span class="mf">0.3888</span> <span class="mf">0.05702</span>
</pre></div>
</div>
<p>Assuming our independent variable is our motor position, we can see it is keyed by <code class="docutils literal notranslate"><span class="pre">'motor'</span></code>.
Let’s use the ‘a’ signal of our detector as our dependent variable, keyed by <code class="docutils literal notranslate"><span class="pre">'ab_det_a'</span></code>.</p>
</section>
<section id="building-a-lockstep-agent">
<h2>Building a Lockstep Agent<a class="headerlink" href="#building-a-lockstep-agent" title="Link to this heading">#</a></h2>
<p>Now we can build a reccomendation agent that will suggest the next motor position based on the most recent data.
For this initial application we will build a per-event agent that suggests either -1 or 1 based on the most recent data.
Since our detector is random, we will move to -1 if the most recent detector signal was less than 0.5, and to 1 otherwise.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Agent</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_value</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_value</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">tell_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_value</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="mi">0</span>
        <span class="k">return</span> <span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_value</span> <span class="o">&lt;</span> <span class="mf">0.5</span> <span class="k">else</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span>
<span class="n">agent</span> <span class="o">=</span> <span class="n">Agent</span><span class="p">()</span>
</pre></div>
</div>
<p>We then need to build this agent into an adaptive plan. We give this a timeout of five measurements, and run the plan.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky_adaptive.per_event</span> <span class="kn">import</span> <span class="n">adaptive_plan</span><span class="p">,</span> <span class="n">recommender_factory</span>
<span class="n">recommender</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">recommender_factory</span><span class="p">(</span><span class="n">agent</span><span class="p">,</span> <span class="n">independent_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;motor&quot;</span><span class="p">],</span> <span class="n">dependent_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ab_det_a&quot;</span><span class="p">],</span> <span class="n">max_count</span><span class="o">=</span><span class="mi">5</span><span class="p">)</span>
<span class="n">plan</span> <span class="o">=</span> <span class="n">adaptive_plan</span><span class="p">([</span><span class="n">ab_det</span><span class="p">],</span> <span class="p">{</span><span class="n">motor</span><span class="p">:</span> <span class="mf">0.0</span><span class="p">},</span> <span class="n">to_recommender</span><span class="o">=</span><span class="n">recommender</span><span class="p">,</span> <span class="n">from_recommender</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
<span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</pre></div>
</div>
<p>Your terminal output should be a LiveTable that shows the motor position and the ‘a’ signal of the detector.
If the previous value of ‘a’ was less than 0.5, the motor should move to -1 in the next step, and to 1 otherwise.
The LivePlot should hold a series of zig-zags as the motor moves back and forth between -1 and 1.</p>
</section>
<section id="adding-comlpexity-with-multiple-signals">
<h2>Adding comlpexity with multiple signals<a class="headerlink" href="#adding-comlpexity-with-multiple-signals" title="Link to this heading">#</a></h2>
<p>This agent is very simple, and only uses the ‘a’ signal of the detector.
Let’s add another independent variable, and another dependent variable to our agent.
First we can do a deterministic scan over the <code class="docutils literal notranslate"><span class="pre">motor</span></code> and <code class="docutils literal notranslate"><span class="pre">motor3</span></code> (using <code class="docutils literal notranslate"><span class="pre">motor3</span></code> for the Hinted ophyd object).
We’ll also make the <code class="docutils literal notranslate"><span class="pre">ab_det_b</span></code> signal hinted so it shows up in our plots and tables.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">bluesky.plans</span> <span class="kn">import</span> <span class="n">grid_scan</span>
<span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">Kind</span>
<span class="n">ab_det</span><span class="o">.</span><span class="n">b</span><span class="o">.</span><span class="n">kind</span> <span class="o">=</span> <span class="n">Kind</span><span class="o">.</span><span class="n">hinted</span>
<span class="n">RE</span><span class="p">(</span><span class="n">grid_scan</span><span class="p">([</span><span class="n">ab_det</span><span class="p">],</span> <span class="n">motor</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="n">motor3</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
<p>This will produce a grid scan and randomly colored heat map in the LivePlot.
Now we can use an agent that expects the <code class="docutils literal notranslate"><span class="pre">motor</span></code> and <code class="docutils literal notranslate"><span class="pre">motor3</span></code> signals, and suggests the next <code class="docutils literal notranslate"><span class="pre">motor</span></code> and <code class="docutils literal notranslate"><span class="pre">motor3</span></code> position based on the <code class="docutils literal notranslate"><span class="pre">ab_det_a</span></code> and <code class="docutils literal notranslate"><span class="pre">ab_det_b</span></code> signals.
In this context x and y will be arrays shaped (2,), and the next suggestion will be an array shaped (2,).</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">numpy.random</span> <span class="kn">import</span> <span class="n">uniform</span>
<span class="k">class</span> <span class="nc">Agent2D</span><span class="p">:</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_values</span> <span class="o">=</span> <span class="kc">None</span>
    
    <span class="k">def</span> <span class="nf">tell</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">last_values</span> <span class="o">=</span> <span class="n">y</span>

    <span class="k">def</span> <span class="nf">tell_many</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">xs</span><span class="p">,</span> <span class="n">ys</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">tell</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">ask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">batch_size</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_values</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Agent should be primed with first plan&quot;</span><span class="p">)</span>   
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_values</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_values</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">next_point</span> <span class="o">=</span> <span class="p">[</span><span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">),</span> <span class="n">uniform</span><span class="p">(</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">)]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">next_point</span> <span class="o">=</span> <span class="p">[</span><span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">),</span> <span class="n">uniform</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">)]</span>
        <span class="k">return</span> <span class="n">next_point</span>
<span class="n">agent2d</span> <span class="o">=</span> <span class="n">Agent2D</span><span class="p">()</span>
</pre></div>
</div>
<p>This agent will suggest a random point in the lower left quadrant if the last ‘a’ signal was greater than the last ‘b’ signal, and a random point in the upper right quadrant otherwise.
Building the reccomender and running the plan is almost the same as before, but with more specified keys.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">recommender</span><span class="p">,</span> <span class="n">queue</span> <span class="o">=</span> <span class="n">recommender_factory</span><span class="p">(</span><span class="n">agent2d</span><span class="p">,</span> <span class="n">independent_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;motor&quot;</span><span class="p">,</span> <span class="s2">&quot;motor3&quot;</span><span class="p">],</span> <span class="n">dependent_keys</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;ab_det_a&quot;</span><span class="p">,</span> <span class="s2">&quot;ab_det_b&quot;</span><span class="p">],</span> <span class="n">max_count</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
<span class="n">plan</span> <span class="o">=</span> <span class="n">adaptive_plan</span><span class="p">([</span><span class="n">ab_det</span><span class="p">],</span> <span class="p">{</span><span class="n">motor</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">motor3</span><span class="p">:</span> <span class="o">-</span><span class="mf">1.0</span><span class="p">},</span> <span class="n">to_recommender</span><span class="o">=</span><span class="n">recommender</span><span class="p">,</span> <span class="n">from_recommender</span><span class="o">=</span><span class="n">queue</span><span class="p">)</span>
<span class="n">RE</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
</pre></div>
</div>
<p>This should give a LiveTable with strictly positive or negative motor positions, and a LivePlot that shows the motor positions in the upper right and lower left quadrants.</p>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="getting-started.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Getting Started</p>
      </div>
    </a>
    <a class="right-next"
       href="async.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Async Agent Tutorial</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#start-bsui">Start BSUI</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#explore-the-devices-available">Explore the devices available</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#standard-plan">Standard Plan</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#inspecting-the-data-model">Inspecting the data model</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#building-a-lockstep-agent">Building a Lockstep Agent</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#adding-comlpexity-with-multiple-signals">Adding comlpexity with multiple signals</a></li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  
  <div class="tocsection editthispage">
    <a href="https://github.com/bluesky/bluesky-adaptive/edit/main/docs/src/tutorials/lockstep.md">
      <i class="fa-solid fa-pencil"></i>
      
      
        
          Edit on GitHub
        
      
    </a>
  </div>
</div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../_sources/tutorials/lockstep.md.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2020, NSLS-II.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.2.6.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>