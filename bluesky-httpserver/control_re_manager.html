

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="./">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Controlling Run Engine Manager &mdash; Bluesky HTTP Server 0.0.12.post17+g5215bf9 documentation</title>
      <link rel="stylesheet" type="text/css" href="_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="_static/css/theme.css?v=e59714d7" />

  
      <script src="_static/jquery.js?v=5d32c60e"></script>
      <script src="_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="_static/documentation_options.js?v=ddc5f964"></script>
      <script src="_static/doctools.js?v=9bcbadda"></script>
      <script src="_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Server Configuration" href="configuration.html" />
    <link rel="prev" title="Starting and Using the Server" href="usage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            Bluesky HTTP Server
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="contributing.html">Contributing</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User's Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Starting and Using the Server</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Controlling Run Engine Manager</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#starting-queue-server-stack-for-the-demo">Starting Queue Server Stack for the Demo</a></li>
<li class="toctree-l2"><a class="reference internal" href="#guide-to-re-manager-api">Guide to RE Manager API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#additional-api">Additional API</a></li>
<li class="toctree-l2"><a class="reference internal" href="#streaming-console-output-of-re-manager">Streaming Console Output of RE Manager</a></li>
<li class="toctree-l2"><a class="reference internal" href="#console-output-of-re-manager">Console Output of RE Manager</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Server Configuration</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Related Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-queueserver">Bluesky Queue Server</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-queueserver-api">Bluesky Queue Server API</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-widgets">Bluesky Widgets</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky">Bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/ophyd">Ophyd</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/databroker">Data Broker</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Bluesky HTTP Server</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Controlling Run Engine Manager</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/control_re_manager.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="controlling-run-engine-manager">
<h1>Controlling Run Engine Manager<a class="headerlink" href="#controlling-run-engine-manager" title="Link to this heading"></a></h1>
<p>Bluesky HTTP Server provides REST API that allow to access all low-level API
exposed by Run Engine (RE) Manager. The server forwards payloads of most REST API
requests to RE Manager over 0MQ and forwards the returned results back to the
client. Some of the parameters used to monitor RE Manager and RE Worker are cached
by HTTP Server and returned to clients without sending requests to RE Manager
each time. Caching removes the load on RE Manager, especially if multiple clients
are monitoring the experiment simultaneously.</p>
<p>Users are expected to control the server using Python scripts based on
<a class="reference external" href="https://blueskyproject.io/bluesky-queueserver-api/">Bluesky Queue Server API</a>,
GUI programs or Web applications. This manual demonstrates how to send the API requests
from command line using <a class="reference external" href="https://httpie.io/">httpie</a>. This approach is not practical,
but may be useful for testing the server and understanding the API.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Unless the server is configured to allow public access to all API, all requests
must include a valid access token or an API key. See the instructions on how
to send tokens and API keys with API requests in section
<a class="reference internal" href="usage.html#passing-tokens-and-api-keys-with-api-requests"><span class="std std-ref">Passing Tokens and API Keys in API Requests</span></a></p>
</div>
<section id="starting-queue-server-stack-for-the-demo">
<h2>Starting Queue Server Stack for the Demo<a class="headerlink" href="#starting-queue-server-stack-for-the-demo" title="Link to this heading"></a></h2>
<p>This section contains instructions on how to start RE Manager and HTTP Server to explore the API
in demo mode. See <a class="reference internal" href="usage.html#starting-http-server"><span class="std std-ref">Starting the Server</span></a> for more detailed information.</p>
<p>Start RE Manager and enable publishing of console output:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ start-re-manager --zmq-publish-console ON
</pre></div>
</div>
<p>Start HTTP Server in single-user mode. In this example the single-user API key is <code class="docutils literal notranslate"><span class="pre">mykey</span></code>, but
it may be any alphanumeric string:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ QSERVER_HTTP_SERVER_SINGLE_USER_API_KEY=mykey uvicorn --host localhost --port 60610 bluesky_httpserver.server:app
</pre></div>
</div>
<p>Now the server API can be accessed by passing the API key with API requests. For example, the status of
RE Manager can be loaded using</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http GET http://localhost:60610/api/status &#39;Authorization: ApiKey mykey&#39;
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In rare cases RE Manager or HTTP Server may crash and leave some sockets open. This was observed
when running development versions of RE Manager that contain bugs. The remaining open sockets
may prevent RE Manager or HTTP Server from restarting. The sockets could be closed by
running</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ netstat -ltnp
</pre></div>
</div>
<p>and finding PIDs of the offending processes. The default ports used by RE Manager are
60615 and 60625 and port used by the HTTP Server is 60610. Kill the offending processes:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ kill -9 &lt;pid&gt;
</pre></div>
</div>
</div>
</section>
<section id="guide-to-re-manager-api">
<h2>Guide to RE Manager API<a class="headerlink" href="#guide-to-re-manager-api" title="Link to this heading"></a></h2>
<p>The most basic request is ‘ping’ intended to fetch some response from RE Manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span>
<span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">ping</span>
</pre></div>
</div>
<p>Currently ‘ping’ request returns the status of RE Manager, but the returned data may change. The recommended
way to fetch status of RE Manager is to use ‘status’ request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">status</span>
</pre></div>
</div>
<p>Before plans could be executed, the RE Worker environment must be opened. Opening RE Worker environment
involves loading beamline profile collection and instantiation of Run Engine and may take a few minutes.
The package comes with simulated profile collection that includes simulated Ophyd devices and built-in
Bluesky plans and loads almost instantly. An open RE Worker environment may be closed or destroyed.
Orderly closing of the environment is a safe operation, which is possible only when RE Worker
(and RE Manager) is in idle state, i.e. no plans are currently running or paused. Destroying
the environment is potentially dangerous, since it involves killing of RE Process that could potentially
be running plans, and supposed to be used for destroying unresponsive environment in case of RE failure.
Note that any operations on the queue (such as adding or removing plans) can be performed before
the environment is opened.</p>
<p>Open the new RE environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">environment</span><span class="o">/</span><span class="nb">open</span>
</pre></div>
</div>
<p>Close RE environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">environment</span><span class="o">/</span><span class="n">close</span>
</pre></div>
</div>
<p>Destroy RE environment:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">environment</span><span class="o">/</span><span class="n">destroy</span>
</pre></div>
</div>
<p>Get the lists (JSON) of allowed plans and devices:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">plans</span><span class="o">/</span><span class="n">allowed</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">devices</span><span class="o">/</span><span class="n">allowed</span>
</pre></div>
</div>
<p>The list of allowed plans and devices is generated based on the list of existing plans and devices
(‘existing_plans_and_devices.yaml’ by default) and user group permissions (‘user_group_permissions.yaml’
by default). The files with permission data are loaded at RE Manager startup. If any of the files
are changed while RE Manager is running (e.g. a new plan was added to the profile collection and
the new ‘existing_plans_and_devices.yaml’ file was generated) and restarting RE Manager is not
desirable, the data can be reloaded by sending ‘permissions_reload’ request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">permissions</span><span class="o">/</span><span class="n">reload</span>
</pre></div>
</div>
<p>Before plans could be executed they should be placed in the <strong>plan queue</strong>. The plan queue contains
<strong>items</strong>. The items are <strong>plans</strong> that could be executed by Run Engine or <strong>instructions</strong> that
can modify the state of the queue or RE Manager. Currently only one instruction (‘queue_stop’ - stops
execution of the queue) is supported.</p>
<p>Push a new plan to the back of the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;scan&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;], &quot;motor&quot;, -1, 1, 10], &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;kwargs&quot;:{&quot;num&quot;:10, &quot;delay&quot;:1}, &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
</pre></div>
</div>
<p>It takes 10 second to execute the third plan in the group above, so it is may be the most convenient for testing
pausing/resuming/stopping of experimental plans.</p>
<p>API for queue operations is designed to work identically with items of all types. For example, a ‘queue_stop`
instruction can be added to the queue <cite>queue_item_add</cite> API:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;queue_stop&quot;, &quot;item_type&quot;: &quot;instruction&quot;}&#39;</span>
</pre></div>
</div>
<p>An item can be added at any position of the queue. Push a plan to the front or the back of the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">pos</span><span class="o">:=</span><span class="s1">&#39;&quot;front&quot;&#39;</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">pos</span><span class="o">:=</span><span class="s1">&#39;&quot;back&quot;&#39;</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">pos</span><span class="o">:=</span><span class="mi">2</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
</pre></div>
</div>
<p>The following command will insert an item in place of the last item in the queue; the last item remains
the last item in the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">pos</span><span class="o">:=-</span><span class="mi">1</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
</pre></div>
</div>
<p>An item can be inserted before or after an existing item with given Item UID.
Insert the plan before an existing item with &lt;uid&gt;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">before_uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid&gt;&#39;</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
</pre></div>
</div>
<p>Insert the plan after an existing item with &lt;uid&gt;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">after_uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid&gt;&#39;</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
</pre></div>
</div>
<p>If the queue has 5 items (0..4), then the following command pushes the new plan to the back of the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span> <span class="n">pos</span><span class="o">:=</span><span class="mi">5</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
</pre></div>
</div>
<p>The ‘queue_item_add’ request will accept any index value. If the index is out of range, then the item will
be pushed to the front or the back of the queue. If the queue is currently running, then it is recommended
to access elements using negative indices (counted from the back of the queue).</p>
<p>The names of the plans and devices are strings. The strings are converted to references to Bluesky plans and
Ophyd devices in the worker process. The simulated beamline profile collection includes all simulated
Ophyd devices and built-in Bluesky plans.</p>
<p>A batch of plans may be submitted to the queue by sending a single request. Every plan in the batch
is validated and the plans are added to the queue only if all plans pass validation. Otherwise the
batch is rejected. The following request adds two plans to the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">add</span><span class="o">/</span><span class="n">batch</span> <span class="n">items</span><span class="o">:=</span><span class="s1">&#39;[{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;]], &quot;item_type&quot;: &quot;plan&quot;}, {&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det2&quot;]], &quot;item_type&quot;: &quot;plan&quot;}]&#39;</span>
</pre></div>
</div>
<p>Alternatively the queue may be populated by uploading the list of plans with parameters in the form of
a spreadsheet to HTTP server. Note that this is an experimental feature, which could be modified at any
time until API is settled. The format of the spreadsheet will be specific to each beamline
using the server. Beamline-specific code will be distributed in a separate package from the core HTTP
server code. Currently, to upload spreadsheet located at <cite>../sample_excel.xlsx</cite> (could be arbitrary path)
run the following command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="o">--</span><span class="n">form</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">upload</span><span class="o">/</span><span class="n">spreadsheet</span> <span class="n">spreadsheet</span><span class="o">@../</span><span class="n">sample_excel</span><span class="o">.</span><span class="n">xlsx</span>
</pre></div>
</div>
<p>Queue Server API allow to execute a single item (plan or instruction) submitted with the API call. Execution
of an item starts immediately if possible (RE Manager is idle and RE Worker environment exists), otherwise
API call fails and the item is not added to the queue. The following commands start execution of a single plan:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">execute</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;kwargs&quot;:{&quot;num&quot;:10, &quot;delay&quot;:1}, &quot;item_type&quot;: &quot;plan&quot;}&#39;</span>
</pre></div>
</div>
<p>Queue can be edited at any time. Changes to the running queue become effective the moment they are
performed. As the currently running plan is finished, the new plan is popped from the top of the queue.</p>
<p>The contents of the queue may be fetched at any time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">get</span>
</pre></div>
</div>
<p>The last item can be removed (popped) from the back of the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">remove</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">remove</span> <span class="n">pos</span><span class="o">:=</span><span class="s1">&#39;&quot;back&quot;&#39;</span>
</pre></div>
</div>
<p>The position of the removed item may be specified similarly to <cite>queue_item_add</cite> request with the difference
that the position index must point to the existing element, otherwise the request fails (returns ‘success==False’).
The following examples remove the plan from the front of the queue and the element previous to last:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">remove</span> <span class="n">pos</span><span class="o">:=</span><span class="s1">&#39;&quot;front&quot;&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">remove</span> <span class="n">pos</span><span class="o">:=-</span><span class="mi">2</span>
</pre></div>
</div>
<p>The items can also be addressed by UID. Remove the item with &lt;uid&gt;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">remove</span> <span class="n">uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid&gt;&#39;</span>
</pre></div>
</div>
<p>Items can be read from the queue without changing it. <cite>queue_item_get</cite> requests are formatted identically to
<cite>queue_item_remove</cite> requests:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">get</span>
<span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">get</span> <span class="n">pos</span><span class="o">:=</span><span class="s1">&#39;&quot;back&quot;&#39;</span>
<span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">get</span> <span class="n">pos</span><span class="o">:=</span><span class="s1">&#39;&quot;front&quot;&#39;</span>
<span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">get</span> <span class="n">pos</span><span class="o">:=-</span><span class="mi">2</span>
<span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">get</span> <span class="n">uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid&gt;&#39;</span>
</pre></div>
</div>
<p>Items can be moved within the queue. Items can be addressed by position or UID. If positional addressing
is used then items are moved from ‘source’ position to ‘destination’ position.
If items are addressed by UID, then the item with &lt;uid_source&gt; is inserted before or after
the item with &lt;uid_dest&gt;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">move</span> <span class="n">pos</span><span class="o">:=</span><span class="mi">3</span> <span class="n">pos_dest</span><span class="o">:=</span><span class="mi">5</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">move</span> <span class="n">uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid_source&gt;&#39;</span> <span class="n">before_uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid_dest&gt;&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">move</span> <span class="n">uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid_source&gt;&#39;</span> <span class="n">after_uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid_dest&gt;&#39;</span>
</pre></div>
</div>
<p>Addressing by position and UID can be mixed. The following instruction will move queue item #3
to the position following an item with &lt;uid_dest&gt;:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">move</span> <span class="n">pos</span><span class="o">:=</span><span class="mi">3</span> <span class="n">after_uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid_dest&gt;&#39;</span>
</pre></div>
</div>
<p>The following instruction moves item with &lt;uid_source&gt; to the front of the queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">move</span> <span class="n">uid</span><span class="o">:=</span><span class="s1">&#39;&lt;uid_source&gt;&#39;</span> <span class="n">pos_dest</span><span class="o">:=</span><span class="s1">&#39;&quot;front&quot;&#39;</span>
</pre></div>
</div>
<p>The parameters of queue items may be updated or replaced. When the item is replaced, it is assigned a new
item UID, while if the item is updated, item UID remains the same. The API implementing those
operations does not distinguish plans and instructions, i.e. an instruction may be updated/replaced
by a plan or a plan by an instruction. The operation is performed by REST API <em>/queue/item/update</em>.
Item parameter <em>‘item_uid’</em> must be set to the UID of the item to be updated. Additional
API parameter ‘replace’ determines if the item is updated or replaced. If the parameter
is skipped or set <em>false</em>, the item is updated. If the parameter is set <em>true</em>,
the item is replaced (i.e. new item UID is generated):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">update</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;item_uid&quot;:&quot;&lt;existing-uid&gt;&quot;, &quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;:&quot;plan&quot;}&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">update</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;item_uid&quot;:&quot;&lt;existing-uid&gt;&quot;, &quot;name&quot;:&quot;queue_stop&quot;, &quot;item_type&quot;:&quot;instruction&quot;}&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">update</span> <span class="n">replace</span><span class="o">:=</span><span class="n">true</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;item_uid&quot;:&quot;&lt;existing-uid&gt;&quot;, &quot;name&quot;:&quot;count&quot;, &quot;args&quot;:[[&quot;det1&quot;, &quot;det2&quot;]], &quot;item_type&quot;:&quot;plan&quot;}&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">item</span><span class="o">/</span><span class="n">update</span> <span class="n">replace</span><span class="o">:=</span><span class="n">true</span> <span class="n">item</span><span class="o">:=</span><span class="s1">&#39;{&quot;item_uid&quot;:&quot;&lt;existing-uid&gt;&quot;, &quot;name&quot;:&quot;queue_stop&quot;, &quot;item_type&quot;:&quot;instruction&quot;}&#39;</span>
</pre></div>
</div>
<p>Remove all entries from the plan queue:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">clear</span>
</pre></div>
</div>
<p>The plan queue can operate in LOOP mode, which is disabled by default. To enable or disable the LOOP mode
the following commands:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">mode</span><span class="o">/</span><span class="nb">set</span> <span class="n">mode</span><span class="o">:=</span><span class="s1">&#39;{&quot;loop&quot;: true}&#39;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">mode</span><span class="o">/</span><span class="nb">set</span> <span class="n">mode</span><span class="o">:=</span><span class="s1">&#39;{&quot;loop&quot;: false}&#39;</span>
</pre></div>
</div>
<p>Start execution of the plan queue. The environment MUST be opened before queue could be started:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">start</span>
</pre></div>
</div>
<p>Request to execute an empty queue is a valid operation that does nothing.</p>
<p>As the queue is running, the list of active runs (runs generated by the running plan may be obtained
at any time). The set of active runs consists of two subsets: open runs and closed runs. For
simple single-run plans the list will contain only one item. The list can be loaded using CLI
commands and HTTP API:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">re</span><span class="o">/</span><span class="n">runs</span><span class="o">/</span><span class="n">active</span>  <span class="c1"># Get the list of active runs</span>
<span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">re</span><span class="o">/</span><span class="n">runs</span><span class="o">/</span><span class="nb">open</span>    <span class="c1"># Get the list of open runs</span>
<span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">re</span><span class="o">/</span><span class="n">runs</span><span class="o">/</span><span class="n">closed</span>  <span class="c1"># Get the list of closed runs</span>
</pre></div>
</div>
<p>The queue can be stopped at any time. Stopping the queue is a safe operation. When the stopping
sequence is initiated, the currently running plan is finished and the next plan is not be started.
The stopping sequence can be cancelled if it was activated by mistake or decision was changed:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">stop</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">queue</span><span class="o">/</span><span class="n">stop</span><span class="o">/</span><span class="n">cancel</span>
</pre></div>
</div>
<p>While a plan in a queue is executed, operation Run Engine can be paused. In the unlikely event
if the request to pause is received while RunEngine is transitioning between two plans, the request
may be rejected by the RE Worker. In this case it needs to be repeated. If Run Engine is in the paused
state, plan execution can be resumed, aborted, stopped or halted. If the plan is aborted, stopped
or halted, it is not removed from the plan queue (it remains the first in the queue) and execution
of the queue is stopped. Execution of the queue may be started again if needed.</p>
<p>Running plan can be paused immediately (returns to the last checkpoint in the plan) or at the next
checkpoint (deferred pause):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">re</span><span class="o">/</span><span class="n">pause</span> <span class="n">option</span><span class="o">=</span><span class="s2">&quot;deferred&quot;</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">re</span><span class="o">/</span><span class="n">pause</span> <span class="n">option</span><span class="o">=</span><span class="s2">&quot;immediate&quot;</span>
</pre></div>
</div>
<p>Resuming, aborting, stopping or halting of currently executed plan:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">re</span><span class="o">/</span><span class="n">resume</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">re</span><span class="o">/</span><span class="n">stop</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">re</span><span class="o">/</span><span class="n">abort</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">re_halt</span>
</pre></div>
</div>
<p>There is minimal user protection features implemented that will prevent execution of
the commands that are not supported in current state of the server. Error messages are printed
in the terminal that is running the server along with output of Run Engine.</p>
<p>Data on executed plans, including stopped plans, is recorded in the history. History can
be downloaded at any time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">history</span><span class="o">/</span><span class="n">get</span>
</pre></div>
</div>
<p>History is not intended for long-term storage. It can be cleared at any time:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">history</span><span class="o">/</span><span class="n">clear</span>
</pre></div>
</div>
<p>Stop RE Manager (exit RE Manager application). There are two options: safe request that is rejected
when the queue is running or a plan is paused:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">echo</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">&#39;</span> <span class="o">|</span> <span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">manager</span><span class="o">/</span><span class="n">stop</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">manager</span><span class="o">/</span><span class="n">stop</span> <span class="n">option</span><span class="o">=</span><span class="s2">&quot;safe_on&quot;</span>
</pre></div>
</div>
<p>Manager can be also stopped at any time using unsafe stop, which causes current RE Worker to be
destroyed even if a plan is running:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">manager</span><span class="o">/</span><span class="n">stop</span> <span class="n">option</span><span class="o">=</span><span class="s2">&quot;safe_off&quot;</span>
</pre></div>
</div>
<p>The ‘test_manager_kill’ request is designed specifically for testing ability of RE Watchdog
to restart malfunctioning RE Manager process. This command stops event loop of RE Manager process
and causes RE Watchdog to restart the process (currently after 5 seconds). RE Manager
process is expected to fully recover its state, so that the restart does not affect
running or paused plans or the state of the queue. Another potential use of the request
is to test handling of communication timeouts, since RE Manager does not respond to the request:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">test</span><span class="o">/</span><span class="n">manager</span><span class="o">/</span><span class="n">kill</span>
</pre></div>
</div>
</section>
<section id="additional-api">
<h2>Additional API<a class="headerlink" href="#additional-api" title="Link to this heading"></a></h2>
<p>API that are implemented, but not yet included in the guide:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">/api/re/runs</span></code> - access to <code class="docutils literal notranslate"><span class="pre">re_runs</span></code>, combines <code class="docutils literal notranslate"><span class="pre">/api/re/runs/active</span></code>, <code class="docutils literal notranslate"><span class="pre">/api/re/runs/open</span></code>, <code class="docutils literal notranslate"><span class="pre">/api/re/runs/closed</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/plans/existing</span></code> - access to <code class="docutils literal notranslate"><span class="pre">plans_existing</span></code> API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/devices/existing</span></code> - access to <code class="docutils literal notranslate"><span class="pre">devices_existing</span></code> API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/permissions/get</span></code> - access to <code class="docutils literal notranslate"><span class="pre">permissions_get</span></code> API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/permissions/set</span></code> - access to <code class="docutils literal notranslate"><span class="pre">permissions_set</span></code> API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/script/upload</span></code> - access to <code class="docutils literal notranslate"><span class="pre">script_upload</span></code> API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/function/execute</span></code> - access to <code class="docutils literal notranslate"><span class="pre">function_execute</span></code> API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/task/status</span></code> - access to <code class="docutils literal notranslate"><span class="pre">task_status</span></code> API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/task/result</span></code> - access to <code class="docutils literal notranslate"><span class="pre">task_result</span></code> API</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/lock</span></code> - lock RE Manager</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/lock/info</span></code> - load RE Manager lock status, optionally verify a lock key</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/api/unlock</span></code> - unlock RE Manager</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">/test/server/sleep</span></code> - causes server to reply after the specified delay.</p></li>
</ul>
</section>
<section id="streaming-console-output-of-re-manager">
<h2>Streaming Console Output of RE Manager<a class="headerlink" href="#streaming-console-output-of-re-manager" title="Link to this heading"></a></h2>
<p>HTTP server provides streaming API <code class="docutils literal notranslate"><span class="pre">stream_console_output</span></code> that allows web applications to receive,
process and display captured console output of RE manager. To test operation of the streaming API,
enable publishing of console output by RE Manager:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">start</span><span class="o">-</span><span class="n">re</span><span class="o">-</span><span class="n">manager</span> <span class="o">--</span><span class="n">zmq</span><span class="o">-</span><span class="n">publish</span><span class="o">-</span><span class="n">console</span> <span class="n">ON</span>
</pre></div>
</div>
<p>start HTTP Server, start Web Browser and type the following address:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">stream_console_output</span>
</pre></div>
</div>
<p>Then open a separate terminal and send a few requests to RE Manager, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">environment</span><span class="o">/</span><span class="nb">open</span>
<span class="n">http</span> <span class="n">POST</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">environment</span><span class="o">/</span><span class="n">close</span>
</pre></div>
</div>
<p>JSON representation of console output message (timestamp and text message) will be displayed
in the browser, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="mf">1629816304.5475085</span><span class="p">,</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="s2">&quot;INFO:bluesky_queueserver.manager.manager:Opening the new RE environment ...</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">}</span>
</pre></div>
</div>
<p>Client application is responsible for processing JSON messages and displaying formatted output to users.</p>
<p>HTTP Server is not performing caching of the console output, so streamed data contain only messages
received after the web client connects to the server.</p>
<p>If RE Manager is configured to publish console address to 0MQ socket with port number different from
default or HTTP server is running on a separate workstation/server, the address of 0MQ socket
can be specified by setting the environment variable <code class="docutils literal notranslate"><span class="pre">QSERVER_ZMQ_INFO_ADDRESS</span></code>, e.g.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">export</span> <span class="n">QSERVER_ZMQ_INFO_ADDRESS</span><span class="o">=</span><span class="s1">&#39;tcp://localhost:60625&#39;</span>
</pre></div>
</div>
</section>
<section id="console-output-of-re-manager">
<h2>Console Output of RE Manager<a class="headerlink" href="#console-output-of-re-manager" title="Link to this heading"></a></h2>
<p>In some cases, using streaming console output is inconvenient or difficult. The server
provides endpoint <code class="docutils literal notranslate"><span class="pre">/console_output</span></code> returns the last <code class="docutils literal notranslate"><span class="pre">nlines</span></code> of the console output
represented as a text string. The parameter <code class="docutils literal notranslate"><span class="pre">nlines</span></code> is optional with the default value of 200.
The maximum number of returned lines is limited (currently to 2000 lines).</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">console_output</span>
<span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">console_output</span> <span class="n">lines</span><span class="o">=</span><span class="mi">500</span>
</pre></div>
</div>
<p>Continuously reloading the text buffer from the server even if it contains no new data is
inefficient. The <code class="docutils literal notranslate"><span class="pre">/console_output/uid</span></code> API returns UID of the console output buffer.
Polling the UID and reloading the text buffer only when UID has changed improves efficiency
and reduces load on the server.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">console_output</span><span class="o">/</span><span class="n">uid</span>
</pre></div>
</div>
<p>If the client application can reconstruct the text from a stream of messages, the
<code class="docutils literal notranslate"><span class="pre">/console_output_update</span></code> API can be used to load messages accumulated after
the message with a given UID passed as a parameter. By polling the API using
UID of the last downloaded message, the application can load the new messages
and generate the text output locally without repeatedly reloading the text
buffer with each buffer update as in the case of <code class="docutils literal notranslate"><span class="pre">/console_output</span></code> API.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">http</span> <span class="n">GET</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">60610</span><span class="o">/</span><span class="n">api</span><span class="o">/</span><span class="n">console_output_update</span> <span class="n">last_msg_uid</span><span class="o">=&lt;</span><span class="n">last</span><span class="o">-</span><span class="n">message</span><span class="o">-</span><span class="n">uid</span><span class="o">&gt;</span>
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="usage.html" class="btn btn-neutral float-left" title="Starting and Using the Server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="configuration.html" class="btn btn-neutral float-right" title="Server Configuration" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>