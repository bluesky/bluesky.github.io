<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Features and Configuration &mdash; bluesky-queueserver 0.0.19 documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/sphinx_highlight.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Organizing Bluesky Startup Code" href="startup_code.html" />
    <link rel="prev" title="Using the Queue Server" href="using_queue_server.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="index.html" class="icon icon-home">
            bluesky-queueserver
          </a>
              <div class="version">
                0.0.19
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bluesky/bluesky-queueserver">Source Code on GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User's Guide</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="introduction_for_users.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="using_queue_server.html">Using the Queue Server</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Features and Configuration</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#managing-user-group-permissions">Managing User Group Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#configuring-user-group-permissions">Configuring User Group Permissions</a></li>
<li class="toctree-l2"><a class="reference internal" href="#remote-monitoring-of-console-output">Remote Monitoring of Console Output</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="startup_code.html">Organizing Bluesky Startup Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="ipython.html">Using IPython Startup Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="item_validation.html">Validation of Queue Items</a></li>
<li class="toctree-l1"><a class="reference internal" href="plan_annotation.html">Annotating Bluesky Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="cli_tools.html">Command-Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="manager_config.html">RE Manager Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="qserver_quick_ref.html"><em>qserver</em> : Quick Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application Developer's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="interacting_with_qs.html">Interacting with Queue Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="re_manager_api.html">Run Engine Manager API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Related Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-queueserver-api">Bluesky Queue Server API</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-httpserver">Bluesky HTTP Server</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-widgets">Bluesky Widgets</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky">Bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/ophyd">Ophyd</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/databroker">Data Broker</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">bluesky-queueserver</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Features and Configuration</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/features_and_config.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="features-and-configuration">
<h1>Features and Configuration<a class="headerlink" href="#features-and-configuration" title="Permalink to this heading">¶</a></h1>
<section id="managing-user-group-permissions">
<span id="id1"></span><h2>Managing User Group Permissions<a class="headerlink" href="#managing-user-group-permissions" title="Permalink to this heading">¶</a></h2>
<p>Direct access via API calls to plans, devices and functions can be restricted by defining permissions
for different groups of users. The permissions are represented in the form of dictionary and saved in
a YAML file (default file name is <code class="docutils literal notranslate"><span class="pre">user_group_permissions.yaml</span></code>) located in the same directory as
the startup code. Alternative path to the YAML file may be specified using <code class="docutils literal notranslate"><span class="pre">--user-group-permissions</span></code>
parameter of <code class="docutils literal notranslate"><span class="pre">start-re-manager</span></code>. The YAML file contains lists of conditions (based on regular expressions)
that are applied to the names of plans and devices defined in startup scripts to generate lists of
allowed plans and devices for each user group. Plans from the allowed list could be submitted to
the queue using API calls such as <a class="reference internal" href="re_manager_api.html#method-queue-item-add"><span class="std std-ref">‘queue_item_add’</span></a> and the names of allowed devices could
be passed as plan parameters and then automatically converted to actual device objects before plans
are executed. Additional filters could be defined for each user group that allow/forbid execution of
functions (see <a class="reference internal" href="re_manager_api.html#method-function-execute"><span class="std std-ref">‘function_execute’</span></a>). The basic principles of configuring user group
permissions are outlined in the section <a class="reference internal" href="#configuring-user-group-permissions"><span class="std std-ref">Configuring User Group Permissions</span></a>.</p>
<p>Simple workflows could be implemented using static permissions defined in a YAML file and loaded
at startup of RE Manager. If the YAML file is changed while RE Manager is running, the permissions
may be reloaded by stopping and restarting RE Manager or sending <a class="reference internal" href="re_manager_api.html#method-permissions-reload"><span class="std std-ref">‘permissions_reload’</span></a> API
request. Note, that changes in permissions affect the plans that are already in the queue, i.e. some
plans may fail to start if the respective user permissions are removed. The dictionary with current
user group permissions can be downloaded by client applications at any time using
<a class="reference internal" href="re_manager_api.html#method-permissions-get"><span class="std std-ref">‘permissions_get’</span></a> API.</p>
<p>More complex workflows may require dynamically changing user group permissions. Dictionary with permissions
can be uploaded by client applications using <a class="reference internal" href="re_manager_api.html#method-permissions-set"><span class="std std-ref">‘permissions_set’</span></a> API. (Application developers
should be careful about exposing this API directly to facility users unless users are expected to be able
to change permissions at will. The API is primarily intended for use by a secure server that is managing
user data and permissions.) The way RE Manager is handling updated permissions is defined by
<code class="docutils literal notranslate"><span class="pre">--user-group-permissions-reload</span></code> parameter of <code class="docutils literal notranslate"><span class="pre">start-re-manager</span></code>, which may take the following values:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">ON_STARTUP</span></code> (default): RE Manager is always loading permissions from disk file at startup.
Permissions from disk can be reloaded at any time using <a class="reference internal" href="re_manager_api.html#method-permissions-reload"><span class="std std-ref">‘permissions_reload’</span></a>
API. Permissions can be uploaded by the client application using <a class="reference internal" href="re_manager_api.html#method-permissions-set"><span class="std std-ref">‘permissions_set’</span></a> API.
RE manager will use the updated permissions until the end of the session. RE Manager is using
the uploaded permissions until the end of the session (until the manager is stopped and started again).</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">ON_REQUEST</span></code>: RE Manager attempts to load internally stored (in Redis) permissions at startup.
If no permissions are found (e.g. when starting newly installed Queue Server), RE Manager loads permissions
from the disk file and saves the permissions internally so that they could be loaded at the next startup.
Permissions can be reloaded from disk at any time by <a class="reference internal" href="re_manager_api.html#method-permissions-reload"><span class="std std-ref">‘permissions_reload’</span></a> API
or uploaded using <a class="reference internal" href="re_manager_api.html#method-permissions-set"><span class="std std-ref">‘permissions_set’</span></a> API. Each time permissions are changed, they are
saved internally, so that they could be loaded on the next startup.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">NEVER</span></code>: RE manager behaves as if it was called with <code class="docutils literal notranslate"><span class="pre">ON_REQUEST</span></code> option except that
<a class="reference internal" href="re_manager_api.html#method-permissions-reload"><span class="std std-ref">‘permissions_reload’</span></a> API can not be used to reload permissions from disk (API call fails).
Permissions are still loaded from disk at startup if no internally stored permissions are found.
This option is the most appropriate for workflows, where permissions are managed externally and
uploaded to RE Manager when changed. In this case the disk file may contain some default, simple
and very restrictive set of permissions used for initialization during the first startup of RE Manager.</p></li>
</ul>
</section>
<section id="configuring-user-group-permissions">
<span id="id2"></span><h2>Configuring User Group Permissions<a class="headerlink" href="#configuring-user-group-permissions" title="Permalink to this heading">¶</a></h2>
<p>Each user group is assigned a set of permissions, which restrict the plans that users
are allowed to execute and devices users may submit to plans as parameters.
The permissions do not influence the code running in RE Worker environment, therefore
any existing plans and devices could be used from within plans. Optionally, permissions
may be configured to allow users to execute Python functions defined in RE Worker namespace
(see <a class="reference internal" href="re_manager_api.html#method-function-execute"><span class="std std-ref">‘function_execute’</span></a> API).</p>
<p>User groups names are defined in user permissions dictionary, which could be saved in
<code class="docutils literal notranslate"><span class="pre">user_group_permissions.yaml</span></code> file and loaded on startup or uploaded by the client application
(see <a class="reference internal" href="re_manager_api.html#method-permissions-set"><span class="std std-ref">‘permissions_set’</span></a> API). The dictionary must define at least one required user group
named <code class="docutils literal notranslate"><span class="pre">root</span></code>. Restrictions defined for <code class="docutils literal notranslate"><span class="pre">root</span></code> are applied to plans and devices accessible
by any other defined group (consider it as a root of the tree of permissions). Internally,
the lists of existing plans and devices are initially filtered using <code class="docutils literal notranslate"><span class="pre">root</span></code> permissions
before the permissions for the other defined groups are applied to create lists of allowed
plans and devices. Putting common restrictions in the permissions for the <code class="docutils literal notranslate"><span class="pre">root</span></code> group
may reduce time of processing permissions. It is not recommended to assign users to
the <code class="docutils literal notranslate"><span class="pre">root</span></code> group or submit plans as <code class="docutils literal notranslate"><span class="pre">root</span></code>, but currently there are no restrictions
that would prevent from doing it.</p>
<p>Permission for each group include lists of allowed and forbidden plans, devices and functions.
Each lists contains names and/or patterns for filtering names of device, plan or function
objects. In order for a device, plan or function to be accessible to users of a group,
the name of the object must match one of the names or patterns from the ‘allowed’ list and
not match any of the names or patterns from the ‘forbidden’ list. The guidelines for
composing lists of names and patterns for devices may be found in <a class="reference internal" href="plan_annotation.html#lists-of-device-names"><span class="std std-ref">Lists of Device Names</span></a>
and for plans and functions in <a class="reference internal" href="plan_annotation.html#lists-of-plan-names"><span class="std std-ref">Lists of Plan Names</span></a>.</p>
<p>All the lists are optional. If ‘allowed’ list is not defined for a given type of objects
(plans, devices or functions), then no objects of this type are allowed. The most efficient
method to allow all objects is to set the first element of the ‘allowed’ list <code class="docutils literal notranslate"><span class="pre">None</span></code>
(it could be the only element of the list, all other elements are ignored). If ‘forbidden’
list is missing or if the first element of the list is <code class="docutils literal notranslate"><span class="pre">None</span></code>, then no objects are forbidden,
i.e. all the objects matching the ‘allowed’ patterns will appear in the list of allowed objects.
Typically, permissions for a group would contain at least <code class="docutils literal notranslate"><span class="pre">allowed_plans</span></code> section to allow
users to submit some plans to the queue, but it may not be necessary in some workflows.
Missing <code class="docutils literal notranslate"><span class="pre">allowed_devices</span></code> section means that no devices could be passed to plans as parameters.</p>
<p>Following is an example of a trivial user permission dictionary (in YAML format), which
allows all plans and devices for <code class="docutils literal notranslate"><span class="pre">primary</span></code> user group (group names could be arbitrarily chosen).
Restrictions for the <code class="docutils literal notranslate"><span class="pre">root</span></code> group forbid access to all plans and devices starting with local
names (starting with ‘_’). Note, that those plans and devices can still be used in plans.
The <code class="docutils literal notranslate"><span class="pre">root</span></code> permissions are applied to all other groups, which means that no group
could be configured to access objects with local names. Additional user group <code class="docutils literal notranslate"><span class="pre">test_user</span></code>
is created with the sole purpose of demonstrating different types of name patterns.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">user_groups</span><span class="p">:</span>
  <span class="n">root</span><span class="p">:</span>  <span class="c1"># The group includes all available plan and devices</span>
    <span class="n">allowed_plans</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">null</span>  <span class="c1"># Allow all</span>
    <span class="n">forbidden_plans</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;:^_&quot;</span>  <span class="c1"># All plans with names starting with &#39;_&#39;</span>
    <span class="n">allowed_devices</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">null</span>  <span class="c1"># Allow all</span>
    <span class="n">forbidden_devices</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;:^_:?.*&quot;</span>  <span class="c1"># All devices with names starting with &#39;_&#39; and their subdevices</span>
    <span class="n">allowed_functions</span><span class="p">:</span>
      <span class="o">-</span> <span class="n">null</span>  <span class="c1"># Allow all</span>
    <span class="n">forbidden_functions</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;:^_&quot;</span>  <span class="c1"># All functions with names starting with &#39;_&#39;</span>
  <span class="n">primary</span><span class="p">:</span>  <span class="c1"># The group includes beamline staff, includes all or most of the plans and devices</span>
    <span class="n">allowed_plans</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;:.*&quot;</span>  <span class="c1"># Different way to allow all plans.</span>
    <span class="n">allowed_devices</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;:?.*:depth=5&quot;</span>  <span class="c1"># Allow all device and subdevices. Maximum deepth for subdevices is 5.</span>
    <span class="n">allowed_functions</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;function_sleep&quot;</span>  <span class="c1"># Explicitly listed name</span>
  <span class="n">test_user</span><span class="p">:</span>  <span class="c1"># Some examples of patterns that could be used in lists</span>
    <span class="n">allowed_plans</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;:^count&quot;</span>  <span class="c1"># Allow all plan names starting with &#39;count&#39;</span>
      <span class="o">-</span> <span class="s2">&quot;:scan$&quot;</span>  <span class="c1"># Allow all plan names ending with &#39;scan&#39;</span>
      <span class="o">-</span> <span class="s2">&quot;:product&quot;</span>  <span class="c1"># Allow all plans names containing the word &#39;product&#39;</span>
    <span class="n">forbidden_plans</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;adaptive_scan&quot;</span>  <span class="c1"># Do not allow the plan &#39;adaptive_scan&#39;</span>
      <span class="o">-</span> <span class="s2">&quot;:^inner_product&quot;</span>  <span class="c1"># Do not allow all plan names starting with &#39;inner_product&#39;</span>
    <span class="n">allowed_devices</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;:^det:?.*&quot;</span>  <span class="c1"># Allow all devices starting with &#39;det&#39; and their subdevices</span>
      <span class="o">-</span> <span class="s2">&quot;:^motor:?.*&quot;</span>  <span class="c1"># Allow allow all devices starting with &#39;motor&#39; and their subdevices</span>
      <span class="o">-</span> <span class="s2">&quot;:^sim_bundle_A:?.*&quot;</span>  <span class="c1"># Same for devices starting with &#39;sim_bundle_A&#39;</span>
    <span class="n">forbidden_devices</span><span class="p">:</span>
      <span class="o">-</span> <span class="s2">&quot;:^det[3-5]$:?.*&quot;</span>  <span class="c1"># Do not allow devices &#39;det3&#39;, &#39;det4&#39; and &#39;det5&#39; and all subdevices</span>
      <span class="o">-</span> <span class="s2">&quot;:^motor</span><span class="se">\\</span><span class="s2">d+$:?.*&quot;</span>  <span class="c1"># Same for all numbered motors, such as &#39;motor2&#39; or &#39;motor256&#39;</span>
</pre></div>
</div>
<p>It is recommended that new projects are started using the sample file
<a class="reference external" href="https://github.com/bluesky/bluesky-queueserver/blob/main/bluesky_queueserver/profile_collection_sim/user_group_permissions.yaml">user_group_permissions.yaml</a>,
which could be copied to the directory containing startup files and then modified according
to the project needs.</p>
</section>
<section id="remote-monitoring-of-console-output">
<span id="id3"></span><h2>Remote Monitoring of Console Output<a class="headerlink" href="#remote-monitoring-of-console-output" title="Permalink to this heading">¶</a></h2>
<p>RE Manager is capable of capturing and publishing console output to 0MQ socket.
0MQ publishing is disabled by default and must be enabled using <code class="docutils literal notranslate"><span class="pre">--zmq-publish</span></code>
parameter of <code class="docutils literal notranslate"><span class="pre">start-re-manager</span></code>. A simple monitoring application (<code class="docutils literal notranslate"><span class="pre">qserver-console-monitor</span></code>)
allows to visualize the published output. See <a class="reference internal" href="tutorials.html#tutorial-remote-monitoring"><span class="std std-ref">Remote Monitoring of RE Manager Console Output</span></a> for a brief
tutorial.</p>
<p><code class="docutils literal notranslate"><span class="pre">bluesky_queueserver</span></code> package provides <code class="docutils literal notranslate"><span class="pre">ReceiveConsoleOutput</span></code> and <code class="docutils literal notranslate"><span class="pre">ReceiveConsoleOutputAsync</span></code>
class, which can be helpful in implementing remote monitoring features in client applications. See
<a class="reference internal" href="interacting_with_qs.html#subscribing-to-console-output"><span class="std std-ref">Subscribing to Published Console Output</span></a> for more details.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="using_queue_server.html" class="btn btn-neutral float-left" title="Using the Queue Server" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="startup_code.html" class="btn btn-neutral float-right" title="Organizing Bluesky Startup Code" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>