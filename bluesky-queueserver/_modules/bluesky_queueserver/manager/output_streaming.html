<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bluesky_queueserver.manager.output_streaming &mdash; bluesky-queueserver 0.0.19.post37+gf7d489f documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            bluesky-queueserver
          </a>
              <div class="version">
                0.0.19.post37+gf7d489f
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../contributing.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bluesky/bluesky-queueserver">Source Code on GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction_for_users.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../using_queue_server.html">Using the Queue Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features_and_config.html">Features and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../startup_code.html">Organizing Bluesky Startup Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ipython.html">Using IPython Startup Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../item_validation.html">Validation of Queue Items</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plan_annotation.html">Annotating Bluesky Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli_tools.html">Command-Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../manager_config.html">RE Manager Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qserver_quick_ref.html"><em>qserver</em> : Quick Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application Developer's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../interacting_with_qs.html">Interacting with Queue Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../re_manager_api.html">Run Engine Manager API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Related Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-queueserver-api">Bluesky Queue Server API</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-httpserver">Bluesky HTTP Server</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-widgets">Bluesky Widgets</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky">Bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/ophyd">Ophyd</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/databroker">Data Broker</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">bluesky-queueserver</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">bluesky_queueserver.manager.output_streaming</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bluesky_queueserver.manager.output_streaming</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">asyncio</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">io</span>
<span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">time</span> <span class="k">as</span> <span class="nn">ttime</span>

<span class="kn">import</span> <span class="nn">zmq</span>

<span class="kn">import</span> <span class="nn">bluesky_queueserver</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">qserver_version</span> <span class="o">=</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">__version__</span>


<span class="n">default_zmq_info_address_for_server</span> <span class="o">=</span> <span class="s2">&quot;tcp://*:60625&quot;</span>
<span class="n">default_zmq_info_address</span> <span class="o">=</span> <span class="s2">&quot;tcp://localhost:60625&quot;</span>


<span class="k">class</span> <span class="nc">ConsoleOutputStream</span><span class="p">(</span><span class="n">io</span><span class="o">.</span><span class="n">TextIOBase</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class that implements writable text file object that collects printed console messages</span>
<span class="sd">    and adds timestamps to messages and adds the message to the queue. The messages are</span>
<span class="sd">    dictionaries in the form ``{&quot;time&quot;: &lt;timestamp&gt;, &quot;msg&quot;: &lt;printed text&gt;}.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msg_queue : multiprocessing.Queue</span>
<span class="sd">        Reference to the queue used for collecting messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">msg_queue</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span> <span class="o">=</span> <span class="n">msg_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_stdout</span> <span class="o">=</span> <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span>

    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">s</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Overrides the method of ``io.TextIOBase``.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">s</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>

        <span class="n">msg</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;time&quot;</span><span class="p">:</span> <span class="n">ttime</span><span class="o">.</span><span class="n">time</span><span class="p">(),</span> <span class="s2">&quot;msg&quot;</span><span class="p">:</span> <span class="n">s</span><span class="p">}</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">redirect_output_streams</span><span class="p">(</span><span class="n">file_obj</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Override the default output streams with custom file object.</span>
<span class="sd">    The object may be an instance of ``ConsoleOutputStream``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    file_obj : ConsoleOutputStream</span>
<span class="sd">        Reference for the open writable file object (text output).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span> <span class="o">=</span> <span class="n">file_obj</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span> <span class="o">=</span> <span class="n">file_obj</span>


<span class="k">def</span> <span class="nf">setup_console_output_redirection</span><span class="p">(</span><span class="n">msg_queue</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Set up redirection of console output. If ``msg_queue`` is ``None``, then do nothing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msg_queue : multiprocessing.Queue</span>
<span class="sd">        Queue that is used to collect console output messages.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">msg_queue</span><span class="p">:</span>
        <span class="n">fobj</span> <span class="o">=</span> <span class="n">ConsoleOutputStream</span><span class="p">(</span><span class="n">msg_queue</span><span class="o">=</span><span class="n">msg_queue</span><span class="p">)</span>
        <span class="n">redirect_output_streams</span><span class="p">(</span><span class="n">fobj</span><span class="p">)</span>

        <span class="c1"># Disable &#39;colorama&#39; (used by Bluesky). We don&#39;t need it in Queue Server.</span>
        <span class="c1">#   Colorama overrides &#39;sys.stdout&#39; and interferes with capturing console output.</span>
        <span class="k">def</span> <span class="nf">do_nothing</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
            <span class="o">...</span>

        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">colorama</span>

            <span class="n">colorama</span><span class="o">.</span><span class="n">init</span> <span class="o">=</span> <span class="n">do_nothing</span>
            <span class="n">colorama</span><span class="o">.</span><span class="n">reinit</span> <span class="o">=</span> <span class="n">do_nothing</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>


<span class="n">_default_zmq_console_topic</span> <span class="o">=</span> <span class="s2">&quot;QS_Console&quot;</span>


<span class="k">class</span> <span class="nc">PublishConsoleOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class that is publishing the collected console output messages to 0MQ socket.</span>
<span class="sd">    The queue is expected to be filled with messages in the format</span>
<span class="sd">    ``{&quot;time&quot;: &lt;timestamp&gt;, &quot;msg&quot;: &lt;text message&gt;}``. The object of the class</span>
<span class="sd">    receives the reference to the queue during initialization. The collected messages</span>
<span class="sd">    are published as they are added to the queue. The messages may be collected</span>
<span class="sd">    in multiple processes.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    msg_queue : multiprocessing.Queue</span>
<span class="sd">        Reference to the queue object, used for collecting of the output messages.</span>
<span class="sd">        The messages added to the queue will be automatically published to 0MQ socket.</span>
<span class="sd">    console_output_on : boolean</span>
<span class="sd">        Enable/disable printing console output to the terminal</span>
<span class="sd">    zmq_publish_on : boolean</span>
<span class="sd">        Enable/disable publishing console output to 0MQ socket</span>
<span class="sd">    zmq_publish_addr : str, None</span>
<span class="sd">        Address of 0MQ PUB socket for the publishing server. If ``None``, then</span>
<span class="sd">        the default address ``tcp://*:60625`` is used.</span>
<span class="sd">    zmq_topic : str</span>
<span class="sd">        Name of the 0MQ topic where the messages are published.</span>
<span class="sd">    name : str</span>
<span class="sd">        Name of the thread where the messages are published.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">msg_queue</span><span class="p">,</span>
        <span class="n">console_output_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">zmq_publish_on</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">zmq_publish_addr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">zmq_topic</span><span class="o">=</span><span class="n">_default_zmq_console_topic</span><span class="p">,</span>
        <span class="n">name</span><span class="o">=</span><span class="s2">&quot;RE Console Output Publisher&quot;</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_running</span> <span class="o">=</span> <span class="kc">False</span>  <span class="c1"># Set True to exit the thread</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_name</span> <span class="o">=</span> <span class="n">name</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span> <span class="o">=</span> <span class="n">msg_queue</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_polling_timeout</span> <span class="o">=</span> <span class="mf">0.1</span>  <span class="c1"># in sec.</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_console_output_on</span> <span class="o">=</span> <span class="n">console_output_on</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_publish_on</span> <span class="o">=</span> <span class="n">zmq_publish_on</span>

        <span class="n">zmq_publish_addr</span> <span class="o">=</span> <span class="n">zmq_publish_addr</span> <span class="ow">or</span> <span class="n">default_zmq_info_address_for_server</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_publish_addr</span> <span class="o">=</span> <span class="n">zmq_publish_addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_topic</span> <span class="o">=</span> <span class="n">zmq_topic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_publish_on</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">PUB</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zmq_publish_addr</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to create 0MQ socket at </span><span class="si">%s</span><span class="s2">. Console output will not be published. Exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_publish_addr</span><span class="p">,</span>
                    <span class="n">ex</span><span class="p">,</span>
                <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_publish_on</span><span class="p">:</span>
            <span class="n">logging</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Publishing console output to 0MQ socket at </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">zmq_publish_addr</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start thread polling the queue.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_start_processing_thread</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop thread that polls the queue (and exit the tread)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_thread_running</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_start_processing_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># The thread should not be started of Message Queue object does not exist</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_running</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_conn</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">Thread</span><span class="p">(</span>
                <span class="n">target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_publishing_thread</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_thread_name</span><span class="p">,</span> <span class="n">daemon</span><span class="o">=</span><span class="kc">True</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_thread_conn</span><span class="o">.</span><span class="n">start</span><span class="p">()</span>

    <span class="k">def</span> <span class="nf">_publishing_thread</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_msg_queue</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_polling_timeout</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_publish</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_thread_running</span><span class="p">:</span>  <span class="c1"># Exit thread</span>
                <span class="k">break</span>

    <span class="k">def</span> <span class="nf">_publish</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">payload</span><span class="p">):</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_console_output_on</span><span class="p">:</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">payload</span><span class="p">[</span><span class="s2">&quot;msg&quot;</span><span class="p">])</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">__stdout__</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_publish_on</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="p">:</span>
            <span class="n">topic</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_topic</span>
            <span class="n">payload_json</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">send_multipart</span><span class="p">([</span><span class="n">topic</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;ascii&quot;</span><span class="p">),</span> <span class="n">payload_json</span><span class="o">.</span><span class="n">encode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">)])</span>


<div class="viewcode-block" id="ReceiveConsoleOutput"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutput.html#bluesky_queueserver.ReceiveConsoleOutput">[docs]</a><span class="k">class</span> <span class="nc">ReceiveConsoleOutput</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The class allows to subscribe to published 0MQ messages and read the messages one by</span>
<span class="sd">    one as they arrive. Subscription is performed using the remote 0MQ address and topic.</span>

<span class="sd">    The class provides blocking (with timeout) ``recv()`` method that waits for the next</span>
<span class="sd">    published message. The following example contains the code illustrating using the class.</span>
<span class="sd">    In real-world  application the loop will be running in a separate thread and generating</span>
<span class="sd">    callbacks on each received message.</span>

<span class="sd">    The ``subscribe()`` and ``unsubscribe()`` methods allow to explicitly subscribe and</span>
<span class="sd">    unsubscribe the socket to the topic. The messages published while the socket is unsubscribed</span>
<span class="sd">    are discarded. First call to ``recv()`` method automatically subscribes the socket.</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from bluesky_queueserver import ReceiveConsoleOutput</span>

<span class="sd">        zmq_subscribe_addr = &quot;tcp://localhost:60625&quot;</span>
<span class="sd">        rco = ReceiveConsoleOutput(zmq_subscribe_addr=zmq_subscribe_addr)</span>

<span class="sd">        while True:</span>
<span class="sd">            try:</span>
<span class="sd">                payload = rco.recv()</span>
<span class="sd">                time, msg = payload.get(&quot;time&quot;, None), payload.get(&quot;msg&quot;, None)</span>
<span class="sd">                # In this example the messages are printed in the terminal.</span>
<span class="sd">                sys.stdout.write(msg)</span>
<span class="sd">                sys.stdout.flush()</span>
<span class="sd">            except TimeoutError:</span>
<span class="sd">                # Timeout does not mean communication error!!!</span>
<span class="sd">                # Insert the code that needs to be executed on timeout (if any).</span>
<span class="sd">                pass</span>
<span class="sd">            # Place for the code that should be executed after receiving each</span>
<span class="sd">            #   message or after timeout (e.g. check a condition and exit</span>
<span class="sd">            #   the loop once the condition is satisfied).</span>


<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    zmq_subscribe_addr : str or None</span>
<span class="sd">        Address of ZMQ server (PUB socket). If None, then the default address is</span>
<span class="sd">        ``tcp://localhost:60625`` is used.</span>
<span class="sd">    zmq_topic : str</span>
<span class="sd">        0MQ topic for console output. Only messages from this topic are going to be received.</span>
<span class="sd">    timeout : int, float or None</span>
<span class="sd">        Timeout for the receive operation in milliseconds. If `None`, then wait</span>
<span class="sd">        for the message indefinitely.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReceiveConsoleOutput.__init__"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutput.html#bluesky_queueserver.ReceiveConsoleOutput.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">zmq_subscribe_addr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zmq_topic</span><span class="o">=</span><span class="n">_default_zmq_console_topic</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>  <span class="c1"># Timeout for &#39;recv&#39; operation (ms)</span>

        <span class="n">zmq_subscribe_addr</span> <span class="o">=</span> <span class="n">zmq_subscribe_addr</span> <span class="ow">or</span> <span class="n">default_zmq_info_address</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subscribing to console output stream from 0MQ address: </span><span class="si">%s</span><span class="s2"> ...&quot;</span><span class="p">,</span> <span class="n">zmq_subscribe_addr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subscribing to 0MQ topic: &#39;</span><span class="si">%s</span><span class="s2">&#39; ...&quot;</span><span class="p">,</span> <span class="n">zmq_topic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_subscribe_addr</span> <span class="o">=</span> <span class="n">zmq_subscribe_addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_topic</span> <span class="o">=</span> <span class="n">zmq_topic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_subscribe_addr</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zmq_subscribe_addr</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReceiveConsoleOutput.subscribe"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutput.subscribe.html#bluesky_queueserver.ReceiveConsoleOutput.subscribe">[docs]</a>    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subscribe 0MQ socket to the console output topic. Once the socket is subscribed,</span>
<span class="sd">        the published messages are cached by 0MQ and could be loaded with ``recv()`` method.</span>
<span class="sd">        The function does nothing if the socket is already subscribed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zmq_topic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ReceiveConsoleOutput.unsubscribe"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutput.unsubscribe.html#bluesky_queueserver.ReceiveConsoleOutput.unsubscribe">[docs]</a>    <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unsubscribe 0MQ socket from the console output topic. Once the socket is unsubscribed,</span>
<span class="sd">        all published messages are discarded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zmq_topic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ReceiveConsoleOutput.recv"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutput.recv.html#bluesky_queueserver.ReceiveConsoleOutput.recv">[docs]</a>    <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the next published message. The function subscribes the socket to 0MQ topic</span>
<span class="sd">        if the socket is not already subscribed. If timeout expires then ``TimeoutError``</span>
<span class="sd">        is raised.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timeout : int, float or None</span>
<span class="sd">            Timeout for the receive operation in milliseconds. If timeout is</span>
<span class="sd">            a negative number (default), the timeout value passed to the class</span>
<span class="sd">            constructor is used. If `None`, then wait indefinitely.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Received message. The dictionary contains timestamp (``time`` key)</span>
<span class="sd">            and text message (``msg`` key).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Timeout occurred. Timeout does not indicate communication error.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>

        <span class="c1"># Subscribe the socket to the topic if it is not already subscribed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;No message received during timeout period </span><span class="si">{timeout}</span><span class="s2"> ms&quot;</span><span class="p">)</span>

        <span class="n">topic</span><span class="p">,</span> <span class="n">payload_json</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>
        <span class="n">payload_json</span> <span class="o">=</span> <span class="n">payload_json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload_json</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">payload</span></div>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<div class="viewcode-block" id="ReceiveConsoleOutputAsync"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutputAsync.html#bluesky_queueserver.ReceiveConsoleOutputAsync">[docs]</a><span class="k">class</span> <span class="nc">ReceiveConsoleOutputAsync</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Async version of ``ReceiveConsoleOutput`` class. There are two ways to use the class:</span>
<span class="sd">    explicitly awaiting for the ``recv`` function (same as in ``ReceiveConsoleOutput``)</span>
<span class="sd">    or setting up a callback function (plain function or coroutine).</span>

<span class="sd">    The ``subscribe()`` and ``unsubscribe()`` methods allow to explicitly subscribe and</span>
<span class="sd">    unsubscribe the socket to the topic. The messages published while the socket is unsubscribed</span>
<span class="sd">    are discarded. Calls to ``recv()`` and ``start()`` methods always subscribe the socket,</span>
<span class="sd">    ``stop()`` method unsubscribes the socket unless called with ``unsubscribe=False``.</span>

<span class="sd">    Explicitly awaiting ``recv`` function:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from bluesky_queueserver import ReceiveConsoleOutputAsync</span>

<span class="sd">        zmq_subscribe_addr = &quot;tcp://localhost:60625&quot;</span>
<span class="sd">        rco = ReceiveConsoleOutputAsync(zmq_subscribe_addr=zmq_subscribe_addr)</span>

<span class="sd">        async def run_acquisition():</span>
<span class="sd">            while True:</span>
<span class="sd">                try:</span>
<span class="sd">                    payload = await rco.recv()</span>
<span class="sd">                    time, msg = payload.get(&quot;time&quot;, None), payload.get(&quot;msg&quot;, None)</span>
<span class="sd">                    # In this example the messages are printed in the terminal.</span>
<span class="sd">                    sys.stdout.write(msg)</span>
<span class="sd">                    sys.stdout.flush()</span>
<span class="sd">                except TimeoutError:</span>
<span class="sd">                    # Timeout does not mean communication error!!!</span>
<span class="sd">                    # Insert the code that needs to be executed on timeout (if any).</span>
<span class="sd">                    pass</span>
<span class="sd">                # Place for the code that should be executed after receiving each</span>
<span class="sd">                #   message or after timeout (e.g. check a condition and exit</span>
<span class="sd">                #   the loop once the condition is satisfied).</span>

<span class="sd">        # Subscribe to start caching messages. Calling &#39;recv()&#39; also subscribes the socket.</span>
<span class="sd">        rco.subscribe()</span>

<span class="sd">        asyncio.run(run_acquisition())</span>

<span class="sd">        # Unsubscribe to discard all new messages</span>
<span class="sd">        rco.unsubscribe()</span>


<span class="sd">    Setting up callback function or coroutine (awaitable function):</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from bluesky_queueserver import ReceiveConsoleOutputAsync</span>

<span class="sd">        zmq_subscribe_addr = &quot;tcp://localhost:60625&quot;</span>
<span class="sd">        rco = ReceiveConsoleOutputAsync(zmq_subscribe_addr=zmq_subscribe_addr)</span>

<span class="sd">        async def cb_coro(payload):</span>
<span class="sd">            time, msg = payload.get(&quot;time&quot;, None), payload.get(&quot;msg&quot;, None)</span>
<span class="sd">            # In this example the messages are printed in the terminal.</span>
<span class="sd">            sys.stdout.write(msg)</span>
<span class="sd">            sys.stdout.flush()</span>

<span class="sd">        rco.set_callback(cb_coro)</span>

<span class="sd">        async def run_acquisition():</span>
<span class="sd">            rco.start()</span>
<span class="sd">            # Do something useful here, e.g. sleep</span>
<span class="sd">            asyncio.sleep(60)</span>
<span class="sd">            rco.stop()</span>

<span class="sd">            # Acquisition can be started and stopped multiple time if necessary</span>
<span class="sd">            rco.start()</span>
<span class="sd">            asyncio.sleep(60)</span>
<span class="sd">            rco.stop()</span>

<span class="sd">        asyncio.run(run_acquisition())</span>

<span class="sd">    .. note::</span>
<span class="sd">        If callback is a plain function, it is executed immediately after the message is received</span>
<span class="sd">        and may potentially block the loop if it takes too long to complete (even occasionally).</span>
<span class="sd">        If the callback is a coroutine, it is not awaited, but instead placed in the loop</span>
<span class="sd">        (with ``ensure_future``), so acquisition of messages will continue. Typically the callback</span>
<span class="sd">        will do a simple operation such as adding the received message to the queue.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    zmq_subscribe_addr : str or None</span>
<span class="sd">        Address of ZMQ server (PUB socket). If None, then the default address is</span>
<span class="sd">        ``tcp://localhost:60625`` is used.</span>
<span class="sd">    zmq_topic : str</span>
<span class="sd">        0MQ topic for console output. Only messages from this topic are going to be received.</span>
<span class="sd">    timeout : int, float or None</span>
<span class="sd">        Timeout for the receive operation in milliseconds. If `None`, then wait</span>
<span class="sd">        for the message indefinitely.</span>
<span class="sd">    &quot;&quot;&quot;</span>

<div class="viewcode-block" id="ReceiveConsoleOutputAsync.__init__"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutputAsync.html#bluesky_queueserver.ReceiveConsoleOutputAsync.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">zmq_subscribe_addr</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">zmq_topic</span><span class="o">=</span><span class="n">_default_zmq_console_topic</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">1000</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span> <span class="o">=</span> <span class="n">timeout</span>  <span class="c1"># Timeout for &#39;recv&#39; operation (ms)</span>

        <span class="n">zmq_subscribe_addr</span> <span class="o">=</span> <span class="n">zmq_subscribe_addr</span> <span class="ow">or</span> <span class="s2">&quot;tcp://localhost:60625&quot;</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># Function that is awaited once a message is received from RE Manager</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subscribing to console output stream from 0MQ address: </span><span class="si">%s</span><span class="s2"> ...&quot;</span><span class="p">,</span> <span class="n">zmq_subscribe_addr</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Subscribing to 0MQ topic: &#39;</span><span class="si">%s</span><span class="s2">&#39; ...&quot;</span><span class="p">,</span> <span class="n">zmq_topic</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_subscribe_addr</span> <span class="o">=</span> <span class="n">zmq_subscribe_addr</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_topic</span> <span class="o">=</span> <span class="n">zmq_topic</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribe_when_stopping</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_zmq_subscribe_addr</span><span class="p">:</span>
            <span class="n">context</span> <span class="o">=</span> <span class="n">zmq</span><span class="o">.</span><span class="n">asyncio</span><span class="o">.</span><span class="n">Context</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="o">=</span> <span class="n">context</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">zmq</span><span class="o">.</span><span class="n">SUB</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zmq_subscribe_addr</span><span class="p">)</span></div>

<div class="viewcode-block" id="ReceiveConsoleOutputAsync.subscribe"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutputAsync.subscribe.html#bluesky_queueserver.ReceiveConsoleOutputAsync.subscribe">[docs]</a>    <span class="k">def</span> <span class="nf">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Subscribe 0MQ socket to the console output topic. Once the socket is subscribed,</span>
<span class="sd">        the published messages are cached by 0MQ and could be loaded with ``recv()`` method.</span>
<span class="sd">        The function does nothing if the socket is already subscribed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="ow">and</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zmq_topic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span> <span class="o">=</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="ReceiveConsoleOutputAsync.unsubscribe"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutputAsync.unsubscribe.html#bluesky_queueserver.ReceiveConsoleOutputAsync.unsubscribe">[docs]</a>    <span class="k">def</span> <span class="nf">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Unsubscribe 0MQ socket from the console output topic. Once the socket is unsubscribed,</span>
<span class="sd">        all published messages are discarded.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_zmq_topic</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket_subscribed</span> <span class="o">=</span> <span class="kc">False</span></div>

<div class="viewcode-block" id="ReceiveConsoleOutputAsync.set_callback"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutputAsync.set_callback.html#bluesky_queueserver.ReceiveConsoleOutputAsync.set_callback">[docs]</a>    <span class="k">def</span> <span class="nf">set_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">cb</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Set callback function, which is called once for each received message. If ``cb`` is</span>
<span class="sd">        a function, it is called immediately and execution of the loop is blocked until the</span>
<span class="sd">        execution of the function is complete. If ``cb`` is coroutine, it is not awaited, but</span>
<span class="sd">        instead placed in the loop using ``asyncio.ensure_future``. Only one callback function</span>
<span class="sd">        can be set.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        cb : callable, coroutine or None</span>
<span class="sd">            Reference to a callback function or coroutine. The function signature is expected</span>
<span class="sd">            to receive a message as a parameter (message is a dictionary with keys ``time`` and ``msg``)</span>
<span class="sd">            and return ``None``. The function is expected to handle exceptions that are raised</span>
<span class="sd">            internally. Pass ``None`` to clear callback (messages will be received and discarded).</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span> <span class="o">=</span> <span class="n">cb</span></div>

<div class="viewcode-block" id="ReceiveConsoleOutputAsync.recv"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutputAsync.recv.html#bluesky_queueserver.ReceiveConsoleOutputAsync.recv">[docs]</a>    <span class="k">async</span> <span class="k">def</span> <span class="nf">recv</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=-</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Get the next published message. If timeout expires then ``TimeoutError`` is raised.</span>
<span class="sd">        If the socket is not subscribed to to topic, then subscribes the socket.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        timeout : int, float or None</span>
<span class="sd">            Timeout for the receive operation in milliseconds. If timeout is</span>
<span class="sd">            a negative number (default), the timeout value passed to the class</span>
<span class="sd">            constructor is used. If `None`, then wait indefinitely.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        dict</span>
<span class="sd">            Received message. The dictionary contains timestamp (``time`` key)</span>
<span class="sd">            and text message (``msg`` key).</span>

<span class="sd">        Raises</span>
<span class="sd">        ------</span>
<span class="sd">        TimeoutError</span>
<span class="sd">            Timeout occurred. Timeout does not indicate communication error.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">timeout</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">timeout</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
            <span class="n">timeout</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_timeout</span>

        <span class="c1"># Subscribe the socket to the topic if it is not already subscribed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">poll</span><span class="p">(</span><span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TimeoutError</span><span class="p">(</span><span class="s2">&quot;No message received during timeout period </span><span class="si">{timeout}</span><span class="s2"> ms&quot;</span><span class="p">)</span>

        <span class="n">topic</span><span class="p">,</span> <span class="n">payload_json</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">recv_multipart</span><span class="p">()</span>

        <span class="n">payload_json</span> <span class="o">=</span> <span class="n">payload_json</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf8&quot;</span><span class="p">,</span> <span class="s2">&quot;strict&quot;</span><span class="p">)</span>
        <span class="n">payload</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">payload_json</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">payload</span></div>

    <span class="k">async</span> <span class="k">def</span> <span class="nf">_recv_next_message</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">payload</span> <span class="o">=</span> <span class="k">await</span> <span class="bp">self</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">iscoroutinefunction</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">):</span>
                    <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">(</span><span class="n">payload</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span>
                <span class="s2">&quot;Exception occurred while while waiting for RE Manager console output message: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">ex</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exit</span><span class="p">:</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recv_next_message</span><span class="p">())</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribe_when_stopping</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">unsubscribe</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">False</span>

<div class="viewcode-block" id="ReceiveConsoleOutputAsync.start"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutputAsync.start.html#bluesky_queueserver.ReceiveConsoleOutputAsync.start">[docs]</a>    <span class="k">def</span> <span class="nf">start</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Start collection of messages published by RE Manager. Collection may be started and stopped</span>
<span class="sd">        multiple times during a session. Repeated calls to the ``start`` method are ignored.</span>
<span class="sd">        The function MUST be called from the event loop. The method always subscribes the socket.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_is_running</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>
            <span class="n">asyncio</span><span class="o">.</span><span class="n">ensure_future</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_recv_next_message</span><span class="p">())</span></div>

<div class="viewcode-block" id="ReceiveConsoleOutputAsync.stop"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.ReceiveConsoleOutputAsync.stop.html#bluesky_queueserver.ReceiveConsoleOutputAsync.stop">[docs]</a>    <span class="k">def</span> <span class="nf">stop</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">unsubscribe</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Stop collection of messages published by RE Manager. Call to ``stop`` method unsubscribes</span>
<span class="sd">        the client from 0MQ topic, therefore all the messages published until collection is started</span>
<span class="sd">        are ignored. The function MUST be called from the event loop.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        unsubscribe: boolean (optional)</span>
<span class="sd">            Unsubscribe the socket if ``True`` (default), otherwise leave the socket subscribed.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_unsubscribe_when_stopping</span> <span class="o">=</span> <span class="n">unsubscribe</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_exit</span> <span class="o">=</span> <span class="kc">True</span></div>

    <span class="k">def</span> <span class="fm">__del__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">stop</span><span class="p">()</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>


<span class="k">def</span> <span class="nf">qserver_console_monitor_cli</span><span class="p">():</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    CLI tool for remote monitoring of console output from RE Manager. The function is also</span>
<span class="sd">    expected to be used as an example of using  ``ReceiveConsoleOutput`` class.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;bluesky_queueserver&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">formatter</span><span class="p">(</span><span class="n">prog</span><span class="p">):</span>
        <span class="c1"># Set maximum width such that printed help mostly fits in the RTD theme code block (documentation).</span>
        <span class="k">return</span> <span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">max_help_position</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Queue Server Console Monitor:</span><span class="se">\n</span><span class="s2">CLI tool for remote monitoring of console output &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;published by RE Manager.</span><span class="se">\n</span><span class="s2">bluesky-queueserver version </span><span class="si">{</span><span class="n">qserver_version</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">formatter</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--zmq-info-addr&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;zmq_info_addr&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The address of RE Manager socket used for publishing console output. The parameter overrides &quot;</span>
        <span class="s2">&quot;the address set using QSERVER_ZMQ_INFO_ADDRESS environment variable. The default value is used &quot;</span>
        <span class="s2">&quot;if the address is not set using the parameter or the environment variable. Address format: &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;&#39;tcp://127.0.0.1:60625&#39; (default: </span><span class="si">{</span><span class="n">default_zmq_info_address</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--zmq-subscribe-addr&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;zmq_subscribe_addr&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The parameter is deprecated and will be removed. Use --zmq-info-addr instead.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>

    <span class="n">zmq_info_addr</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">zmq_info_addr</span>
    <span class="k">if</span> <span class="n">args</span><span class="o">.</span><span class="n">zmq_subscribe_addr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;The parameter --zmq-subscribe-addr is deprecated and will be removed. Use --zmq-info-addr instead.&quot;</span>
        <span class="p">)</span>
    <span class="n">zmq_info_addr</span> <span class="o">=</span> <span class="n">zmq_info_addr</span> <span class="ow">or</span> <span class="n">args</span><span class="o">.</span><span class="n">zmq_subscribe_addr</span>
    <span class="n">zmq_info_addr</span> <span class="o">=</span> <span class="n">zmq_info_addr</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;QSERVER_ZMQ_INFO_ADDRESS&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">zmq_info_addr</span> <span class="o">=</span> <span class="n">zmq_info_addr</span> <span class="ow">or</span> <span class="n">default_zmq_info_address</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">rco</span> <span class="o">=</span> <span class="n">ReceiveConsoleOutput</span><span class="p">(</span><span class="n">zmq_subscribe_addr</span><span class="o">=</span><span class="n">zmq_info_addr</span><span class="p">)</span>
        <span class="n">rco</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>
        <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">payload</span> <span class="o">=</span> <span class="n">rco</span><span class="o">.</span><span class="n">recv</span><span class="p">()</span>
                <span class="n">time</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;time&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="n">payload</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;msg&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># noqa: F841</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">stdout</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">TimeoutError</span><span class="p">:</span>
                <span class="c1"># Timeout does not mean communication error!!!</span>
                <span class="c1"># There is no need to use or process timeouts. This code</span>
                <span class="c1">#   serves mostly as an example of how to use it.</span>
                <span class="k">pass</span>
            <span class="c1"># Place for the code that should be executed after receiving each</span>
            <span class="c1">#   message or after timeout. (E.g. the code may check some condition</span>
            <span class="c1">#   and exit the loop once the condition is fulfilled.)</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>  <span class="c1"># The code is set if the loope is exited (which does not happen here)</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Queue Server Console Monitor failed with exception: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">exit_code</span>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>