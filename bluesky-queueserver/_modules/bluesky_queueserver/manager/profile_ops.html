<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bluesky_queueserver.manager.profile_ops &mdash; bluesky-queueserver 0.0.16.post49+g9f67960 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/_sphinx_javascript_frameworks_compat.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> bluesky-queueserver
          </a>
              <div class="version">
                0.0.16.post49+g9f67960
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials.html">Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference external" href="https://github.com/bluesky/bluesky-queueserver">Source Code on GitHub</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction_for_users.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../using_queue_server.html">Using the Queue Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features_and_config.html">Features and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../startup_code.html">Organizing Bluesky Startup Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ipython.html">Using IPython Startup Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../item_validation.html">Validation of Queue Items</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plan_annotation.html">Annotating Bluesky Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli_tools.html">Command-Line Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../qserver_quick_ref.html"><em>qserver</em> : Quick Introduction</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application Developer's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../interacting_with_qs.html">Interacting with Queue Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../re_manager_api.html">Run Engine Manager API</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Related Projects</span></p>
<ul>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-queueserver-api">Bluesky Queueserver API</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-httpserver">Bluesky HTTP Server</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky-widgets">Bluesky Widgets</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/bluesky">Bluesky</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/ophyd">Ophyd</a></li>
<li class="toctree-l1"><a class="reference external" href="https://blueskyproject.io/databroker">Data Broker</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">bluesky-queueserver</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>bluesky_queueserver.manager.profile_ops</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bluesky_queueserver.manager.profile_ops</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">ast</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">from</span> <span class="nn">collections.abc</span> <span class="kn">import</span> <span class="n">Iterable</span>
<span class="kn">import</span> <span class="nn">pkg_resources</span>
<span class="kn">import</span> <span class="nn">yaml</span>
<span class="kn">import</span> <span class="nn">re</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">import</span> <span class="nn">pprint</span>
<span class="kn">import</span> <span class="nn">jsonschema</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">import</span> <span class="nn">typing</span>
<span class="kn">import</span> <span class="nn">pydantic</span>
<span class="kn">import</span> <span class="nn">enum</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">argparse</span>
<span class="kn">import</span> <span class="nn">importlib</span>
<span class="kn">import</span> <span class="nn">numbers</span>
<span class="kn">from</span> <span class="nn">numpydoc.docscrape</span> <span class="kn">import</span> <span class="n">NumpyDocString</span>
<span class="kn">import</span> <span class="nn">traceback</span>

<span class="kn">import</span> <span class="nn">logging</span>
<span class="kn">import</span> <span class="nn">bluesky_queueserver</span>

<span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">qserver_version</span> <span class="o">=</span> <span class="n">bluesky_queueserver</span><span class="o">.</span><span class="n">__version__</span>


<span class="k">class</span> <span class="nc">ScriptLoadingError</span><span class="p">(</span><span class="ne">Exception</span><span class="p">):</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_tb</span> <span class="o">=</span> <span class="n">tb</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">tb</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Returns the full traceback (string) that is passed as a second parameter.</span>
<span class="sd">        The traceback is expected to be fully prepared so that it could be saved</span>
<span class="sd">        or passed to consumer over the network. Capturing traceback in the function</span>
<span class="sd">        executing the script is reducing references to Queue Server code, which</span>
<span class="sd">        is generic and unimportant for debugging startup scripts.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_tb</span>


<span class="k">def</span> <span class="nf">get_default_startup_dir</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns the path to the default profile collection that is distributed with the package.</span>
<span class="sd">    The function does not guarantee that the directory exists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">pc_path</span> <span class="o">=</span> <span class="n">pkg_resources</span><span class="o">.</span><span class="n">resource_filename</span><span class="p">(</span><span class="s2">&quot;bluesky_queueserver&quot;</span><span class="p">,</span> <span class="s2">&quot;profile_collection_sim/&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">pc_path</span>


<span class="n">_startup_script_patch</span> <span class="o">=</span> <span class="s2">&quot;&quot;&quot;</span>
<span class="s2">import sys</span>
<span class="s2">import logging</span>
<span class="s2">from bluesky_queueserver.manager.profile_tools import global_user_namespace</span>
<span class="s2">logger_patch = logging.Logger(__name__)</span>

<span class="s2">global_user_namespace.set_user_namespace(user_ns=locals(), use_ipython=False)</span>

<span class="s2">class IPDummy:</span>
<span class="s2">    def __init__(self, user_ns):</span>
<span class="s2">        self.user_ns = user_ns</span>

<span class="s2">        # May be this should be some meaningful logger (used by &#39;configure_bluesky_logging&#39;)</span>
<span class="s2">        self.log = logging.Logger(&#39;ipython_patch&#39;)</span>

<span class="s2">def get_ipython_patch():</span>
<span class="s2">    ip_dummy = IPDummy(global_user_namespace.user_ns)</span>
<span class="s2">    return ip_dummy</span>

<span class="s2">get_ipython = get_ipython_patch</span>
<span class="s2">&quot;&quot;&quot;</span>


<span class="c1"># Discard RE and db from the profile namespace (if they exist).</span>
<span class="k">def</span> <span class="nf">_discard_re_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Discard RE and db from the profile namespace (if they exist).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">keep_re</span><span class="p">:</span>
        <span class="n">nspace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;RE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">nspace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_patch_script_code</span><span class="p">(</span><span class="n">code_str</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Patch script code represented as a single text string:</span>
<span class="sd">    detect lines that import ``get_ipython`` from ``IPython`` and</span>
<span class="sd">    set ``get_ipython=get_ipython_patch`` after each import.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">is_get_ipython_imported_in_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Check if ``get_ipython()`` is imported in the line&quot;&quot;&quot;</span>
        <span class="c1"># It is assumed that commenting is done using #</span>
        <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[^#]*IPython[^#]+get_ipython&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">))</span>

    <span class="n">s_list</span> <span class="o">=</span> <span class="n">code_str</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">s_list</span><span class="p">)):</span>
        <span class="n">line</span> <span class="o">=</span> <span class="n">s_list</span><span class="p">[</span><span class="n">n</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">is_get_ipython_imported_in_line</span><span class="p">(</span><span class="n">line</span><span class="p">):</span>
            <span class="c1"># The line may have comments. The patch should be inserted before the comment.</span>
            <span class="n">line_split</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;#&quot;</span><span class="p">,</span> <span class="n">line</span><span class="p">)</span>
            <span class="c1"># Do not patch empty lines that have only comments</span>
            <span class="k">if</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">line</span> <span class="o">=</span> <span class="n">line_split</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="s2">&quot;; get_ipython = get_ipython_patch&quot;</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">line_split</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">line</span> <span class="o">+=</span> <span class="s2">&quot;  #&quot;</span> <span class="o">+</span> <span class="s2">&quot;#&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">line_split</span><span class="p">[</span><span class="mi">1</span><span class="p">:])</span>
                <span class="n">s_list</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">=</span> <span class="n">line</span>

    <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s_list</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_profile_collection</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">patch_profiles</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load profile collection located at the specified path. The collection consists of</span>
<span class="sd">    .py files started with &#39;DD-&#39;, where D is a digit (e.g. 05-file.py). The files</span>
<span class="sd">    are alphabetically sorted before execution.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path: str</span>
<span class="sd">        path to profile collection</span>
<span class="sd">    patch_profiles: boolean</span>
<span class="sd">        enable/disable patching profiles. At this point there is no reason not to</span>
<span class="sd">        patch profiles.</span>
<span class="sd">    keep_re: boolean</span>
<span class="sd">        Indicates if ``RE`` and ``db`` defined in the module should be kept (``True``)</span>
<span class="sd">        or removed (``False``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        namespace in which the profile collection was executed</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        path does not exist or the profile collection contains no valid startup files</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Create the list of files to load</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load the profile collection. Path &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; is not a directory.&quot;</span><span class="p">)</span>

    <span class="n">file_pattern_py</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;*.py&quot;</span><span class="p">)</span>
    <span class="n">file_pattern_ipy</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;*.ipy&quot;</span><span class="p">)</span>
    <span class="n">file_list</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_pattern_py</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">file_pattern_ipy</span><span class="p">)</span>
    <span class="n">file_list</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>  <span class="c1"># Sort in alphabetical order</span>

    <span class="c1"># If the profile collection contains no startup files, it is very likely</span>
    <span class="c1">#   that the profile collection directory is specified incorrectly.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">file_list</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The directory &#39;</span><span class="si">{</span><span class="n">path</span><span class="si">}</span><span class="s2">&#39; contains no startup files (mask &#39;[0-9][0-9]*.py&#39;).&quot;</span><span class="p">)</span>

    <span class="c1"># Add original path to the profile collection to allow local imports</span>
    <span class="c1">#   from the patched temporary file.</span>
    <span class="k">if</span> <span class="n">path</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="p">:</span>
        <span class="c1"># We don&#39;t want to add/remove the path if it is already in `sys.path` for some reason.</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="n">path_is_set</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">path_is_set</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="c1"># Load the files into the namespace &#39;nspace&#39;.</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">if</span> <span class="n">patch_profiles</span><span class="p">:</span>
            <span class="n">exec</span><span class="p">(</span><span class="n">_startup_script_patch</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">file</span> <span class="ow">in</span> <span class="n">file_list</span><span class="p">:</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Loading startup file </span><span class="si">{</span><span class="n">file</span><span class="si">!r}</span><span class="s2"> ...&quot;</span><span class="p">)</span>

                <span class="c1"># Set &#39;__file__&#39; and &#39;__name__&#39; variables</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__file__ = &#39;</span><span class="si">{</span><span class="n">file</span><span class="si">}</span><span class="s2">&#39;; __name__ = &#39;startup_script&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>

                <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">file</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Startup file </span><span class="si">{</span><span class="n">file</span><span class="si">!r}</span><span class="s2"> was not found&quot;</span><span class="p">)</span>
                <span class="n">code_str</span> <span class="o">=</span> <span class="n">_patch_script_code</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">())</span>
                <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="n">code_str</span><span class="p">,</span> <span class="n">file</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">)</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="c1"># Capture traceback and send it as a message</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error while executing script </span><span class="si">{</span><span class="n">file</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">ex_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
                <span class="n">ex_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg</span>
                <span class="k">raise</span> <span class="n">ScriptLoadingError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ex_str</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>

            <span class="k">finally</span><span class="p">:</span>
                <span class="n">patch</span> <span class="o">=</span> <span class="s2">&quot;del __file__</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># Do not delete &#39;__name__&#39;</span>
                <span class="n">exec</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>

        <span class="n">_discard_re_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">path_is_set</span><span class="p">:</span>
                <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>

    <span class="k">return</span> <span class="n">nspace</span>


<span class="k">def</span> <span class="nf">load_startup_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate namespace by import a module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    module_name: str</span>
<span class="sd">        name of the module to import</span>
<span class="sd">    keep_re: boolean</span>
<span class="sd">        Indicates if ``RE`` and ``db`` defined in the module should be kept (``True``)</span>
<span class="sd">        or removed (``False``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        namespace that contains objects loaded from the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>

    <span class="k">try</span><span class="p">:</span>

        <span class="n">_module</span> <span class="o">=</span> <span class="n">importlib</span><span class="o">.</span><span class="n">import_module</span><span class="p">(</span><span class="n">module_name</span><span class="p">)</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="n">_module</span><span class="o">.</span><span class="vm">__dict__</span>

    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c1"># Capture traceback and send it as a message</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error while loading module </span><span class="si">{</span><span class="n">module_name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ex_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="n">ex_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg</span>
        <span class="k">raise</span> <span class="n">ScriptLoadingError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ex_str</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>

    <span class="n">_discard_re_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nspace</span>


<span class="k">def</span> <span class="nf">load_startup_script</span><span class="p">(</span><span class="n">script_path</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">enable_local_imports</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Populate namespace by import a module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    script_path : str</span>
<span class="sd">        full path to the startup script</span>
<span class="sd">    keep_re : boolean</span>
<span class="sd">        Indicates if ``RE`` and ``db`` defined in the module should be kept (``True``)</span>
<span class="sd">        or removed (``False``).</span>
<span class="sd">    enable_local_imports : boolean</span>
<span class="sd">        If ``False``, local imports from the script will not work. Setting to ``True``</span>
<span class="sd">        enables local imports.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        namespace that contains objects loaded from the module.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to load the script &#39;</span><span class="si">{</span><span class="n">script_path</span><span class="si">}</span><span class="s2">&#39;: script was not found&quot;</span><span class="p">)</span>

    <span class="n">nspace</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">enable_local_imports</span><span class="p">:</span>
        <span class="n">p</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">script_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>  <span class="c1"># Needed to make local imports work.</span>
        <span class="c1"># Save the list of available modules</span>
        <span class="n">sm_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">script_path</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Startup file </span><span class="si">{</span><span class="n">script_path</span><span class="si">!r}</span><span class="s2"> was not found&quot;</span><span class="p">)</span>

        <span class="c1"># Set &#39;__file__&#39; and &#39;__name__&#39; variables</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;__file__ = &#39;</span><span class="si">{</span><span class="n">script_path</span><span class="si">}</span><span class="s2">&#39;; __name__ = &#39;startup_script&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>

        <span class="n">code</span> <span class="o">=</span> <span class="nb">compile</span><span class="p">(</span><span class="nb">open</span><span class="p">(</span><span class="n">script_path</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="n">script_path</span><span class="p">,</span> <span class="s2">&quot;exec&quot;</span><span class="p">)</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">code</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c1"># Capture traceback and send it as a message</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error while executing script </span><span class="si">{</span><span class="n">script_path</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ex_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="n">ex_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg</span>
        <span class="k">raise</span> <span class="n">ScriptLoadingError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ex_str</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>

    <span class="k">finally</span><span class="p">:</span>

        <span class="n">patch</span> <span class="o">=</span> <span class="s2">&quot;del __file__</span><span class="se">\n</span><span class="s2">&quot;</span>  <span class="c1"># Do not delete &#39;__name__&#39;</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">enable_local_imports</span><span class="p">:</span>
            <span class="c1"># Delete data on all modules that were loaded by the script.</span>
            <span class="c1"># We don&#39;t need them anymore. Modules will be reloaded from disk if</span>
            <span class="c1">#   the script is executed again.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sm_keys</span><span class="p">:</span>
                    <span class="c1"># print(f&quot;Deleting the key &#39;{key}&#39;&quot;)</span>
                    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>

    <span class="n">_discard_re_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">nspace</span>


<span class="k">def</span> <span class="nf">load_worker_startup_code</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span> <span class="n">startup_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load worker startup code. Possible sources: startup directory (IPython-style profile collection),</span>
<span class="sd">    startup script or startup module.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    startup_dir : str</span>
<span class="sd">        Name of the directory that contains startup files.</span>
<span class="sd">    startup_module_name : str</span>
<span class="sd">        Name of the startup module.</span>
<span class="sd">    startup_script_path : str</span>
<span class="sd">        Path to startup script.</span>
<span class="sd">    keep_re: boolean</span>
<span class="sd">        Indicates if ``RE`` and ``db`` defined in the module should be kept (``True``)</span>
<span class="sd">        or removed (``False``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    nspace : dict</span>
<span class="sd">       Dictionary with loaded namespace data</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">[</span><span class="n">startup_dir</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="p">]])</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source of the startup code was not specified or multiple sources were specified.&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">startup_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading RE Worker startup code from directory &#39;</span><span class="si">%s</span><span class="s2">&#39; ...&quot;</span><span class="p">,</span> <span class="n">startup_dir</span><span class="p">)</span>
        <span class="n">startup_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">startup_dir</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Startup directory: &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">startup_dir</span><span class="p">)</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="n">load_profile_collection</span><span class="p">(</span><span class="n">startup_dir</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">startup_module_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading RE Worker startup code from module &#39;</span><span class="si">%s</span><span class="s2">&#39; ...&quot;</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="p">)</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="n">load_startup_module</span><span class="p">(</span><span class="n">startup_module_name</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">elif</span> <span class="n">startup_script_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Loading RE Worker startup code from script &#39;</span><span class="si">%s</span><span class="s2">&#39; ...&quot;</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="p">)</span>
        <span class="n">startup_script_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">startup_script_path</span><span class="p">))</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="n">load_startup_script</span><span class="p">(</span><span class="n">startup_script_path</span><span class="p">,</span> <span class="n">keep_re</span><span class="o">=</span><span class="n">keep_re</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
            <span class="s2">&quot;Source of startup information is not specified. RE Worker will be started with empty environment.&quot;</span>
        <span class="p">)</span>
        <span class="n">nspace</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">return</span> <span class="n">nspace</span>


<span class="k">def</span> <span class="nf">extract_script_root_path</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">startup_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The function returns path to the root directory for local imports based on the source of</span>
<span class="sd">    startup files. The function returns ``None`` if root directory does not exist (e.g. when</span>
<span class="sd">    startup scripts are imported from the module). The root directory is a parameter of</span>
<span class="sd">    ``load_script_into_existing_nspace`` function. The startup code locations are checked</span>
<span class="sd">    in the same order as in ``load_worker_startup_code`` function.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    startup_dir : str</span>
<span class="sd">        Name of the directory that contains startup files.</span>
<span class="sd">    startup_module_name : str</span>
<span class="sd">        Name of the startup module.</span>
<span class="sd">    startup_script_path : str</span>
<span class="sd">        Path to startup script.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    str or None</span>
<span class="sd">        Path to the root directory of startup files.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">startup_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">startup_dir</span>
    <span class="k">elif</span> <span class="n">startup_module_name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>
    <span class="k">elif</span> <span class="n">startup_script_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">startup_script_path</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">None</span>


<span class="k">def</span> <span class="nf">load_script_into_existing_nspace</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span> <span class="n">script</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">enable_local_imports</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">script_root_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">update_re</span><span class="o">=</span><span class="kc">False</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Execute the script into the existing namespace ``nspace``. The script is expected to be executable</span>
<span class="sd">    in the current namespace. An exception is raised if execution of the script fails. The code</span>
<span class="sd">    calling this function is responsible for capturing exceptions and displaying or storing the error</span>
<span class="sd">    messages in the convenient form.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    script: str</span>
<span class="sd">        Valid Python script, which is executable in the existing namespace.</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        The existing namespace.</span>
<span class="sd">    enable_local_imports: boolean</span>
<span class="sd">        Enable/disable local imports when loading the script (``True/False``).</span>
<span class="sd">    script_root_path: str or None</span>
<span class="sd">        Root path (hypothetic location of the script) to use for local imports. The root directory</span>
<span class="sd">        is returned by the ``extract_script_root_path`` function.</span>
<span class="sd">    update_re: boolean</span>
<span class="sd">        Update the ``RE`` and ``db`` in ``nspace`` if they are changed in the script if ``True``,</span>
<span class="sd">        discard those objects otherwise.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exceptions may be raised by the ``exec`` function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">global</span> <span class="n">_n_running_scripts</span>

    <span class="n">importlib</span><span class="o">.</span><span class="n">invalidate_caches</span><span class="p">()</span>

    <span class="n">root_path_exists</span> <span class="o">=</span> <span class="n">script_root_path</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">script_root_path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">enable_local_imports</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">root_path_exists</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;The path </span><span class="si">{</span><span class="n">script_root_path</span><span class="si">!r}</span><span class="s2"> does not exist. Local imports will not work.&quot;</span><span class="p">)</span>

    <span class="n">use_local_imports</span> <span class="o">=</span> <span class="n">enable_local_imports</span> <span class="ow">and</span> <span class="n">root_path_exists</span>

    <span class="k">if</span> <span class="n">use_local_imports</span><span class="p">:</span>
        <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">script_root_path</span><span class="p">)</span>  <span class="c1"># Needed to make local imports work.</span>
        <span class="c1"># Save the list of available modules</span>
        <span class="n">sm_keys</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

    <span class="n">object_backup</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">update_re</span><span class="p">:</span>
        <span class="c1"># Save references to RE and db in case they are changed by the script</span>
        <span class="k">if</span> <span class="s2">&quot;RE&quot;</span> <span class="ow">in</span> <span class="n">nspace</span><span class="p">:</span>
            <span class="n">object_backup</span><span class="p">[</span><span class="s2">&quot;RE&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nspace</span><span class="p">[</span><span class="s2">&quot;RE&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="s2">&quot;db&quot;</span> <span class="ow">in</span> <span class="n">nspace</span><span class="p">:</span>
            <span class="n">object_backup</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">nspace</span><span class="p">[</span><span class="s2">&quot;db&quot;</span><span class="p">]</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Set &#39;__name__&#39; variables. NOTE: &#39;__file__&#39; variable is undefined (difference!!!)</span>
        <span class="n">patch</span> <span class="o">=</span> <span class="s2">&quot;__name__ = &#39;startup_script&#39;</span><span class="se">\n</span><span class="s2">&quot;</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">patch</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>

        <span class="c1"># A script may be partially loaded into the environment in case it fails.</span>
        <span class="c1">#   This is &#39;realistic&#39; behavior, similar to what happens in IPython.</span>
        <span class="n">exec</span><span class="p">(</span><span class="n">script</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">nspace</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c1"># Capture traceback and send it as a message</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Failed to execute stript: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="n">ex_str</span> <span class="o">=</span> <span class="n">traceback</span><span class="o">.</span><span class="n">format_exception</span><span class="p">(</span><span class="o">*</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">())</span>
        <span class="n">ex_str</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">ex_str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">msg</span>
        <span class="k">raise</span> <span class="n">ScriptLoadingError</span><span class="p">(</span><span class="n">msg</span><span class="p">,</span> <span class="n">ex_str</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">update_re</span><span class="p">:</span>
            <span class="c1"># Remove references for &#39;RE&#39; and &#39;db&#39; from the namespace</span>
            <span class="n">nspace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;RE&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">nspace</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;db&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="c1"># Restore the original reference to &#39;RE&#39; and &#39;db&#39; (if they existed)</span>
            <span class="n">nspace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">object_backup</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">use_local_imports</span><span class="p">:</span>
            <span class="c1"># Delete data on all modules that were loaded by the script.</span>
            <span class="c1"># We don&#39;t need them anymore. Modules will be reloaded from disk if</span>
            <span class="c1">#   the script is executed again.</span>
            <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
                <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">sm_keys</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Deleting the key &#39;</span><span class="si">{</span><span class="n">key</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>
                    <span class="k">del</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>

            <span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">script_root_path</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">plans_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract plans from the namespace. Currently the function returns the dict of callable objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        Namespace that may contain plans.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict(str: callable)</span>
<span class="sd">        Dictionary of Bluesky plans</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plans</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">nspace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">plans</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="k">return</span> <span class="n">plans</span>


<span class="k">def</span> <span class="nf">devices_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Extract signals and devices from the namespace. Currently the function returns the dict of</span>
<span class="sd">    namespace items of types inherited from ophyd.ophydobj.OphydObject objects.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        Namespace that may contain plans and devices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict(str: callable)</span>
<span class="sd">        Dictionary that maps device names to device objects.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">protocols</span>

    <span class="n">devices</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">nspace</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">obj</span><span class="p">,</span> <span class="p">(</span><span class="n">protocols</span><span class="o">.</span><span class="n">Readable</span><span class="p">,</span> <span class="n">protocols</span><span class="o">.</span><span class="n">Flyable</span><span class="p">))</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isclass</span><span class="p">(</span><span class="n">obj</span><span class="p">):</span>
            <span class="n">devices</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="k">return</span> <span class="n">devices</span>


<span class="k">def</span> <span class="nf">_get_nspace_object</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">objects_in_nspace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for object in namespace by name (e.g. ``count`` or ``det1.val``).</span>
<span class="sd">    The function searches for subdevices by using ``component_name`` device property</span>
<span class="sd">    (plans have no ``component_name`` attribute). Returns a reference to</span>
<span class="sd">    the device object if it is found or device name (string) if the device is not found.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    object_name: str</span>
<span class="sd">        Object (device or plan) name, such as ``count``, ``det1`` or ``det1.val``.</span>
<span class="sd">    objects_in_nspace: dict</span>
<span class="sd">        Dictionary of objects (devices and/or plans) in namespace.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    device: callable, ophyd.Object or str</span>
<span class="sd">        Reference to the object or object name (str) if the object is not found.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">components</span><span class="p">,</span> <span class="n">uses_re</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_name_pattern</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">uses_re</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object (device or plan) name </span><span class="si">{</span><span class="n">object_name</span><span class="si">!r}</span><span class="s2"> can not contain regular expressions&quot;</span><span class="p">)</span>

    <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]</span>  <span class="c1"># We use only the 1st element</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">components</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Device name </span><span class="si">{</span><span class="n">object_name</span><span class="si">!r}</span><span class="s2"> contains no components&quot;</span><span class="p">)</span>

    <span class="n">object_found</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">objects_in_nspace</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">objects_in_nspace</span><span class="p">[</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">object_found</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">object_found</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="s2">&quot;component_names&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">device</span><span class="o">.</span><span class="n">component_names</span><span class="p">):</span>
                <span class="c1"># The defice MUST have the attribute &#39;c&#39;, but still process the case when</span>
                <span class="c1">#   there is a bug and the device doesn&#39;t have the attribute</span>
                <span class="n">device</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">c</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">object_found</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">object_found</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;Device &#39;</span><span class="si">%s</span><span class="s2">&#39; does not have attribute (subdevice) &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">object_name</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">))</span>
                <span class="n">object_found</span> <span class="o">=</span> <span class="n">object_found</span> <span class="k">if</span> <span class="n">device</span> <span class="k">else</span> <span class="kc">False</span>

            <span class="k">else</span><span class="p">:</span>
                <span class="n">object_found</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">object_found</span><span class="p">:</span>
                <span class="k">break</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">object_found</span><span class="p">:</span>
        <span class="n">device</span> <span class="o">=</span> <span class="n">object_name</span>

    <span class="k">return</span> <span class="n">device</span>


<span class="k">def</span> <span class="nf">prepare_plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">plans_in_nspace</span><span class="p">,</span> <span class="n">devices_in_nspace</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare the plan for execution: replace the device names (str) in the plan specification</span>
<span class="sd">    by references to ophyd objects; replace plan name by the reference to the plan.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan : dict</span>
<span class="sd">        Plan specification. Keys: `name` (str) - plan name, `args` - plan args,</span>
<span class="sd">        `kwargs` - plan kwargs. The plan parameters must contain ``user_group``.</span>
<span class="sd">    plans_in_nspace : dict(str, callable)</span>
<span class="sd">        Dictionary of existing plans from the RE workspace.</span>
<span class="sd">    devices_in_nspace : dict(str, ophyd.Device)</span>
<span class="sd">        Dictionary of existing devices from RE workspace.</span>
<span class="sd">    allowed_plans : dict(str, dict)</span>
<span class="sd">        Dictionary of allowed plans that maps group name to dictionary of plans allowed</span>
<span class="sd">        to the members of the group (group name can be found in ``plan[&quot;user_group&quot;]``.</span>
<span class="sd">    allowed_devices : dict(str, dict)</span>
<span class="sd">        Dictionary of allowed devices that maps group name to dictionary of devices allowed</span>
<span class="sd">        to the members of the group.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Parsed plan specification that contains references to plans and Ophyd devices.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        Raised in case parsing was not successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">success</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">err_msg</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">plan_name</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">plan_args</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;args&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;args&quot;</span> <span class="ow">in</span> <span class="n">plan</span> <span class="k">else</span> <span class="p">[]</span>
    <span class="n">plan_kwargs</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;kwargs&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;kwargs&quot;</span> <span class="ow">in</span> <span class="n">plan</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="n">plan_meta</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]</span> <span class="k">if</span> <span class="s2">&quot;meta&quot;</span> <span class="ow">in</span> <span class="n">plan</span> <span class="k">else</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="s2">&quot;user_group&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No user group is specified in parameters for the plan &#39;</span><span class="si">{</span><span class="n">plan_name</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">user_group</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;user_group&quot;</span><span class="p">]</span>  <span class="c1"># User group is REQUIRED parameter of the plan</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">user_group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_plans</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">user_group</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_devices</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Lists of allowed plans and devices is not defined for the user group &#39;</span><span class="si">{</span><span class="n">user_group</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="n">group_plans</span> <span class="o">=</span> <span class="n">allowed_plans</span><span class="p">[</span><span class="n">user_group</span><span class="p">]</span>
    <span class="n">group_devices</span> <span class="o">=</span> <span class="n">allowed_devices</span><span class="p">[</span><span class="n">user_group</span><span class="p">]</span>

    <span class="c1"># Run full validation of parameters (same as during plan submission)</span>
    <span class="n">success</span><span class="p">,</span> <span class="n">errmsg</span> <span class="o">=</span> <span class="n">validate_plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="o">=</span><span class="n">group_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="o">=</span><span class="n">group_devices</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Validation of plan parameters failed: </span><span class="si">{</span><span class="n">errmsg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Create the signature based on EXISTING plan from the workspace</span>
    <span class="n">signature</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">plans_in_nspace</span><span class="p">[</span><span class="n">plan_name</span><span class="p">])</span>

    <span class="c1"># Compare parameters in the signature and in the list of allowed plans. Make sure that the parameters</span>
    <span class="c1">#   in the list of allowed plans are a subset of the existing parameters (otherwise the plan can not</span>
    <span class="c1">#   be started). This not full validation.</span>
    <span class="n">existing_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">_</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">signature</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">()])</span>
    <span class="n">allowed_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">([</span><span class="n">_</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">group_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]])</span>
    <span class="n">extra_names</span> <span class="o">=</span> <span class="n">allowed_names</span> <span class="o">-</span> <span class="n">existing_names</span>
    <span class="k">if</span> <span class="n">extra_names</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Plan description in the list of allowed plans has extra parameters </span><span class="si">{</span><span class="n">extra_names</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Bind arguments of the plan</span>
    <span class="n">bound_args</span> <span class="o">=</span> <span class="n">signature</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">plan_args</span><span class="p">,</span> <span class="o">**</span><span class="n">plan_kwargs</span><span class="p">)</span>
    <span class="c1"># Separate dictionary for the default values define in the annotation decorator</span>
    <span class="n">default_params</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="c1"># Apply the default values defined in the annotation decorator. Default values defined in</span>
    <span class="c1">#   the decorator may still be converted to device references (e.g. str-&gt;ophyd.Device).</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">group_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
        <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default_defined_in_decorator&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
                <span class="n">default_value</span> <span class="o">=</span> <span class="n">_process_default_value</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">])</span>
                <span class="n">default_params</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">default_value</span><span class="p">})</span>

    <span class="k">def</span> <span class="nf">ref_from_name</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">objects_in_nspace</span><span class="p">,</span> <span class="n">sel_object_names</span><span class="p">,</span> <span class="n">selected_object_tree</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">v</span> <span class="ow">in</span> <span class="n">sel_object_names</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_is_object_name_in_list</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">allowed_objects</span><span class="o">=</span><span class="n">selected_object_tree</span><span class="p">):</span>
                <span class="n">v</span> <span class="o">=</span> <span class="n">_get_nspace_object</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">objects_in_nspace</span><span class="o">=</span><span class="n">objects_in_nspace</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">process_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">objects_in_nspace</span><span class="p">,</span> <span class="n">sel_object_names</span><span class="p">,</span> <span class="n">selected_object_tree</span><span class="p">):</span>
        <span class="c1"># Recursively process lists (iterables) and dictionaries</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">ref_from_name</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">objects_in_nspace</span><span class="p">,</span> <span class="n">sel_object_names</span><span class="p">,</span> <span class="n">selected_object_tree</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">v</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_argument</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">objects_in_nspace</span><span class="p">,</span> <span class="n">sel_object_names</span><span class="p">,</span> <span class="n">selected_object_tree</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
            <span class="n">v_original</span> <span class="o">=</span> <span class="n">v</span>
            <span class="n">v</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v_original</span><span class="p">:</span>
                <span class="n">v</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">process_argument</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">objects_in_nspace</span><span class="p">,</span> <span class="n">sel_object_names</span><span class="p">,</span> <span class="n">selected_object_tree</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">v</span>

    <span class="k">def</span> <span class="nf">process_parameter_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">objects_in_nspace</span><span class="p">,</span> <span class="n">group_plans</span><span class="p">,</span> <span class="n">group_devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Process a parameter value ``value`` based on parameter description ``pp``</span>
<span class="sd">        (``pp = allowed_plans[&lt;plan_name&gt;][&lt;param_name&gt;]``).</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Include/exclude all devices/plans if required</span>
        <span class="n">convert_all_plan_names</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;convert_plan_names&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>  <span class="c1"># None - not defined</span>
        <span class="n">convert_all_device_names</span> <span class="o">=</span> <span class="n">pp</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;convert_device_names&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># A set of the selected device names (device names are listed explicitly, not as a tree)</span>
        <span class="n">sel_object_names</span><span class="p">,</span> <span class="n">pname_list</span><span class="p">,</span> <span class="n">dname_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">(),</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="s2">&quot;annotation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">:</span>
            <span class="n">convert_all_plan_names</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">(</span><span class="n">convert_all_plan_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">convert_all_plan_names</span>
            <span class="n">convert_all_device_names</span> <span class="o">=</span> <span class="kc">True</span> <span class="k">if</span> <span class="p">(</span><span class="n">convert_all_device_names</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="k">else</span> <span class="n">convert_all_device_names</span>
        <span class="k">elif</span> <span class="p">(</span><span class="s2">&quot;plans&quot;</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">])</span> <span class="ow">or</span> <span class="p">(</span><span class="s2">&quot;devices&quot;</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]):</span>
            <span class="c1"># &#39;Custom&#39; annotation: attempt to convert strings only to the devices</span>
            <span class="c1">#    and plans that are part of the description.</span>
            <span class="n">pname_list</span><span class="p">,</span> <span class="n">dname_list</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">plist</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">plist</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">plist</span> <span class="k">if</span> <span class="n">_is_object_name_in_list</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">allowed_objects</span><span class="o">=</span><span class="n">group_plans</span><span class="p">)]</span>
                <span class="n">pname_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">plist</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">dlist</span> <span class="ow">in</span> <span class="n">pp</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
                <span class="n">dlist</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">dlist</span> <span class="k">if</span> <span class="n">_is_object_name_in_list</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">allowed_objects</span><span class="o">=</span><span class="n">group_devices</span><span class="p">)]</span>
                <span class="n">dname_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">dlist</span><span class="p">))</span>
            <span class="n">pname_list</span><span class="p">,</span> <span class="n">dname_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">pname_list</span><span class="p">),</span> <span class="nb">set</span><span class="p">(</span><span class="n">dname_list</span><span class="p">)</span>

        <span class="c1"># Create a tree of objects (dictionary of plans and devices)</span>
        <span class="n">selected_object_tree</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="n">convert_all_plan_names</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">selected_object_tree</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">group_plans</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">convert_all_plan_names</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">pname_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="k">if</span> <span class="n">convert_all_device_names</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">:</span>
            <span class="n">selected_object_tree</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">group_devices</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">convert_all_device_names</span> <span class="ow">is</span> <span class="kc">False</span><span class="p">:</span>
            <span class="n">dname_list</span> <span class="o">=</span> <span class="nb">set</span><span class="p">()</span>

        <span class="n">sel_object_names</span> <span class="o">=</span> <span class="n">pname_list</span><span class="o">.</span><span class="n">union</span><span class="p">(</span><span class="n">dname_list</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">sel_object_names</span> <span class="ow">or</span> <span class="n">selected_object_tree</span><span class="p">:</span>
            <span class="n">value</span> <span class="o">=</span> <span class="n">process_argument</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">objects_in_nspace</span><span class="p">,</span> <span class="n">sel_object_names</span><span class="p">,</span> <span class="n">selected_object_tree</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">value</span>

    <span class="c1"># Existing items include existing devices and existing plans</span>
    <span class="n">items_in_nspace</span> <span class="o">=</span> <span class="n">devices_in_nspace</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">items_in_nspace</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plans_in_nspace</span><span class="p">)</span>

    <span class="n">plan_func</span> <span class="o">=</span> <span class="n">process_argument</span><span class="p">(</span><span class="n">plan_name</span><span class="p">,</span> <span class="n">plans_in_nspace</span><span class="p">,</span> <span class="nb">set</span><span class="p">(),</span> <span class="n">group_plans</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_func</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Plan &#39;</span><span class="si">{</span><span class="n">plan_name</span><span class="si">}</span><span class="s2">&#39; is not allowed or does not exist&quot;</span>

    <span class="c1"># Map names to parameter descriptions</span>
    <span class="n">param_descriptions</span> <span class="o">=</span> <span class="p">{</span><span class="n">_</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]:</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">group_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">][</span><span class="s2">&quot;parameters&quot;</span><span class="p">]}</span>
    <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span>
        <span class="c1"># Fetch parameter description ({} if parameter is not found)</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">param_descriptions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_parameter_value</span><span class="p">(</span>
            <span class="n">value</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">group_plans</span><span class="p">,</span> <span class="n">group_devices</span>
        <span class="p">)</span>

    <span class="k">for</span> <span class="n">p_name</span> <span class="ow">in</span> <span class="n">default_params</span><span class="p">:</span>
        <span class="n">value</span> <span class="o">=</span> <span class="n">default_params</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span>
        <span class="c1"># Fetch parameter description ({} if parameter is not found)</span>
        <span class="n">pp</span> <span class="o">=</span> <span class="n">group_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">p_name</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">default_params</span><span class="p">[</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">process_parameter_value</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">pp</span><span class="p">,</span> <span class="n">items_in_nspace</span><span class="p">,</span> <span class="n">group_plans</span><span class="p">,</span> <span class="n">group_devices</span><span class="p">)</span>

    <span class="n">plan_args_parsed</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">bound_args</span><span class="o">.</span><span class="n">args</span><span class="p">)</span>
    <span class="n">plan_kwargs_parsed</span> <span class="o">=</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">kwargs</span>
    <span class="n">plan_kwargs_parsed</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">default_params</span><span class="p">)</span>

    <span class="c1"># If metadata is a list of dictionaries, then merge the dictionaries into one</span>
    <span class="c1">#   with dictionaries with lower index having higher priority.</span>
    <span class="n">success_meta</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_meta</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">p</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="n">plan_meta</span><span class="p">):</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="n">p</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">meta</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">success_meta</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">if</span> <span class="n">success_meta</span><span class="p">:</span>
            <span class="n">plan_meta</span> <span class="o">=</span> <span class="n">p</span>
    <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan_meta</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">success_meta</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">success_meta</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">err_msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Plan metadata must be a dictionary or a list of dictionaries: &#39;</span><span class="si">{</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">plan_meta</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error while parsing the plan: </span><span class="si">{</span><span class="n">err_msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">plan_prepared</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;callable&quot;</span><span class="p">:</span> <span class="n">plan_func</span><span class="p">,</span>
        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">plan_args_parsed</span><span class="p">,</span>
        <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="n">plan_kwargs_parsed</span><span class="p">,</span>
        <span class="s2">&quot;meta&quot;</span><span class="p">:</span> <span class="n">plan_meta</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">plan_prepared</span>


<span class="k">def</span> <span class="nf">prepare_function</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">func_info</span><span class="p">,</span> <span class="n">nspace</span><span class="p">,</span> <span class="n">user_group_permissions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare function for execution in the worker namespace. Returned dictionary</span>
<span class="sd">    contains reference to the callable object in the namespace, list of args and</span>
<span class="sd">    dictionary of kwargs. The function may check if the user is allowed to</span>
<span class="sd">    execute the function if ``user_group_permissions`` is provided (not ``None``).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    func_info: dict</span>
<span class="sd">        Dictionary which contains keys: ``name``, ``user_group``, ``args`` (optional)</span>
<span class="sd">        and ``kwargs`` (optional).</span>
<span class="sd">    nspace: dict</span>
<span class="sd">        Reference to the RE Worker namespace.</span>
<span class="sd">    user_group_permissions: dict or None</span>
<span class="sd">        Dictionary that contains user group permissions. User permissions are not checked</span>
<span class="sd">        if ``None``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Function data: ``callable`` is a reference to a callable object in RE Worker namespace,</span>
<span class="sd">        ``args`` is list of args and ``kwargs`` is a dictionary of kwargs.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        Error while preparing the function.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">func_info</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No function name is specified: </span><span class="si">{</span><span class="n">func_info</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;user_group&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">func_info</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No user group is specified in parameters for the function: </span><span class="si">{</span><span class="n">func_info</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">func_name</span> <span class="o">=</span> <span class="n">func_info</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
    <span class="n">user_group</span> <span class="o">=</span> <span class="n">func_info</span><span class="p">[</span><span class="s2">&quot;user_group&quot;</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">user_group_permissions</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">check_if_function_allowed</span><span class="p">(</span>
            <span class="n">func_name</span><span class="p">,</span> <span class="n">group_name</span><span class="o">=</span><span class="n">user_group</span><span class="p">,</span> <span class="n">user_group_permissions</span><span class="o">=</span><span class="n">user_group_permissions</span>
        <span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">func_name</span><span class="si">!r}</span><span class="s2"> is not allowed for users from </span><span class="si">{</span><span class="n">user_group</span><span class="si">!r}</span><span class="s2"> user group&quot;</span><span class="p">)</span>

    <span class="n">func_args</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">func_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">[]))</span>
    <span class="n">func_kwargs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="n">func_info</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{}))</span>

    <span class="k">if</span> <span class="n">func_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">nspace</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Function </span><span class="si">{</span><span class="n">func_name</span><span class="si">!r}</span><span class="s2"> is not found in the worker namespace&quot;</span><span class="p">)</span>

    <span class="n">func_callable</span> <span class="o">=</span> <span class="n">nspace</span><span class="p">[</span><span class="n">func_name</span><span class="p">]</span>

    <span class="c1"># Following are basic checks to avoid most common errors. The list of check can be expanded.</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">callable</span><span class="p">(</span><span class="n">func_callable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object </span><span class="si">{</span><span class="n">func_name</span><span class="si">!r}</span><span class="s2"> defined in worker namespace is not callable&quot;</span><span class="p">)</span>
    <span class="c1"># Generator functions defined in the worker namespace are plans, which return generators</span>
    <span class="c1">#   when called. There is no point in calling those functions directly.</span>
    <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">func_callable</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Object </span><span class="si">{</span><span class="n">func_name</span><span class="si">!r}</span><span class="s2"> defined in worker namespace is a generator function&quot;</span><span class="p">)</span>

    <span class="n">func_prepared</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;callable&quot;</span><span class="p">:</span> <span class="n">func_callable</span><span class="p">,</span>
        <span class="s2">&quot;args&quot;</span><span class="p">:</span> <span class="n">func_args</span><span class="p">,</span>
        <span class="s2">&quot;kwargs&quot;</span><span class="p">:</span> <span class="n">func_kwargs</span><span class="p">,</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">func_prepared</span>


<span class="c1"># ===============================================================================</span>
<span class="c1">#   Processing of plan annotations and plan descriptions</span>

<span class="n">_supported_device_types</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="s2">&quot;__READABLE__&quot;</span><span class="p">,</span> <span class="s2">&quot;__FLYABLE__&quot;</span><span class="p">,</span> <span class="s2">&quot;__DETECTOR__&quot;</span><span class="p">,</span> <span class="s2">&quot;__MOTOR__&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_split_name_pattern</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Split name pattern into components. The pattern may represent names of devices</span>
<span class="sd">    plans or functions. The patterns for device names may consist of multiple components,</span>
<span class="sd">    while the patterns from plan and function name always have one component.</span>
<span class="sd">    For devices, the list element may contain device or subdevice name (e.g. ``det1``,</span>
<span class="sd">    ``det1.val``, ``sim_stage.det.val``) or specify regular expressions used to find</span>
<span class="sd">    elements in the list of existing elements (e.g. ``:^det:^val$``, ``:-^det:^val$``,</span>
<span class="sd">    ``__DETECTORS__:-^sim_stage$:.+:^val$``). The ``-`` character immediately following</span>
<span class="sd">    ``:`` (``:-``) is not part of the regular expression. It indicates that all subdevices</span>
<span class="sd">    with matching regular expressions in this and previous pattern components are</span>
<span class="sd">    not included in the list but search continues to its subdevices. Optionally ``:``</span>
<span class="sd">    may be followed by ``+`` character, which indicates that the device must be included</span>
<span class="sd">    in the search result (this is the default behavior). The ``__DETECTORS__`` keyword</span>
<span class="sd">    indicates that only detectors that satisfy the conditions are included in the list.</span>
<span class="sd">    The following keywords are currently supported: ``__READABLE__``, ``__FLYABLE__``,</span>
<span class="sd">    ``__DETECTOR__`` and ``__MOTOR__``. The definition may also contain &#39;full name&#39;</span>
<span class="sd">    patterns that are applyed to the remaining part of the subdevice name. The</span>
<span class="sd">    &#39;full name&#39; pattern is defined by putting &#39;?&#39; after &#39;:&#39;, e.g. the pattern</span>
<span class="sd">    ``:?^det.*val$`` selects  all device and subdevice names that starts with ``det``</span>
<span class="sd">    and ends with ``val``, such as ``detector_val``, ``det.val``, ``det.somesubdevice.val``</span>
<span class="sd">    etc. The search depth may be limited by specifying ``depth`` parameter after</span>
<span class="sd">    the full name pattern, e.g. ``:?det.*val$:depth=5`` limits depth search to 5.</span>
<span class="sd">    Depth values starts with 1, e.g. in the example above, ``:?det.*val$:depth=1``</span>
<span class="sd">    will find only ``detector_val``. If &#39;full name&#39; pattern is preceded with a number</span>
<span class="sd">    of subdevice name patterns, then &#39;full_name&#39; pattern is applied to the remainder of</span>
<span class="sd">    the name, e.g. ``:^sim_stage$:?^det.*val$:depth=3`` would select ``sim_stage``</span>
<span class="sd">    and all its subdevices such as ``sim_stage.det5.val`` searching to the total depth</span>
<span class="sd">    of 4 (``sim_stage`` name is at level 1 and full name search is performed at levels</span>
<span class="sd">    2, 3 and 4).</span>

<span class="sd">    Note, that the last pattern component can not be deselected. For example ``:^det:-val$``</span>
<span class="sd">    is identical to ``:^det:val$``.</span>

<span class="sd">    The function may be applied to list elements describing plans, since they consist of</span>
<span class="sd">    the same set of components. The element may be a name, such as ``count`` or</span>
<span class="sd">    regular expression used to pick plans from the list of existing names, such as ``:^count``.</span>
<span class="sd">    Since plan names and patterns are much simpler, additional validation of the split</span>
<span class="sd">    results should be performed. The separators ``:+``, ``:-`` and ``:?`` can still be used</span>
<span class="sd">    with plan or function names, but they have no meaning and are ignored during processing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    name_pattern: str</span>
<span class="sd">        Name pattern of a device, plan or function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    components: list(tuple)</span>
<span class="sd">        List of tuples, each tuple contains the following items: regular expression or device/subdevice name,</span>
<span class="sd">        boolean flag that indicates if the matching is found at the current depth level should be included</span>
<span class="sd">        in the list (for regular expressions), boolean flag that indicates if regular expression should</span>
<span class="sd">        be applied to the full remaining part of the subdevice name (the full tree or subtree is going to</span>
<span class="sd">        be searched), depth (int, 1-based or ``None`` if not set) that limites depth of the tree searched</span>
<span class="sd">        for the name matching full name regular expressions.</span>
<span class="sd">    uses_re: boolean</span>
<span class="sd">        Boolean value that indicates if the components are regular expressions.</span>
<span class="sd">    device_type: str</span>
<span class="sd">        Contains the keyword that specifies device type (for regular expressions). Empty string if</span>
<span class="sd">        the device type is not specified or if the components are device/subdevice names.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        The element definition is not a string.</span>
<span class="sd">    ValueError</span>
<span class="sd">        The element definition is incorrectly formatted and can not be processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Name pattern </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2"> has incorrect type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">)</span><span class="si">!r}</span><span class="s2">. Expected type: &#39;str&#39;&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Remove spaces</span>
    <span class="n">name_pattern</span> <span class="o">=</span> <span class="n">name_pattern</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot; &quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">len</span><span class="p">(</span><span class="n">name_pattern</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name pattern </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2"> is an empty string&quot;</span><span class="p">)</span>

    <span class="c1"># Check if the element is defined using regular expressions</span>
    <span class="n">uses_re</span> <span class="o">=</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">name_pattern</span>
    <span class="n">device_type</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="k">if</span> <span class="n">uses_re</span><span class="p">:</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">name_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
        <span class="n">device_type</span> <span class="o">=</span> <span class="n">components</span><span class="p">[:</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># The first element is a string (may be empty string)</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>

        <span class="c1"># Find the components starting with &#39;?&#39;</span>
        <span class="n">n_full_re</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">components</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">c</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">):</span>
                <span class="n">n_full_re</span> <span class="o">=</span> <span class="n">n</span>
                <span class="k">break</span>

        <span class="n">depth</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">n_full_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># &#39;Full name&#39; RE can be the last or next to last component.</span>
            <span class="k">if</span> <span class="n">n_full_re</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Full name regular expression </span><span class="si">{</span><span class="n">components</span><span class="p">[</span><span class="n">n_full_re</span><span class="p">]</span><span class="si">!r}</span><span class="s2"> must be the last: </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
                <span class="p">)</span>
            <span class="k">elif</span> <span class="n">n_full_re</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">-</span> <span class="mi">2</span><span class="p">:</span>
                <span class="c1"># If &#39;full name&#39; RE is next to last, it can be followed only by &#39;depth&#39; specification</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">components</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;depth=&quot;</span><span class="p">):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Full name regular expression </span><span class="si">{</span><span class="n">components</span><span class="p">[</span><span class="n">n_full_re</span><span class="p">]</span><span class="si">!r}</span><span class="s2"> can be only followed by &quot;</span>
                        <span class="sa">f</span><span class="s2">&quot;the depth specification: </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">elif</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;^depth=[0-9]+$&quot;</span><span class="p">,</span> <span class="n">components</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]):</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Depth specification </span><span class="si">{</span><span class="n">components</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="si">!r}</span><span class="s2"> has incorrect format: </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">_</span><span class="p">,</span> <span class="n">depth</span> <span class="o">=</span> <span class="n">components</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;=&quot;</span><span class="p">)</span>  <span class="c1"># Remove depth specification</span>
                    <span class="n">depth</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">depth</span><span class="p">)</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Depth (</span><span class="si">{</span><span class="n">depth</span><span class="si">}</span><span class="s2">) must be positive integer greater or equal to 1: </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">device_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">_supported_device_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Device type </span><span class="si">{</span><span class="n">device_type</span><span class="si">!r}</span><span class="s2"> is not supported. Supported types: </span><span class="si">{</span><span class="n">_supported_device_types</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">components_include</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span> <span class="k">if</span> <span class="n">_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="kc">True</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]</span>
        <span class="n">components_include</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>  <span class="c1"># Always set the last component as included.</span>

        <span class="n">components_full_re</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>
        <span class="n">components_depth</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>  <span class="c1"># &#39;depth == None&#39; means that depth is not specified</span>
        <span class="k">if</span> <span class="n">n_full_re</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">components_full_re</span><span class="p">[</span><span class="n">n_full_re</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">components_depth</span><span class="p">[</span><span class="n">n_full_re</span><span class="p">]</span> <span class="o">=</span> <span class="n">depth</span>

        <span class="c1"># Remove &#39;+&#39; and &#39;?&#39; from the beginning of each component</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span>
            <span class="n">_</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="k">if</span> <span class="n">_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;+&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;-&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">_</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;?&quot;</span><span class="p">)</span> <span class="k">else</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">components</span>
        <span class="p">]</span>

        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name pattern </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2"> contains empty components&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">c</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">re</span><span class="o">.</span><span class="n">error</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Name pattern </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2"> contains invalid regular expression </span><span class="si">{</span><span class="n">c</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="n">components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">components_include</span><span class="p">,</span> <span class="n">components_full_re</span><span class="p">,</span> <span class="n">components_depth</span><span class="p">))</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^[_a-zA-Z]([_a-zA-Z0-9\.]*[_a-zA-Z0-9])?$&quot;</span><span class="p">,</span> <span class="n">name_pattern</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Name pattern </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2"> contains invalid characters. &quot;</span>
                <span class="s2">&quot;The pattern could be a valid regular expression, but it is not labeled with &#39;:&#39; (e.g. &#39;:^det$&#39;)&quot;</span>
            <span class="p">)</span>
        <span class="n">components</span> <span class="o">=</span> <span class="n">name_pattern</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">c</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Plan, device or subdevice name in the description </span><span class="si">{</span><span class="n">name_pattern</span><span class="si">!r}</span><span class="s2"> is an empty string&quot;</span>
                <span class="p">)</span>
        <span class="n">components_include</span> <span class="o">=</span> <span class="p">[</span><span class="kc">True</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>
        <span class="n">components_full_re</span> <span class="o">=</span> <span class="p">[</span><span class="kc">False</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>
        <span class="n">components_depth</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>

        <span class="n">components</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">components</span><span class="p">,</span> <span class="n">components_include</span><span class="p">,</span> <span class="n">components_full_re</span><span class="p">,</span> <span class="n">components_depth</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">components</span><span class="p">,</span> <span class="n">uses_re</span><span class="p">,</span> <span class="n">device_type</span>


<span class="k">def</span> <span class="nf">_is_object_name_in_list</span><span class="p">(</span><span class="n">object_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allowed_objects</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Search for object (plan or device) name (e.g. ``count`` or ``det1.val``) in the tree</span>
<span class="sd">    of device names (list of allowed devices) and returns ``True`` if the device is in</span>
<span class="sd">    the list and ``False`` otherwise. If search for a device name n the tree is terminated</span>
<span class="sd">    prematurely or at the node which has optional ``excluded`` attribute set ``True``, then</span>
<span class="sd">    it is considered that the name is not in the list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    object_name: str</span>
<span class="sd">        Object name, such as ``count``, ``det1`` or ``det1.val``.</span>
<span class="sd">    allowed_objects: dict</span>
<span class="sd">        Dictionary that contains descriptions of allowed objects (plans and/or devices)</span>
<span class="sd">        for a user group.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bool</span>
<span class="sd">        ``True`` if device was found in the list, ``False`` if the device is not in the list or</span>
<span class="sd">        the ``object_name`` is not a valid name for the object.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">components</span><span class="p">,</span> <span class="n">uses_re</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_name_pattern</span><span class="p">(</span><span class="n">object_name</span><span class="p">)</span>
        <span class="n">object_in_list</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="k">except</span> <span class="p">(</span><span class="ne">TypeError</span><span class="p">,</span> <span class="ne">ValueError</span><span class="p">):</span>
        <span class="n">object_in_list</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">object_in_list</span> <span class="ow">and</span> <span class="n">uses_re</span><span class="p">:</span>
        <span class="n">object_in_list</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="n">object_in_list</span><span class="p">:</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]</span>  <span class="c1"># We use only the 1st element</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">components</span><span class="p">:</span>
            <span class="n">object_in_list</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="c1"># The object name is valid, so search for the object in the list</span>
    <span class="k">if</span> <span class="n">object_in_list</span><span class="p">:</span>
        <span class="n">root</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">in</span> <span class="n">allowed_objects</span><span class="p">:</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">allowed_objects</span><span class="p">[</span><span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
            <span class="n">object_in_list</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;excluded&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">object_in_list</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">root</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">components</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
                <span class="k">if</span> <span class="p">(</span><span class="s2">&quot;components&quot;</span> <span class="ow">in</span> <span class="n">root</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">c</span> <span class="ow">in</span> <span class="n">root</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">]):</span>
                    <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">][</span><span class="n">c</span><span class="p">]</span>
                    <span class="n">object_in_list</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;excluded&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">object_in_list</span> <span class="o">=</span> <span class="kc">False</span>
                    <span class="k">break</span>

    <span class="k">return</span> <span class="n">object_in_list</span>


<span class="k">def</span> <span class="nf">_get_device_type_condition</span><span class="p">(</span><span class="n">device_type</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generator function that returns reference to a function that verifies if device</span>
<span class="sd">    satisfy condition for the selecte device type.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    device_type: str</span>
<span class="sd">        Deivce type</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    callable</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># The condition is applied to the device to decide if it is included in the list</span>
    <span class="k">if</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">_btype</span><span class="p">):</span>
            <span class="k">return</span> <span class="kc">True</span>

    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">&quot;__READABLE__&quot;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">_btype</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_readable&quot;</span><span class="p">])</span>

    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">&quot;__DETECTOR__&quot;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">_btype</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_readable&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_movable&quot;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">&quot;__MOTOR__&quot;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">_btype</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_readable&quot;</span><span class="p">]</span> <span class="ow">and</span> <span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_movable&quot;</span><span class="p">]</span>

    <span class="k">elif</span> <span class="n">device_type</span> <span class="o">==</span> <span class="s2">&quot;__FLYABLE__&quot;</span><span class="p">:</span>

        <span class="k">def</span> <span class="nf">condition</span><span class="p">(</span><span class="n">_btype</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">bool</span><span class="p">(</span><span class="n">_btype</span><span class="p">[</span><span class="s2">&quot;is_flyable&quot;</span><span class="p">])</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported device type: </span><span class="si">{</span><span class="n">device_type</span><span class="si">!r}</span><span class="s2">. Supported types: </span><span class="si">{</span><span class="n">_supported_device_types</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">condition</span>


<span class="k">def</span> <span class="nf">_build_device_name_list</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">uses_re</span><span class="p">,</span> <span class="n">device_type</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate list of device names (including subdevices) based on one element of a device</span>
<span class="sd">    list from plan parameter annotation. The element is preprocessed with</span>
<span class="sd">    ``_split_list_element_definition()`` represented as ``components``, ``uses_re`` and</span>
<span class="sd">    ``device_type`` parameters. If the element is a device name, it is simply included</span>
<span class="sd">    in the list. If the element is a pattern, the matching devices are selected</span>
<span class="sd">    from ``existing_devices`` dictionary and added to the list. The ``components`` is</span>
<span class="sd">    a list of tuples for each depth level. The first element of the tuple represents</span>
<span class="sd">    a pattern device/subdevice name at the given level. If matching devices are found,</span>
<span class="sd">    they are added to the list of devices if the second tuple element is ``True`` and then</span>
<span class="sd">    the subdevices of each matching device are processed using the pattern defined for</span>
<span class="sd">    the next depth level (the second element may be ``True`` or ``False``).</span>
<span class="sd">    A pattern may also be a &#39;full name&#39; regular expression applied to the remainder</span>
<span class="sd">    of the subdevice (if 3rd element of the tuple is True). Depth for &#39;full name&#39; search</span>
<span class="sd">    can be restricted (4th component of the tuple). Depth may be integer (&gt;=1) or ``None``</span>
<span class="sd">    (depth is not define, therefore considered infinite).</span>

<span class="sd">    The devices with set parameter ``&#39;excluded&#39;: True`` are not included in the list.</span>

<span class="sd">    It is assumed that element definitions are first processed using</span>
<span class="sd">    ``_split_list_element_definition``, which catches and processes all the errors,</span>
<span class="sd">    so this function does not perform any validation of data integrity.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    components: list(tuple)</span>
<span class="sd">        List of tuples, each tuple consists of four elements: device/subdevice name or</span>
<span class="sd">        pattern for name search; a boolean flag that tells if the matching devices or</span>
<span class="sd">        subdevices at this level should be added to the device list; a boolean flag</span>
<span class="sd">        that tells if the pattern should be applied to the remainder of the device name</span>
<span class="sd">        (full name search); integer value that limits the depth of full name search</span>
<span class="sd">        (``None`` if the depth is not limited).</span>
<span class="sd">    uses_re: boolean</span>
<span class="sd">        Boolean parameter that tells if the components represent device name or pattern based</span>
<span class="sd">        on regular expressions.</span>
<span class="sd">    device_type: str</span>
<span class="sd">        If components define the pattern, then device type is used to limit search to the devices</span>
<span class="sd">        of certain type.</span>
<span class="sd">    existing_devices: dict</span>
<span class="sd">        The list of existing (or allowed) devices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list(str)</span>
<span class="sd">        List of device names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">condition</span> <span class="o">=</span> <span class="n">_get_device_type_condition</span><span class="p">(</span><span class="n">device_type</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">uses_re</span><span class="p">:</span>
        <span class="n">max_depth</span><span class="p">,</span> <span class="n">device_list</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">),</span> <span class="p">[]</span>

        <span class="k">def</span> <span class="nf">process_devices_full_name</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">name_suffix</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_stop</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">depth_stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">depth_stop</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">dname</span><span class="p">,</span> <span class="n">dparams</span> <span class="ow">in</span> <span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">name_suffix_new</span> <span class="o">=</span> <span class="n">dname</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">name_suffix</span> <span class="k">else</span> <span class="p">(</span><span class="n">name_suffix</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">dname</span><span class="p">)</span>
                    <span class="n">full_name</span> <span class="o">=</span> <span class="n">name_suffix_new</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span> <span class="k">else</span> <span class="p">(</span><span class="n">base_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">name_suffix_new</span><span class="p">)</span>
                    <span class="k">if</span> <span class="p">(</span>
                        <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name_suffix_new</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="ow">not</span> <span class="n">dparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;excluded&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
                        <span class="ow">and</span> <span class="n">condition</span><span class="p">(</span><span class="n">dparams</span><span class="p">)</span>
                    <span class="p">):</span>
                        <span class="n">device_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
                    <span class="k">if</span> <span class="s2">&quot;components&quot;</span> <span class="ow">in</span> <span class="n">dparams</span><span class="p">:</span>
                        <span class="n">process_devices_full_name</span><span class="p">(</span>
                            <span class="n">devices</span><span class="o">=</span><span class="n">dparams</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">],</span>
                            <span class="n">base_name</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span>
                            <span class="n">name_suffix</span><span class="o">=</span><span class="n">name_suffix_new</span><span class="p">,</span>
                            <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                            <span class="n">depth</span><span class="o">=</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                            <span class="n">depth_stop</span><span class="o">=</span><span class="n">depth_stop</span><span class="p">,</span>
                        <span class="p">)</span>

        <span class="k">def</span> <span class="nf">process_devices</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">base_name</span><span class="p">,</span> <span class="n">depth</span><span class="p">):</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">max_depth</span><span class="p">)</span> <span class="ow">and</span> <span class="n">devices</span><span class="p">:</span>
                <span class="n">pattern</span><span class="p">,</span> <span class="n">include_devices</span><span class="p">,</span> <span class="n">is_full_re</span><span class="p">,</span> <span class="n">remaining_depth</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">is_full_re</span><span class="p">:</span>
                    <span class="n">process_devices_full_name</span><span class="p">(</span>
                        <span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span>
                        <span class="n">base_name</span><span class="o">=</span><span class="n">base_name</span><span class="p">,</span>
                        <span class="n">name_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                        <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                        <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                        <span class="n">depth_stop</span><span class="o">=</span><span class="n">depth</span> <span class="o">+</span> <span class="n">remaining_depth</span> <span class="k">if</span> <span class="n">remaining_depth</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">dname</span><span class="p">,</span> <span class="n">dparams</span> <span class="ow">in</span> <span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">dname</span><span class="p">):</span>
                            <span class="n">full_name</span> <span class="o">=</span> <span class="n">dname</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">base_name</span> <span class="k">else</span> <span class="p">(</span><span class="n">base_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">dname</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">include_devices</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">dparams</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;excluded&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">and</span> <span class="n">condition</span><span class="p">(</span><span class="n">dparams</span><span class="p">):</span>
                                <span class="n">device_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">full_name</span><span class="p">)</span>
                            <span class="k">if</span> <span class="s2">&quot;components&quot;</span> <span class="ow">in</span> <span class="n">dparams</span><span class="p">:</span>
                                <span class="n">process_devices</span><span class="p">(</span>
                                    <span class="n">devices</span><span class="o">=</span><span class="n">dparams</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">],</span> <span class="n">base_name</span><span class="o">=</span><span class="n">full_name</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span>
                                <span class="p">)</span>

        <span class="n">process_devices</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span> <span class="n">base_name</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Simplified approach: just copy the device name to list. No checks are performed.</span>
        <span class="c1"># Change the code in this block if device names are to be handled differently.</span>
        <span class="n">device_name</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">components</span><span class="p">])</span>
        <span class="n">device_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">device_name</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">device_list</span>


<span class="k">def</span> <span class="nf">_filter_device_tree</span><span class="p">(</span><span class="n">item_dict</span><span class="p">,</span> <span class="n">allow_patterns</span><span class="p">,</span> <span class="n">disallow_patterns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter device tree based on sets of patterns for &#39;allowed&#39; and &#39;disallowed&#39;</span>
<span class="sd">    devices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    item_dict: dict</span>
<span class="sd">        Dictionary that represents a tree of existing devices. Some of the devices</span>
<span class="sd">        may be labeled as excluded: those devices will remain excluded and could be</span>
<span class="sd">        removed from the tree.</span>
<span class="sd">    allowed_patterns: list(str)</span>
<span class="sd">        List of patterns from ``allowed_devices`` section of user group permissions.</span>
<span class="sd">        If the parameter value is ``[]`` or the first list element is ``None``,</span>
<span class="sd">        then it is assumed that all the devices are allowed.</span>
<span class="sd">    disallow_patterns: list(str)</span>
<span class="sd">        List of patterns from ``forbidden_devices`` section of user group permissions.</span>
<span class="sd">        If the parameter value is ``[]`` or the first list element is ``None``,</span>
<span class="sd">        then it is assumed that no devices are forbidden.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    allowed_devices: dict</span>
<span class="sd">        Dictionary that represents a tree of devices after filtering. Excluded</span>
<span class="sd">        devices could be labeled as excluded (parameter ``&quot;exclude&quot;: True``).</span>
<span class="sd">        Branches that consist of excluded parameters are removed from the tree.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        May raise exceptions if provided patterns are invalid and/or filtering</span>
<span class="sd">        can not be completed.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Add temporary flag (&#39;excl&#39;: False) to each device</span>
    <span class="k">def</span> <span class="nf">add_excl_flag</span><span class="p">(</span><span class="n">devices_dict</span><span class="p">,</span> <span class="n">exclude_all</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Add temporary ``excl`` parameter to each device and subdevice.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        devices_dict: dict</span>
<span class="sd">            Dictionary that contains the device tree</span>
<span class="sd">        exclude_all: boolean</span>
<span class="sd">            The value for the ``excl`` parameter.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">for</span> <span class="n">_</span><span class="p">,</span> <span class="n">dparam</span> <span class="ow">in</span> <span class="n">devices_dict</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="n">dparam</span><span class="p">[</span><span class="s2">&quot;excl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exclude_all</span>
            <span class="k">if</span> <span class="s2">&quot;components&quot;</span> <span class="ow">in</span> <span class="n">dparam</span><span class="p">:</span>
                <span class="n">add_excl_flag</span><span class="p">(</span><span class="n">dparam</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">],</span> <span class="n">exclude_all</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">apply_pattern_filter</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">devices_dict</span><span class="p">,</span> <span class="n">exclude</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Apply a pattern to the tree of deivce. Pattern can be an explicitly state name</span>
<span class="sd">        such as ``&quot;det&quot;`` or ``&quot;det.val&quot;`` or regular expression, such as ``&quot;:^det:val$&quot;``.</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        pattern_item: str</span>
<span class="sd">            Device/subdevice name or regular expression to be applied to the device names.</span>
<span class="sd">        existing_devices: dict</span>
<span class="sd">            Dictionary that represents a tree of devices/subdevices.</span>
<span class="sd">        exclude: boolean</span>
<span class="sd">            True - exclude devices, False - include devices.</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        None</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">components</span><span class="p">,</span> <span class="n">uses_re</span><span class="p">,</span> <span class="n">device_type</span> <span class="o">=</span> <span class="n">_split_name_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">uses_re</span><span class="p">:</span>
            <span class="n">condition</span> <span class="o">=</span> <span class="n">_get_device_type_condition</span><span class="p">(</span><span class="n">device_type</span><span class="p">)</span>
            <span class="n">max_depth</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span>

            <span class="k">def</span> <span class="nf">apply_filter_full_name</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">name_suffix</span><span class="p">,</span> <span class="n">pattern</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="n">depth_stop</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">exclude</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">depth_stop</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">depth_stop</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">dname</span><span class="p">,</span> <span class="n">dparams</span> <span class="ow">in</span> <span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                        <span class="n">name_suffix_new</span> <span class="o">=</span> <span class="n">dname</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">name_suffix</span> <span class="k">else</span> <span class="p">(</span><span class="n">name_suffix</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">dname</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">name_suffix_new</span><span class="p">)</span> <span class="ow">and</span> <span class="n">condition</span><span class="p">(</span><span class="n">dparams</span><span class="p">):</span>
                            <span class="n">dparams</span><span class="p">[</span><span class="s2">&quot;excl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exclude</span>
                        <span class="k">if</span> <span class="s2">&quot;components&quot;</span> <span class="ow">in</span> <span class="n">dparams</span><span class="p">:</span>
                            <span class="n">apply_filter_full_name</span><span class="p">(</span>
                                <span class="n">devices</span><span class="o">=</span><span class="n">dparams</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">],</span>
                                <span class="n">name_suffix</span><span class="o">=</span><span class="n">name_suffix_new</span><span class="p">,</span>
                                <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                                <span class="n">depth</span><span class="o">=</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span>
                                <span class="n">depth_stop</span><span class="o">=</span><span class="n">depth_stop</span><span class="p">,</span>
                                <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
                            <span class="p">)</span>

            <span class="k">def</span> <span class="nf">apply_filter</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="n">depth</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">exclude</span><span class="p">):</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">max_depth</span><span class="p">)</span> <span class="ow">and</span> <span class="n">devices</span><span class="p">:</span>
                    <span class="n">pattern</span><span class="p">,</span> <span class="n">include_devices</span><span class="p">,</span> <span class="n">is_full_re</span><span class="p">,</span> <span class="n">remaining_depth</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="n">depth</span><span class="p">]</span>
                    <span class="k">if</span> <span class="n">is_full_re</span><span class="p">:</span>
                        <span class="n">apply_filter_full_name</span><span class="p">(</span>
                            <span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span>
                            <span class="n">name_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span>
                            <span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span>
                            <span class="n">depth</span><span class="o">=</span><span class="n">depth</span><span class="p">,</span>
                            <span class="n">depth_stop</span><span class="o">=</span><span class="n">depth</span> <span class="o">+</span> <span class="n">remaining_depth</span> <span class="k">if</span> <span class="n">remaining_depth</span> <span class="k">else</span> <span class="kc">None</span><span class="p">,</span>
                            <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">,</span>
                        <span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">for</span> <span class="n">dname</span><span class="p">,</span> <span class="n">dparams</span> <span class="ow">in</span> <span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">dname</span><span class="p">):</span>
                                <span class="k">if</span> <span class="n">include_devices</span> <span class="ow">and</span> <span class="n">condition</span><span class="p">(</span><span class="n">dparams</span><span class="p">):</span>
                                    <span class="n">dparams</span><span class="p">[</span><span class="s2">&quot;excl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">bool</span><span class="p">(</span><span class="n">exclude</span><span class="p">)</span>
                                <span class="k">if</span> <span class="s2">&quot;components&quot;</span> <span class="ow">in</span> <span class="n">dparams</span><span class="p">:</span>
                                    <span class="n">apply_filter</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">dparams</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">],</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>

            <span class="n">apply_filter</span><span class="p">(</span><span class="n">devices</span><span class="o">=</span><span class="n">devices_dict</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="n">exclude</span><span class="p">)</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># &#39;components&#39; represent an explicitly stated name</span>
            <span class="n">root</span> <span class="o">=</span> <span class="n">allowed_devices</span>
            <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">c</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">([</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]):</span>
                <span class="k">if</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">root</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">n</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">root</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;excl&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">exclude</span>
                    <span class="k">if</span> <span class="s2">&quot;components&quot;</span> <span class="ow">in</span> <span class="n">root</span><span class="p">[</span><span class="n">c</span><span class="p">]:</span>
                        <span class="n">root</span> <span class="o">=</span> <span class="n">root</span><span class="p">[</span><span class="n">c</span><span class="p">][</span><span class="s2">&quot;components&quot;</span><span class="p">]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">break</span>

    <span class="k">def</span> <span class="nf">trim_device_dict</span><span class="p">(</span><span class="n">devices_dict</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Remove ``excl`` parameter from each device. Remove branches that contain only</span>
<span class="sd">        the devices that were excluded. Add ``&quot;excluded&quot;: True`` to the devices that</span>
<span class="sd">        were excluded but can not be removed from the tree (``&quot;excl&quot;: True``).</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        devices_dict: dict</span>
<span class="sd">            Dictionary representing the tree of devices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">contains_devices</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">for</span> <span class="n">dname</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">devices_dict</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
            <span class="n">dparam</span> <span class="o">=</span> <span class="n">devices_dict</span><span class="p">[</span><span class="n">dname</span><span class="p">]</span>

            <span class="n">exclude_this_device</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="s2">&quot;components&quot;</span> <span class="ow">in</span> <span class="n">dparam</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">trim_device_dict</span><span class="p">(</span><span class="n">dparam</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">]):</span>
                    <span class="n">exclude_this_device</span> <span class="o">=</span> <span class="kc">False</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">del</span> <span class="n">dparam</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">dparam</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;excluded&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">dparam</span><span class="p">[</span><span class="s2">&quot;excl&quot;</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">True</span><span class="p">):</span>
                <span class="n">dparam</span><span class="p">[</span><span class="s2">&quot;excluded&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">exclude_this_device</span> <span class="o">=</span> <span class="kc">False</span>

            <span class="k">if</span> <span class="n">exclude_this_device</span><span class="p">:</span>
                <span class="c1"># Device is excluded and contains no subdevices that were not excluded.</span>
                <span class="k">del</span> <span class="n">devices_dict</span><span class="p">[</span><span class="n">dname</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">dparam</span><span class="p">[</span><span class="s2">&quot;excl&quot;</span><span class="p">]</span>
                <span class="n">contains_devices</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="k">return</span> <span class="n">contains_devices</span>

    <span class="n">allowed_devices</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item_dict</span><span class="p">)</span>

    <span class="c1"># Process the case when all devices/subdevices are allowed</span>
    <span class="n">allow_all</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">allow_patterns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">allow_patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">add_excl_flag</span><span class="p">(</span><span class="n">allowed_devices</span><span class="p">,</span> <span class="n">exclude_all</span><span class="o">=</span><span class="ow">not</span> <span class="n">allow_all</span><span class="p">)</span>

    <span class="c1"># Process &#39;allow_patterns&#39;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">allow_all</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">allow_patterns</span><span class="p">:</span>
            <span class="n">apply_pattern_filter</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">devices_dict</span><span class="o">=</span><span class="n">allowed_devices</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Process &#39;disallow_patterns&#39;</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">disallow_patterns</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">disallow_patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">disallow_patterns</span><span class="p">:</span>
            <span class="n">apply_pattern_filter</span><span class="p">(</span><span class="n">pattern</span><span class="o">=</span><span class="n">pattern</span><span class="p">,</span> <span class="n">devices_dict</span><span class="o">=</span><span class="n">allowed_devices</span><span class="p">,</span> <span class="n">exclude</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">trim_device_dict</span><span class="p">(</span><span class="n">allowed_devices</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">allowed_devices</span>


<span class="k">def</span> <span class="nf">_build_plan_name_list</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">components</span><span class="p">,</span> <span class="n">uses_re</span><span class="p">,</span> <span class="n">device_type</span><span class="p">,</span> <span class="n">existing_plans</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    components: list(tuple)</span>
<span class="sd">        List of tuples returned by ``_split_list_element_definition()``. For the plans</span>
<span class="sd">        the list must contain exactly one component, elements 2 and 3 of each tuple</span>
<span class="sd">        must be ``False`` and element 4 must be ``None``. Exception will be raised if those</span>
<span class="sd">        requirements are not satisfied (this is part of normal operation, it means that</span>
<span class="sd">        the definition contains elements, such as ``+`` or ``?`` that are not supported</span>
<span class="sd">        for plans, so the user should be informed that the definition can not be processed)</span>
<span class="sd">    uses_re: boolean</span>
<span class="sd">        Boolean parameter that tells if the components represent device name or pattern based</span>
<span class="sd">        on regular expressions.</span>
<span class="sd">    device_type: str</span>
<span class="sd">        This parameter is returned by ``_split_list_element_definition()`` and must be</span>
<span class="sd">        an empty string ``&quot;&quot;``. Exception will be raised otherwise (device type can not be</span>
<span class="sd">        used in the pattern defining a plan).</span>
<span class="sd">    existing_plans: set or dict</span>
<span class="sd">        A set of plan names or a list (dictionary) of existing (or allowed) plans.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    list(str)</span>
<span class="sd">        List of device names.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">c</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">components</span><span class="p">]</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;List element describing a plan may contain only one component. Components: </span><span class="si">{</span><span class="n">c</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># At this point we know that &#39;components&#39; has precisely one element.</span>
    <span class="n">pattern</span><span class="p">,</span> <span class="n">include_devices</span><span class="p">,</span> <span class="n">is_full_re</span><span class="p">,</span> <span class="n">remaining_depth</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

    <span class="k">if</span> <span class="n">remaining_depth</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Depth specification can not be part of the name pattern for a plan: </span><span class="si">{</span><span class="n">pattern</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">device_type</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Device type can not be included in the name pattern for a plan: </span><span class="si">{</span><span class="p">(</span><span class="n">device_type</span> <span class="o">+</span> <span class="s1">&#39;:&#39;</span><span class="p">)</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="n">plan_list</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="k">if</span> <span class="n">uses_re</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">plan_name</span> <span class="ow">in</span> <span class="n">existing_plans</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="n">plan_name</span><span class="p">):</span>
                <span class="n">plan_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">plan_name</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># Simplified approach: just add the plan name to the list. No checks are performed.</span>
        <span class="c1"># Change the code in this block if device names are to be handled differently.</span>
        <span class="n">plan_list</span> <span class="o">=</span> <span class="p">[</span><span class="n">pattern</span><span class="p">]</span>

    <span class="k">return</span> <span class="n">plan_list</span>


<span class="k">def</span> <span class="nf">_expand_parameter_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">,</span> <span class="n">existing_plans</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expand the lists if plans and device in annotation. The function does not filter</span>
<span class="sd">    the lists: all names of plans and devices that are explicitly defined in the lists</span>
<span class="sd">    are copied to the new lists. Plans and devices that are defined using regular</span>
<span class="sd">    expressions are searched in the lists of existing plans and devices respectively.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    annotation: dict</span>
<span class="sd">        Parameter annotation.</span>
<span class="sd">    existing_devices: dict, None</span>
<span class="sd">        Dictionary with allowed or existing devices. If ``None``, then all the expanded lists</span>
<span class="sd">        will be empty.</span>
<span class="sd">    existing_plans: set, dict or None</span>
<span class="sd">        A set of existng plan names or a dictionary where the keys are the existing plan names.</span>
<span class="sd">        The function does not require complete plan descriptions, since they are typically not</span>
<span class="sd">        available on this stage. If ``None``, then all the expanded lists will be empty.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Expanded annotation. Always returns deep copy, so the original annotation remains unchanged</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">existing_devices</span> <span class="o">=</span> <span class="n">existing_devices</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">existing_plans</span> <span class="o">=</span> <span class="n">existing_plans</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">annotation</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">section</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="s2">&quot;plans&quot;</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">section</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">[</span><span class="n">section</span><span class="p">]</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Unsupported type of a device or plan list </span><span class="si">{</span><span class="n">k</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">item_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">components</span><span class="p">,</span> <span class="n">uses_re</span><span class="p">,</span> <span class="n">device_type</span> <span class="o">=</span> <span class="n">_split_name_pattern</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">section</span> <span class="o">==</span> <span class="s2">&quot;plans&quot;</span><span class="p">:</span>
                    <span class="n">name_list</span> <span class="o">=</span> <span class="n">_build_plan_name_list</span><span class="p">(</span>
                        <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">,</span>
                        <span class="n">uses_re</span><span class="o">=</span><span class="n">uses_re</span><span class="p">,</span>
                        <span class="n">device_type</span><span class="o">=</span><span class="n">device_type</span><span class="p">,</span>
                        <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">name_list</span> <span class="o">=</span> <span class="n">_build_device_name_list</span><span class="p">(</span>
                        <span class="n">components</span><span class="o">=</span><span class="n">components</span><span class="p">,</span>
                        <span class="n">uses_re</span><span class="o">=</span><span class="n">uses_re</span><span class="p">,</span>
                        <span class="n">device_type</span><span class="o">=</span><span class="n">device_type</span><span class="p">,</span>
                        <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span>
                    <span class="p">)</span>
                <span class="n">item_list</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">name_list</span><span class="p">)</span>
            <span class="c1"># Remove repeated entries</span>
            <span class="n">item_list</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">item_list</span><span class="p">))</span>
            <span class="c1"># Sort the list of names by lower case letters</span>
            <span class="n">item_list</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">item_list</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">_</span><span class="p">:</span> <span class="p">(</span><span class="n">_</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="n">_</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">islower</span><span class="p">()))</span>
            <span class="n">annotation</span><span class="p">[</span><span class="n">section</span><span class="p">][</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">item_list</span>

    <span class="c1"># Process enums: convert tuples to lists</span>
    <span class="k">if</span> <span class="s2">&quot;enums&quot;</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
        <span class="n">an_enums</span> <span class="o">=</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;enums&quot;</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">an_enums</span><span class="o">.</span><span class="n">keys</span><span class="p">():</span>
            <span class="n">an_enums</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">an_enums</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">annotation</span>


<span class="k">def</span> <span class="nf">_expand_plan_description</span><span class="p">(</span><span class="n">plan_description</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">,</span> <span class="n">existing_plans</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Expand lists of items for custom enum types for each parameter in the plan description.</span>
<span class="sd">    After expansion, plan description is ready for use in plan validation. The function</span>
<span class="sd">    does not change the plan description if there are no lists to expand, therefore it can</span>
<span class="sd">    be repeatedly applied to the same plan description without consequences (except extra</span>
<span class="sd">    execution time). The function always returnes a COPY of the plan description, so</span>
<span class="sd">    it is safe to apply to elements of the list of allowed/existing plans without changing</span>
<span class="sd">    the original descriptions.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan_description: dict</span>
<span class="sd">        Plan description. The format of plan description is the same as in the list of</span>
<span class="sd">        allowed/existing plans. The function will not change the original dictionary,</span>
<span class="sd">        which is referenced by this parameter.</span>
<span class="sd">    existing_devices: dict, None</span>
<span class="sd">        Dictionary with allowed or existing devices. If ``None``, then all the expanded lists</span>
<span class="sd">        will be empty.</span>
<span class="sd">    existing_plans: set, dict or None</span>
<span class="sd">        A set of existng plan names or a dictionary where the keys are the existing plan names.</span>
<span class="sd">        The function does not require complete plan descriptions, since they are typically not</span>
<span class="sd">        available on this stage. If ``None``, then all the expanded lists will be empty.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Expanded plan description, which contains full lists of items. Always returns the</span>
<span class="sd">        copy of the plan description.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">        Exceptions are raised if plan description can not be properly processed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plan_description</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">plan_description</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">plan_description</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">plan_description</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
            <span class="k">if</span> <span class="s2">&quot;annotation&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">_expand_parameter_annotation</span><span class="p">(</span>
                    <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">],</span> <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span> <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">plan_description</span>


<span class="c1"># ===============================================================================</span>
<span class="c1">#   Validation of plan parameters</span>


<span class="k">def</span> <span class="nf">_convert_str_to_number</span><span class="p">(</span><span class="n">value_in</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Interpret a string ``value_in`` as ``int`` or ``float`` (whichever is sufficient).</span>
<span class="sd">    Raise the exception if conversion fails.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Try to convert string value to float</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">value_in</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="n">value_out</span> <span class="o">=</span> <span class="nb">float</span><span class="p">(</span><span class="n">value_in</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value &#39;</span><span class="si">{</span><span class="n">value_in</span><span class="si">}</span><span class="s2">&#39; is not a string (type: </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">value_in</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_out</span><span class="p">)</span> <span class="o">==</span> <span class="n">value_out</span><span class="p">:</span>
            <span class="n">value_out</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">value_out</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to interpret the value </span><span class="si">{</span><span class="n">value_in</span><span class="si">!r}</span><span class="s2"> as integer or float number: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">value_out</span>


<span class="k">def</span> <span class="nf">_compare_types</span><span class="p">(</span><span class="n">object_in</span><span class="p">,</span> <span class="n">object_out</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares types of parameters. If both parameters are iterables (list or tuple),</span>
<span class="sd">    then the function is recursively called for each element. A set of rules is</span>
<span class="sd">    applied to types to determine if the types are matching.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_in</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_out</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_in</span><span class="p">)</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_out</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">o_in</span><span class="p">,</span> <span class="n">o_out</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">object_in</span><span class="p">,</span> <span class="n">object_out</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">_compare_types</span><span class="p">(</span><span class="n">o_in</span><span class="p">,</span> <span class="n">o_out</span><span class="p">):</span>
                    <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># This should never happen, since &#39;object_out&#39; is obtained by</span>
            <span class="c1">#   applying transformations on &#39;object_in&#39;, but it is still</span>
            <span class="c1">#   good to check to avoid exceptions.</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># This is the set of rules used to determine if types are matching.</span>
        <span class="c1">#   Types are required to be identical, except in the following cases:</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_out</span><span class="p">,</span> <span class="nb">type</span><span class="p">(</span><span class="n">object_in</span><span class="p">)):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># &#39;int&#39; is allowed to be converted to float</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_out</span><span class="p">,</span> <span class="nb">float</span><span class="p">)</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">object_in</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

        <span class="c1"># Conversion to Enum is valid (parameters often contain values, that are converted to Enums).</span>
        <span class="k">elif</span> <span class="nb">issubclass</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">object_out</span><span class="p">),</span> <span class="n">enum</span><span class="o">.</span><span class="n">Enum</span><span class="p">)</span> <span class="ow">and</span> <span class="n">object_in</span> <span class="o">==</span> <span class="n">object_out</span><span class="o">.</span><span class="n">value</span><span class="p">:</span>
            <span class="n">match</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="n">match</span>


<span class="k">def</span> <span class="nf">_compare_in_out</span><span class="p">(</span><span class="n">kwargs_in</span><span class="p">,</span> <span class="n">kwargs_out</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares input and output kwargs for ``pydantic`` model. Accumulates and returns</span>
<span class="sd">    the error message that includes the data on all parameters with mismatching types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">match</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">kwargs_out</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs_in</span><span class="p">:</span>
            <span class="n">valid</span> <span class="o">=</span> <span class="n">_compare_types</span><span class="p">(</span><span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">],</span> <span class="n">v</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">valid</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="n">msg</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Incorrect parameter type: key=&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;value=&#39;</span><span class="si">{</span><span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">])</span><span class="si">}</span><span class="s2">), &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;interpreted as &#39;</span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2">&#39; (</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">v</span><span class="p">)</span><span class="si">}</span><span class="s2">)&quot;</span>
                <span class="p">)</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">match</span><span class="p">,</span> <span class="n">msg</span>


<span class="k">def</span> <span class="nf">_check_ranges</span><span class="p">(</span><span class="n">kwargs_in</span><span class="p">,</span> <span class="n">param_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if each parameter in ``kwargs_in`` is within the range limited by</span>
<span class="sd">    the minimum and maximum values if the range is specified in plan parameter</span>
<span class="sd">    descriptions.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">process_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">):</span>
        <span class="c1"># Recursively process lists (iterables) and dictionaries.</span>
        <span class="c1"># Raises the exception if any found number is out of range.</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">numbers</span><span class="o">.</span><span class="n">Number</span><span class="p">):</span>
            <span class="n">out_of_range</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">v_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span> <span class="o">&lt;</span> <span class="n">v_min</span><span class="p">):</span>
                <span class="n">out_of_range</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">v_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v</span> <span class="o">&gt;</span> <span class="n">v_max</span><span class="p">):</span>
                <span class="n">out_of_range</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">out_of_range</span><span class="p">:</span>
                <span class="n">s_v_min</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v_min</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">v_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;-inf&quot;</span>
                <span class="n">s_v_max</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">v_max</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">v_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="k">else</span> <span class="s2">&quot;inf&quot;</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Value </span><span class="si">{</span><span class="n">v</span><span class="si">}</span><span class="s2"> is out of range [</span><span class="si">{</span><span class="n">s_v_min</span><span class="si">}</span><span class="s2">, </span><span class="si">{</span><span class="n">s_v_max</span><span class="si">}</span><span class="s2">]&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">key</span><span class="p">,</span> <span class="n">value</span> <span class="ow">in</span> <span class="n">v</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                <span class="n">process_argument</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">v</span><span class="p">:</span>
                <span class="n">process_argument</span><span class="p">(</span><span class="n">item</span><span class="p">,</span> <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>

    <span class="n">match</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
        <span class="n">k</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">v_min</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">v_max</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Perform check only if the parameter value is passed to the plan and</span>
        <span class="c1">#   v_max or v_min is specified.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">k</span> <span class="ow">in</span> <span class="n">kwargs_in</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">v_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">v_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">v</span> <span class="o">=</span> <span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">v_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v_min</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">v_min</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">v_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">v_max</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">v_max</span><span class="p">)</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="n">process_argument</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">v_min</span><span class="p">,</span> <span class="n">v_max</span><span class="p">)</span>

            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">msg</span> <span class="k">else</span> <span class="n">msg</span>
                <span class="n">msg</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;Parameter value is out of range: key=&#39;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">&#39;, &quot;</span> <span class="sa">f</span><span class="s2">&quot;value=&#39;</span><span class="si">{</span><span class="n">kwargs_in</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">match</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">return</span> <span class="n">match</span><span class="p">,</span> <span class="n">msg</span>


<span class="k">def</span> <span class="nf">_find_and_replace_built_in_types</span><span class="p">(</span><span class="n">annotation_type_str</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">plans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">enums</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find and replace built-in types in parameter annotation type string. Built-in types are</span>
<span class="sd">    ``__PLAN__``, ``__DEVICE__``, ``__PLAN_OR_DEVICE__``. Since plan and device names are passed</span>
<span class="sd">    as strings and then converted to respective object, the built-in plan names are replaced by ``str``</span>
<span class="sd">    type, which is then used in parameter validation. The function also determines whether plans, devices</span>
<span class="sd">    or both plans and devices need to be converted. If the name of the built-in type is redefined</span>
<span class="sd">    in ``plans``, ``devices`` or ``enums`` section, then the keyword is ignored.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    annotation_type_str: str</span>
<span class="sd">        String that represents a type from parameter annotation</span>
<span class="sd">    plans: dict or None</span>
<span class="sd">        Reference to the ``plans`` section of the parameter annotation</span>
<span class="sd">    devices: dict or None</span>
<span class="sd">        Reference to the ``devices`` section of the parameter annotation</span>
<span class="sd">    enums: dict or None</span>
<span class="sd">        Reference to the ``enum`` section of the parameter annotation</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    annotation_type_str: str</span>
<span class="sd">        Modified parameter type</span>
<span class="sd">    convert_plan_names: boolean</span>
<span class="sd">        Indicates whether the plan names need to be converted based on the parameter type.</span>
<span class="sd">    convert_device_names: boolean</span>
<span class="sd">        Indicates whether the devices names need to be converted based on the parameter type.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Built-in types that may be contained in &#39;annotation_type_str&#39; and</span>
    <span class="c1">#   should be converted to another known type</span>
    <span class="n">plans</span> <span class="o">=</span> <span class="n">plans</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">devices</span> <span class="o">=</span> <span class="n">devices</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="n">enums</span> <span class="o">=</span> <span class="n">enums</span> <span class="ow">or</span> <span class="p">{}</span>

    <span class="n">built_in_types</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;__PLAN__&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">False</span><span class="p">),</span>
        <span class="s2">&quot;__DEVICE__&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;__PLAN_OR_DEVICE__&quot;</span><span class="p">:</span> <span class="p">(</span><span class="s2">&quot;str&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">}</span>
    <span class="n">convert_plan_names</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">convert_device_names</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">for</span> <span class="n">btype</span><span class="p">,</span> <span class="p">(</span><span class="n">btype_replace</span><span class="p">,</span> <span class="n">pl</span><span class="p">,</span> <span class="n">dev</span><span class="p">)</span> <span class="ow">in</span> <span class="n">built_in_types</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="c1"># If &#39;plans&#39;, &#39;devices&#39; or &#39;enums&#39; contains the type name, then leave it as is</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">btype</span> <span class="ow">in</span> <span class="n">plans</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">btype</span> <span class="ow">in</span> <span class="n">devices</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">btype</span> <span class="ow">in</span> <span class="n">enums</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">btype</span><span class="p">,</span> <span class="n">annotation_type_str</span><span class="p">):</span>
            <span class="n">annotation_type_str</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">btype</span><span class="p">,</span> <span class="n">btype_replace</span><span class="p">,</span> <span class="n">annotation_type_str</span><span class="p">)</span>
            <span class="n">convert_plan_names</span> <span class="o">=</span> <span class="n">convert_plan_names</span> <span class="ow">or</span> <span class="n">pl</span>
            <span class="n">convert_device_names</span> <span class="o">=</span> <span class="n">convert_device_names</span> <span class="ow">or</span> <span class="n">dev</span>

    <span class="k">return</span> <span class="n">annotation_type_str</span><span class="p">,</span> <span class="n">convert_plan_names</span><span class="p">,</span> <span class="n">convert_device_names</span>


<span class="k">def</span> <span class="nf">_process_annotation</span><span class="p">(</span><span class="n">encoded_annotation</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">ns</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Processed annotation is encoded the same way as in the descriptions of existing plans.</span>
<span class="sd">    Returns reference to the annotation (type object) and the list of temporary types</span>
<span class="sd">    that needs to be deleted once the processing (parameter validation) is complete.</span>
<span class="sd">    The built-in type names (__DEVICE__, __PLAN__, __PLAN_OR_DEVICE__) are replaced with ``str``</span>
<span class="sd">    unless types with the same name are defined in ``plans``, ``devices`` or</span>
<span class="sd">    ``enums`` sections of the annotation. Explicitly defined the types with the same names</span>
<span class="sd">    as built-in types are treated as regular types.</span>

<span class="sd">    The function validates annotation and raises exceptions in the following cases:</span>
<span class="sd">    the types defined in &#39;plans&#39;, &#39;devices&#39; or &#39;enums&#39; sections are not lists or tuples;</span>
<span class="sd">    the types defined in &#39;plans&#39;, &#39;devices&#39; or &#39;enums&#39; sections are not used as part</span>
<span class="sd">    of the parameter type (may indicate a bug in the user code); annotation contains</span>
<span class="sd">    unsupported keys.</span>

<span class="sd">    This function does not change the annotation.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    encoded_annotation : dict</span>
<span class="sd">        Dictionary that contains encoded annotation. The dictionary may contain the following</span>
<span class="sd">        keys: ``type`` - type represented as a string, ``devices`` - a dictionary that maps</span>
<span class="sd">        device types and lists of device names, ``plans`` - similar dictionary for plan types</span>
<span class="sd">        and ``enums`` - similar dictionary for simple enums (strings).</span>
<span class="sd">    ns : dict</span>
<span class="sd">        Namespace that is used to evaluate the annotations. Custom types with unique names</span>
<span class="sd">        may be added to the namesace by the function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    annotation_type: type</span>
<span class="sd">        Type reconstructed from annotation.</span>
<span class="sd">    convert_plan_names: bool</span>
<span class="sd">        Indicates if __PLAN__ or __PLAN_OR_DEVICE__ built-in type was detected and matching</span>
<span class="sd">        strings should be converted to plan objects.</span>
<span class="sd">    convert_device_names: bool</span>
<span class="sd">        Indicates if __DEVICE__ or __PLAN_OR_DEVICE__ built-in type was detected and matching</span>
<span class="sd">        strings should be converted to devuce objects.</span>
<span class="sd">    ns: dict</span>
<span class="sd">        Namespace dictionary with created types.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Namespace that contains the types created in the process of processing the annotation</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="n">ns</span> <span class="ow">or</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="s2">&quot;typing&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="n">typing</span><span class="p">})</span>
    <span class="k">if</span> <span class="s2">&quot;enum&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;enum&quot;</span><span class="p">:</span> <span class="n">enum</span><span class="p">})</span>
    <span class="k">if</span> <span class="s2">&quot;NoneType&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;NoneType&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)})</span>

    <span class="n">annotation_type_str</span> <span class="o">=</span> <span class="s2">&quot;&lt;not-specified&gt;&quot;</span>
    <span class="n">annotation_type</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;type&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">encoded_annotation</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Type is not specififed&quot;</span><span class="p">)</span>

        <span class="c1"># Verify that the annotation does not have any unsupported keys</span>
        <span class="n">allowed_keys</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="s2">&quot;enums&quot;</span><span class="p">)</span>
        <span class="n">invalid_keys</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">encoded_annotation</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_keys</span><span class="p">:</span>
                <span class="n">invalid_keys</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">invalid_keys</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Annotation contains unsupported keys: </span><span class="si">{</span><span class="n">invalid_keys</span><span class="si">}</span><span class="s2">. Supported keys: </span><span class="si">{</span><span class="n">allowed_keys</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="p">)</span>

        <span class="n">annotation_type_str</span> <span class="o">=</span> <span class="n">encoded_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">)</span>  <span class="c1"># Required!</span>
        <span class="n">devices</span> <span class="o">=</span> <span class="n">encoded_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">plans</span> <span class="o">=</span> <span class="n">encoded_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">enums</span> <span class="o">=</span> <span class="n">encoded_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;enums&quot;</span><span class="p">,</span> <span class="p">{})</span>
        <span class="n">items</span> <span class="o">=</span> <span class="n">devices</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">items</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">plans</span><span class="p">)</span>
        <span class="n">items</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">enums</span><span class="p">)</span>

        <span class="n">annotation_type_str</span><span class="p">,</span> <span class="n">convert_plan_names</span><span class="p">,</span> <span class="n">convert_device_names</span> <span class="o">=</span> <span class="n">_find_and_replace_built_in_types</span><span class="p">(</span>
            <span class="n">annotation_type_str</span><span class="p">,</span> <span class="n">plans</span><span class="o">=</span><span class="n">plans</span><span class="p">,</span> <span class="n">devices</span><span class="o">=</span><span class="n">devices</span><span class="p">,</span> <span class="n">enums</span><span class="o">=</span><span class="n">enums</span>
        <span class="p">)</span>

        <span class="c1"># Create types</span>
        <span class="k">for</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="n">items</span><span class="p">:</span>
            <span class="c1"># The dictionary value for the devices/plans may be a list(tuple) of items.</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">items</span><span class="p">[</span><span class="n">item_name</span><span class="p">],</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">)):</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;The list of items (</span><span class="si">{</span><span class="n">item_name</span><span class="si">!r}</span><span class="s2">: </span><span class="si">{</span><span class="n">items</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span><span class="si">!r}</span><span class="s2">) must be a list of a tuple.&quot;</span>
                <span class="p">)</span>

            <span class="k">if</span> <span class="n">item_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">annotation_type_str</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Type </span><span class="si">{</span><span class="n">item_name</span><span class="si">!r}</span><span class="s2"> is defined in the annotation, but not used in the parameter type&quot;</span>
                <span class="p">)</span>

            <span class="c1"># Create temporary unique type name</span>
            <span class="n">type_name</span> <span class="o">=</span> <span class="n">type_name_base</span> <span class="o">=</span> <span class="n">item_name</span>
            <span class="k">while</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># Try the original name first</span>
                <span class="k">if</span> <span class="n">type_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">ns</span><span class="p">:</span>
                    <span class="k">break</span>
                <span class="n">type_name</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">type_name_base</span><span class="si">}</span><span class="s2">_</span><span class="si">{</span><span class="n">random</span><span class="o">.</span><span class="n">randint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">100000</span><span class="p">)</span><span class="si">}</span><span class="s2">_&quot;</span>

            <span class="c1"># Replace all occurrences of the type name in the custom annotation.</span>
            <span class="n">annotation_type_str</span> <span class="o">=</span> <span class="n">annotation_type_str</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span> <span class="n">type_name</span><span class="p">)</span>

            <span class="c1"># Create temporary type as a subclass of enum.Enum, e.g.</span>
            <span class="c1"># enum.Enum(&#39;Device&#39;, {&#39;det1&#39;: &#39;det1&#39;, &#39;det2&#39;: &#39;det2&#39;, &#39;det3&#39;: &#39;det3&#39;})</span>
            <span class="n">type_code</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;enum.Enum(&#39;</span><span class="si">{</span><span class="n">type_name</span><span class="si">}</span><span class="s2">&#39;, </span><span class="se">{{</span><span class="s2">&quot;</span>
            <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">items</span><span class="p">[</span><span class="n">item_name</span><span class="p">]:</span>
                <span class="n">type_code</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;&#39;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&#39;: &#39;</span><span class="si">{</span><span class="n">d</span><span class="si">}</span><span class="s2">&#39;,&quot;</span>
            <span class="n">type_code</span> <span class="o">+=</span> <span class="s2">&quot;})&quot;</span>
            <span class="n">ns</span><span class="p">[</span><span class="n">type_name</span><span class="p">]</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">type_code</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

        <span class="c1"># Once all the types are created,  execute the code for annotation.</span>
        <span class="n">annotation_type</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">annotation_type_str</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process annotation &#39;</span><span class="si">{</span><span class="n">annotation_type_str</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&#39;&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">annotation_type</span><span class="p">,</span> <span class="n">convert_plan_names</span><span class="p">,</span> <span class="n">convert_device_names</span><span class="p">,</span> <span class="n">ns</span>


<span class="k">def</span> <span class="nf">_process_default_value</span><span class="p">(</span><span class="n">encoded_default_value</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Evaluates the default value represented as a string.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    encoded_default_value : str</span>
<span class="sd">        Default value represented as a string (e.g. &quot;10&quot; or &quot;&#39;some-str&#39;&quot;</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    p_default</span>
<span class="sd">        Default value.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Raised if evaluation of the string containing the default value fails</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">p_default</span> <span class="o">=</span> <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">encoded_default_value</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to decode the default value &#39;</span><span class="si">{</span><span class="n">encoded_default_value</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">p_default</span>


<span class="k">def</span> <span class="nf">_decode_parameter_types_and_defaults</span><span class="p">(</span><span class="n">param_list</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Decode parameter types and default values by using string representations of</span>
<span class="sd">    types and defaults stored in list of available devices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters : list(dict)</span>
<span class="sd">        List of dictionaries that contains annotations and default values of parameters.</span>
<span class="sd">        Used keys of the dictionaries: ``annotation`` and ``default``. If ``annotation``</span>
<span class="sd">        key is missing, then the the type is set to ``typing.Any``. If ``default`` is</span>
<span class="sd">        missing, then the default value is set to ``inspect.Parameter.empty``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Mapping of parameter names to the dictionaries containing type (``type`` key)</span>
<span class="sd">        and default value (``default`` key).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">decoded_types_and_defaults</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
        <span class="k">if</span> <span class="s2">&quot;name&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No &#39;name&#39; key in the parameter description </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;annotation&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">p_type</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_process_annotation</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_type</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">Any</span>

        <span class="k">if</span> <span class="s2">&quot;default&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
            <span class="n">p_default</span> <span class="o">=</span> <span class="n">_process_default_value</span><span class="p">(</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">])</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">p_default</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span>

        <span class="n">decoded_types_and_defaults</span><span class="p">[</span><span class="n">p</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">p_type</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="n">p_default</span><span class="p">}</span>

    <span class="k">return</span> <span class="n">decoded_types_and_defaults</span>


<span class="k">def</span> <span class="nf">construct_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">params_decoded</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct the list of ``inspect.Parameter`` parameters based on the parameter list.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param_list : list(dict)</span>
<span class="sd">        List of item (plan) parameters as it is stored in the list of existing plans.</span>
<span class="sd">        Used keys of each parameter dictionary: ``name``, ``kind``, ``default``,</span>
<span class="sd">        ``annotation``.</span>
<span class="sd">    params_decoded : dict or None</span>
<span class="sd">        Dictionary that maps parameter name to the decoded parameter type</span>
<span class="sd">        and default value. The dictionary is created by calling</span>
<span class="sd">        ``_decode_parameter_types_and_defaults()``.  If the value is ``None``,</span>
<span class="sd">        then the decoded parameters are created automatically from the list ``param_list``.</span>
<span class="sd">        The parameter is intended for cases when the instantiated values are used repeatedly</span>
<span class="sd">        to avoid unnecessary multiple calls to ``_decode_parameter_types_and_defaults()``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    parameters : inspect.Parameters</span>
<span class="sd">        Item (plan) parameters represented in the form accepted by ``inspect.Signature``:</span>
<span class="sd">        ``sig=inspect.Signature(parameters)``.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exceptions with meaningful error messages are generated if parameters can not be</span>
<span class="sd">    instantiated.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">params_decoded</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">params_decoded</span> <span class="o">=</span> <span class="n">_decode_parameter_types_and_defaults</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>

    <span class="n">parameters</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
            <span class="n">p_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="n">p_kind</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kind&quot;</span><span class="p">,</span> <span class="p">{})</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;value&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">p_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Description for parameter contains no key &#39;name&#39;: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">p_kind</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Description for parameter contains no key &#39;kind&#39;: </span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="c1"># The following values are ALWAYS created by &#39;_instantiate_parameter_types_and_defaults&#39;</span>
            <span class="n">p_type</span> <span class="o">=</span> <span class="n">params_decoded</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="s2">&quot;type&quot;</span><span class="p">]</span>
            <span class="n">p_default</span> <span class="o">=</span> <span class="n">params_decoded</span><span class="p">[</span><span class="n">p_name</span><span class="p">][</span><span class="s2">&quot;default&quot;</span><span class="p">]</span>

            <span class="n">param</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">p_name</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="n">p_kind</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="n">p_default</span><span class="p">,</span> <span class="n">annotation</span><span class="o">=</span><span class="n">p_type</span><span class="p">)</span>
            <span class="n">parameters</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">param</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to construct &#39;inspect.Parameters&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">parameters</span>


<span class="k">def</span> <span class="nf">pydantic_construct_model_class</span><span class="p">(</span><span class="n">parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Construct the &#39;pydantic&#39; model based on parameters.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    parameters : inspect.Parameters</span>
<span class="sd">        Parameters of the plan with annotations created by ``_create_parameters`` function.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    class</span>
<span class="sd">        Dynamically created Pydantic model class</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">model_kwargs</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;default&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="o">!=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
            <span class="n">default</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">default</span> <span class="o">=</span> <span class="o">...</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="s2">&quot;annotation&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_POSITIONAL</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">List</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">annotation</span><span class="p">]</span>
            <span class="k">elif</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span> <span class="o">==</span> <span class="n">p</span><span class="o">.</span><span class="n">VAR_KEYWORD</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">typing</span><span class="o">.</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">annotation</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">model_kwargs</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="n">default</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">model_kwargs</span><span class="p">[</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>
    <span class="k">return</span> <span class="n">pydantic</span><span class="o">.</span><span class="n">create_model</span><span class="p">(</span><span class="s2">&quot;Model&quot;</span><span class="p">,</span> <span class="o">**</span><span class="n">model_kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">pydantic_validate_model</span><span class="p">(</span><span class="n">kwargs</span><span class="p">,</span> <span class="n">pydantic_model_class</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the function parameters using &#39;pydantic&#39; model based</span>
<span class="sd">    (by instantiating the model using model class and bound model parameters).</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    kwargs: dict</span>
<span class="sd">        Bound parameters of the function call.</span>
<span class="sd">    pydantic_model_class : class</span>
<span class="sd">        Pydantic model class (created using ``pydantic_construct_model_class()``).</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    class</span>
<span class="sd">        Constructed Pydantic model class</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Verify the arguments by instantiating the &#39;pydantic&#39; model</span>
    <span class="k">return</span> <span class="n">pydantic_model_class</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">_validate_plan_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="p">,</span> <span class="n">call_args</span><span class="p">,</span> <span class="n">call_kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate plan parameters based on parameter annotations.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    param_list: dict</span>
<span class="sd">        The list of parameters with annotations (including custom annotations if available).</span>
<span class="sd">    call_args: list</span>
<span class="sd">        &#39;args&#39; of the plan</span>
<span class="sd">    call_kwargs: dict</span>
<span class="sd">        &#39;kwargs&#39; of the plan</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Bound arguments of the called plan.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    Exception</span>
<span class="sd">        Exception is raised if the plan is invalid. The exception message contains</span>
<span class="sd">        information on the error.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Reconstruct &#39;inspect.Parameter&#39; parameters based on the parameter list</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">construct_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>

        <span class="c1"># Create signature based on the list of parameters</span>
        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>

        <span class="c1"># Verify the list of parameters based on signature.</span>
        <span class="n">bound_args</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">call_args</span><span class="p">,</span> <span class="o">**</span><span class="n">call_kwargs</span><span class="p">)</span>

        <span class="n">pydantic_model_class</span> <span class="o">=</span> <span class="n">pydantic_construct_model_class</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
        <span class="n">m</span> <span class="o">=</span> <span class="n">pydantic_validate_model</span><span class="p">(</span><span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">pydantic_model_class</span><span class="p">)</span>

        <span class="c1"># The next step: match types of the output value of the pydantic model with input</span>
        <span class="c1">#   types. &#39;Pydantic&#39; is converting types whenever possible, but we need precise</span>
        <span class="c1">#   type checking with a fiew exceptions</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">_compare_in_out</span><span class="p">(</span><span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">m</span><span class="o">.</span><span class="n">dict</span><span class="p">())</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Error in argument types: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

        <span class="c1"># Finally check the ranges of parameters that have min. and max. are defined</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="n">_check_ranges</span><span class="p">(</span><span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span><span class="p">,</span> <span class="n">param_list</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">success</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Argument values are out of range: </span><span class="si">{</span><span class="n">msg</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">raise</span>

    <span class="k">return</span> <span class="n">bound_args</span><span class="o">.</span><span class="n">arguments</span>


<span class="k">def</span> <span class="nf">filter_plan_description</span><span class="p">(</span><span class="n">plan_description</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Filter plan description from the list of existing plans (modify parameters</span>
<span class="sd">    ``plan[&quot;annotation&quot;][&quot;plans&quot;]`` and ``plan[&quot;annotation&quot;][&quot;devices&quot;]``)</span>
<span class="sd">    to include only plans and devices from the lists of allowed plans and allowed devices</span>
<span class="sd">    for the given group. Creates and returns a modified copy of the plan.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan_description: dict</span>
<span class="sd">        The dictionary containing plan description from the list of existing plans</span>
<span class="sd">    allowed_plans: dict or None</span>
<span class="sd">        The dictionary with allowed plans: key - plan name. If None, then</span>
<span class="sd">        all plans are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        plans are allowed.</span>
<span class="sd">    allowed_devices: dict or None</span>
<span class="sd">        The dictionary with allowed devices: key - device name. If None, then</span>
<span class="sd">        all devices are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        devices are allowed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The dictionary with modified plan description.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plan_description</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">plan_description</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">plan_description</span><span class="p">:</span>
        <span class="n">param_list</span> <span class="o">=</span> <span class="n">plan_description</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>

        <span class="c1"># Filter &#39;devices&#39; and &#39;plans&#39; entries of &#39;param_list&#39;. Leave only plans that are</span>
        <span class="c1">#   in &#39;allowed_plans&#39; and devices that are in &#39;allowed_devices&#39;</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">param_list</span><span class="p">:</span>
            <span class="k">if</span> <span class="s2">&quot;annotation&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">:</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">allowed_plans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;plans&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]):</span>
                    <span class="n">p_plans</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">][</span><span class="s2">&quot;plans&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">p_type</span> <span class="ow">in</span> <span class="n">p_plans</span><span class="p">:</span>
                        <span class="n">p_plans</span><span class="p">[</span><span class="n">p_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">p_plans</span><span class="p">[</span><span class="n">p_type</span><span class="p">]</span> <span class="k">if</span> <span class="n">_is_object_name_in_list</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">allowed_objects</span><span class="o">=</span><span class="n">allowed_plans</span><span class="p">)</span>
                        <span class="p">]</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">allowed_devices</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;devices&quot;</span> <span class="ow">in</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]):</span>
                    <span class="n">p_dev</span> <span class="o">=</span> <span class="n">p</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">][</span><span class="s2">&quot;devices&quot;</span><span class="p">]</span>
                    <span class="k">for</span> <span class="n">p_type</span> <span class="ow">in</span> <span class="n">p_dev</span><span class="p">:</span>
                        <span class="n">p_dev</span><span class="p">[</span><span class="n">p_type</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">p_dev</span><span class="p">[</span><span class="n">p_type</span><span class="p">]</span> <span class="k">if</span> <span class="n">_is_object_name_in_list</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">allowed_objects</span><span class="o">=</span><span class="n">allowed_devices</span><span class="p">)</span>
                        <span class="p">]</span>
    <span class="k">return</span> <span class="n">plan_description</span>


<span class="k">def</span> <span class="nf">_filter_allowed_plans</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Apply ``filter_plan_description`` to each plan in the list of allowed plans so that</span>
<span class="sd">    only the allowed plans and devices are left in the enums for ``plans`` and ``devices``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    allowed_plans: dict or None</span>
<span class="sd">        The dictionary with allowed plans: key - plan name. If None, then</span>
<span class="sd">        all plans are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        plans are allowed.</span>
<span class="sd">    allowed_devices: dict or None</span>
<span class="sd">        The dictionary with allowed devices: key - device name. If None, then</span>
<span class="sd">        all devices are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        devices are allowed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">       The modified copy of ``allowed_plans``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">filter_plan_description</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="o">=</span><span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="o">=</span><span class="n">allowed_devices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">allowed_plans</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>


<div class="viewcode-block" id="validate_plan"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.validate_plan.html#bluesky_queueserver.validate_plan">[docs]</a><span class="k">def</span> <span class="nf">validate_plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the dictionary of plan parameters. The function is called before the plan</span>
<span class="sd">    is added to the queue. The function can also be called by the client application</span>
<span class="sd">    to validate a plan before it is submitted to the queue. The dictionaries</span>
<span class="sd">    ``allowed_plans`` and ``allowed_devices`` must contain plans and devices</span>
<span class="sd">    that are allowed for the user and can be downloaded from the server.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan: dict</span>
<span class="sd">        The dictionary of plan parameters</span>
<span class="sd">    allowed_plans: dict or None</span>
<span class="sd">        The dictionary with allowed plans: key - plan name. If None, then</span>
<span class="sd">        all plans are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        plans are allowed.</span>
<span class="sd">    allowed_devices: dict or None</span>
<span class="sd">        The dictionary with allowed devices: key - device name. If None, then</span>
<span class="sd">        all devices are allowed (may change in the future). If ``{}`` then no</span>
<span class="sd">        devices are allowed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        Indicates if validation was successful (``True``) or failed (``False``).</span>
<span class="sd">    str</span>
<span class="sd">        Error message that explains the reason for validation failure. Empty string</span>
<span class="sd">        if validation is successful.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">success</span><span class="p">,</span> <span class="n">msg</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span> <span class="s2">&quot;&quot;</span>

        <span class="c1"># If there is no list of allowed plans (it is None), then consider the plan valid.</span>
        <span class="k">if</span> <span class="n">allowed_plans</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Verify that plan name is in the list of allowed plans</span>
            <span class="n">plan_name</span> <span class="o">=</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>

            <span class="k">if</span> <span class="n">plan_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">allowed_plans</span><span class="p">:</span>
                <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Plan &#39;</span><span class="si">{</span><span class="n">plan</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">]</span><span class="si">}</span><span class="s2">&#39; is not in the list of allowed plans.&quot;</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

            <span class="n">plan_description</span> <span class="o">=</span> <span class="n">allowed_plans</span><span class="p">[</span><span class="n">plan_name</span><span class="p">]</span>
            <span class="c1"># Plan description should contain only allowed plans and devices as parameters at</span>
            <span class="c1">#   this point. But run the filtering again just in case.</span>
            <span class="n">plan_description</span> <span class="o">=</span> <span class="n">filter_plan_description</span><span class="p">(</span>
                <span class="n">plan_description</span><span class="p">,</span> <span class="n">allowed_plans</span><span class="o">=</span><span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="o">=</span><span class="n">allowed_devices</span>
            <span class="p">)</span>
            <span class="n">param_list</span> <span class="o">=</span> <span class="n">plan_description</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span>

            <span class="n">call_args</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;args&quot;</span><span class="p">,</span> <span class="p">{})</span>
            <span class="n">call_kwargs</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;kwargs&quot;</span><span class="p">,</span> <span class="p">{})</span>

            <span class="n">_validate_plan_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="o">=</span><span class="n">param_list</span><span class="p">,</span> <span class="n">call_args</span><span class="o">=</span><span class="n">call_args</span><span class="p">,</span> <span class="n">call_kwargs</span><span class="o">=</span><span class="n">call_kwargs</span><span class="p">)</span>

        <span class="c1"># Check if supplied plan metadata is a dictionary or a list of dictionaries.</span>
        <span class="k">if</span> <span class="s2">&quot;meta&quot;</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">:</span>
            <span class="n">meta_msg</span> <span class="o">=</span> <span class="s2">&quot;Plan parameter &#39;meta&#39; must be a dictionary or a list of dictionaries&quot;</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">],</span> <span class="p">(</span><span class="nb">tuple</span><span class="p">,</span> <span class="nb">list</span><span class="p">)):</span>
                <span class="k">for</span> <span class="n">meta</span> <span class="ow">in</span> <span class="n">plan</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">]:</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">meta</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                        <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">meta_msg</span><span class="p">)</span>
            <span class="k">elif</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">plan</span><span class="p">[</span><span class="s2">&quot;meta&quot;</span><span class="p">],</span> <span class="nb">dict</span><span class="p">):</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="n">meta_msg</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">success</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Plan validation failed: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="si">}</span><span class="se">\n</span><span class="s2">Plan: </span><span class="si">{</span><span class="n">pprint</span><span class="o">.</span><span class="n">pformat</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="k">return</span> <span class="n">success</span><span class="p">,</span> <span class="n">msg</span></div>


<span class="k">def</span> <span class="nf">bind_plan_arguments</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">plan_args</span><span class="p">,</span> <span class="n">plan_kwargs</span><span class="p">,</span> <span class="n">plan_parameters</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Bind plan arguments given as ``plan_args`` and ``plan_kwargs`` to plan parameters.</span>
<span class="sd">    The function contains shortened version of code executed in ``validate_plan`` function.</span>
<span class="sd">    The dictionary of bound arguments can be accessed as ``bound_args.arguments``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan_args : list</span>
<span class="sd">        A list containing plan args</span>
<span class="sd">    plan_kwargs : dict</span>
<span class="sd">        A dictionary containing plan kwargs</span>
<span class="sd">    plan_parameters : dict</span>
<span class="sd">        A dictionary containing description of plan signature. The dictionary is the entry</span>
<span class="sd">        of ``allowed_plans`` dictionary (e.g. ``allowed_plans[&#39;count&#39;]``)</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    bound_args : inspect.BoundArgument</span>
<span class="sd">        Bound arguments of the plan.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    TypeError</span>
<span class="sd">        Arguments could not be bound to plan parameters (raised by ``inspect.Signature.bind``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">param_list</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">plan_parameters</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">])</span>
    <span class="n">parameters</span> <span class="o">=</span> <span class="n">construct_parameters</span><span class="p">(</span><span class="n">param_list</span><span class="p">)</span>
    <span class="c1"># Create signature based on the list of parameters</span>
    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Signature</span><span class="p">(</span><span class="n">parameters</span><span class="p">)</span>
    <span class="c1"># Verify the list of parameters based on signature.</span>
    <span class="n">bound_args</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="o">*</span><span class="n">plan_args</span><span class="p">,</span> <span class="o">**</span><span class="n">plan_kwargs</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">bound_args</span>


<span class="k">def</span> <span class="nf">_parse_docstring</span><span class="p">(</span><span class="n">docstring</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Parse docstring of a function using ``numpydoc``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    docstring: str or None</span>
<span class="sd">        Docstring to be parsed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary that contains the extracted data. Returns ``{}`` if ``docstring`` is ``None``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">doc_annotation</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">docstring</span><span class="p">:</span>

        <span class="c1"># Make sure that the first line of the docstring is properly indented, otherwise it is</span>
        <span class="c1">#   incorrectly parsed by &#39;numpydoc&#39; (new line is optional).</span>
        <span class="c1"># Find the minimum</span>
        <span class="n">ds_split</span> <span class="o">=</span> <span class="n">docstring</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">ds_split</span> <span class="o">=</span> <span class="n">ds_split</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>  <span class="c1"># Ignore the first line</span>
        <span class="n">n_indent</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">ds_split</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>  <span class="c1"># Don&#39;t process empty strings (that contain only spaces)</span>
                <span class="n">n</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">ch</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">s</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">ch</span> <span class="o">!=</span> <span class="s2">&quot; &quot;</span><span class="p">:</span>
                        <span class="n">n</span> <span class="o">=</span> <span class="n">i</span>
                        <span class="k">break</span>
                <span class="k">if</span> <span class="n">n</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">n_indent</span> <span class="o">=</span> <span class="n">n</span> <span class="k">if</span> <span class="n">n_indent</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">else</span> <span class="nb">min</span><span class="p">(</span><span class="n">n</span><span class="p">,</span> <span class="n">n_indent</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">n_indent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">docstring</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">n_indent</span> <span class="o">+</span> <span class="n">docstring</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

        <span class="n">doc</span> <span class="o">=</span> <span class="n">NumpyDocString</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>

        <span class="n">summary</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;Summary&quot;</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">summary</span><span class="p">:</span>
            <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">summary</span><span class="p">)</span>

        <span class="n">params</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;Parameters&quot;</span><span class="p">]</span>
        <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">desc</span>
            <span class="k">if</span> <span class="s2">&quot;:&quot;</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">n</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s2">&quot;:&quot;</span><span class="p">)</span>
                <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="p">[:</span><span class="n">n</span><span class="p">]</span>
            <span class="n">names</span> <span class="o">=</span> <span class="n">names</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
            <span class="c1"># Remove &#39;*&#39; (should not be part of the name, but used in some plan annotations)</span>
            <span class="n">names</span> <span class="o">=</span> <span class="p">[</span><span class="n">_</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">names</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">name</span> <span class="ow">in</span> <span class="n">names</span><span class="p">:</span>
                <span class="n">name</span> <span class="o">=</span> <span class="n">name</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span>
                <span class="k">if</span> <span class="n">name</span><span class="p">:</span>
                    <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
                    <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">name</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">desc</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">params_to_str</span><span class="p">(</span><span class="n">params</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Assembles return type info into one string. This joins the description</span>
<span class="sd">            of return parameters into one string.</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="n">p_list</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">params</span><span class="p">:</span>
                <span class="n">s</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
                <span class="n">indent</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot; : &quot;</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">or</span> <span class="n">p</span><span class="o">.</span><span class="n">type</span><span class="p">)</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">desc</span><span class="p">:</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>
                    <span class="n">indent</span> <span class="o">=</span> <span class="mi">4</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">desc</span><span class="p">:</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">desc</span>
                    <span class="n">lines</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot; &quot;</span> <span class="o">*</span> <span class="n">indent</span> <span class="o">+</span> <span class="n">_</span> <span class="k">if</span> <span class="n">_</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span> <span class="k">else</span> <span class="n">_</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">lines</span><span class="p">]</span>
                    <span class="n">s</span> <span class="o">+=</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">lines</span><span class="p">)</span>
                <span class="n">p_list</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
            <span class="k">return</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">p_list</span><span class="p">)</span>

        <span class="n">returns</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;Returns&quot;</span><span class="p">]</span>
        <span class="n">yields</span> <span class="o">=</span> <span class="n">doc</span><span class="p">[</span><span class="s2">&quot;Yields&quot;</span><span class="p">]</span>
        <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;returns&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">p_str</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">yields</span><span class="p">:</span>
            <span class="n">p_str</span> <span class="o">=</span> <span class="n">params_to_str</span><span class="p">(</span><span class="n">yields</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">returns</span><span class="p">:</span>
            <span class="n">p_str</span> <span class="o">=</span> <span class="n">params_to_str</span><span class="p">(</span><span class="n">returns</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">p_str</span><span class="p">:</span>
            <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;returns&quot;</span><span class="p">][</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">p_str</span>

    <span class="k">return</span> <span class="n">doc_annotation</span>


<span class="k">def</span> <span class="nf">_process_plan</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">,</span> <span class="n">existing_plans</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Returns parameters of a plan. The function accepts callable object that implements the plan</span>
<span class="sd">    and returns the dictionary with descriptions of the plan and plan parameters. The function</span>
<span class="sd">    extracts the parameters and their annotations from the plan signature and plan and parameter</span>
<span class="sd">    descriptions from the docstring. If the plan is decorated with``parameter_annotation_decorator``,</span>
<span class="sd">    then the specifications of plan and parameter descriptions and parameter annotations passed</span>
<span class="sd">    to the decorator override the descriptions from the docstring and Python parameter annotations</span>
<span class="sd">    from the function header.</span>

<span class="sd">    Limitation on the support types of the plan parameters and the default values that could be</span>
<span class="sd">    used in function signatures. Parameter types must be native Python types (such as ``int``,</span>
<span class="sd">    ``float``, ``str``, etc.) or generic types based on Python native types</span>
<span class="sd">    (``typing.List[typing.Union[int, str]]``). The operation of recreating the type from its</span>
<span class="sd">    string representation using ``eval`` and the namespace with imported ``typing`` module</span>
<span class="sd">    and ``NoneType`` type should be successful. The default values are reconstructed using</span>
<span class="sd">    ``ast.literal_eval`` and the operation ``ast.literal_eval(f&quot;{v!r}&quot;)`` must run successfully.</span>

<span class="sd">    The description of the plan is represented as a Python dictionary in the following format</span>
<span class="sd">    (all elements are optional unless they are labeled as REQUIRED):</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        {</span>
<span class="sd">            &quot;name&quot;: &lt;plan name&gt;,  # REQUIRED</span>
<span class="sd">            &quot;module&quot;: &lt;module name&gt;,  # whenever available</span>
<span class="sd">            &quot;description&quot;: &lt;plan description (multiline text)&gt;,</span>
<span class="sd">            &quot;properties&quot;: {  # REQUIRED, may be empty</span>
<span class="sd">                &quot;is_generator&quot;: &lt;boolean that indicates if this is a generator function&gt;</span>
<span class="sd">            },</span>
<span class="sd">            &quot;parameters&quot;: [  # REQUIRED, may be empty</span>
<span class="sd">                &lt;param_name_1&gt;: {</span>
<span class="sd">                     &quot;name&quot;: &lt;parameter name&gt;,  # REQUIRED</span>
<span class="sd">                     &quot;description&quot;: &lt;parameter description&gt;,</span>
<span class="sd">                     # For values of the &#39;kind&#39; see documentation for &#39;inspect.Parameter&#39;</span>
<span class="sd">                     &quot;kind&quot;: {  # REQUIRED</span>
<span class="sd">                         &quot;name&quot;: &lt;string representation&gt;,</span>
<span class="sd">                         &quot;value&quot;: &lt;integer representation&gt;,</span>
<span class="sd">                     },</span>
<span class="sd">                     &quot;annotation&quot;: {</span>
<span class="sd">                         # &#39;type&#39; is REQUIRED if annotation is present</span>
<span class="sd">                         &quot;type&quot;: &lt;parameter type represented as a string&gt;,</span>
<span class="sd">                         # Enums for devices, plans and simple enums are in the same format as</span>
<span class="sd">                         #   the &#39;parameter_annotation_decorator&#39;.</span>
<span class="sd">                         &quot;devices&quot;: &lt;dict of device types (lists of device names)&gt;,</span>
<span class="sd">                         &quot;plans&quot;: &lt;dict of plan types (lists of plan names)&gt;,</span>
<span class="sd">                         &quot;enums&quot;: &lt;dict of enum types (lists of strings)&gt;,</span>
<span class="sd">                     }</span>
<span class="sd">                     &quot;default&quot;: &lt;string representation of the default value&gt;,</span>
<span class="sd">                     &quot;default_defined_in_decorator&quot;: boolean,  # True if the default value is defined</span>
<span class="sd">                                                              # in decorator, otherwise False/not set</span>
<span class="sd">                     &quot;min&quot;: &lt;string representing int or float&gt;,</span>
<span class="sd">                     &quot;max&quot;: &lt;string representing int or float&gt;,</span>
<span class="sd">                     &quot;step&quot;: &lt;string representing int or float&gt;,</span>
<span class="sd">                }</span>
<span class="sd">                &lt;parameter_name_2&gt;: ...</span>
<span class="sd">                &lt;parameter_name_3&gt;: ...</span>
<span class="sd">                ...</span>
<span class="sd">            ]</span>
<span class="sd">        }</span>

<span class="sd">    .. note::</span>

<span class="sd">        This function does not expand built-in lists of devices or add subdevices for devices with</span>
<span class="sd">        specified length if those are used in the plan annotation decorator. Call ``expand_plan_description()``</span>
<span class="sd">        for each plan description in order for the lists to be expanded based on the current list of</span>
<span class="sd">        available or existing devices.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plan: callable</span>
<span class="sd">        Reference to the function implementing the plan</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        Prepared dictionary of existing devices (returned by the function ``_prepare_devices``.</span>
<span class="sd">        The dictionary is used to create lists of devices for built-in device lists ``AllDevicesList``,</span>
<span class="sd">        ``AllDetectorsList``, ``AllMotorsList``, ``AllFlyersList``. If it is known that built-in plans</span>
<span class="sd">        are not used, then empty dictionary can be passed instead of the list of existing devices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary with plan parameters.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    ValueError</span>
<span class="sd">        Error occurred while creating plan description.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">convert_annotation_to_string</span><span class="p">(</span><span class="n">annotation</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Ignore the type if it can not be properly reconstructed using &#39;eval&#39;</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">ns</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;typing&quot;</span><span class="p">:</span> <span class="n">typing</span><span class="p">,</span> <span class="s2">&quot;NoneType&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="kc">None</span><span class="p">)}</span>

        <span class="c1"># This will work for generic types like &#39;typing.List[int]&#39;</span>
        <span class="n">a_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">annotation</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="c1"># The following takes care of Python base types, such as &#39;int&#39;, &#39;float&#39;</span>
        <span class="c1">#   expressed as &quot;&lt;class &#39;int&#39;&gt;&quot;, but have valid &#39;__name__&#39; attribute</span>
        <span class="c1">#   containing type name, such as &quot;int&quot;.</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">annotation</span><span class="p">,</span> <span class="s2">&quot;__name__&quot;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;^&lt;.*&gt;$&quot;</span><span class="p">,</span> <span class="n">a_str</span><span class="p">):</span>
            <span class="c1"># Note, that starting with Python 3.10 parameter annotation always have</span>
            <span class="c1">#   &#39;__name__&#39;, which is meaningless for types other than base types.</span>
            <span class="n">a_str</span> <span class="o">=</span> <span class="n">annotation</span><span class="o">.</span><span class="vm">__name__</span>

        <span class="c1"># Verify if the type could be recreated by evaluating the string during validation.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">an</span> <span class="o">=</span> <span class="nb">eval</span><span class="p">(</span><span class="n">a_str</span><span class="p">,</span> <span class="n">ns</span><span class="p">,</span> <span class="n">ns</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">an</span> <span class="o">!=</span> <span class="n">annotation</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">Exception</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># Ignore the type if it can not be recreated.</span>
            <span class="n">a_str</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">a_str</span>

    <span class="k">def</span> <span class="nf">convert_expression_to_string</span><span class="p">(</span><span class="n">value</span><span class="p">,</span> <span class="n">expression_role</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Raise &#39;ValueError&#39; if the string representation of the value can not be evaluated</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">role_str</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot; of </span><span class="si">{</span><span class="n">expression_role</span><span class="si">}</span><span class="s2">&quot;</span> <span class="k">if</span> <span class="n">expression_role</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>

        <span class="n">s_value</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">value</span><span class="si">!r}</span><span class="s2">&quot;</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">ast</span><span class="o">.</span><span class="n">literal_eval</span><span class="p">(</span><span class="n">s_value</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If default value can not be accepted, then the plan is considered invalid.</span>
            <span class="c1">#    Processing should be interrupted.</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;The expression (</span><span class="si">{</span><span class="n">s_value</span><span class="si">}</span><span class="s2">) can not be evaluated with &#39;ast.literal_eval()&#39;: &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;unsupported type</span><span class="si">{</span><span class="n">role_str</span><span class="si">}</span><span class="s2">.&quot;</span>
            <span class="p">)</span>
        <span class="k">return</span> <span class="n">s_value</span>

    <span class="k">def</span> <span class="nf">assemble_custom_annotation</span><span class="p">(</span><span class="n">parameter</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">existing_plans</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Assemble annotation from parameters of the decorator.</span>
<span class="sd">        Returns ``None`` if there is no annotation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="k">if</span> <span class="s2">&quot;annotation&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parameter</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span>

        <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;type&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">parameter</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="s2">&quot;enums&quot;</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">keys</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">parameter</span><span class="p">:</span>
                <span class="n">annotation</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">parameter</span><span class="p">[</span><span class="n">k</span><span class="p">])</span>

        <span class="n">annotation</span> <span class="o">=</span> <span class="n">_expand_parameter_annotation</span><span class="p">(</span>
            <span class="n">annotation</span><span class="p">,</span> <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span> <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span>
        <span class="p">)</span>

        <span class="k">return</span> <span class="n">annotation</span>

    <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>
    <span class="n">docstring</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="s2">&quot;__doc__&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">param_annotation</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">plan</span><span class="p">,</span> <span class="s2">&quot;_custom_parameter_annotation_&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
    <span class="n">doc_annotation</span> <span class="o">=</span> <span class="n">_parse_docstring</span><span class="p">(</span><span class="n">docstring</span><span class="p">)</span>

    <span class="c1"># Returned value: dictionary with fully processed plan description</span>
    <span class="n">ret</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">plan</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{},</span> <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">[]}</span>

    <span class="n">module_name</span> <span class="o">=</span> <span class="n">plan</span><span class="o">.</span><span class="vm">__module__</span>
    <span class="k">if</span> <span class="n">module_name</span> <span class="o">!=</span> <span class="s2">&quot;&lt;run_path&gt;&quot;</span><span class="p">:</span>
        <span class="n">ret</span><span class="o">.</span><span class="n">update</span><span class="p">({</span><span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="n">module_name</span><span class="p">})</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Properties</span>
        <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;properties&quot;</span><span class="p">][</span><span class="s2">&quot;is_generator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span> <span class="ow">or</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgenerator</span><span class="p">(</span><span class="n">plan</span><span class="p">)</span>

        <span class="c1"># Plan description</span>
        <span class="n">desc</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">param_annotation</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">desc</span> <span class="ow">and</span> <span class="n">doc_annotation</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">=</span> <span class="n">doc_annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>

        <span class="c1"># Function parameters</span>
        <span class="n">use_docstring</span> <span class="o">=</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">doc_annotation</span>
        <span class="n">use_custom</span> <span class="o">=</span> <span class="n">param_annotation</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">param_annotation</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
            <span class="n">working_dict</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">}</span>
            <span class="n">ret</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">working_dict</span><span class="p">)</span>

            <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;kind&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;name&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;value&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">kind</span><span class="o">.</span><span class="n">value</span><span class="p">}</span>

            <span class="c1"># Parameter description (attempt to get it from the decorator, then from docstring)</span>
            <span class="n">desc</span><span class="p">,</span> <span class="n">annotation</span><span class="p">,</span> <span class="n">default</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">vmin</span><span class="p">,</span> <span class="n">vmax</span><span class="p">,</span> <span class="n">step</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
            <span class="n">default_defined_in_decorator</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">use_custom</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]):</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                <span class="c1"># Copy &#39;convert_plan_names&#39; and &#39;convert_device_names&#39; if they exist</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;convert_plan_names&quot;</span><span class="p">,</span> <span class="s2">&quot;convert_device_names&quot;</span><span class="p">):</span>
                    <span class="k">if</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]:</span>
                        <span class="n">working_dict</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">][</span><span class="n">k</span><span class="p">]</span>

                <span class="n">annotation</span> <span class="o">=</span> <span class="n">assemble_custom_annotation</span><span class="p">(</span>
                    <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">],</span>
                    <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span><span class="p">,</span>
                    <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span>
                <span class="p">)</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">_</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">default</span> <span class="o">=</span> <span class="n">_</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">default</span> <span class="o">=</span> <span class="n">convert_expression_to_string</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;default value in decorator&quot;</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">default</span><span class="p">:</span>
                        <span class="n">default_defined_in_decorator</span> <span class="o">=</span> <span class="kc">True</span>

                    <span class="n">_</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">_</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vmin</span> <span class="o">=</span> <span class="n">convert_expression_to_string</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;min value in decorator&quot;</span><span class="p">)</span>

                    <span class="n">_</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

                    <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="n">_</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">vmax</span> <span class="o">=</span> <span class="n">convert_expression_to_string</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;max value in decorator&quot;</span><span class="p">)</span>

                    <span class="n">_</span> <span class="o">=</span> <span class="n">param_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="n">step</span> <span class="o">=</span> <span class="n">_</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">step</span> <span class="o">=</span> <span class="n">convert_expression_to_string</span><span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;step value in decorator&quot;</span><span class="p">)</span>

                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="ow">not</span> <span class="n">desc</span> <span class="ow">and</span> <span class="n">use_docstring</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span> <span class="ow">in</span> <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]):</span>
                <span class="n">desc</span> <span class="o">=</span> <span class="n">doc_annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">annotation</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">annotation</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="n">annotation</span> <span class="o">=</span> <span class="n">convert_annotation_to_string</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">annotation</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
                    <span class="c1"># The case when annotation does exist (otherwise it is None)</span>
                    <span class="n">annotation</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="n">annotation</span><span class="p">}</span>
            <span class="k">if</span> <span class="n">default</span> <span class="ow">and</span> <span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">:</span>
                <span class="c1"># The default value in the decorator overrides the default value in the header,</span>
                <span class="c1">#   not replace it. Therefore the default value is required in the header if</span>
                <span class="c1">#   one is specified in the decorator.</span>
                <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Missing default value for the parameter &#39;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; in the plan signature: &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;The default value </span><span class="si">{</span><span class="n">default</span><span class="si">}</span><span class="s2"> is specified in the annotation decorator, &quot;</span>
                    <span class="sa">f</span><span class="s2">&quot;there for a default value is required in the plan header.&quot;</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">default</span> <span class="ow">and</span> <span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">default</span> <span class="ow">is</span> <span class="ow">not</span> <span class="n">inspect</span><span class="o">.</span><span class="n">Parameter</span><span class="o">.</span><span class="n">empty</span><span class="p">):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">default</span> <span class="o">=</span> <span class="n">convert_expression_to_string</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">default</span><span class="p">,</span> <span class="n">expression_role</span><span class="o">=</span><span class="s2">&quot;default value&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Parameter &#39;</span><span class="si">{</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">desc</span><span class="p">:</span>
                <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>

            <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
                <span class="c1"># Verify that the encoded type could be decoded (raises an exception if fails)</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">convert_plan_names</span><span class="p">,</span> <span class="n">convert_device_names</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_process_annotation</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>
                <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;annotation&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">annotation</span>

                <span class="c1"># Set the following parameters True only if they do not already exist (ignore if False)</span>
                <span class="k">if</span> <span class="n">convert_plan_names</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;convert_plan_names&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">working_dict</span><span class="p">):</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;convert_plan_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>
                <span class="k">if</span> <span class="n">convert_device_names</span> <span class="ow">and</span> <span class="p">(</span><span class="s2">&quot;convert_device_names&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">working_dict</span><span class="p">):</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;convert_device_names&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="k">if</span> <span class="n">default</span><span class="p">:</span>
                <span class="c1"># Verify that the encoded representation of the default can be decoded.</span>
                <span class="n">_process_default_value</span><span class="p">(</span><span class="n">default</span><span class="p">)</span>  <span class="c1"># May raises exception</span>
                <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;default&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">default</span>
                <span class="k">if</span> <span class="n">default_defined_in_decorator</span><span class="p">:</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;default_defined_in_decorator&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="kc">True</span>

            <span class="c1"># &#39;min&#39;, &#39;max&#39; and &#39;step&#39; (may exist only in decorator)</span>
            <span class="k">if</span> <span class="n">vmin</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># Attempt to convert to number (use the same function as during validation)</span>
                    <span class="n">vmin</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">vmin</span><span class="p">)</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;min&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vmin</span><span class="si">}</span><span class="s2">&quot;</span>  <span class="c1"># Save as a string</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process min. value: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">vmax</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">vmax</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">vmax</span><span class="p">)</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;max&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">vmax</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process max. value: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">step</span> <span class="o">=</span> <span class="n">_convert_str_to_number</span><span class="p">(</span><span class="n">step</span><span class="p">)</span>
                    <span class="n">working_dict</span><span class="p">[</span><span class="s2">&quot;step&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">step</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to process step value: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create description of plan &#39;</span><span class="si">{</span><span class="n">plan</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="n">ex</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>

    <span class="k">return</span> <span class="n">ret</span>


<span class="k">def</span> <span class="nf">_prepare_plans</span><span class="p">(</span><span class="n">plans</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare dictionary of existing plans for saving to YAML file.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    plans : dict</span>
<span class="sd">        Dictionary of plans extracted from the workspace</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        Prepared dictionary of existing devices (returned by the function ``_prepare_devices``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary that maps plan names to plan descriptions</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plan_names</span> <span class="o">=</span> <span class="nb">set</span><span class="p">(</span><span class="n">plans</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
    <span class="k">return</span> <span class="p">{</span>
        <span class="n">k</span><span class="p">:</span> <span class="n">_process_plan</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span> <span class="n">existing_plans</span><span class="o">=</span><span class="n">plan_names</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">plans</span><span class="o">.</span><span class="n">items</span><span class="p">()</span>
    <span class="p">}</span>


<span class="k">def</span> <span class="nf">_prepare_devices</span><span class="p">(</span><span class="n">devices</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">max_depth</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">ignore_all_subdevices_if_one_fails</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">expand_areadetectors</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Prepare dictionary of existing devices for saving to YAML file.</span>
<span class="sd">    ``max_depth`` is the maximum depth for the components. The default value (50)</span>
<span class="sd">    is a very large number.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    devices: dict</span>
<span class="sd">        Dictionary of devices from the namespace (key - device name, value - reference</span>
<span class="sd">        to the device object).</span>
<span class="sd">    max_depth: int</span>
<span class="sd">        Maximum depth for the device search: 0 - infinite depth, 1 - only top level</span>
<span class="sd">        devices, 2 - device and subdevices etc.</span>
<span class="sd">    ignore_all_subdevices_if_one_fails: bool</span>
<span class="sd">        Ignore all components of devices if at least one component (PVs) can not</span>
<span class="sd">        be accessed. It saves a lot of time to ignore all components, since</span>
<span class="sd">        stale code may contain devices with many components with non-existing PVs</span>
<span class="sd">        and respective timeout may amount to substantial waiting time.</span>
<span class="sd">    expand_areadetectors: bool</span>
<span class="sd">        Find subdevices of areadetectors. It may take significant time to expand an</span>
<span class="sd">        areadetector and it is unlikely that the areadetector subdevices should be</span>
<span class="sd">        accessed via plan parameters.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        List of existing devices (tree of devices and subdevices).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">max_depth</span> <span class="o">=</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_depth</span><span class="p">)</span>  <span class="c1"># must be &gt;= 0</span>

    <span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">protocols</span>
    <span class="kn">from</span> <span class="nn">ophyd.areadetector</span> <span class="kn">import</span> <span class="n">ADBase</span>

    <span class="k">def</span> <span class="nf">get_device_params</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">{</span>
            <span class="s2">&quot;is_readable&quot;</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">protocols</span><span class="o">.</span><span class="n">Readable</span><span class="p">),</span>
            <span class="s2">&quot;is_movable&quot;</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">protocols</span><span class="o">.</span><span class="n">Movable</span><span class="p">),</span>
            <span class="s2">&quot;is_flyable&quot;</span><span class="p">:</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">protocols</span><span class="o">.</span><span class="n">Flyable</span><span class="p">),</span>
            <span class="s2">&quot;classname&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span>
            <span class="s2">&quot;module&quot;</span><span class="p">:</span> <span class="nb">type</span><span class="p">(</span><span class="n">device</span><span class="p">)</span><span class="o">.</span><span class="vm">__module__</span><span class="p">,</span>
        <span class="p">}</span>

    <span class="k">def</span> <span class="nf">get_device_component_names</span><span class="p">(</span><span class="n">device</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="s2">&quot;component_names&quot;</span><span class="p">):</span>
            <span class="n">component_names</span> <span class="o">=</span> <span class="n">device</span><span class="o">.</span><span class="n">component_names</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">component_names</span><span class="p">,</span> <span class="n">Iterable</span><span class="p">):</span>
                <span class="n">component_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">component_names</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">return</span> <span class="n">component_names</span>

    <span class="k">def</span> <span class="nf">create_device_description</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">description</span> <span class="o">=</span> <span class="n">get_device_params</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">comps</span> <span class="o">=</span> <span class="n">get_device_component_names</span><span class="p">(</span><span class="n">device</span><span class="p">)</span>
        <span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="n">is_areadetector</span> <span class="o">=</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">ADBase</span><span class="p">)</span>
        <span class="n">expand</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">is_areadetector</span> <span class="ow">or</span> <span class="n">expand_areadetectors</span>

        <span class="k">if</span> <span class="n">expand</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="n">max_depth</span> <span class="ow">or</span> <span class="p">(</span><span class="n">depth</span> <span class="o">&lt;</span> <span class="n">max_depth</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)):</span>
            <span class="n">ignore_subdevices</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">for</span> <span class="n">comp_name</span> <span class="ow">in</span> <span class="n">comps</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">):</span>
                        <span class="n">c</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">device</span><span class="p">,</span> <span class="n">comp_name</span><span class="p">)</span>
                        <span class="n">desc</span> <span class="o">=</span> <span class="n">create_device_description</span><span class="p">(</span><span class="n">c</span><span class="p">,</span> <span class="n">device_name</span> <span class="o">+</span> <span class="s2">&quot;.&quot;</span> <span class="o">+</span> <span class="n">comp_name</span><span class="p">,</span> <span class="n">depth</span><span class="o">=</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="n">components</span><span class="p">[</span><span class="n">comp_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                    <span class="n">ignore_subdevices</span> <span class="o">=</span> <span class="n">ignore_all_subdevices_if_one_fails</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                        <span class="sa">f</span><span class="s2">&quot;Device &#39;%s&#39;: component </span><span class="si">{</span><span class="n">comp_name</span><span class="si">!r}</span><span class="s2"> can not be processed: %s&quot;</span><span class="p">,</span> <span class="n">device_name</span><span class="p">,</span> <span class="n">ex</span>
                    <span class="p">)</span>
                <span class="k">if</span> <span class="n">ignore_subdevices</span><span class="p">:</span>
                    <span class="n">components</span> <span class="o">=</span> <span class="p">{}</span>  <span class="c1"># Ignore all components of the subdevice</span>
                    <span class="k">break</span>
            <span class="k">if</span> <span class="n">components</span><span class="p">:</span>
                <span class="n">description</span><span class="p">[</span><span class="s2">&quot;components&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">components</span>

        <span class="k">return</span> <span class="n">description</span>

    <span class="k">return</span> <span class="p">{</span><span class="n">k</span><span class="p">:</span> <span class="n">create_device_description</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">k</span><span class="p">)</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">devices</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>


<span class="k">def</span> <span class="nf">existing_plans_and_devices_from_nspace</span><span class="p">(</span><span class="o">*</span><span class="p">,</span> <span class="n">nspace</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate lists of existing plans and devices from namespace. The namespace</span>
<span class="sd">    must be in the form returned by ``load_worker_startup_code()``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    nspace : dict</span>
<span class="sd">        Namespace that contains plans and devices</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    existing_plans : dict</span>
<span class="sd">        Dictionary of descriptions of existing plans</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        Dictionary of descriptions of existing devices</span>
<span class="sd">    plans_in_nspace : dict</span>
<span class="sd">        Dictionary of plans in namespace</span>
<span class="sd">    devices_in_nspace : dict</span>
<span class="sd">        Dictionary of devices in namespace</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">plans_in_nspace</span> <span class="o">=</span> <span class="n">plans_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">)</span>
    <span class="n">devices_in_nspace</span> <span class="o">=</span> <span class="n">devices_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="p">)</span>

    <span class="n">existing_devices</span> <span class="o">=</span> <span class="n">_prepare_devices</span><span class="p">(</span><span class="n">devices_in_nspace</span><span class="p">)</span>
    <span class="n">existing_plans</span> <span class="o">=</span> <span class="n">_prepare_plans</span><span class="p">(</span><span class="n">plans_in_nspace</span><span class="p">,</span> <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">existing_plans</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">,</span> <span class="n">plans_in_nspace</span><span class="p">,</span> <span class="n">devices_in_nspace</span>


<span class="k">def</span> <span class="nf">save_existing_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">existing_plans</span><span class="p">,</span>
    <span class="n">existing_devices</span><span class="p">,</span>
    <span class="n">file_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Save dictionaries of existing plans and devices to YAML file. The dictionaries of existing</span>
<span class="sd">    plans and devices must be in the form returned by ``existing_plans_and_devices_from_nspace``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    existing_plans : dict</span>
<span class="sd">        dictionary of existing plans (key - plan name, value - plan description)</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        dictionary of existing devices (key - device name, value - device description)</span>
<span class="sd">    startup_script_path : str or None</span>
<span class="sd">        name of the startup script</span>
<span class="sd">    file_dir : str or None</span>
<span class="sd">        path to the directory where the file is to be created. None - create file in current directory.</span>
<span class="sd">    file_name : str</span>
<span class="sd">        name of the output YAML file, None - default file name is used</span>
<span class="sd">    overwrite : boolean</span>
<span class="sd">        overwrite the file if it already exists</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">existing_plans_and_devices</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s2">&quot;existing_plans&quot;</span><span class="p">:</span> <span class="n">existing_plans</span><span class="p">,</span>
        <span class="s2">&quot;existing_devices&quot;</span><span class="p">:</span> <span class="n">existing_devices</span><span class="p">,</span>
    <span class="p">}</span>

    <span class="n">file_path</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">file_dir</span><span class="p">,</span> <span class="n">file_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">file_path</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">file_path</span><span class="si">}</span><span class="s2">&#39; already exists. File overwriting is disabled.&quot;</span><span class="p">)</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file_path</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="n">stream</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;# This file is automatically generated. Edit at your own risk.</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">existing_plans_and_devices</span><span class="p">,</span> <span class="n">stream</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">gen_list_of_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">startup_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">startup_module_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">startup_script_path</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_dir</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">file_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate the list of plans and devices from a collection of startup files, python module or</span>
<span class="sd">    a script. Only one source of startup code should be specified, otherwise an exception will be</span>
<span class="sd">    raised.</span>

<span class="sd">    If ``file_name`` is specified, it is used as a name for the output file, otherwise</span>
<span class="sd">    the default file name ``existing_plans_and_devices.yaml`` is used. The file will be saved</span>
<span class="sd">    to ``file_dir`` or current directory if ``file_dir`` is not specified or ``None``.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    startup_dir: str or None</span>
<span class="sd">        path to the directory that contains a collection of startup files (IPython-style)</span>
<span class="sd">    startup_module_name: str or None</span>
<span class="sd">        name of the startup module to load</span>
<span class="sd">    startup_script_path: str or None</span>
<span class="sd">        name of the startup script</span>
<span class="sd">    file_dir: str or None</span>
<span class="sd">        path to the directory where the file is to be created. None - create file in current directory.</span>
<span class="sd">    file_name: str</span>
<span class="sd">        name of the output YAML file, None - default file name is used</span>
<span class="sd">    overwrite: boolean</span>
<span class="sd">        overwrite the file if it already exists</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    None</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    RuntimeError</span>
<span class="sd">        Error occurred while creating or saving the lists.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">.profile_tools</span> <span class="kn">import</span> <span class="n">set_re_worker_active</span><span class="p">,</span> <span class="n">clear_re_worker_active</span>

    <span class="n">file_name</span> <span class="o">=</span> <span class="n">file_name</span> <span class="ow">or</span> <span class="s2">&quot;existing_plans_and_devices.yaml&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">file_dir</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">getcwd</span><span class="p">()</span>

        <span class="k">if</span> <span class="nb">sum</span><span class="p">([</span><span class="n">_</span> <span class="ow">is</span> <span class="kc">None</span> <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="p">[</span><span class="n">startup_dir</span><span class="p">,</span> <span class="n">startup_module_name</span><span class="p">,</span> <span class="n">startup_script_path</span><span class="p">]])</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Source of the startup code was not specified or multiple sources were specified.&quot;</span><span class="p">)</span>

        <span class="n">set_re_worker_active</span><span class="p">()</span>

        <span class="n">nspace</span> <span class="o">=</span> <span class="n">load_worker_startup_code</span><span class="p">(</span>
            <span class="n">startup_dir</span><span class="o">=</span><span class="n">startup_dir</span><span class="p">,</span>
            <span class="n">startup_module_name</span><span class="o">=</span><span class="n">startup_module_name</span><span class="p">,</span>
            <span class="n">startup_script_path</span><span class="o">=</span><span class="n">startup_script_path</span><span class="p">,</span>
        <span class="p">)</span>

        <span class="n">existing_plans</span><span class="p">,</span> <span class="n">existing_devices</span><span class="p">,</span> <span class="n">_</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">existing_plans_and_devices_from_nspace</span><span class="p">(</span><span class="n">nspace</span><span class="o">=</span><span class="n">nspace</span><span class="p">)</span>

        <span class="n">save_existing_plans_and_devices</span><span class="p">(</span>
            <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span><span class="p">,</span>
            <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span>
            <span class="n">file_dir</span><span class="o">=</span><span class="n">file_dir</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to create the list of plans and devices: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span> <span class="nn">ex</span>

    <span class="k">finally</span><span class="p">:</span>
        <span class="n">clear_re_worker_active</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">gen_list_of_plans_and_devices_cli</span><span class="p">():</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    &#39;qserver-list-plans-devices&#39;</span>
<span class="sd">    CLI tool for generating the list of existing plans and devices based on profile collection.</span>
<span class="sd">    The tool is supposed to be called as &#39;qserver-list-plans-devices&#39; from command line.</span>
<span class="sd">    The function will ALWAYS overwrite the existing list of plans and devices (the list</span>
<span class="sd">    is automatically generated, so overwriting (updating) should be a safe operation that doesn&#39;t</span>
<span class="sd">    lead to loss configuration data.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">basicConfig</span><span class="p">(</span><span class="n">level</span><span class="o">=</span><span class="n">logging</span><span class="o">.</span><span class="n">WARNING</span><span class="p">)</span>
    <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="s2">&quot;bluesky_queueserver&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">setLevel</span><span class="p">(</span><span class="s2">&quot;INFO&quot;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">formatter</span><span class="p">(</span><span class="n">prog</span><span class="p">):</span>
        <span class="c1"># Set maximum width such that printed help mostly fits in the RTD theme code block (documentation).</span>
        <span class="k">return</span> <span class="n">argparse</span><span class="o">.</span><span class="n">RawDescriptionHelpFormatter</span><span class="p">(</span><span class="n">prog</span><span class="p">,</span> <span class="n">max_help_position</span><span class="o">=</span><span class="mi">20</span><span class="p">,</span> <span class="n">width</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>

    <span class="n">parser</span> <span class="o">=</span> <span class="n">argparse</span><span class="o">.</span><span class="n">ArgumentParser</span><span class="p">(</span>
        <span class="n">description</span><span class="o">=</span><span class="s2">&quot;Bluesky-QServer:</span><span class="se">\n</span><span class="s2">CLI tool for generating the list of plans and devices &quot;</span>
        <span class="sa">f</span><span class="s2">&quot;from beamline startup scripts.</span><span class="se">\n</span><span class="s2">bluesky-queueserver version </span><span class="si">{</span><span class="n">qserver_version</span><span class="si">}</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="n">formatter_class</span><span class="o">=</span><span class="n">formatter</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--file-dir&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;file_dir&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Directory name where the list of plans and devices is saved. By default, the list is saved &quot;</span>
        <span class="s2">&quot;to the file &#39;existing_plans_and_devices.yaml&#39; in the current directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">parser</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--file-name&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;file_name&quot;</span><span class="p">,</span>
        <span class="n">action</span><span class="o">=</span><span class="s2">&quot;store&quot;</span><span class="p">,</span>
        <span class="n">required</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Name of the file where the list of plans and devices is saved. Default file name: &quot;</span>
        <span class="s2">&quot;&#39;existing_plans_and_devices.yaml&#39;.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">group</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">add_mutually_exclusive_group</span><span class="p">()</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--startup-dir&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;startup_dir&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;Path to directory that contains a set of startup files (*.py and *.ipy). All the scripts &quot;</span>
        <span class="s2">&quot;in the directory will be sorted in alphabetical order of their names and loaded in &quot;</span>
        <span class="s2">&quot;the Run Engine Worker environment. The set of startup files may be located in any accessible &quot;</span>
        <span class="s2">&quot;directory. For example, &#39;qserver-list-plans-devices --startup-dir .&#39; loads startup &quot;</span>
        <span class="s2">&quot;files from the current directory and saves the lists to the file in current directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--startup-module&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;startup_module_name&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The name of the module that contains the startup code. The module must be installed &quot;</span>
        <span class="s2">&quot; in the current environment For example, &#39;qserver-list-plans-devices &quot;</span>
        <span class="s2">&quot;--startup-module some.startup.module&#39; loads startup code from the module &#39;some.startup.module&#39; &quot;</span>
        <span class="s2">&quot;and saves results to the file in the current directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>
    <span class="n">group</span><span class="o">.</span><span class="n">add_argument</span><span class="p">(</span>
        <span class="s2">&quot;--startup-script&quot;</span><span class="p">,</span>
        <span class="n">dest</span><span class="o">=</span><span class="s2">&quot;startup_script_path&quot;</span><span class="p">,</span>
        <span class="nb">type</span><span class="o">=</span><span class="nb">str</span><span class="p">,</span>
        <span class="n">default</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
        <span class="n">help</span><span class="o">=</span><span class="s2">&quot;The path to the script with startup code. For example, &quot;</span>
        <span class="s2">&quot;&#39;qserver-list-plans-devices --startup-script ~/startup/scripts/script.py&#39; loads &quot;</span>
        <span class="s2">&quot;startup code from the script and saves the results to the file in the current directory.&quot;</span><span class="p">,</span>
    <span class="p">)</span>

    <span class="n">args</span> <span class="o">=</span> <span class="n">parser</span><span class="o">.</span><span class="n">parse_args</span><span class="p">()</span>
    <span class="n">file_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file_dir</span>
    <span class="n">file_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">file_name</span>
    <span class="n">startup_dir</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">startup_dir</span>
    <span class="n">startup_module_name</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">startup_module_name</span>
    <span class="n">startup_script_path</span> <span class="o">=</span> <span class="n">args</span><span class="o">.</span><span class="n">startup_script_path</span>

    <span class="k">if</span> <span class="n">file_dir</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)</span>
        <span class="n">file_dir</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">file_dir</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="n">gen_list_of_plans_and_devices</span><span class="p">(</span>
            <span class="n">startup_dir</span><span class="o">=</span><span class="n">startup_dir</span><span class="p">,</span>
            <span class="n">startup_module_name</span><span class="o">=</span><span class="n">startup_module_name</span><span class="p">,</span>
            <span class="n">startup_script_path</span><span class="o">=</span><span class="n">startup_script_path</span><span class="p">,</span>
            <span class="n">file_dir</span><span class="o">=</span><span class="n">file_dir</span><span class="p">,</span>
            <span class="n">file_name</span><span class="o">=</span><span class="n">file_name</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;The list of existing plans and devices was created successfully.&quot;</span><span class="p">)</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">except</span> <span class="ne">BaseException</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Failed to create the list of plans and devices: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="n">exit_code</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">exit_code</span>


<span class="k">def</span> <span class="nf">load_existing_plans_and_devices</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the lists of allowed plans and devices from YAML file. Returns empty lists</span>
<span class="sd">    if `path_to_file` is None or &quot;&quot; or the file does not exist or corrupt.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_to_file: str on None</span>
<span class="sd">        Full path to .yaml file that contains the lists.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    (dict, dict)</span>
<span class="sd">        List of allowed plans and list of allowed devices.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">msg</span> <span class="o">=</span> <span class="s2">&quot;List of plans and devices is not loaded.&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">path_to_file</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> File path is not specified.&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> File &#39;</span><span class="si">%s</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">existing_plans_and_devices</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">stream</span><span class="p">,</span> <span class="n">Loader</span><span class="o">=</span><span class="n">yaml</span><span class="o">.</span><span class="n">FullLoader</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> File &#39;</span><span class="si">%s</span><span class="s2">&#39; has invalid YAML: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
            <span class="n">existing_plans_and_devices</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">existing_plans_and_devices</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">%s</span><span class="s2"> The file &#39;</span><span class="si">%s</span><span class="s2">&#39; has invalid format or empty.&quot;</span><span class="p">,</span> <span class="n">msg</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">)</span>
        <span class="k">return</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="n">existing_plans</span> <span class="o">=</span> <span class="n">existing_plans_and_devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing_plans&quot;</span><span class="p">,</span> <span class="p">{})</span>
    <span class="n">existing_devices</span> <span class="o">=</span> <span class="n">existing_plans_and_devices</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;existing_devices&quot;</span><span class="p">,</span> <span class="p">{})</span>

    <span class="k">return</span> <span class="n">existing_plans</span><span class="p">,</span> <span class="n">existing_devices</span>


<span class="k">def</span> <span class="nf">compare_existing_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">existing_plans</span><span class="p">,</span>
    <span class="n">existing_devices</span><span class="p">,</span>
    <span class="n">existing_plans_ref</span><span class="p">,</span>
    <span class="n">existing_devices_ref</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Compares the lists of existing plans and devices with the reference lists. Returns ``False``</span>
<span class="sd">    if the exception is raised while comparing the lists. (Consistent exception handling is</span>
<span class="sd">    the only reason we need this function.)</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    existing_plans : dict</span>
<span class="sd">        The updated list (dictionary) of descriptions of the existing plans.</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        The updated list (dictionary) of descriptions of the existing devices.</span>
<span class="sd">    existing_plans_ref : dict or None</span>
<span class="sd">        The reference list (dictionary) of descriptions of the existing plans.</span>
<span class="sd">    existing_devices_ref : dict or None</span>
<span class="sd">        The reference list (dictionary) of descriptions of the existing devices.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        ``True`` - the lists are equal, ``False`` otherwise.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">lists_equal</span> <span class="o">=</span> <span class="p">(</span><span class="n">existing_plans</span> <span class="o">==</span> <span class="n">existing_plans_ref</span><span class="p">)</span> <span class="ow">and</span> <span class="p">(</span><span class="n">existing_devices</span> <span class="o">==</span> <span class="n">existing_devices_ref</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="c1"># If the lists (dictionaries) of plans and devices can not be compared, then save the new lists.</span>
        <span class="c1">#   This issue should be investigated if it is repeated regularly.</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to compare existing plans or existing devices: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>
        <span class="n">lists_equal</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">return</span> <span class="n">lists_equal</span>


<span class="k">def</span> <span class="nf">update_existing_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">path_to_file</span><span class="p">,</span>
    <span class="n">existing_plans</span><span class="p">,</span>
    <span class="n">existing_devices</span><span class="p">,</span>
    <span class="n">existing_plans_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">existing_devices_ref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">always_save</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Update the lists of existing plans and devices stored in the file ``path_to_file`` on disk if</span>
<span class="sd">    the lists are different from the reference lists. The reference lists can be passed to the function</span>
<span class="sd">    or loaded from the file if ``existing_plans_ref`` or ``existing_devices_ref`` are ``None``.</span>
<span class="sd">    If ``always_save`` is False, then the descriptions are updated only if the lists have changed,</span>
<span class="sd">    otherwise the lists are always saved. The function will never modified files in the directory</span>
<span class="sd">    with startup scripts, which is part of the repository or distributed package.</span>

<span class="sd">    This function never raises exceptions by design, since successful updating of stored lists of plans</span>
<span class="sd">    and devices is not considered critical for executing plans. If the function regularly generates</span>
<span class="sd">    warnings or error messages, the issue must be investigated.</span>

<span class="sd">    .. note::</span>

<span class="sd">        Lists of plans are devices are represented as Python dictionaries.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_to_file : str</span>
<span class="sd">        Path to file that contains the lists of existing plans and devices</span>
<span class="sd">    existing_plans : dict</span>
<span class="sd">        The updated list (dictionary) of descriptions of the existing plans.</span>
<span class="sd">    existing_devices : dict</span>
<span class="sd">        The updated list (dictionary) of descriptions of the existing devices.</span>
<span class="sd">    existing_plans_ref : dict or None</span>
<span class="sd">        The reference list (dictionary) of descriptions of the existing plans.</span>
<span class="sd">    existing_devices_ref : dict or None</span>
<span class="sd">        The reference list (dictionary) of descriptions of the existing devices.</span>
<span class="sd">    always_save : boolean</span>
<span class="sd">        If ``False`` then save lists of plans and devices only if it is different</span>
<span class="sd">        from reference lists. Always save the lists to disk if ``True``.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        ``True`` if the lists of existing plans and devices is different from the reference</span>
<span class="sd">        lists or if ``always_save`` is ``True``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">always_save</span><span class="p">:</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">existing_plans_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">existing_devices_ref</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ep</span><span class="p">,</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">load_existing_plans_and_devices</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_plans_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ep</span> <span class="o">=</span> <span class="n">existing_plans_ref</span>
        <span class="k">if</span> <span class="n">existing_devices_ref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">ed</span> <span class="o">=</span> <span class="n">existing_devices_ref</span>

        <span class="n">changes_exist</span> <span class="o">=</span> <span class="ow">not</span> <span class="n">compare_existing_plans_and_devices</span><span class="p">(</span>
            <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span><span class="p">,</span>
            <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span>
            <span class="n">existing_plans_ref</span><span class="o">=</span><span class="n">ep</span><span class="p">,</span>
            <span class="n">existing_devices_ref</span><span class="o">=</span><span class="n">ed</span><span class="p">,</span>
        <span class="p">)</span>

    <span class="k">else</span><span class="p">:</span>
        <span class="n">changes_exist</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">if</span> <span class="n">changes_exist</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Updating the list of existing plans and devices in the file &#39;</span><span class="si">%s</span><span class="s2">&#39;&quot;</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">)</span>

        <span class="k">def</span> <span class="nf">normalize_path</span><span class="p">(</span><span class="n">fpath</span><span class="p">):</span>
            <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">            Normalize path to make it easier to compare to other paths</span>
<span class="sd">            &quot;&quot;&quot;</span>
            <span class="k">return</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">realpath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">abspath</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">expanduser</span><span class="p">(</span><span class="n">fpath</span><span class="p">)))</span>

        <span class="n">default_startup_dir</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">get_default_startup_dir</span><span class="p">())</span>
        <span class="n">file_path</span> <span class="o">=</span> <span class="n">normalize_path</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">path_is_default</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">commonpath</span><span class="p">([</span><span class="n">default_startup_dir</span><span class="p">,</span> <span class="n">file_path</span><span class="p">])</span> <span class="o">==</span> <span class="n">default_startup_dir</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="n">path_is_default</span> <span class="o">=</span> <span class="kc">False</span>

        <span class="k">if</span> <span class="n">path_is_default</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span>
                <span class="s2">&quot;The file &#39;</span><span class="si">%s</span><span class="s2">&#39; is located in the directory, which is part of the package and can not be updated&quot;</span><span class="p">,</span>
                <span class="n">path_to_file</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># Saving the updated plans and devices is not critical for real-time operation of the queue server.</span>
            <span class="c1">#   Plans can still be executed, so the error can be ignored, but it should be investigated, because</span>
            <span class="c1">#   some functionality may not be working properly.</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">save_existing_plans_and_devices</span><span class="p">(</span>
                    <span class="n">existing_plans</span><span class="o">=</span><span class="n">existing_plans</span><span class="p">,</span>
                    <span class="n">existing_devices</span><span class="o">=</span><span class="n">existing_devices</span><span class="p">,</span>
                    <span class="n">file_dir</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">dirname</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">),</span>
                    <span class="n">file_name</span><span class="o">=</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">),</span>
                    <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">error</span><span class="p">(</span>
                    <span class="s2">&quot;Failed to save lists of existing plans and device to file &#39;</span><span class="si">%s</span><span class="s2">&#39;: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">path_to_file</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span>
                <span class="p">)</span>

    <span class="k">return</span> <span class="n">changes_exist</span>


<span class="n">_user_group_permission_schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;required&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">],</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;user_groups&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;allowed_plans&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;forbidden_plans&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;allowed_devices&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;forbidden_devices&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;allowed_functions&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;forbidden_functions&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                        <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="p">[</span><span class="s2">&quot;string&quot;</span><span class="p">,</span> <span class="s2">&quot;null&quot;</span><span class="p">]},</span>
                    <span class="p">},</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>


<span class="k">def</span> <span class="nf">_validate_user_group_permissions_schema</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate user group permissions schema. Raises exception if validation fails.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    user_group_permissions: dict</span>
<span class="sd">        A dictionary with user group permissions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">jsonschema</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">instance</span><span class="o">=</span><span class="n">user_group_permissions</span><span class="p">,</span> <span class="n">schema</span><span class="o">=</span><span class="n">_user_group_permission_schema</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">validate_user_group_permissions</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Validate the dictionary with user group permissions. Exception is raised errors are detected.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    user_group_permissions: dict</span>
<span class="sd">        The dictionary with user group permissions.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;User group permissions: Invalid type &#39;</span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">)</span><span class="si">}</span><span class="s2">&#39;, must be &#39;dict&#39;&quot;</span><span class="p">)</span>

    <span class="n">_validate_user_group_permissions_schema</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">)</span>

    <span class="k">if</span> <span class="s2">&quot;root&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">]:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;User group permissions: Missing required user group: &#39;root&#39;&quot;</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">load_user_group_permissions</span><span class="p">(</span><span class="n">path_to_file</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the data on allowed plans and devices for user groups. User group &#39;root&#39;</span>
<span class="sd">    is required. Exception is raised in user group &#39;root&#39; is missing.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_to_file: str</span>
<span class="sd">        Full path to YAML file that contains user data permissions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Data structure with user permissions. Returns ``{}`` if path is an empty string</span>
<span class="sd">        or None.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    IOError</span>
<span class="sd">        Error while reading the YAML file.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">path_to_file</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File &#39;</span><span class="si">{</span><span class="n">path_to_file</span><span class="si">}</span><span class="s2">&#39; does not exist.&quot;</span><span class="p">)</span>

        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path_to_file</span><span class="p">,</span> <span class="s2">&quot;r&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">stream</span><span class="p">:</span>
            <span class="n">user_group_permissions</span> <span class="o">=</span> <span class="n">yaml</span><span class="o">.</span><span class="n">safe_load</span><span class="p">(</span><span class="n">stream</span><span class="p">)</span>

        <span class="n">validate_user_group_permissions</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;root&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">]:</span>
            <span class="k">raise</span> <span class="ne">Exception</span><span class="p">(</span><span class="s2">&quot;Missing required user group: &#39;root&#39;&quot;</span><span class="p">)</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">msg</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;Error while loading user group permissions from file &#39;</span><span class="si">{</span><span class="n">path_to_file</span><span class="si">}</span><span class="s2">&#39;: </span><span class="si">{</span><span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="k">raise</span> <span class="ne">IOError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">user_group_permissions</span>


<span class="k">def</span> <span class="nf">_check_if_plan_or_func_allowed</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span> <span class="n">allow_patterns</span><span class="p">,</span> <span class="n">disallow_patterns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if an item with ``item_name`` is allowed based on ``allow_patterns``</span>
<span class="sd">    and ``disallow_patterns``. Patterns may be explicitly listed names and regular expressions.</span>
<span class="sd">    ``None`` may appear only as a first element of the pattern list.</span>
<span class="sd">    The function should be used only with function and plan names.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    item_name: str</span>
<span class="sd">        Name of the item.</span>
<span class="sd">    allow_patterns: list(str)</span>
<span class="sd">        Selected item should match at least one of the re patterns. If the value is ``[None]``</span>
<span class="sd">        then all items are selected. If ``[]``, then no items are selected.</span>
<span class="sd">    disallow_patterns: list(str)</span>
<span class="sd">        Items are deselected based on re patterns in the list: if an item matches at least one</span>
<span class="sd">        of the patterns, it is deselected. If the value is ``[None]`` or ``[]`` then no items</span>
<span class="sd">        are deselected.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        Indicates if the item is permitted based on ``allow_patterns`` and ``disallow_patterns``.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">False</span>

    <span class="k">def</span> <span class="nf">prepare_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">pattern</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Pattern is not a string: </span><span class="si">{pattern!r}</span><span class="s2"> (</span><span class="si">{allow_patterns}</span><span class="s2">)&quot;</span><span class="p">)</span>
        <span class="c1"># Prepare patterns</span>
        <span class="n">components</span><span class="p">,</span> <span class="n">uses_re</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_split_name_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">components</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Name pattern for functions and plans must contain one component: </span><span class="si">{components}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">component</span> <span class="o">=</span> <span class="n">components</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">uses_re</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="s2">&quot;[_a-zA-Z][_0-9a-zA-Z]*&quot;</span><span class="p">,</span> <span class="n">component</span><span class="p">):</span>
                <span class="k">assert</span> <span class="ne">ValueError</span><span class="p">(</span>
                    <span class="sa">f</span><span class="s2">&quot;Plan or function name pattern </span><span class="si">{</span><span class="n">component</span><span class="si">!r}</span><span class="s2"> contains invalid characters. &quot;</span>
                    <span class="s2">&quot;The pattern could be a valid regular expression, &quot;</span>
                    <span class="s2">&quot;but it is not labeled with &#39;:&#39; (e.g. &#39;:^count$&#39;)&quot;</span>
                <span class="p">)</span>
        <span class="k">return</span> <span class="n">component</span><span class="p">,</span> <span class="n">uses_re</span>

    <span class="k">if</span> <span class="n">allow_patterns</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">allow_patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">True</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">allow_patterns</span><span class="p">:</span>
                <span class="n">component</span><span class="p">,</span> <span class="n">uses_re</span> <span class="o">=</span> <span class="n">prepare_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uses_re</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">item_name</span><span class="p">):</span>
                        <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item_name</span> <span class="o">==</span> <span class="n">component</span><span class="p">:</span>
                        <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">break</span>

    <span class="k">if</span> <span class="n">item_is_allowed</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">disallow_patterns</span> <span class="ow">and</span> <span class="p">(</span><span class="n">disallow_patterns</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="n">disallow_patterns</span><span class="p">:</span>
                <span class="n">component</span><span class="p">,</span> <span class="n">uses_re</span> <span class="o">=</span> <span class="n">prepare_pattern</span><span class="p">(</span><span class="n">pattern</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">uses_re</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">component</span><span class="p">,</span> <span class="n">item_name</span><span class="p">):</span>
                        <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">item_name</span> <span class="o">==</span> <span class="n">component</span><span class="p">:</span>
                        <span class="n">item_is_allowed</span> <span class="o">=</span> <span class="kc">False</span>
                        <span class="k">break</span>

    <span class="k">return</span> <span class="n">item_is_allowed</span>


<span class="k">def</span> <span class="nf">check_if_function_allowed</span><span class="p">(</span><span class="n">function_name</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">group_name</span><span class="p">,</span> <span class="n">user_group_permissions</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Check if the function with name ``function_name`` is allowed for users of ``group_name`` group.</span>
<span class="sd">    The function first checks if the function name passes root permissions and then permissions</span>
<span class="sd">    for the specific group.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    function_name: str</span>
<span class="sd">        Function name to check</span>
<span class="sd">    group_name: str</span>
<span class="sd">        User group name. Permissions must be defined for this group.</span>
<span class="sd">    user_group_permissions: dict or None</span>
<span class="sd">        Reference to a dictionary, which contains the defined user group permissions.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    boolean</span>
<span class="sd">        Indicates if the user that belong to ``user_group`` are allowed to run the function.</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    KeyError</span>
<span class="sd">        ``user_group_permissions`` do not contain ``user_groups`` key or permissions for</span>
<span class="sd">        ``group_name`` group are not defined.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">user_group_permissions</span><span class="p">:</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="k">if</span> <span class="s2">&quot;user_groups&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_group_permissions</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;User group permissions dictionary does not contain &#39;user_groups&#39; key&quot;</span><span class="p">)</span>

    <span class="n">user_groups</span> <span class="o">=</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">]</span>

    <span class="k">if</span> <span class="s2">&quot;root&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="s2">&quot;No permissions are defined for user group &#39;root&#39;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">group_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">KeyError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No permissions are defined for user group </span><span class="si">{</span><span class="n">group_name</span><span class="si">!r}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">root_allow_patterns</span> <span class="o">=</span> <span class="n">user_groups</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_functions&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">root_disallow_patterns</span> <span class="o">=</span> <span class="n">user_groups</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_functions&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">group_allow_patterns</span> <span class="o">=</span> <span class="n">user_groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_functions&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="n">group_disallow_patterns</span> <span class="o">=</span> <span class="n">user_groups</span><span class="p">[</span><span class="n">group_name</span><span class="p">]</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_functions&quot;</span><span class="p">,</span> <span class="p">[])</span>

    <span class="k">return</span> <span class="n">_check_if_plan_or_func_allowed</span><span class="p">(</span>
        <span class="n">function_name</span><span class="p">,</span>
        <span class="n">root_allow_patterns</span><span class="p">,</span>
        <span class="n">root_disallow_patterns</span><span class="p">,</span>
    <span class="p">)</span> <span class="ow">and</span> <span class="n">_check_if_plan_or_func_allowed</span><span class="p">(</span>
        <span class="n">function_name</span><span class="p">,</span>
        <span class="n">group_allow_patterns</span><span class="p">,</span>
        <span class="n">group_disallow_patterns</span><span class="p">,</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">_select_allowed_plans</span><span class="p">(</span><span class="n">item_dict</span><span class="p">,</span> <span class="n">allow_patterns</span><span class="p">,</span> <span class="n">disallow_patterns</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Creates the dictionary of items selected from `item_dict` with names names that</span>
<span class="sd">    satisfy patterns in `allow_patterns` and not satisfy patterns in `disallow_patterns`.</span>
<span class="sd">    The function does not modify the dictionary, but creates a new dictionary with</span>
<span class="sd">    selected items, where item values are deep copies of the values of the original</span>
<span class="sd">    dictionary.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    item_dict: dict</span>
<span class="sd">        Dictionary of items.</span>
<span class="sd">    allow_patterns: list(str)</span>
<span class="sd">        Selected item should match at least one of the re patterns. If the value is ``[None]``</span>
<span class="sd">        then all items are selected. If ``[]``, then no items are selected.</span>
<span class="sd">    disallow_patterns: list(str)</span>
<span class="sd">        Items are deselected based on re patterns in the list: if an item matches at least one</span>
<span class="sd">        of the patterns, it is deselected. If the value is ``[None]`` or ``[]`` then no items</span>
<span class="sd">        are deselected.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        Dictionary of the selected items.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">items_selected</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">item_name</span> <span class="ow">in</span> <span class="n">item_dict</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">_check_if_plan_or_func_allowed</span><span class="p">(</span><span class="n">item_name</span><span class="p">,</span> <span class="n">allow_patterns</span><span class="p">,</span> <span class="n">disallow_patterns</span><span class="p">):</span>
            <span class="n">items_selected</span><span class="p">[</span><span class="n">item_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">item_dict</span><span class="p">[</span><span class="n">item_name</span><span class="p">])</span>

    <span class="k">return</span> <span class="n">items_selected</span>


<span class="k">def</span> <span class="nf">load_allowed_plans_and_devices</span><span class="p">(</span>
    <span class="o">*</span><span class="p">,</span>
    <span class="n">path_existing_plans_and_devices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">path_user_group_permissions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">existing_plans</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">existing_devices</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="n">user_group_permissions</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
<span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Generate dictionaries of allowed plans and devices for each user group. If there are no user</span>
<span class="sd">    groups defined (path is None), then output dictionaries will have one user group &#39;root&#39;</span>
<span class="sd">    with all existing plans and devices allowed. The function is using the lists (dict) of</span>
<span class="sd">    existing plans and devices passed as parameters. If the lists are not passed (or ``None``),</span>
<span class="sd">    then they are loaded from the file ``path_existing_plans_and_devices``.</span>
<span class="sd">    If the lists of plans and devices do not exist (path_existing_plans_and_devices is ``None``</span>
<span class="sd">    or points to non-existing file), then empty dictionaries are returned.</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    path_existing_plans_and_devices: str or None</span>
<span class="sd">        Full path to YAML file, which contains dictionaries of existing plans and devices.</span>
<span class="sd">        Raises an exception if the file does not exist. If ``None`` or the file contains</span>
<span class="sd">        no plans and/or devices, then empty dictionaries of the allowed plans and devices</span>
<span class="sd">        are returned for all groups.</span>
<span class="sd">    path_user_group_permissions: str or None</span>
<span class="sd">        Full path to YAML file, which contains information on user group permissions.</span>
<span class="sd">        Exception is raised if the file does not exist. The path is ignored if</span>
<span class="sd">        ``user_group_permissions`` is set. If both ``path_user_group_permissions`` is ``None``</span>
<span class="sd">        and ``user_group_permissions`` is ``None`` or ``{}``, then dictionaries of allowed</span>
<span class="sd">        plans and devices will contain one group &#39;root&#39; with all existing devices and plans</span>
<span class="sd">        set as allowed.</span>
<span class="sd">    existing_plans: dict or None</span>
<span class="sd">        List (dict) of the existing plans. If ``None``, then the list is loaded from</span>
<span class="sd">        the file ``path_existing_plans_and_devices``.</span>
<span class="sd">    existing_devices: dict or None</span>
<span class="sd">        List (dict) of the existing devices. If ``None``, then the list is loaded from</span>
<span class="sd">        the file ``path_existing_plans_and_devices``.</span>
<span class="sd">    user_group_permissions: str or None</span>
<span class="sd">        Dictionary with user group permissions. If ``None``, then permissions are loaded</span>
<span class="sd">        from the file ``path_user_group_permissions``. If ``{}``, then dictionaries of allowed</span>
<span class="sd">        plans and devices will contain one group &#39;root&#39; with all existing devices and plans</span>
<span class="sd">        set as allowed.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict, dict</span>
<span class="sd">        Dictionaries of allowed plans and devices. Dictionary keys are names of the user groups.</span>
<span class="sd">        Dictionaries are ``{}`` if no data on existing plans and devices is provided.</span>
<span class="sd">        Dictionaries contain one group (``root``) if no user perission data is provided.</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">user_group_permissions</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">user_group_permissions</span> <span class="o">=</span> <span class="n">load_user_group_permissions</span><span class="p">(</span><span class="n">path_user_group_permissions</span><span class="p">)</span>

        <span class="c1"># Data from the file is loaded only if ``existing_plans`` or ``existing_devices`` is ``None``.</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">existing_plans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">existing_devices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">ep</span><span class="p">,</span> <span class="n">ed</span> <span class="o">=</span> <span class="n">load_existing_plans_and_devices</span><span class="p">(</span><span class="n">path_existing_plans_and_devices</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">existing_plans</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">existing_plans</span> <span class="o">=</span> <span class="n">ep</span>
        <span class="k">if</span> <span class="n">existing_devices</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">existing_devices</span> <span class="o">=</span> <span class="n">ed</span>

        <span class="c1"># Detect some possible errors</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">user_group_permissions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No user permissions are specified&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;&#39;user_group_permissions&#39; has type </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">)</span><span class="si">}</span><span class="s2"> instead of &#39;dict&#39;&quot;</span>
            <span class="p">)</span>

        <span class="k">if</span> <span class="s2">&quot;user_groups&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">user_group_permissions</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;No user groups are defined: &#39;user_groups&#39; keys is not in &#39;user_group_permissions&#39;&quot;</span><span class="p">)</span>

        <span class="n">user_groups</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>

        <span class="c1"># First filter the plans and devices based on the permissions for &#39;root&#39; user group.</span>
        <span class="c1">#   The &#39;root&#39; user group permissions should be used to exclude all &#39;junk&#39;, i.e.</span>
        <span class="c1">#   unused/outdated/not functioning plans and devices collected from namespace, from</span>
        <span class="c1">#   the lists available to ALL the users.</span>
        <span class="n">plans_root</span><span class="p">,</span> <span class="n">devices_root</span> <span class="o">=</span> <span class="n">existing_plans</span><span class="p">,</span> <span class="n">existing_devices</span>
        <span class="k">if</span> <span class="s2">&quot;root&quot;</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">:</span>
            <span class="n">group_permissions_root</span> <span class="o">=</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">][</span><span class="s2">&quot;root&quot;</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">existing_devices</span><span class="p">:</span>
                <span class="n">devices_root</span> <span class="o">=</span> <span class="n">_filter_device_tree</span><span class="p">(</span>
                    <span class="n">existing_devices</span><span class="p">,</span>
                    <span class="n">group_permissions_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_devices&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="n">group_permissions_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_devices&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="p">)</span>
            <span class="k">if</span> <span class="n">existing_plans</span><span class="p">:</span>
                <span class="n">plans_root</span> <span class="o">=</span> <span class="n">_select_allowed_plans</span><span class="p">(</span>
                    <span class="n">existing_plans</span><span class="p">,</span>
                    <span class="n">group_permissions_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_plans&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="n">group_permissions_root</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_plans&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                <span class="p">)</span>

        <span class="c1"># Now create lists of allowed devices and plans based on the lists for the &#39;root&#39; user group</span>
        <span class="k">for</span> <span class="n">group</span> <span class="ow">in</span> <span class="n">user_groups</span><span class="p">:</span>
            <span class="n">selected_devices</span><span class="p">,</span> <span class="n">selected_plans</span> <span class="o">=</span> <span class="p">{},</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">group</span> <span class="o">==</span> <span class="s2">&quot;root&quot;</span><span class="p">:</span>
                <span class="n">selected_devices</span> <span class="o">=</span> <span class="n">devices_root</span>
                <span class="n">selected_plans</span> <span class="o">=</span> <span class="n">plans_root</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">group_permissions</span> <span class="o">=</span> <span class="n">user_group_permissions</span><span class="p">[</span><span class="s2">&quot;user_groups&quot;</span><span class="p">][</span><span class="n">group</span><span class="p">]</span>

                <span class="k">if</span> <span class="n">existing_devices</span><span class="p">:</span>
                    <span class="n">selected_devices</span> <span class="o">=</span> <span class="n">_filter_device_tree</span><span class="p">(</span>
                        <span class="n">devices_root</span><span class="p">,</span>
                        <span class="n">group_permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_devices&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="n">group_permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_devices&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="p">)</span>

                <span class="k">if</span> <span class="n">existing_plans</span><span class="p">:</span>
                    <span class="n">selected_plans</span> <span class="o">=</span> <span class="n">_select_allowed_plans</span><span class="p">(</span>
                        <span class="n">plans_root</span><span class="p">,</span>
                        <span class="n">group_permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;allowed_plans&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                        <span class="n">group_permissions</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;forbidden_plans&quot;</span><span class="p">,</span> <span class="p">[]),</span>
                    <span class="p">)</span>

            <span class="n">selected_plans</span> <span class="o">=</span> <span class="n">_filter_allowed_plans</span><span class="p">(</span><span class="n">allowed_plans</span><span class="o">=</span><span class="n">selected_plans</span><span class="p">,</span> <span class="n">allowed_devices</span><span class="o">=</span><span class="n">selected_devices</span><span class="p">)</span>

            <span class="n">allowed_devices</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_devices</span>
            <span class="n">allowed_plans</span><span class="p">[</span><span class="n">group</span><span class="p">]</span> <span class="o">=</span> <span class="n">selected_plans</span>

    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">ex</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">exception</span><span class="p">(</span><span class="s2">&quot;Error occurred while generating the list of allowed plans and devices: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">ex</span><span class="p">))</span>

        <span class="c1"># The &#39;default&#39; lists in case error occurred while generating lists</span>
        <span class="n">allowed_plans</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">existing_plans</span>
        <span class="n">allowed_devices</span><span class="p">[</span><span class="s2">&quot;root&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">existing_devices</span>

    <span class="k">return</span> <span class="n">allowed_plans</span><span class="p">,</span> <span class="n">allowed_devices</span>


<span class="k">def</span> <span class="nf">load_profile_collection_from_ipython</span><span class="p">(</span><span class="n">path</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load profile collection from IPython. Useful utility function that may be used to</span>
<span class="sd">    test if a profile collection can be loaded from IPython.</span>
<span class="sd">    Manually run this function from IPython:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from bluesky_queueserver.manager.profile_ops import load_profile_collection_from_ipython</span>
<span class="sd">        load_profile_collection_from_ipython()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ip</span> <span class="o">=</span> <span class="n">get_ipython</span><span class="p">()</span>  <span class="c1"># noqa F821</span>
    <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.py&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;*.ipy&quot;</span><span class="p">)):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Executing &#39;</span><span class="si">{</span><span class="n">f</span><span class="si">}</span><span class="s2">&#39; in TravisCI&quot;</span><span class="p">)</span>
        <span class="n">ip</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">_exec_file</span><span class="p">(</span><span class="n">f</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Profile collection was loaded successfully.&quot;</span><span class="p">)</span>


<div class="viewcode-block" id="format_text_descriptions"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.format_text_descriptions.html#bluesky_queueserver.format_text_descriptions">[docs]</a><span class="k">def</span> <span class="nf">format_text_descriptions</span><span class="p">(</span><span class="n">item_parameters</span><span class="p">,</span> <span class="o">*</span><span class="p">,</span> <span class="n">use_html</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Format parameter descriptions for a plan from the list of allowed plans.</span>
<span class="sd">    Returns description of the plan and each parameter represented as formatted strings</span>
<span class="sd">    containing plan name/description and parameter name/type/default/min/max/step/description.</span>
<span class="sd">    The text is prepared for presentation in user interfaces. The descriptions are</span>
<span class="sd">    represented as a dictionary:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        {</span>
<span class="sd">            &quot;description&quot;: &quot;Multiline formatted text description of the plan&quot;,</span>
<span class="sd">            &quot;parameters&quot;: {</span>
<span class="sd">                &quot;param_name1&quot;: &quot;Multiline formatted description&quot;,</span>
<span class="sd">                &quot;param_name2&quot;: &quot;Multiline formatted description&quot;,</span>
<span class="sd">                &quot;param_name3&quot;: &quot;Multiline formatted description&quot;,</span>
<span class="sd">            }</span>
<span class="sd">        }</span>

<span class="sd">    Parameters</span>
<span class="sd">    ----------</span>
<span class="sd">    item_parameters : dict</span>
<span class="sd">        A dictionary of item parameters, e.g. an element from the list of existing or allowed plans.</span>
<span class="sd">    use_html : boolean</span>
<span class="sd">        Select if the formatted text should be returned as plain text (default) or HTML.</span>

<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    dict</span>
<span class="sd">        The dictionary that contains formatted descriptions for the plan and its parameters.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">item_parameters</span><span class="p">:</span>
        <span class="k">return</span> <span class="p">{}</span>

    <span class="n">start_bold</span> <span class="o">=</span> <span class="s2">&quot;&lt;b&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">stop_bold</span> <span class="o">=</span> <span class="s2">&quot;&lt;/b&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">start_it</span> <span class="o">=</span> <span class="s2">&quot;&lt;i&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">stop_it</span> <span class="o">=</span> <span class="s2">&quot;&lt;/i&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
    <span class="n">new_line</span> <span class="o">=</span> <span class="s2">&quot;&lt;br&gt;&quot;</span> <span class="k">if</span> <span class="n">use_html</span> <span class="k">else</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span>

    <span class="n">not_available</span> <span class="o">=</span> <span class="s2">&quot;Description is not available&quot;</span>

    <span class="n">descriptions</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="n">item_name</span> <span class="o">=</span> <span class="n">item_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>

    <span class="n">item_description</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">item_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span>
    <span class="n">item_description</span> <span class="o">=</span> <span class="n">item_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span>
    <span class="n">s</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Name:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">item_name</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="k">if</span> <span class="n">item_description</span><span class="p">:</span>
        <span class="n">s</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_line</span><span class="si">}{</span><span class="n">item_description</span><span class="si">}</span><span class="s2">&quot;</span>

    <span class="n">descriptions</span><span class="p">[</span><span class="s2">&quot;description&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">s</span> <span class="k">if</span> <span class="n">s</span> <span class="k">else</span> <span class="n">not_available</span>

    <span class="n">descriptions</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">item_parameters</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;parameters&quot;</span><span class="p">,</span> <span class="p">[]):</span>
        <span class="n">p_name</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;name&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>

        <span class="n">p_type</span> <span class="o">=</span> <span class="s2">&quot;-&quot;</span>
        <span class="n">p_custom_types</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;annotation&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="n">p_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">annotation</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;type&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>
            <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="p">(</span><span class="s2">&quot;devices&quot;</span><span class="p">,</span> <span class="s2">&quot;plans&quot;</span><span class="p">,</span> <span class="s2">&quot;enums&quot;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">ct</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">[</span><span class="n">t</span><span class="p">]:</span>
                        <span class="n">p_custom_types</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="n">ct</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">(</span><span class="n">annotation</span><span class="p">[</span><span class="n">t</span><span class="p">][</span><span class="n">ct</span><span class="p">])))</span>

        <span class="n">p_default</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;default&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;-&quot;</span>

        <span class="n">p_min</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;min&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">p_max</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;max&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="n">p_step</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;step&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

        <span class="n">p_description</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;description&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
        <span class="n">p_description</span> <span class="o">=</span> <span class="n">p_description</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">new_line</span><span class="p">)</span>

        <span class="n">desc</span> <span class="o">=</span> <span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Name:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_name</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}{</span><span class="n">new_line</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Type:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_type</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}{</span><span class="n">new_line</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

        <span class="k">for</span> <span class="n">ct</span><span class="p">,</span> <span class="n">ct_items</span> <span class="ow">in</span> <span class="n">p_custom_types</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">ct</span><span class="si">}</span><span class="s2">:</span><span class="si">{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">ct_items</span><span class="si">}{</span><span class="n">new_line</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Default:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_default</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">p_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="ow">or</span> <span class="p">(</span><span class="n">p_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
            <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_line</span><span class="si">}</span><span class="s2">&quot;</span>
            <span class="n">insert_space</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="n">p_min</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Min:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_min</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">insert_space</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">p_max</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">insert_space</span><span class="p">:</span>
                    <span class="n">desc</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>
                <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Max:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_max</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>
                <span class="n">insert_space</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="n">p_step</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">insert_space</span><span class="p">:</span>
                    <span class="n">desc</span> <span class="o">+=</span> <span class="s2">&quot; &quot;</span>
                <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">start_it</span><span class="si">}</span><span class="s2">Step:</span><span class="si">{</span><span class="n">stop_it</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">start_bold</span><span class="si">}{</span><span class="n">p_step</span><span class="si">}{</span><span class="n">stop_bold</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="k">if</span> <span class="n">p_description</span><span class="p">:</span>
            <span class="n">desc</span> <span class="o">+=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">new_line</span><span class="si">}{</span><span class="n">p_description</span><span class="si">}</span><span class="s2">&quot;</span>

        <span class="n">descriptions</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">][</span><span class="n">p_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">desc</span> <span class="k">if</span> <span class="n">desc</span> <span class="k">else</span> <span class="n">not_available</span>

    <span class="k">return</span> <span class="n">descriptions</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>