<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>bluesky_queueserver.manager.annotation_decorator &mdash; bluesky-queueserver 0.post1+g94504d5 documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/jquery.js"></script>
        <script src="../../../_static/underscore.js"></script>
        <script src="../../../_static/doctools.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../../../index.html" class="icon icon-home"> bluesky-queueserver
          </a>
              <div class="version">
                0.post1+g94504d5
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../../installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorial.html">Basic Tutorials</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../release_history.html">Release History</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">User's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../introduction_for_users.html">Introduction</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../features_and_config.html">Features and Configuration</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../workflow.html">Submitting and Managing Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../startup_code.html">Organizing Bluesky Startup Code</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../ipython.html">Using IPython Startup Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../item_validation.html">Validation of Queue Items</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../plan_annotation.html">Annotating Bluesky Plans</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../cli_tools.html">Command-Line Tools</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Application Developer's Guide</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../interacting_with_qs.html">Interacting with Queue Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../re_manager_api.html">Run Engine Manager API</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">bluesky-queueserver</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home"></a> &raquo;</li>
          <li><a href="../../index.html">Module code</a> &raquo;</li>
      <li>bluesky_queueserver.manager.annotation_decorator</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for bluesky_queueserver.manager.annotation_decorator</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">functools</span>
<span class="kn">import</span> <span class="nn">inspect</span>
<span class="kn">import</span> <span class="nn">jsonschema</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="n">_parameter_annotation_schema</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
    <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
        <span class="s2">&quot;parameters&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
                <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
                <span class="s2">&quot;properties&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;description&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;annotation&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;devices&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/custom_types_plans_devices&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;plans&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/custom_types_plans_devices&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;enums&quot;</span><span class="p">:</span> <span class="p">{</span>
                        <span class="s2">&quot;$ref&quot;</span><span class="p">:</span> <span class="s2">&quot;#/definitions/custom_types&quot;</span><span class="p">,</span>
                    <span class="p">},</span>
                    <span class="s2">&quot;default&quot;</span><span class="p">:</span> <span class="p">{},</span>  <span class="c1"># Expression of any time should be accepted</span>
                    <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;step&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;number&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;convert_plan_names&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                    <span class="s2">&quot;convert_device_names&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;boolean&quot;</span><span class="p">},</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
    <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
    <span class="s2">&quot;definitions&quot;</span><span class="p">:</span> <span class="p">{</span>
        <span class="s2">&quot;custom_types&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;patternProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;^[_a-zA-Z][_a-zA-Z0-9]*$&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                    <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
        <span class="s2">&quot;custom_types_plans_devices&quot;</span><span class="p">:</span> <span class="p">{</span>
            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;object&quot;</span><span class="p">,</span>
            <span class="s2">&quot;additionalProperties&quot;</span><span class="p">:</span> <span class="kc">False</span><span class="p">,</span>
            <span class="s2">&quot;patternProperties&quot;</span><span class="p">:</span> <span class="p">{</span>
                <span class="s2">&quot;^[_a-zA-Z][_a-zA-Z0-9]*$&quot;</span><span class="p">:</span> <span class="p">{</span>
                    <span class="s2">&quot;anyOf&quot;</span><span class="p">:</span> <span class="p">[</span>
                        <span class="p">{</span>
                            <span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;array&quot;</span><span class="p">,</span>
                            <span class="s2">&quot;items&quot;</span><span class="p">:</span> <span class="p">{</span><span class="s2">&quot;type&quot;</span><span class="p">:</span> <span class="s2">&quot;string&quot;</span><span class="p">},</span>
                        <span class="p">},</span>
                    <span class="p">],</span>
                <span class="p">},</span>
            <span class="p">},</span>
        <span class="p">},</span>
    <span class="p">},</span>
<span class="p">}</span>


<div class="viewcode-block" id="parameter_annotation_decorator"><a class="viewcode-back" href="../../../generated/bluesky_queueserver.parameter_annotation_decorator.html#bluesky_queueserver.parameter_annotation_decorator">[docs]</a><span class="k">def</span> <span class="nf">parameter_annotation_decorator</span><span class="p">(</span><span class="n">annotation</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    The decorator allows to attach a custom description to a function or generator function.</span>
<span class="sd">    The purpose of the decorator is to extend the standard Python annotation</span>
<span class="sd">    capabilities. The annotation elements defined in the decorator always override</span>
<span class="sd">    the identical elements defined in the function header (type hints and default values) and</span>
<span class="sd">    the docstring (text descriptions of the function and its parameters). All the fields in</span>
<span class="sd">    the dictionary passed to the decorator are optional, so only the parameters that are needed</span>
<span class="sd">    should be specified. In many cases the complete description of the function may be generated</span>
<span class="sd">    from the existing docstring and parameter hints. In those cases using the decorator may be avoided.</span>

<span class="sd">    The purpose of the custom parameter annotations is to provide alternative type hints for some</span>
<span class="sd">    parameters. Those alternative hints may be necessary for validation of plan parameters outside</span>
<span class="sd">    the Run Engine environment. Standard Python types, such as ``float``, ``int`` or ``str``),</span>
<span class="sd">    may be unambiguously specified as parameter hints and used for plan validation and typechecking</span>
<span class="sd">    (e.g. with ``mypy``). Some plans may accept references to devices or other Bluesky plans</span>
<span class="sd">    defined in RE Worker namespace as parameters. Plans and devices are referred by their names</span>
<span class="sd">    in parameters of the plans submitted to the queue. Type validation for those parameters</span>
<span class="sd">    must include checking the parameter type (e.g. if the parameter is a list) and verifying</span>
<span class="sd">    that the values are strings from specified set (e.g. that strings in the list are the devices</span>
<span class="sd">    from specified set). This functionality may be achieved by defining custom enum types that</span>
<span class="sd">    are supported by the decorator. Custom enum types allow define list of names for ``devices``</span>
<span class="sd">    (names of devices from RE Worker namespace), ``plans`` (names of plans from RE Worker namespace)</span>
<span class="sd">    and ``enums`` (string literals). Type annotations in the decorator may use custom enum types</span>
<span class="sd">    to define complex types (using generic types based on ``typing`` module).</span>

<span class="sd">    The decorator allows to define additional parameter annotation items: ``min``, ``max`` and</span>
<span class="sd">    ``step``. Those items are applied only to numbers in data structures passed as parameter values.</span>
<span class="sd">    If ``min`` or ``max`` values are defined for a parameter, each number found</span>
<span class="sd">    in the data structure (such as list, tuple, dictionary, list of dictionaries etc.)</span>
<span class="sd">    is compared to the values of ``min`` and ``max`` and the plan is rejected if any value</span>
<span class="sd">    is out of range. Range validation is inteded primarily for using with parameters that</span>
<span class="sd">    accept numbers or lists/tuples of numbers. The ``step`` value specified in annotation</span>
<span class="sd">    is not used by Queue Server, but passed to the client application and may be useful for</span>
<span class="sd">    generating GUI components (e.g. spin boxes).</span>

<span class="sd">    Another potential use of the decorator is to provide shorter text descriptions (e.g. for tooltips)</span>
<span class="sd">    for the parameters in case long description extracted from the function docstring is too detailed.</span>
<span class="sd">    The plan and parameter descriptions defined in the decorator override the descriptions from</span>
<span class="sd">    the docstring, hiding them from the client applications.</span>

<span class="sd">    The decorator does not change the function and does not overwrite an existing docstring.</span>
<span class="sd">    The decorator does not generate function descriptions, instead the parameter dictionary</span>
<span class="sd">    passed to the decorator is saved as ``_custom_parameter_annotation_`` attribute of the function</span>
<span class="sd">    and may be used later for generation of plan descriptions.</span>

<span class="sd">    The decorator verifies if the parameter dictionary matches JSON schema and if names of all</span>
<span class="sd">    the parameter names exist in the function signature. The exception is raised if there is</span>
<span class="sd">    a mismatch.</span>

<span class="sd">    The following is an example of custom annotation (Python dictionary) with inline comments.</span>
<span class="sd">    The example is not practical. It demonstrates syntax of defining various annotation elements</span>
<span class="sd">    using the decorator:</span>

<span class="sd">    .. code-block:: python</span>

<span class="sd">        from bluesky_queueserver import parameter_annotation_decorator</span>

<span class="sd">        @parameter_annotation_decorator({</span>
<span class="sd">            # Optional function description.</span>
<span class="sd">            &quot;description&quot;: &quot;Custom annotation with plans and devices.&quot;,</span>

<span class="sd">            # &#39;parameters&#39; dictionary is optional. Empty &#39;parameters&#39; dictionary will</span>
<span class="sd">            #   also be accepted. The keys in the parameter dictionary are names of</span>
<span class="sd">            #   the function parameters. The parameters must exist in function signature,</span>
<span class="sd">            #   otherwise an exception will be raised.</span>
<span class="sd">            &quot;parameters&quot;: {</span>

<span class="sd">                &quot;experiment_name&quot;: {</span>
<span class="sd">                    # This parameter will probably have type hint &#39;some_name: str`.</span>
<span class="sd">                    &quot;description&quot;: &quot;String selected from a list of strings (similar to enum)&quot;,</span>
<span class="sd">                    &quot;annotation&quot;: &quot;Names&quot;,</span>

<span class="sd">                    # Note, that &quot;devices&quot;, &quot;plans&quot; and &quot;names&quot; are treated identically</span>
<span class="sd">                    #   during type checking, since they represent lists of strings.</span>
<span class="sd">                    #   One parameter may have name groups from &quot;devices&quot;, &quot;plans&quot;</span>
<span class="sd">                    #   and &quot;enums&quot; combined in complex expression using &#39;typing&#39;</span>
<span class="sd">                    #   module. The names listed as ``enums`` are not replaced by</span>
<span class="sd">                    #   references to objects in RE Worker namespace.</span>
<span class="sd">                    &quot;enums&quot;: {</span>
<span class="sd">                        &quot;Names&quot;: (&quot;name1&quot;, &quot;name2&quot;, &quot;name3&quot;),</span>
<span class="sd">                    },</span>
<span class="sd">                }</span>

<span class="sd">                &quot;devices&quot;: {</span>
<span class="sd">                    &quot;description&quot;: &quot;Parameter that accepts the list of devices.&quot;,</span>
<span class="sd">                    &quot;annotation&quot;: &quot;typing.List[typing.Union[DeviceType1, DeviceType2]]&quot;,</span>

<span class="sd">                    # Here we provide the list of devices. &#39;devices&#39; and &#39;plans&#39; are</span>
<span class="sd">                    #    treated similarly, but should be separated into different sections</span>
<span class="sd">                    #    to implement proper parameter validation. The devices may be listed</span>
<span class="sd">                    #    explicitly by name or using patterns based on regular expressions.</span>
<span class="sd">                    #    The list may contain any combination of names and patterns.</span>
<span class="sd">                    #    The patterns are distinguished from names by leading ``:`` at the</span>
<span class="sd">                    #    beginning of each pattern. Patterns may contain multiple regular</span>
<span class="sd">                    #    expressions separated with ``:``: the first expression is applied</span>
<span class="sd">                    #    to the device name, the second expression to subdevices of the</span>
<span class="sd">                    #    device, the third - to subdevices of subdevices etc. For example,</span>
<span class="sd">                    #    the pattern ``:^stage_:^det:val$ would match the devices with names</span>
<span class="sd">                    #    such as ``stage_sim.det2.val``.</span>
<span class="sd">                    #</span>
<span class="sd">                    #    Adding ``-`` before an expression (after ``:``) excludes the matching</span>
<span class="sd">                    #    devices/subdevices from the list (e.g. ``:^stage_:-^det:val$ adds</span>
<span class="sd">                    #    ``stage_sim`` and ``stage_sim.det2.val`` to the list, but not</span>
<span class="sd">                    #    ``stage_sim.det2``).</span>
<span class="sd">                    #</span>
<span class="sd">                    #    A regular expression may be applied to the full name (including</span>
<span class="sd">                    #    subdevice names) or remaining name of the device. An expression</span>
<span class="sd">                    #    could be labelled as &#39;full-name&#39; by placing ``?`` before it.</span>
<span class="sd">                    #    For example ``:?^stage_.*val$`` would pick all devices with names</span>
<span class="sd">                    #    starting with ``stage_`` and ending with ``val`` from the complete</span>
<span class="sd">                    #    tree of existing devices. The search depth may be restricted by</span>
<span class="sd">                    #    adding ``depth`` parameter (e.g. ``:?^stage_.*val$:depth=5``</span>
<span class="sd">                    #    restricts the search depth to 5).</span>
<span class="sd">                    #</span>
<span class="sd">                    #    The both types of expressions could be mixed in one pattern.</span>
<span class="sd">                    #    The full-name expression must be the last in the pattern and</span>
<span class="sd">                    #    is applied to the remaining part of the name. For example</span>
<span class="sd">                    #    ``:^stage_:?^det.*val$:depth=4`` selects the device ``stage_sim``</span>
<span class="sd">                    #    and all its subdevices starting with ``det`` and ending with ``val``</span>
<span class="sd">                    #    up to the total depth of 5 (depth=4 is set for the full-name expression).</span>
<span class="sd">                    #    Note, that searching devices using full-name expressions is less</span>
<span class="sd">                    #    efficient and should be minimized or avoided if possible.</span>
<span class="sd">                    #</span>
<span class="sd">                    #    Regular expressions may be preceded with one the keywords that</span>
<span class="sd">                    #    defines the type of matching devices: ``__READABLE__``,</span>
<span class="sd">                    #    ``__MOTOR__``, ``__DETECTOR__`` and ``__FLYABLE__``.</span>
<span class="sd">                    #    For example, ``__READABLE__:^stage_:?^det.*val$:depth=4``</span>
<span class="sd">                    #    selects only the devices that are readable.</span>
<span class="sd">                    &quot;devices&quot;: {</span>
<span class="sd">                        &quot;DeviceType1&quot;: (&quot;det1&quot;, &quot;:^det2$&quot;, &quot;:^det:val$&quot;, &quot;:?^det.*val$&quot;),</span>
<span class="sd">                        &quot;DeviceType2&quot;: (&quot;__MOTOR__:?.*:depth=5&quot;),</span>
<span class="sd">                    },</span>
<span class="sd">                    # Set default value to string &#39;det1&#39;. The default value MUST be</span>
<span class="sd">                    #   defined in the function header for the parameter that has</span>
<span class="sd">                    #   the default value overridden in the decorator. The default</span>
<span class="sd">                    #   value in the header is reference to &#39;det1&#39;.</span>
<span class="sd">                    &quot;default&quot;: &quot;&#39;det1&#39;&quot;,</span>
<span class="sd">                },</span>

<span class="sd">                # Parameter that accepts a plan or a list of plans</span>
<span class="sd">                #   (plans must exist in RE Worker namespace,</span>
<span class="sd">                #    reference to the plans will be passed to the plan).</span>
<span class="sd">                &quot;plans_to_run&quot;: {</span>
<span class="sd">                    # Text descriptions of parameters are optional.</span>
<span class="sd">                    &quot;description&quot;: &quot;Parameter that accepts a plan or a list of plans.&quot;,</span>
<span class="sd">                    &quot;annotation&quot;: &quot;typing.Union[PlanType1, typing.List[PlanType2]]&quot;,</span>

<span class="sd">                    # Similarly to lists of name patterns for devices, the lists of</span>
<span class="sd">                    #   patterns for plan may include device names and name patterns</span>
<span class="sd">                    #   based on regular expressions. The patterns always start with</span>
<span class="sd">                    #   ``:`` and may contain only a single regular expressions.</span>
<span class="sd">                    #   The regular expression may be preced with ``+``, ``-`` and ``?``</span>
<span class="sd">                    #   characters (e.g. ``:?^count$), but those characters are ignored</span>
<span class="sd">                    #   by the processing algorithm. ``depth`` can not be used in</span>
<span class="sd">                    #   the plan patterns.</span>
<span class="sd">                    #</span>
<span class="sd">                    # In the following example, two lists of plan names are defined.</span>
<span class="sd">                    #   Names of the plan lists are used as types in &#39;annotation&#39;.</span>
<span class="sd">                    #   The example of annotation above allows to pass one plan from</span>
<span class="sd">                    #   the group &#39;PlanType1&#39; or a list of plans from &#39;PlanType2&#39;.</span>
<span class="sd">                    &quot;plans&quot;: {</span>
<span class="sd">                        &quot;PlanType1&quot;: (&quot;:^count$&quot;, &quot;scan&quot;, &quot;gridscan&quot;),</span>
<span class="sd">                        &quot;PlanType2&quot;: (&quot;more&quot;, &quot;plan&quot;, &quot;names&quot;, &quot;:^move_&quot;),</span>
<span class="sd">                    },</span>
<span class="sd">                },</span>

<span class="sd">                &quot;dwell_time&quot;: {</span>
<span class="sd">                    &quot;description&quot;: &quot;Dwell time.&quot;,</span>
<span class="sd">                    # The simple type &#39;float&#39; should probably be specified as</span>
<span class="sd">                    #   a parameter hint, but it can also be specified here. Putting</span>
<span class="sd">                    #   it in both places will also work.</span>
<span class="sd">                    &quot;annotation&quot;: &quot;float&quot;,</span>
<span class="sd">                    &quot;min&quot;: 0.1,</span>
<span class="sd">                    &quot;max&quot;: 10.0,</span>
<span class="sd">                    &quot;step&quot;: 0.1,</span>
<span class="sd">                }</span>

<span class="sd">                &quot;str_or_int_or_float&quot;: {</span>
<span class="sd">                    &quot;description&quot;: &quot;Some values that may be of &#39;str&#39;, &#39;int&#39; or &#39;float&#39; type.&quot;,</span>
<span class="sd">                    # The following expression can also be put as the parameter hint.</span>
<span class="sd">                    &quot;annotation&quot;: &quot;typing.Union[str, int, float]&quot;,</span>
<span class="sd">                }</span>

<span class="sd">            },</span>
<span class="sd">        })</span>
<span class="sd">        def plan(experiment_name, plans_to_run, devices=det1, dwell_time=1.0, str_or_int_or_float=5):</span>
<span class="sd">            &lt;code implementing the plan&gt;</span>

<span class="sd">    Raises</span>
<span class="sd">    ------</span>
<span class="sd">    jsonschema.ValidationError</span>
<span class="sd">        The parameter dictionary does not match the schema.</span>
<span class="sd">    ValueError</span>
<span class="sd">        The dictionary contains parameters that are not function arguments (not in the function signature).</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">function_wrap</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">inspect</span><span class="o">.</span><span class="n">isgeneratorfunction</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>

            <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">return</span> <span class="p">(</span><span class="k">yield from</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span>

            <span class="nd">@functools</span><span class="o">.</span><span class="n">wraps</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
            <span class="k">def</span> <span class="nf">wrapper</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
                <span class="k">return</span> <span class="n">func</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>

        <span class="c1"># Always create the copy (annotation dictionary may be reused)</span>
        <span class="k">nonlocal</span> <span class="n">annotation</span>
        <span class="n">annotation</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

        <span class="c1"># Create custom validator which recognizes lists and tuples as jsonschema &#39;arrays&#39;</span>
        <span class="k">def</span> <span class="nf">is_array</span><span class="p">(</span><span class="n">checker</span><span class="p">,</span> <span class="n">instance</span><span class="p">):</span>
            <span class="k">return</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">instance</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">tuple</span><span class="p">))</span>

        <span class="n">type_checker</span> <span class="o">=</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">Draft3Validator</span><span class="o">.</span><span class="n">TYPE_CHECKER</span><span class="o">.</span><span class="n">redefine</span><span class="p">(</span><span class="s2">&quot;array&quot;</span><span class="p">,</span> <span class="n">is_array</span><span class="p">)</span>
        <span class="n">ValidatorCustom</span> <span class="o">=</span> <span class="n">jsonschema</span><span class="o">.</span><span class="n">validators</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">jsonschema</span><span class="o">.</span><span class="n">Draft7Validator</span><span class="p">,</span> <span class="n">type_checker</span><span class="o">=</span><span class="n">type_checker</span><span class="p">)</span>
        <span class="n">validator</span> <span class="o">=</span> <span class="n">ValidatorCustom</span><span class="p">(</span><span class="n">schema</span><span class="o">=</span><span class="n">_parameter_annotation_schema</span><span class="p">)</span>

        <span class="c1"># Validate annotation</span>
        <span class="n">validator</span><span class="o">.</span><span class="n">validate</span><span class="p">(</span><span class="n">annotation</span><span class="p">)</span>

        <span class="n">sig</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">signature</span><span class="p">(</span><span class="n">func</span><span class="p">)</span>
        <span class="n">parameters</span> <span class="o">=</span> <span class="n">sig</span><span class="o">.</span><span class="n">parameters</span>

        <span class="n">param_unknown</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="s2">&quot;parameters&quot;</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">annotation</span><span class="p">[</span><span class="s2">&quot;parameters&quot;</span><span class="p">]:</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">parameters</span><span class="p">:</span>
                    <span class="n">param_unknown</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">param_unknown</span><span class="p">:</span>
            <span class="n">msg</span> <span class="o">=</span> <span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;Custom annotation parameters </span><span class="si">{</span><span class="n">param_unknown</span><span class="si">}</span><span class="s2"> are not &quot;</span>
                <span class="sa">f</span><span class="s2">&quot;in the signature of function &#39;</span><span class="si">{</span><span class="n">func</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&#39;.&quot;</span>
            <span class="p">)</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="n">msg</span><span class="p">)</span>

        <span class="nb">setattr</span><span class="p">(</span><span class="n">wrapper</span><span class="p">,</span> <span class="s2">&quot;_custom_parameter_annotation_&quot;</span><span class="p">,</span> <span class="n">annotation</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">wrapper</span>

    <span class="k">return</span> <span class="n">function_wrap</span></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2019-2021, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>