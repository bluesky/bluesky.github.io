

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Draft Specification &mdash; tiled 0.1.0a10.post46+g944cc1e documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Release History" href="release-history.html" />
    <link rel="prev" title="Requirements" href="requirements.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> tiled
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0a10.post46+g944cc1e
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/navigation.html">Navigate a Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/search.html">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/slicing.html">Load Slices of Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/caching.html">Keep a Local Copy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/serving-files.html">Serve a Directory of Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/plotly-integration.html">Plot Data in Plotly Chart Studio</a></li>
</ul>
<p class="caption"><span class="caption-text">How To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/configuration.html">Serve Catalogs using Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/direct-client.html">Use Tiled in Python without an HTTP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/scaling.html">Control Speed, Memory Usage, and Disk Usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/access-control.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/lineage.html">How Tiled Fits into the Ecosystem</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="http-api-overview.html">HTTP API Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="requirements.html">Requirements</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Draft Specification</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#python-api">Python API</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#readers">Readers</a></li>
<li class="toctree-l3"><a class="reference internal" href="#catalogs">Catalogs</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#queries">Queries</a></li>
<li class="toctree-l4"><a class="reference internal" href="#access-policy">Access Policy</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="min-versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tiled</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Draft Specification</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/reference/specification.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="draft-specification">
<h1>Draft Specification<a class="headerlink" href="#draft-specification" title="Permalink to this headline">¶</a></h1>
<p>There are four user-facing objects in the system:</p>
<ul class="simple">
<li><p><strong>Reader</strong> – extracts the metadata, structure, and (tiled) data from some
source of store or generated data</p></li>
<li><p><strong>Catalog</strong> – nestable collection of other Catalogs or Readers</p></li>
<li><p><strong>Query</strong> – high-level description of a search query over entries in a
Catalog</p></li>
<li><p><strong>AccessPolicy</strong> – class with methods for enforcing access control on which
entries in a Catalog a given identity (user) can see</p></li>
</ul>
<p>This specification proposes the Python API required to duck-type as a Catalog or
Reader as well as a sample HTTP API based on
<a class="reference external" href="https://jsonapi.org/">JSON API</a>.</p>
<div class="section" id="python-api">
<h2>Python API<a class="headerlink" href="#python-api" title="Permalink to this headline">¶</a></h2>
<div class="section" id="readers">
<h3>Readers<a class="headerlink" href="#readers" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Readers MUST implement a <code class="docutils literal notranslate"><span class="pre">metadata</span></code> attribute or property which returns
a dict-like. This <code class="docutils literal notranslate"><span class="pre">metadata</span></code> is treated as user space, and no part of the
server or client will rely on its contents.</p></li>
<li><p>Readers MUST implement a <code class="docutils literal notranslate"><span class="pre">structure_family</span></code> attribute or property which returns
a string of the general type that will be returned by <code class="docutils literal notranslate"><span class="pre">read()</span></code>, as in
intake. These will be generic terms like <code class="docutils literal notranslate"><span class="pre">&quot;array&quot;</span></code>, not the
<code class="docutils literal notranslate"><span class="pre">__qualname__</span></code> of the class. It is meant to encompass the range of concrete
types (cupy array, sparse array, dask array, numpy ndarray) that duck-type as
a given generic structure.</p></li>
<li><p>Readers MUST implement a method <code class="docutils literal notranslate"><span class="pre">structure()</span></code> with no arguments
which returns a description of the structure of this data. For each structure family
(array, dataframe, etc.) there will be a specific schema for this description
(TBD). For example, “array” reports machine data type, shape, and chunks.
Richer structure (e.g. xarray) will include high-level structure like columns,
dimensions, indexes.</p></li>
<li><p>Readers MUST implement a method <code class="docutils literal notranslate"><span class="pre">read()</span></code> returns the data structure. It MAY
return a lazy object, such as a PIMS sequence, dask array, dask dataframe, or
other structure with delayed I/O.</p></li>
<li><p>Readers MUST implement a method <code class="docutils literal notranslate"><span class="pre">read_block(...)</span></code> that efficiently reads and
return a single block of data. It MUST perform all necessary I/O and return a
self-contained and complete structure; that is, unlike <code class="docutils literal notranslate"><span class="pre">read()</span></code> it must not
be delayed. The signature SHOULD reuse existing terminology from the
corresponding data strucutre.  Examples:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">array_reader</span><span class="o">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="n">dataframe_reader</span><span class="o">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">partition</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
<span class="n">dataset_reader</span><span class="o">.</span><span class="n">read_block</span><span class="p">(</span><span class="n">variable</span><span class="o">=</span><span class="s2">&quot;image&quot;</span><span class="p">,</span> <span class="n">coord</span><span class="o">=</span><span class="s2">&quot;x&quot;</span><span class="p">,</span> <span class="n">block</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,))</span>
</pre></div>
</div>
<p>Additionally, the method SHOULD accept a <code class="docutils literal notranslate"><span class="pre">slice</span></code> parameter which takes a
tuple of Python <code class="docutils literal notranslate"><span class="pre">slice</span></code> objects into the block to specify a partial block.</p>
</li>
<li><p>Reader MAY allocate system resources (file handles, network connections, a
cache in memory) but MUST implement a method <code class="docutils literal notranslate"><span class="pre">close()</span></code> which releases those
resources. It MUST also implement the context manager API and call <code class="docutils literal notranslate"><span class="pre">close()</span></code>
on exiting the context.</p></li>
<li><p>Readers MAY implement other methods beyond these for application-specific
needs or usability.</p></li>
</ul>
</div>
<div class="section" id="catalogs">
<h3>Catalogs<a class="headerlink" href="#catalogs" title="Permalink to this headline">¶</a></h3>
<ul>
<li><p>Catalogs MUST implement the <code class="docutils literal notranslate"><span class="pre">collections.abc.Mapping</span></code> interface. That is:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">catalog</span><span class="o">.</span><span class="fm">__getitem__</span>
<span class="n">catalog</span><span class="o">.</span><span class="fm">__iter__</span>
</pre></div>
</div>
<p>Catalogs may omit <code class="docutils literal notranslate"><span class="pre">__len___</span></code> as long as they provide
<a class="reference external" href="https://www.python.org/dev/peps/pep-0424/"><code class="docutils literal notranslate"><span class="pre">__length_hint__</span></code></a>, an estimated
length that may be less expensive for Catalogs backed by databases. That is,
implement one or both of these:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">catalog</span><span class="o">.</span><span class="fm">__len__</span>
<span class="n">catalog</span><span class="o">.</span><span class="fm">__length_hint__</span>
</pre></div>
</div>
</li>
<li><p>Catalogs MUST implement an attributes which support efficient positional
lookup and slicing.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">catalog</span><span class="o">.</span><span class="n">keys_indexer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>             <span class="c1"># -&gt; str</span>
<span class="n">catalog</span><span class="o">.</span><span class="n">values_indexer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>           <span class="c1"># -&gt; Union[Catalog, Reader]</span>
<span class="n">catalog</span><span class="o">.</span><span class="n">items_indexer</span><span class="p">[</span><span class="n">i</span><span class="p">]</span>            <span class="c1"># -&gt; Tuple[str, Union[Catalog, Reader]]</span>
<span class="n">catalog</span><span class="o">.</span><span class="n">keys_indexer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>    <span class="c1"># -&gt; List[str]</span>
<span class="n">catalog</span><span class="o">.</span><span class="n">items_indexer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>   <span class="c1"># -&gt; List[Union[Catalog, Reader]]</span>
<span class="n">catalog</span><span class="o">.</span><span class="n">values_indexer</span><span class="p">[</span><span class="n">start</span><span class="p">:</span><span class="n">stop</span><span class="p">]</span>  <span class="c1"># -&gt; List[Tuple[str, Union[Catalog, Reader]]]</span>
</pre></div>
</div>
</li>
<li><p>It is NOT necessary to implemented strided slicing, as in <code class="docutils literal notranslate"><span class="pre">[start:stop:5]</span></code>.
It is sufficient to assume the stride is always 1.</p></li>
<li><p>The values in a Catalog MUST be other Catalogs or Readers.</p></li>
<li><p>The keys in a Catalog MUST be non-empty strings adhering to the JSON API spec
for allowed characters in resource ids.</p></li>
<li><p>Catalogs MUST implement a <code class="docutils literal notranslate"><span class="pre">search</span></code> method which accepts a <code class="docutils literal notranslate"><span class="pre">Query</span></code> as its
argument and returns another Catalog with a subset of the items.  specified.</p></li>
<li><p>Catalogs MUST implement a <code class="docutils literal notranslate"><span class="pre">metadata</span></code> attribute or property which
returns a dict-like. This <code class="docutils literal notranslate"><span class="pre">metadata</span></code> is treated as user space, and no part
of the server or client will rely on its contents.</p></li>
<li><p>Catalogs MAY implement other methods beyond these for application-specific
needs or usability.</p></li>
<li><p>The method for initializing this object is intentionally unspecified. There
will be variety.</p></li>
<li><p>[This may need revisiting. Should it be qualified? Eliminated?] The items in a
Catalog MUST have an explicit and stable order.</p></li>
<li><p>[This may need revisiting. Should it be qualified? Eliminated?] The data
underlying the Catalog may be updated to add items, even though the Catalog
itself is a read-only view on that data. Any items added MUST be added to the
end. Items may not be removed.</p></li>
</ul>
<div class="section" id="queries">
<h4>Queries<a class="headerlink" href="#queries" title="Permalink to this headline">¶</a></h4>
<ul class="simple">
<li><p>Queries MUST be dataclasses.</p></li>
<li><p>They MAY have any attributes. There are no required attributes.</p></li>
</ul>
</div>
<div class="section" id="access-policy">
<h4>Access Policy<a class="headerlink" href="#access-policy" title="Permalink to this headline">¶</a></h4>
<p>An <code class="docutils literal notranslate"><span class="pre">AcessPolicy</span></code> is tightly coupled to:</p>
<ol class="simple">
<li><p>How the metadata related to data management are stored — “Which type of
database? Which collection / table in the database? Which field / column in
that table?”</p></li>
<li><p>The particulars of a given access management system that encodes who can see
what — “Given an authenticated identity, what API do I use to check what it
is allowed to see?”</p></li>
</ol>
<p>We envision a custom <code class="docutils literal notranslate"><span class="pre">AccessPolicy</span></code> will be needed for every combination of
(1) and (2). It is injected into a given <code class="docutils literal notranslate"><span class="pre">Catalog</span></code> at <code class="docutils literal notranslate"><span class="pre">__init__</span></code> time.</p>
<p>An <code class="docutils literal notranslate"><span class="pre">AccessPolicy</span></code> gets two opportunities to restrict the entries that a caller
can see. First, a Catalog gives it the opportunity to modify a query before it
is processed in order to restirct the set of results marshalled from storage.
Second, it may filter the query results before they are returned to the user.
Depending on the storage and the complexity of the data access rules, one or
both of these modes may be used by a given AccessPolicy.</p>
<ul class="simple">
<li><p>An AccessPolicy MUST implement a method
<code class="docutils literal notranslate"><span class="pre">modify_query(query:</span> <span class="pre">Query,</span> <span class="pre">authenticated_identity:</span> <span class="pre">str)</span> <span class="pre">-&gt;</span> <span class="pre">Query</span></code>. This MAY
filter the result at the database level so that less data is marshalled from
storage.</p></li>
<li><p>An AccessPolicy MUST implement a method
<code class="docutils literal notranslate"><span class="pre">filter_results(catalog,</span> <span class="pre">authenticated_identity:</span> <span class="pre">str)</span> <span class="pre">-&gt;</span> <span class="pre">Catalog</span></code></p></li>
<li><p>An AccessPolicy MUST implement a method
<code class="docutils literal notranslate"><span class="pre">check_compatibility(catalog)</span> <span class="pre">-&gt;</span> <span class="pre">bool</span></code> which can be used by the Catalog to
verify at its <code class="docutils literal notranslate"><span class="pre">__init___</span></code> time that the <code class="docutils literal notranslate"><span class="pre">AccessPolicy</span></code> it has been given
understands how to modify its queries.</p></li>
</ul>
</div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="release-history.html" class="btn btn-neutral float-right" title="Release History" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="requirements.html" class="btn btn-neutral float-left" title="Requirements" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Bluesky Collaboration.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>