

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Streaming &mdash; tiled 0.0.1.dev2376+g92c890d44 documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=9edc463e" />
      <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=a1f3aa11"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Simple Tiled Server" href="simple-server.html" />
    <link rel="prev" title="Writing Data" href="writing.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            tiled
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="navigation.html">Navigate with the Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="slicing.html">Load Slices of Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="export.html">Deliberate Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="login.html">Log into an Authenticated Tiled Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="serving-files.html">Serve a Directory of Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="search.html">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="writing.html">Writing Data</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Streaming</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#prerequisite-redis">Prerequisite: Redis</a></li>
<li class="toctree-l2"><a class="reference internal" href="#launch-tiled-server-with-streaming-cache">Launch Tiled Server with Streaming Cache</a></li>
<li class="toctree-l2"><a class="reference internal" href="#write-and-stream-data">Write and Stream Data</a></li>
<li class="toctree-l2"><a class="reference internal" href="#disconnecting-or-closing">Disconnecting or Closing</a></li>
<li class="toctree-l2"><a class="reference internal" href="#sequence-number-guarantees">Sequence Number Guarantees</a></li>
<li class="toctree-l2"><a class="reference internal" href="#performance-optimization-non-persistent-updates">Performance Optimization: Non-persistent Updates</a></li>
<li class="toctree-l2"><a class="reference internal" href="#limitations">Limitations</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="simple-server.html">Simple Tiled Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotly-integration.html">Plot Data in Plotly Chart Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="zarr-integration.html">Serve Data as Zarr</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/authentication.html">Python Client Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/profiles.html">Use Profiles to streamline Python client setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/client-logger.html">Use Performance and Debug Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/docker.html">Run Tiled Server in a Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/helm.html">Run Tiled Server from the Helm chart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/configuration.html">Serve Data using Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/read-custom-formats.html">Serve Files with Custom Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/custom-export-formats.html">Add Custom Export Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/api-keys.html">Create and Use API Keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/custom-clients.html">Custom Python Client Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/metrics.html">Prometheus Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/direct-client.html">Use Tiled in Python without an HTTP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/tiled-authn-database.html">Set up a database for a scaled authenticated deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/register.html">Register Content in Tiled</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/retries.html">Control Retries</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/standards.html">Standards Used by Tiled</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/structures.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/metadata.html">Metadata and “Specs”</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/compression.html">Compression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/specialized-formats.html">Case Study: Reading and Exporting a Specialized Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/caching.html">Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/access-control.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/catalog.html">Catalog Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/lineage.html">How Tiled Fits into the Ecosystem</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/storage-database.html">Storage Database</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/service.html">Service-side Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/http-api-overview.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/python-client.html">Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/queries.html">Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/authentication.html">Authentication Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/scopes.html">Scopes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/commandline.html">Command-line tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/service-configuration.html">Service Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/client-profiles.html">Client Profiles Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/min-versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tiled</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Streaming</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/tutorials/streaming.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="streaming">
<h1>Streaming<a class="headerlink" href="#streaming" title="Link to this heading"></a></h1>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Streaming is an experimental feature in Tiled, subject to backward-compatible
changes without notice.</p>
<p>Additionally, it is only currently supported on containers, arrays (both
uploaded and external registered data), and tables (uploaded data only).
Support for external registered tabular data and other structures (sparse,
awkward) is planned but not yet implemented.</p>
</div>
<section id="prerequisite-redis">
<h2>Prerequisite: Redis<a class="headerlink" href="#prerequisite-redis" title="Link to this heading"></a></h2>
<p>Tiled’s streaming feature requires Redis, which it uses to cache
recent fragments of data (or pointers to large data) and track
when to notify subscribed clients about updates.</p>
<p>You can run it however you wish. For simple testing, this works:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">docker</span> <span class="n">run</span> <span class="o">-</span><span class="n">d</span> <span class="o">--</span><span class="n">rm</span> <span class="o">--</span><span class="n">name</span> <span class="n">tiled</span><span class="o">-</span><span class="n">test</span><span class="o">-</span><span class="n">redis</span> <span class="o">-</span><span class="n">p</span> <span class="mi">6379</span><span class="p">:</span><span class="mi">6379</span> <span class="n">docker</span><span class="o">.</span><span class="n">io</span><span class="o">/</span><span class="n">redis</span><span class="p">:</span><span class="mi">7</span><span class="o">-</span><span class="n">alpine</span>
</pre></div>
</div>
<p>(For production, we recommend configuring Redis with encryption and a password.)</p>
</section>
<section id="launch-tiled-server-with-streaming-cache">
<h2>Launch Tiled Server with Streaming Cache<a class="headerlink" href="#launch-tiled-server-with-streaming-cache" title="Link to this heading"></a></h2>
<p>For simple testing, this is a suitable command:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tiled</span> <span class="n">serve</span> <span class="n">catalog</span> <span class="o">--</span><span class="n">temp</span> <span class="o">--</span><span class="n">api</span><span class="o">-</span><span class="n">key</span> <span class="n">secret</span> <span class="o">--</span><span class="n">cache</span> <span class="n">redis</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">6379</span>
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Never specify a guessable API key like <code class="docutils literal notranslate"><span class="pre">secret</span></code> in production; let Tiled
generate a random one. This is just a convenience for testing.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If using a config file, add this section:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>```yaml
streaming_cache:
  uri: redis://localhost:6379
```
</pre></div>
</div>
</div>
</section>
<section id="write-and-stream-data">
<span id="write-stream-data"></span><h2>Write and Stream Data<a class="headerlink" href="#write-and-stream-data" title="Link to this heading"></a></h2>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tiled.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">from_uri</span>

<span class="c1"># Connect</span>
<span class="n">client</span> <span class="o">=</span> <span class="n">from_uri</span><span class="p">(</span><span class="s1">&#39;http://localhost:8000&#39;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;secret&#39;</span><span class="p">)</span>

<span class="c1"># Create a Subscription</span>
<span class="n">sub</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>

<span class="c1"># Register a callback, a function that will be called when updates are received.</span>
<span class="k">def</span><span class="w"> </span><span class="nf">on_child_created</span><span class="p">(</span><span class="n">update</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;NEW:&quot;</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">child</span><span class="p">())</span>

<span class="n">sub</span><span class="o">.</span><span class="n">child_created</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">on_child_created</span><span class="p">)</span>

<span class="c1"># Start listening for updates.</span>
<span class="n">sub</span><span class="o">.</span><span class="n">start_in_thread</span><span class="p">()</span>
</pre></div>
</div>
<p>In a separate process (if you like) create a new array.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span><span class="w"> </span><span class="nn">tiled.client</span><span class="w"> </span><span class="kn">import</span> <span class="n">from_uri</span>
<span class="kn">import</span><span class="w"> </span><span class="nn">numpy</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">from_uri</span><span class="p">(</span><span class="s1">&#39;http://localhost:8000&#39;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;secret&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">write_array</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">]),</span> <span class="n">key</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
</pre></div>
</div>
<p>Back in the process with the subscription, you will see that something has been
printed.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>NEW: &lt;ArrayClient shape=(3,) chunks=((3,)) dtype=int64&gt;
</pre></div>
</div>
<p>If we are interested, we can subscribe to updates about <code class="docutils literal notranslate"><span class="pre">x</span></code> and its data.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">x_sub</span> <span class="o">=</span> <span class="n">c</span><span class="p">[</span><span class="s1">&#39;x&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">new_data</span><span class="o">.</span><span class="n">subscribe</span><span class="p">()</span>

<span class="k">def</span><span class="w"> </span><span class="nf">on_new_data</span><span class="p">(</span><span class="n">update</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;offset:&quot;</span><span class="p">,</span> <span class="n">update</span><span class="o">.</span><span class="n">offset</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">update</span><span class="o">.</span><span class="n">data</span><span class="p">())</span>

<span class="n">x_sub</span><span class="o">.</span><span class="n">new_data</span><span class="o">.</span><span class="n">add_callback</span><span class="p">(</span><span class="n">on_new_data</span><span class="p">)</span>
</pre></div>
</div>
<p>Suppose that, while we are getting that set up, the other process extends the
array with more data in <code class="docutils literal notranslate"><span class="pre">x</span></code>:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="n">offset</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">extend</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p>We can ensure that subscriber sees the full (recent) picture by specifying that
its subscription should start from as far back as the server has available.
(By default, the server retains an hour of history in Redis for fast streaming
access, but it may shed history earlier if it grows short on available RAM.)</p>
<p>This feature is not designed to provide a comprehensive history, only to allow
clients to catch up if they start late—such as a live data processing job
launched after an experiment is already in progress.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">x_sub</span><span class="o">.</span><span class="n">start_in_thread</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
<p>It will receive updates that have already happened:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>offset: (0,)
[1, 2, 3]
offset: (3,)
[4, 5, 6]
</pre></div>
</div>
<p>and, from there, any new updates as well.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">update</span></code> includes a <code class="docutils literal notranslate"><span class="pre">sequence</span></code> counter, starting from the number 1.
Subscribers can use this if, for example, they need to recover from an
interruption. They can subscribe from a specific counter index
<code class="docutils literal notranslate"><span class="pre">sub.start_in_thread(N)</span></code>. As already mentioned above, <code class="docutils literal notranslate"><span class="pre">x.start_in_thread(0)</span></code>
means, “Start from the oldest record retained.”</p>
<p>Of course, clients can always fetch <em>all</em> of the data via the non-streaming
interface.</p>
</section>
<section id="disconnecting-or-closing">
<h2>Disconnecting or Closing<a class="headerlink" href="#disconnecting-or-closing" title="Link to this heading"></a></h2>
<p>A subscriber can disconnect from a stream at any point, like so:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">sub</span><span class="o">.</span><span class="n">disconnect</span><span class="p">()</span>
</pre></div>
</div>
<p>Producers (writers) can indicate that no more data is expected (for now).</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">close_stream</span><span class="p">()</span>
</pre></div>
</div>
<p>This will cause the server to disconnect any active subscribers, once
they are caught up to the last item in the stream. (On a protocol level,
this sends the WebSocket code <code class="docutils literal notranslate"><span class="pre">1000</span> <span class="pre">ConnectionClosedOK</span></code>. Clients can tell
that they were disconnected due to stream completion, not an error.) In the
Python client, this will stop the threads that are listening for updates and
it will set <code class="docutils literal notranslate"><span class="pre">sub.closed</span></code> to <code class="docutils literal notranslate"><span class="pre">True</span></code>.</p>
<p>Writing can still resume writing later—or even immediately. Closing a stream
signals that consumers should not <em>expect</em> any more data soon, and forces them
to affirmatively re-subscribe if they want to watch for any. Live data
processing jobs may use this as a prompt to clean up and free up resources.</p>
</section>
<section id="sequence-number-guarantees">
<h2>Sequence Number Guarantees<a class="headerlink" href="#sequence-number-guarantees" title="Link to this heading"></a></h2>
<p>While the sequence number is guaranteed to increment by 1 during an active
stream, clients should expect that it <em>may</em> reset back to 1 after a stream has
been idle. This happens quickly (1 hour, by default) if a stream is explicitly
closed or slowly (30 days, by default) if a stream is left un-closed but
dormant. These intervals are configurable via the settings <code class="docutils literal notranslate"><span class="pre">data_ttl</span></code> and
<code class="docutils literal notranslate"><span class="pre">seq_ttl</span></code> respectively under <code class="docutils literal notranslate"><span class="pre">streaming_cach</span></code> configuration.  (In the <code class="docutils literal notranslate"><span class="pre">tiled</span> <span class="pre">serve</span></code> CLI they are <code class="docutils literal notranslate"><span class="pre">--cache-data-ttl</span></code> and <code class="docutils literal notranslate"><span class="pre">--cache-seq-ttl</span></code>.)</p>
</section>
<section id="performance-optimization-non-persistent-updates">
<h2>Performance Optimization: Non-persistent Updates<a class="headerlink" href="#performance-optimization-non-persistent-updates" title="Link to this heading"></a></h2>
<p>To rapidly stream large arrays of transitory data, it might be unnecessary
or even undesirable to persist the intermediate arrays to storage.
In this case, pass the parameter <code class="docutils literal notranslate"><span class="pre">persist=False</span></code> to <code class="docutils literal notranslate"><span class="pre">ArrayClient.write()</span></code>
or <code class="docutils literal notranslate"><span class="pre">ArrayClient.patch()</span></code>.</p>
<p>This could be useful for serving reconstructed images to an on-screen display
while an iterative algorithm is refining that reconstruction. Only the final
image needs to be persisted. The intermediate images can be discarded as each
new image is received.</p>
<p>To try this yourself, modify the code in <a class="reference internal" href="#write-stream-data"><span class="std std-ref">Write and Stream Data</span></a> to include the
<code class="docutils literal notranslate"><span class="pre">persist=False</span></code> when sending updates.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Intial state: x == [1, 2, 3]</span>

<span class="c1"># PUT (write) new values</span>
<span class="n">x</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="n">persist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="c1"># x == [1, 2, 3], update.data() == [4, 5, 6]</span>
<span class="n">x</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]),</span> <span class="n">persist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="c1"># x == [1, 2, 3], update.data() == [7, 8, 9]</span>

<span class="c1"># Persist the final array</span>
<span class="n">x</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]))</span>  <span class="c1"># x == [11, 12, 13], persist == True</span>
</pre></div>
</div>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># Intial state: x == [1, 2, 3]</span>

<span class="c1"># PATCH (patch) new values</span>
<span class="n">x</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">11</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,)),</span> <span class="n">persist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="c1"># x == [1, 2, 3], update.data() == [11], update.offset() == (0,)</span>
<span class="n">x</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">12</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,)),</span> <span class="n">persist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="c1"># x == [1, 2, 3], update.data() == [12], update.offset() == (1,)</span>
<span class="n">x</span><span class="o">.</span><span class="n">patch</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">13</span><span class="p">],</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">2</span><span class="p">,)),</span> <span class="n">persist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="c1"># x == [1, 2, 3], update.data() == [13], update.offset() == (2,)</span>

<span class="c1"># Persist the final array</span>
<span class="n">x</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]))</span>  <span class="c1"># x == [11, 12, 13], persist == True</span>
</pre></div>
</div>
<p>The array could initially be left empty to further reduce the writes to disk.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">client</span> <span class="o">=</span> <span class="n">from_uri</span><span class="p">(</span><span class="s1">&#39;http://localhost:8000&#39;</span><span class="p">,</span> <span class="n">api_key</span><span class="o">=</span><span class="s1">&#39;secret&#39;</span><span class="p">)</span>
<span class="n">x</span> <span class="o">=</span> <span class="n">client</span><span class="o">.</span><span class="n">new</span><span class="p">(</span>
    <span class="n">structure_family</span><span class="o">=</span><span class="n">StructureFamily</span><span class="o">.</span><span class="n">array</span><span class="p">,</span>
    <span class="n">data_sources</span><span class="o">=</span><span class="p">[</span><span class="n">tiff_data_source</span><span class="p">],</span>  <span class="c1"># DataSource details omitted for brevity</span>
    <span class="n">data_sources</span><span class="o">=</span><span class="p">[</span>
        <span class="c1"># In-memory DataSource details omitted for brevity</span>
        <span class="n">DataSource</span><span class="p">(</span><span class="n">structure</span><span class="o">=</span><span class="n">structure</span><span class="p">,</span> <span class="n">structure_family</span><span class="o">=</span><span class="n">StructureFamily</span><span class="o">.</span><span class="n">array</span><span class="p">),</span>
        <span class="c1"># Or use an external data source, such as a TIFF file</span>
        <span class="n">tiff_data_source</span><span class="p">,</span>  <span class="c1"># DataSource details omitted for brevity</span>
    <span class="p">],</span>
    <span class="n">key</span><span class="o">=</span><span class="s1">&#39;x&#39;</span><span class="p">,</span>
<span class="p">)</span>
<span class="c1"># Intial state: x == [?, ?, ?]</span>

<span class="c1"># PUT (write) new values</span>
<span class="n">x</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">]),</span> <span class="n">persist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="c1"># x == [?, ?, ?], update.data() == [4, 5, 6]</span>
<span class="n">x</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]),</span> <span class="n">persist</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
  <span class="c1"># x == [?, ?, ?], update.data() == [7, 8, 9]</span>

<span class="c1"># Persist the final array</span>
<span class="n">x</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">numpy</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]))</span>  <span class="c1"># x == [11, 12, 13], persist == True</span>
</pre></div>
</div>
</section>
<section id="limitations">
<h2>Limitations<a class="headerlink" href="#limitations" title="Link to this heading"></a></h2>
<p>This feature is in a very early preview stage.</p>
<ul class="simple">
<li><p>External registered tabular data is not yet supported.</p></li>
<li><p>Other data structures (sparse, awkward) are not yet supported.</p></li>
<li><p>Arrays can be patched with either <code class="docutils literal notranslate"><span class="pre">extend=True</span></code> or <code class="docutils literal notranslate"><span class="pre">persist=False</span></code>,
but not both.</p></li>
<li><p>Deletions of nodes are not yet visible to subscribers.</p></li>
</ul>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="writing.html" class="btn btn-neutral float-left" title="Writing Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="simple-server.html" class="btn btn-neutral float-right" title="Simple Tiled Server" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Bluesky Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>