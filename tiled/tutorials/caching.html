

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Keep a Local Copy &mdash; tiled 0.1.0a14.post2+g49c1b96 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
  <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Deliberate Export" href="export.html" />
    <link rel="prev" title="Load Slices of Data" href="slicing.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> tiled
          

          
          </a>

          
            
            
              <div class="version">
                0.1.0a14.post2+g49c1b96
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Tutorials</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="navigation.html">Navigate a Catalog</a></li>
<li class="toctree-l1"><a class="reference internal" href="slicing.html">Load Slices of Data</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Keep a Local Copy</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#make-repeated-access-fast-within-one-working-session-process">Make repeated access fast within one working session / process</a></li>
<li class="toctree-l2"><a class="reference internal" href="#make-repeated-access-fast-across-working-sessions-processes">Make repeated access fast across working sessions / processes</a></li>
<li class="toctree-l2"><a class="reference internal" href="#work-offline-in-airplane-mode-no-network-connection">Work offline in “airplane mode” (no network connection)</a></li>
<li class="toctree-l2"><a class="reference internal" href="#comparison-to-deliberate-export">Comparison to “deliberate export”</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="export.html">Deliberate Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="serving-files.html">Serve a Directory of Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="search.html">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="plotly-integration.html">Plot Data in Plotly Chart Studio</a></li>
</ul>
<p class="caption"><span class="caption-text">How To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/configuration.html">Serve Catalogs using Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/profiles.html">Use Profiles to streamline Python client setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/direct-client.html">Use Tiled in Python without an HTTP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/scaling.html">Control Speed, Memory Usage, and Disk Usage</a></li>
</ul>
<p class="caption"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/structures.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/access-control.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/lineage.html">How Tiled Fits into the Ecosystem</a></li>
</ul>
<p class="caption"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/service.html">Service-side Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/http-api-overview.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/python-client.html">Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/authentication.html">Authentication Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/commandline.html">Command-line tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/service-configuration.html">Service Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/client-profiles.html">Client Profiles Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/design-documents/index.html">Design Documents</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/min-versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tiled</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Keep a Local Copy</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/tutorials/caching.md.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="keep-a-local-copy">
<h1>Keep a Local Copy<a class="headerlink" href="#keep-a-local-copy" title="Permalink to this headline">¶</a></h1>
<p>Tiled can use a local <em>cache</em> to make efficient use of network bandwidth and the
user’s time. It avoids downloading something twice if it hasn’t changed.
This also enables an offline “airplane mode”.</p>
<p>To follow along, start the Tiled server with the demo Catalog from a Terminal.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">tiled</span> <span class="n">serve</span> <span class="n">pyobject</span> <span class="o">--</span><span class="n">public</span> <span class="n">tiled</span><span class="o">.</span><span class="n">examples</span><span class="o">.</span><span class="n">generated</span><span class="p">:</span><span class="n">demo</span>
</pre></div>
</div>
<div class="section" id="make-repeated-access-fast-within-one-working-session-process">
<h2>Make repeated access fast within one working session / process<a class="headerlink" href="#make-repeated-access-fast-within-one-working-session-process" title="Permalink to this headline">¶</a></h2>
<p><em>Solution: Stash results in memory (RAM).</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tiled.client</span> <span class="kn">import</span> <span class="n">from_uri</span>
<span class="kn">from</span> <span class="nn">tiled.client.cache</span> <span class="kn">import</span> <span class="n">Cache</span>

<span class="n">catalog</span> <span class="o">=</span> <span class="n">from_uri</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">Cache</span><span class="o">.</span><span class="n">in_memory</span><span class="p">(</span><span class="mf">2e9</span><span class="p">))</span>
</pre></div>
</div>
<p>where we have to specify the maximum RAM we are willing to dedicate to the cache,
here set to <code class="docutils literal notranslate"><span class="pre">2e9</span></code>, 2 GB.</p>
<p>Most things that we do with a Catalog or dataset make an HTTP request to the
server and receive a response. For example…</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">catalog</span> <span class="o">=</span> <span class="n">from_uri</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">Cache</span><span class="o">.</span><span class="n">in_memory</span><span class="p">(</span><span class="mf">2e9</span><span class="p">))</span>  <span class="c1"># fetches some metadata</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">catalog</span>
<span class="go">&lt;Catalog {&#39;arrays&#39;, &#39;dataframes&#39;, &#39;xarrays&#39;, &#39;nested&#39;, ...} ~5 entries&gt;   # fetches the first couple entry names</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">catalog</span><span class="o">.</span><span class="n">metadata</span>  <span class="c1"># fetches metadata (in this case empty)</span>
<span class="go">DictView({})</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;dataframes&#39;</span><span class="p">][</span><span class="s1">&#39;df&#39;</span><span class="p">]</span>  <span class="c1"># fetches column names</span>
<span class="go">&lt;DataFrameClient [&#39;A&#39;, &#39;B&#39;, &#39;C&#39;]&gt;</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;dataframes&#39;</span><span class="p">][</span><span class="s1">&#39;df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">metadata</span>  <span class="c1"># fetches metadata (in this case empty)</span>
<span class="go">DictView({})</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">catalog</span><span class="p">[</span><span class="s1">&#39;dataframes&#39;</span><span class="p">][</span><span class="s1">&#39;df&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">compute</span><span class="p">()</span>  <span class="c1"># fetches data, in partitions</span>
<span class="go">              A         B         C</span>
<span class="go">index                              </span>
<span class="go">0      0.748885  0.769644  0.296070</span>
<span class="go">1      0.071319  0.364743  0.718473</span>
<span class="go">2      0.322665  0.897854  0.558606</span>
<span class="go">3      0.328785  0.810159  0.073775</span>
<span class="go">4      0.158253  0.822505  0.637224</span>
<span class="gp">... </span>        <span class="o">...</span>       <span class="o">...</span>       <span class="o">...</span>
<span class="go">95     0.913758  0.488304  0.615120</span>
<span class="go">96     0.969652  0.287850  0.288405</span>
<span class="go">97     0.769774  0.941785  0.353047</span>
<span class="go">98     0.350033  0.052412  0.969244</span>
<span class="go">99     0.356245  0.683540  0.166682</span>

<span class="go">[100 rows x 3 columns]</span>
</pre></div>
</div>
<p>If run any of the code above, a second time, we’ll find that it’s faster.</p>
<p>How does it work? Each HTTP request and response is captured inside
<code class="docutils literal notranslate"><span class="pre">Cache</span></code>. If the same operation is performed again later, we send a request
to the server to check whether the content has changed since our last
request, and it only sends a fresh copy if it has. Otherwise, we can use the
copy in our <code class="docutils literal notranslate"><span class="pre">Cache</span></code> to save bandwidth and time. All of this happens
automatically.</p>
<p>If the size limit is reached, <code class="docutils literal notranslate"><span class="pre">Cache</span></code> evicts entries to make room for new
ones. It decides what to evict based on a “score” that takes into account how
long it would take to re-download and how often it’s been used recently.</p>
<p>Because the <code class="docutils literal notranslate"><span class="pre">Cache.in_memory(...)</span></code> stores data in RAM it only applies to
specific Python process. Once Python exits (or a Jupyter kernel is restarted)
or data is lost and will need to be cached anew. To persist it for longer,
see the next section.</p>
</div>
<div class="section" id="make-repeated-access-fast-across-working-sessions-processes">
<h2>Make repeated access fast across working sessions / processes<a class="headerlink" href="#make-repeated-access-fast-across-working-sessions-processes" title="Permalink to this headline">¶</a></h2>
<p><em>Solution: Stash results on disk.</em></p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tiled.client</span> <span class="kn">import</span> <span class="n">from_uri</span>
<span class="kn">from</span> <span class="nn">tiled.client.cache</span> <span class="kn">import</span> <span class="n">Cache</span>

<span class="hll"><span class="n">catalog</span> <span class="o">=</span> <span class="n">from_uri</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">Cache</span><span class="o">.</span><span class="n">on_disk</span><span class="p">(</span><span class="s2">&quot;my_cache_directory&quot;</span><span class="p">))</span>
</span></pre></div>
</div>
<p>This works exactly the same as before, but now the data is stored in files on disk.
The data can be shared across processes and reused between working sessions.</p>
<p>Some things to know:</p>
<ul class="simple">
<li><p>You can place an upper limit on how much disk space this is allowed to use.
By default it will use all the space available on the disk minus 1 GB.</p></li>
<li><p>The directory will be created if it doesn’t yet exist.</p></li>
<li><p>It is safe to reuse the same directory for multiple different Catalogs.
The files will not collide.</p></li>
<li><p>It is safe to share a directory across concurrent processes. The on-disk
cache uses file-based locking to stay consistent.</p></li>
<li><p>The naming and format of the files is internal to Tiled. It is not intended to be
accessed by other programs or directly touched by the user. For export files for
use by other programs see a later section.</p></li>
</ul>
</div>
<div class="section" id="work-offline-in-airplane-mode-no-network-connection">
<h2>Work offline in “airplane mode” (no network connection)<a class="headerlink" href="#work-offline-in-airplane-mode-no-network-connection" title="Permalink to this headline">¶</a></h2>
<p><em>Solution: Proactively download a Catalog into Cache that can be used offline.</em></p>
<p>First, when connected to the Internet, connect a Catalog and download it.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tiled.client.cache</span> <span class="kn">import</span> <span class="n">download</span>
<span class="kn">from</span> <span class="nn">tiled.client</span> <span class="kn">import</span> <span class="n">from_uri</span>

<span class="n">catalog</span> <span class="o">=</span> <span class="n">from_uri</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">)</span>
<span class="n">download</span><span class="p">(</span><span class="n">catalog</span><span class="p">,</span> <span class="s2">&quot;my_cache_directory&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>This will downloaded everything needed for basic usage. Note it cannot
support open-ended <em>search</em> functionality because the space of possible
queries is too large, but specific search results can be cached by
just running the search while connected:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">catalog</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="o">...</span><span class="p">)</span>
</pre></div>
</div>
<p>TO DO: Demonstrate downloading only a <em>portion</em> of a Catalog.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Alternatively, a basic download can be performed from the command line via the
tiled CLI.</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>$ tiled download &quot;http://localhost:8000&quot; my_cache_directory
</pre></div>
</div>
</div>
<p>In normal <em>online</em> operation, Tiled will still “phone home” to the server
just to check that its cached copy is still the most recent version of
the meadata and data. By setting <code class="docutils literal notranslate"><span class="pre">offline=True</span></code> we tell it not to
attempt to connect and to rely entirely on its local cache.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tiled.client</span> <span class="kn">import</span> <span class="n">from_uri</span>
<span class="kn">from</span> <span class="nn">tiled.client.cache</span> <span class="kn">import</span> <span class="n">Cache</span>

<span class="hll"><span class="n">catalog</span> <span class="o">=</span> <span class="n">from_uri</span><span class="p">(</span><span class="s2">&quot;http://localhost:8000&quot;</span><span class="p">,</span> <span class="n">cache</span><span class="o">=</span><span class="n">Cache</span><span class="o">.</span><span class="n">on_disk</span><span class="p">(</span><span class="s2">&quot;my_cache_directory&quot;</span><span class="p">),</span> <span class="n">offline</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</span></pre></div>
</div>
<p>If you attempt to access something that was not downloaded a
<code class="docutils literal notranslate"><span class="pre">NotAvailableOffline</span></code> error will be raised.</p>
</div>
<div class="section" id="comparison-to-deliberate-export">
<h2>Comparison to “deliberate export”<a class="headerlink" href="#comparison-to-deliberate-export" title="Permalink to this headline">¶</a></h2>
<p>When caching, Tiled takes control of the data. The format, layout, and naming of
the files in the cache should be treated as internal to Tiled. It is up to Tiled
to manage them, and they should not be modified or directly accessed by user code.</p>
<p>To save files for use by user code or other software, use <a class="reference internal" href="export.html"><span class="doc">Deliberate Export</span></a>.</p>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="export.html" class="btn btn-neutral float-right" title="Deliberate Export" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="slicing.html" class="btn btn-neutral float-left" title="Load Slices of Data" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, Bluesky Collaboration.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>