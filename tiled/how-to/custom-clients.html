<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.18.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Custom Python Client Objects &mdash; tiled 0.1.0a98.dev6+gf030418 documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/sphinx_highlight.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Prometheus Metrics" href="metrics.html" />
    <link rel="prev" title="Create and Use API Keys" href="api-keys.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            tiled
          </a>
              <div class="version">
                0.1.0a98.dev6+gf030418
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/navigation.html">Navigate with the Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/slicing.html">Load Slices of Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/caching.html">Keep a Local Copy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/export.html">Deliberate Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/login.html">Log into an Authenticated Tiled Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/serving-files.html">Serve a Directory of Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/search.html">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/writing.html">Writing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/plotly-integration.html">Plot Data in Plotly Chart Studio</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How To Guides</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="client-logger.html">Use Performance and Debug Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="configuration.html">Serve Data using Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="read-custom-formats.html">Serve Files with Custom Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="custom-export-formats.html">Add Custom Export Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="profiles.html">Use Profiles to streamline Python client setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="api-keys.html">Create and Use API Keys</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Custom Python Client Objects</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#example">Example</a></li>
<li class="toctree-l2"><a class="reference internal" href="#precedence">Precedence</a></li>
<li class="toctree-l2"><a class="reference internal" href="#more-possibilities-and-design-guidelines">More Possibilities and Design Guidelines</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="metrics.html">Prometheus Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="direct-client.html">Use Tiled in Python without an HTTP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="tune-caches.html">Tune Caches to Balance Speed and Memory Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="docker.html">Run Tiled using Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="tiled-database.html">Set up a database for a scaled authenticated deloyment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../explanations/standards.html">Standards Used by Tiled</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/structures.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/metadata.html">Metadata and “Specs”</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/compression.html">Compression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/specialized-formats.html">Case Study: Reading and Exporting a Specialized Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/caching.html">Caching Design and Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/access-control.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/scaling-down.html">Scaling Tiled Down</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../explanations/lineage.html">How Tiled Fits into the Ecosystem</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/service.html">Service-side Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/http-api-overview.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/python-client.html">Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/queries.html">Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/authentication.html">Authentication Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/scopes.html">Scopes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/commandline.html">Command-line tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/service-configuration.html">Service Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/client-profiles.html">Client Profiles Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/min-versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tiled</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Custom Python Client Objects</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/how-to/custom-clients.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="custom-python-client-objects">
<h1>Custom Python Client Objects<a class="headerlink" href="#custom-python-client-objects" title="Permalink to this heading">¶</a></h1>
<p>To provide an “upgraded” and more finely-tuned user experience for certain
kinds of dataset, Tiled can be configured to use custom Python objects.
This is transparent and automatic from the point view of the user.</p>
<p>In the Python client, when a user accesses a given item, Tiled inspects the
item to decide what type of object to use to represent it.
In simple cases, this is just based on the <code class="docutils literal notranslate"><span class="pre">structure_family</span></code>: <code class="docutils literal notranslate"><span class="pre">&quot;array&quot;</span></code> goes
to <code class="docutils literal notranslate"><span class="pre">tiled.client.array.ArrayClient</span></code>;  <code class="docutils literal notranslate"><span class="pre">&quot;dataframe&quot;</span></code> goes to
<code class="docutils literal notranslate"><span class="pre">tiled.client.dataframe.DataFrameClient</span></code>; <code class="docutils literal notranslate"><span class="pre">&quot;container&quot;</span></code> goes to
<code class="docutils literal notranslate"><span class="pre">tiled.clide.container.Container</span></code>. Those classes then manage further communication
with Tiled server to access their contents.</p>
<p>Each item always has exactly one <code class="docutils literal notranslate"><span class="pre">structure_family</span></code>, and it’s always from a
fixed list. In addition, it may have a list of <code class="docutils literal notranslate"><span class="pre">specs</span></code>, labels which are meant
to communicate some more specific expectations about the data that may or may
not have meaning to a given client. If a client does not recognize some spec,
it can still access the metadata and data and performed Tiled’s essential
functions. If it does recognize a spec, it can provide an upgraded user
experience.</p>
<section id="example">
<h2>Example<a class="headerlink" href="#example" title="Permalink to this heading">¶</a></h2>
<p>Suppose data labeled with the <code class="docutils literal notranslate"><span class="pre">xdi</span></code> spec is guaranteed to have a metadata
dictionary containing the following two entries:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="n">x</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;XDI&quot;</span><span class="p">][</span><span class="s2">&quot;Element&quot;</span><span class="p">][</span><span class="s2">&quot;Symbol&quot;</span><span class="p">]</span>
<span class="n">x</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;XDI&quot;</span><span class="p">][</span><span class="s2">&quot;Element&quot;</span><span class="p">][</span><span class="s2">&quot;Edge&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>When the Tiled client encounters this type of data, we would like to hand
the user a custom Python object that includes the information in the string
representation displayed by the Python interpreter (or Jupyter notebook).</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">tiled.client.dataframe</span>


<span class="k">class</span> <span class="nc">XDIDatasetClient</span><span class="p">(</span><span class="n">tiled</span><span class="o">.</span><span class="n">client</span><span class="o">.</span><span class="n">dataframe</span><span class="o">.</span><span class="n">DataFrameClient</span><span class="p">):</span>
    <span class="s2">&quot;A custom DataFrame client for DataFrames that have XDI metadata.&quot;</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">()</span><span class="o">.</span><span class="fm">__init__</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="c1"># Optional sanity check to ensure this cannot be accidentally</span>
        <span class="c1"># registered for use with data that is not a dataframe.</span>
        <span class="k">assert</span> <span class="bp">self</span><span class="o">.</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;attributes&quot;</span><span class="p">][</span><span class="s2">&quot;structure_family&quot;</span><span class="p">]</span> <span class="o">==</span> <span class="s2">&quot;dataframe&quot;</span>

    <span class="k">def</span> <span class="fm">__repr__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">md</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;XDI&quot;</span><span class="p">]</span>
        <span class="k">return</span> <span class="sa">f</span><span class="s1">&#39;&lt;</span><span class="si">{</span><span class="n">x</span><span class="o">.</span><span class="n">item</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">md</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">][</span><span class="s2">&quot;Symbol&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1"> </span><span class="si">{</span><span class="n">md</span><span class="p">[</span><span class="s2">&quot;Element&quot;</span><span class="p">][</span><span class="s2">&quot;Edge&quot;</span><span class="p">]</span><span class="si">}</span><span class="s1">&gt;&#39;</span>
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>An Aside of Python <code class="docutils literal notranslate"><span class="pre">__repr__</span></code></strong></p>
<p>Python calls <code class="docutils literal notranslate"><span class="pre">__repr__</span></code> to obtain a string representation of it for interactive
display as in:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">my_object</span>
<span class="go">&lt;...&gt;</span>
</pre></div>
</div>
</div>
<p>It is conventional to include angle brackets <code class="docutils literal notranslate"><span class="pre">&lt;&gt;</span></code> when the string is not valid
Python code, as opposed to</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="mi">1</span>
<span class="go">1</span>
</pre></div>
</div>
<p>where the string representation is the exactly the code you would run to
reproduce that object.</p>
<p>You may want to override <code class="docutils literal notranslate"><span class="pre">__str__</span></code> in addition, which determines what
is returned by <code class="docutils literal notranslate"><span class="pre">str(...)</span></code> and displayed by <code class="docutils literal notranslate"><span class="pre">print(...)</span></code>. If you override
<code class="docutils literal notranslate"><span class="pre">__str__</span></code> but not <code class="docutils literal notranslate"><span class="pre">__repr__</span></code>, then <code class="docutils literal notranslate"><span class="pre">__repr__</span></code> falls back to <code class="docutils literal notranslate"><span class="pre">__str__</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>
Now we want to configure Tiled to this class whenever it encounters
data labeled with the `xdi` spec. We&#39;ll register it manually for development
and testing. Then we&#39;ll see how to configure it seamlessly for the user.

```py
from tiled.client.container import DEFAULT_STRUCTURE_CLIENT_DISPATCH
from tiled.client import from_uri

custom = dict(DEFAULT_STRUCTURE_CLIENT_DISPATCH[&quot;numpy&quot;])
custom[&quot;xdi&quot;] = XDIDatasetClient
client = from_uri(&quot;https://...&quot;, structure_clients=custom)
</pre></div>
</div>
<p>Test by accessing a dataset and checking the type:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="nb">type</span><span class="p">(</span><span class="n">client</span><span class="p">[</span><span class="o">...</span><span class="p">])</span>
</pre></div>
</div>
<p>Python
<a class="reference external" href="https://packaging.python.org/en/latest/specifications/entry-points/">entry points</a>
allow Tiled to efficiently scan the software environment for third-party
packages that provide custom Tiled clients. (Crucially, for speed, it does <em>not</em>
need to import a package to discover what if any custom Tiled clients it
includes. The entry points declarations can be read statically.) To register a
custom Tiled client from a third party package, add this to the <code class="docutils literal notranslate"><span class="pre">setup.py</span></code>:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="c1"># setup.py</span>
<span class="n">setup</span><span class="p">(</span>
    <span class="n">entry_points</span><span class="o">=</span><span class="p">{</span>
        <span class="s2">&quot;tiled.special_client&quot;</span><span class="p">:</span> <span class="p">[</span>
            <span class="s2">&quot;xdi = my_package.my_module:XDIDatasetClient&quot;</span><span class="p">,</span>
        <span class="p">],</span>
    <span class="p">},</span>
<span class="p">)</span>
</pre></div>
</div>
<p>On the left side of the <code class="docutils literal notranslate"><span class="pre">=</span></code> is the spec name, and on the right is the import
path to the custom object we want Tiled to use. Beware the somewhat unusual
syntax, in particular the colon between the final module and the object.</p>
<p>Re-install the package after adding or editing the entry points. Notice that
even in “editable” installations (i.e. <code class="docutils literal notranslate"><span class="pre">pip</span> <span class="pre">install</span> <span class="pre">-e</span> <span class="pre">...</span></code>) a re-install step
is needed to register the entry point.</p>
<p>Then, Tiled should be able to automatically discover the custom class with
no change in the user’s process:</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">tiled.client</span> <span class="kn">import</span> <span class="n">from_uri</span>

<span class="n">client</span> <span class="o">=</span> <span class="n">from_uri</span><span class="p">(</span><span class="s2">&quot;https://...&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>When Tiled see an <code class="docutils literal notranslate"><span class="pre">xdi</span></code> spec, it will query the entry points for a client registered
with that spec. It will discover the custom Python package, import the relevant
class, and use it.</p>
</section>
<section id="precedence">
<h2>Precedence<a class="headerlink" href="#precedence" title="Permalink to this heading">¶</a></h2>
<p>A given item may have multiple specs (or none). It always has exactly one structure family.
It’s possible that clients have been registered for multiple specs in the in the list.
Tiled walks the spec list in order and uses the first one that it recognizes. If it
recognizes none of the specs, or if there are no specs, it falls back to using the
structure family. Specs should generally be sorted from most specific to least
specific, so that Tiled uses the most finely-tuned client object available.</p>
</section>
<section id="more-possibilities-and-design-guidelines">
<h2>More Possibilities and Design Guidelines<a class="headerlink" href="#more-possibilities-and-design-guidelines" title="Permalink to this heading">¶</a></h2>
<p>There are many other useful things we could do with a custom client that is purpose-built
for a specific kinds of data and/or metadata. We can add convenience properties
to quickly access certain metadata.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CustomClient</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">element</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">metadata</span><span class="p">[</span><span class="s2">&quot;XDI&quot;</span><span class="p">][</span><span class="s2">&quot;Element&quot;</span><span class="p">][</span><span class="s2">&quot;Symbol&quot;</span><span class="p">]</span>
</pre></div>
</div>
<p>We can add convenience methods that read certain sections of the data and perhaps do
light computation on the way out.</p>
<div class="highlight-py notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">CustomClient</span><span class="p">(</span><span class="o">...</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">energy</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># Read energy column</span>
        <span class="k">return</span> <span class="bp">self</span><span class="p">[</span><span class="s2">&quot;energy&quot;</span><span class="p">][:]</span> <span class="o">*</span> <span class="n">UNIT_CONVERSION</span>
</pre></div>
</div>
<p>We offer two guidelines to help your custom clients compose well with Tiled and
with other scientific Python libraries.</p>
<ol class="arabic simple">
<li><p>In your subclass, <em>add</em> methods, attributes, and properties, but do not
<em>change</em> the behavior of the existing methods, attributes, and properties in
the base class. This is a well-known
<a class="reference external" href="https://en.wikipedia.org/wiki/Liskov_substitution_principle">principle</a> in
software design generally, and it is especially crucial here. If a user runs
code in a software environment where the library with the custom objects
happens to be missing, we want the user to immediate notice the missing
methods, not get confusingly different results from the “standard” method
and the customized one. In addition, it is helpful if the “vanilla” Tiled
documentation and user knowledge transfers to the custom classes with
<em>additions</em> but no confusing <em>changes</em>.</p></li>
<li><p>If something custom will do I/O (i.e. download metadata or data from the
server) make it method, not a property. Properties that do “surprise” I/O
may block over a slow network and can be very confusing. The same guideline
applies if the property performs more just very light computation.</p></li>
</ol>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="api-keys.html" class="btn btn-neutral float-left" title="Create and Use API Keys" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="metrics.html" class="btn btn-neutral float-right" title="Prometheus Metrics" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Bluesky Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>