<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>tiled.client.cache &mdash; tiled 0.1.0a99.dev7+g665a1bd documentation</title>
      <link rel="stylesheet" href="../../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../../../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../../../" id="documentation_options" src="../../../_static/documentation_options.js"></script>
        <script src="../../../_static/doctools.js"></script>
        <script src="../../../_static/sphinx_highlight.js"></script>
        <script src="../../../_static/clipboard.min.js"></script>
        <script src="../../../_static/copybutton.js"></script>
    <script src="../../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../../genindex.html" />
    <link rel="search" title="Search" href="../../../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../../index.html" class="icon icon-home">
            tiled
          </a>
              <div class="version">
                0.1.0a99.dev7+g665a1bd
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/navigation.html">Navigate with the Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/slicing.html">Load Slices of Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/export.html">Deliberate Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/login.html">Log into an Authenticated Tiled Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/serving-files.html">Serve a Directory of Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/search.html">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/writing.html">Writing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../tutorials/plotly-integration.html">Plot Data in Plotly Chart Studio</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/client-logger.html">Use Performance and Debug Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/configuration.html">Serve Data using Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/read-custom-formats.html">Serve Files with Custom Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/custom-export-formats.html">Add Custom Export Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/profiles.html">Use Profiles to streamline Python client setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/api-keys.html">Create and Use API Keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/custom-clients.html">Custom Python Client Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/metrics.html">Prometheus Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/direct-client.html">Use Tiled in Python without an HTTP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/tune-caches.html">Tune Caches to Balance Speed and Memory Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/docker.html">Run Tiled using Docker</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../how-to/tiled-authn-database.html">Set up a database for a scaled authenticated deloyment</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/standards.html">Standards Used by Tiled</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/structures.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/metadata.html">Metadata and “Specs”</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/compression.html">Compression</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/specialized-formats.html">Case Study: Reading and Exporting a Specialized Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/caching.html">Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/access-control.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/scaling-down.html">Scaling Tiled Down</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../explanations/lineage.html">How Tiled Fits into the Ecosystem</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/service.html">Service-side Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/http-api-overview.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/python-client.html">Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/queries.html">Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/authentication.html">Authentication Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/scopes.html">Scopes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/commandline.html">Command-line tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/service-configuration.html">Service Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/client-profiles.html">Client Profiles Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../../reference/min-versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../../index.html">tiled</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../../index.html">Module code</a></li>
      <li class="breadcrumb-item active">tiled.client.cache</li>
      <li class="wy-breadcrumbs-aside">
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <h1>Source code for tiled.client.cache</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">json</span>
<span class="kn">import</span> <span class="nn">sqlite3</span>
<span class="kn">import</span> <span class="nn">threading</span>
<span class="kn">import</span> <span class="nn">typing</span> <span class="k">as</span> <span class="nn">tp</span>
<span class="kn">from</span> <span class="nn">contextlib</span> <span class="kn">import</span> <span class="n">closing</span>
<span class="kn">from</span> <span class="nn">datetime</span> <span class="kn">import</span> <span class="n">datetime</span>
<span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

<span class="kn">import</span> <span class="nn">httpx</span>

<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">TiledResponse</span>

<span class="n">CACHE_DATABASE_SCHEMA_VERSION</span> <span class="o">=</span> <span class="mi">1</span>


<span class="k">class</span> <span class="nc">CachedResponse</span><span class="p">(</span><span class="n">TiledResponse</span><span class="p">):</span>
    <span class="k">pass</span>


<span class="k">def</span> <span class="nf">get_cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">str</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Get the cache key from a request.</span>

<span class="sd">    The cache key is the str request url.</span>

<span class="sd">    Args:</span>
<span class="sd">        request: httpx.Request</span>

<span class="sd">    Returns:</span>
<span class="sd">        str: httpx.Request.url</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="nb">str</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">url</span><span class="p">)</span>


<span class="k">def</span> <span class="nf">get_size</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># get content or stream_content</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;_content&quot;</span><span class="p">):</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ResponseNotRead</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">size</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">content</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">size</span>


<span class="k">def</span> <span class="nf">dump</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># get content or stream_content</span>
    <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s2">&quot;_content&quot;</span><span class="p">):</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">content</span>
        <span class="n">is_stream</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">elif</span> <span class="n">content</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ResponseNotRead</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">body</span> <span class="o">=</span> <span class="n">content</span>
        <span class="n">is_stream</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="k">return</span> <span class="p">(</span>
        <span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span>
        <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">headers</span><span class="o">.</span><span class="n">multi_items</span><span class="p">()),</span>
        <span class="n">body</span><span class="p">,</span>
        <span class="n">is_stream</span><span class="p">,</span>
        <span class="n">response</span><span class="o">.</span><span class="n">encoding</span> <span class="ow">or</span> <span class="kc">None</span><span class="p">,</span>
        <span class="nb">len</span><span class="p">(</span><span class="n">body</span><span class="p">),</span>
        <span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span>
        <span class="mi">0</span><span class="p">,</span>  <span class="c1"># never yet accessed</span>
    <span class="p">)</span>


<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">status_code</span><span class="p">,</span> <span class="n">headers_json</span><span class="p">,</span> <span class="n">body</span><span class="p">,</span> <span class="n">is_stream</span><span class="p">,</span> <span class="n">encoding</span> <span class="o">=</span> <span class="n">row</span>
    <span class="n">headers</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">headers_json</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">is_stream</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="n">httpx</span><span class="o">.</span><span class="n">ByteStream</span><span class="p">(</span><span class="n">body</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">content</span> <span class="o">=</span> <span class="n">body</span>
        <span class="n">stream</span> <span class="o">=</span> <span class="kc">None</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">CachedResponse</span><span class="p">(</span>
        <span class="n">status_code</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span> <span class="n">content</span><span class="o">=</span><span class="n">content</span><span class="p">,</span> <span class="n">stream</span><span class="o">=</span><span class="n">stream</span>
    <span class="p">)</span>
    <span class="k">if</span> <span class="n">encoding</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">encoding</span> <span class="o">=</span> <span class="n">encoding</span>

    <span class="k">if</span> <span class="n">request</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">response</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">request</span>
    <span class="k">return</span> <span class="n">response</span>


<span class="k">def</span> <span class="nf">_create_tables</span><span class="p">(</span><span class="n">conn</span><span class="p">):</span>
    <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="n">conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">            </span><span class="sd">&quot;&quot;&quot;CREATE TABLE responses (</span>
<span class="sd">cache_key TEXT PRIMARY KEY,</span>
<span class="sd">status_code INTEGER,</span>
<span class="sd">headers JSON,</span>
<span class="sd">body BLOB,</span>
<span class="sd">is_stream INTEGER,</span>
<span class="sd">encoding TEXT,</span>
<span class="sd">size INTEGER,</span>
<span class="sd">time_created REAL,</span>
<span class="sd">time_last_accessed REAL</span>
<span class="sd">)&quot;&quot;&quot;</span>
        <span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;CREATE TABLE tiled_http_response_cache_version (version INTEGER)&quot;</span><span class="p">)</span>
        <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
            <span class="s2">&quot;INSERT INTO tiled_http_response_cache_version (version) VALUES (?)&quot;</span><span class="p">,</span>
            <span class="p">(</span><span class="n">CACHE_DATABASE_SCHEMA_VERSION</span><span class="p">,),</span>
        <span class="p">)</span>
        <span class="n">conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>


<span class="k">def</span> <span class="nf">_prepare_database</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">readonly</span><span class="p">):</span>
    <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">readonly</span><span class="p">:</span>
        <span class="c1"># The methods in Cache will not try to write when in readonly mode.</span>
        <span class="c1"># For extra safety we open a readonly connection to the database, so</span>
        <span class="c1"># that SQLite itself will prohibit writing.</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;file:</span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2">?mode=ro&quot;</span><span class="p">,</span> <span class="n">uri</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">False</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT name FROM sqlite_master WHERE type=&#39;table&#39;;&quot;</span><span class="p">)</span>
    <span class="n">tables</span> <span class="o">=</span> <span class="p">[</span><span class="n">row</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchall</span><span class="p">()]</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">tables</span><span class="p">:</span>
        <span class="c1"># We have an empty database.</span>
        <span class="n">_create_tables</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">elif</span> <span class="s2">&quot;tiled_http_response_cache_version&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">tables</span><span class="p">:</span>
        <span class="c1"># We have a nonempty database that we do not recognize.</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Database at </span><span class="si">{</span><span class="n">filepath</span><span class="si">}</span><span class="s2"> is not empty and not recognized as a tiled HTTP response cache.&quot;</span>
        <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># We have a nonempty database that we recognize.</span>
        <span class="n">cursor</span> <span class="o">=</span> <span class="n">conn</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT * FROM tiled_http_response_cache_version;&quot;</span><span class="p">)</span>
        <span class="p">(</span><span class="n">version</span><span class="p">,)</span> <span class="o">=</span> <span class="n">cursor</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">version</span> <span class="o">!=</span> <span class="n">CACHE_DATABASE_SCHEMA_VERSION</span><span class="p">:</span>
            <span class="c1"># It is likely that this cache database will be very stable; we</span>
            <span class="c1"># *may* never need to change the schema. But if we do, we will</span>
            <span class="c1"># not bother with migrations. The cache is highly disposable.</span>
            <span class="c1"># Just silently blow it away and start over.</span>
            <span class="n">Path</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="n">conn</span> <span class="o">=</span> <span class="n">sqlite3</span><span class="o">.</span><span class="n">connect</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">check_same_thread</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="n">_create_tables</span><span class="p">(</span><span class="n">conn</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">conn</span>


<div class="viewcode-block" id="Cache"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.html#tiled.client.cache.Cache">[docs]</a><span class="k">class</span> <span class="nc">Cache</span><span class="p">:</span>
<div class="viewcode-block" id="Cache.__init__"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.html#tiled.client.cache.Cache.__init__">[docs]</a>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="n">filepath</span><span class="p">,</span>
        <span class="n">capacity</span><span class="o">=</span><span class="mi">500_000_000</span><span class="p">,</span>
        <span class="n">max_item_size</span><span class="o">=</span><span class="mi">500_000</span><span class="p">,</span>
        <span class="n">readonly</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
    <span class="p">):</span>
        <span class="k">if</span> <span class="n">capacity</span> <span class="o">&lt;=</span> <span class="n">max_item_size</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;capacity must be greater than max_item_size&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_item_size</span> <span class="o">=</span> <span class="n">max_item_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_readonly</span> <span class="o">=</span> <span class="n">readonly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_owner_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="n">_prepare_database</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cache.write_safe"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.write_safe.html#tiled.client.cache.Cache.write_safe">[docs]</a>    <span class="k">def</span> <span class="nf">write_safe</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Check that it is safe to write.</span>

<span class="sd">        SQLite is not threadsafe for concurrent _writes_.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span> <span class="o">==</span> <span class="bp">self</span><span class="o">.</span><span class="n">_owner_thread</span></div>

    <span class="k">def</span> <span class="nf">__getstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">filepath</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_item_size</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readonly</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__setstate__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">state</span><span class="p">):</span>
        <span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">capacity</span><span class="p">,</span> <span class="n">max_item_size</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span> <span class="o">=</span> <span class="n">state</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="n">capacity</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_item_size</span> <span class="o">=</span> <span class="n">max_item_size</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_readonly</span> <span class="o">=</span> <span class="n">readonly</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span> <span class="o">=</span> <span class="n">filepath</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_owner_thread</span> <span class="o">=</span> <span class="n">threading</span><span class="o">.</span><span class="n">current_thread</span><span class="p">()</span><span class="o">.</span><span class="n">ident</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span> <span class="o">=</span> <span class="n">_prepare_database</span><span class="p">(</span><span class="n">filepath</span><span class="p">,</span> <span class="n">readonly</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">readonly</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;If True, cache be read but not updated.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_readonly</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">filepath</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Filepath of SQLite database storing cache data&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_filepath</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Max capacity in bytes. Includes response bodies only.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_capacity</span>

    <span class="nd">@capacity</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">capacity</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">capacity</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_capacity</span> <span class="o">=</span> <span class="n">capacity</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">max_item_size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Max size of a response body eligible for caching.&quot;</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_max_item_size</span>

    <span class="nd">@max_item_size</span><span class="o">.</span><span class="n">setter</span>
    <span class="k">def</span> <span class="nf">max_item_size</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">max_item_size</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_max_item_size</span> <span class="o">=</span> <span class="n">max_item_size</span>

<div class="viewcode-block" id="Cache.clear"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.clear.html#tiled.client.cache.Cache.clear">[docs]</a>    <span class="k">def</span> <span class="nf">clear</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Drop all entries from HTTP response cache.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cannot clear read-only cache&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM responses&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Cache.get"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.get.html#tiled.client.cache.Cache.get">[docs]</a>    <span class="k">def</span> <span class="nf">get</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">]:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Get cached response from Cache.</span>

<span class="sd">        We use the httpx.Request.url as key.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: httpx.Request</span>

<span class="sd">        Returns:</span>
<span class="sd">            tp.Optional[httpx.Response]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">cache_key</span> <span class="o">=</span> <span class="n">get_cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
            <span class="n">row</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;SELECT</span>
<span class="sd">status_code, headers, body, is_stream, encoding</span>
<span class="sd">FROM</span>
<span class="sd">responses</span>
<span class="sd">WHERE cache_key = ?&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">cache_key</span><span class="p">,),</span>
            <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">row</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="kc">None</span>
            <span class="k">if</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">)</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_safe</span><span class="p">():</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;UPDATE responses</span>
<span class="sd">    SET time_last_accessed = ?</span>
<span class="sd">    WHERE cache_key = ?&quot;&quot;&quot;</span><span class="p">,</span>
                    <span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">now</span><span class="p">()</span><span class="o">.</span><span class="n">timestamp</span><span class="p">(),</span> <span class="n">cache_key</span><span class="p">),</span>
                <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>

        <span class="k">return</span> <span class="n">load</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">request</span><span class="p">)</span></div>

<div class="viewcode-block" id="Cache.set"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.set.html#tiled.client.cache.Cache.set">[docs]</a>    <span class="k">def</span> <span class="nf">set</span><span class="p">(</span>
        <span class="bp">self</span><span class="p">,</span>
        <span class="o">*</span><span class="p">,</span>
        <span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">,</span>
        <span class="n">response</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Response</span><span class="p">,</span>
        <span class="n">content</span><span class="p">:</span> <span class="n">tp</span><span class="o">.</span><span class="n">Optional</span><span class="p">[</span><span class="nb">bytes</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Set new response entry in cache.</span>

<span class="sd">        In case the response does not yet have a &#39;_content&#39; property, content should</span>
<span class="sd">        be provided in the optional &#39;content&#39; kwarg (usually using a callback)</span>

<span class="sd">        Parameters</span>
<span class="sd">        ----------</span>
<span class="sd">        request: httpx.Request</span>
<span class="sd">        response: httpx.Response, to cache</span>
<span class="sd">        content (bytes, optional): Defaults to None, should be provided in case</span>
<span class="sd">            response that not have yet content.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cache is readonly&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_safe</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Write is not safe from another thread&quot;</span><span class="p">)</span>
        <span class="n">incoming_size</span> <span class="o">=</span> <span class="n">get_size</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">incoming_size</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">max_item_size</span><span class="p">:</span>
            <span class="c1"># Decline to store.</span>
            <span class="k">return</span> <span class="kc">False</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="p">(</span><span class="n">total_size</span><span class="p">,)</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT SUM(size) FROM responses&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
            <span class="n">total_size</span> <span class="o">=</span> <span class="n">total_size</span> <span class="ow">or</span> <span class="mi">0</span>  <span class="c1"># If empty, total_size is None.</span>
            <span class="k">while</span> <span class="p">(</span><span class="n">incoming_size</span> <span class="o">+</span> <span class="n">total_size</span><span class="p">)</span> <span class="o">&gt;</span> <span class="bp">self</span><span class="o">.</span><span class="n">capacity</span><span class="p">:</span>
                <span class="c1"># Cull to make space.</span>
                <span class="p">(</span><span class="n">cache_key</span><span class="p">,</span> <span class="n">size</span><span class="p">)</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                    </span><span class="sd">&quot;&quot;&quot;SELECT</span>
<span class="sd">cache_key, size</span>
<span class="sd">FROM responses</span>
<span class="sd">ORDER BY time_last_accessed ASC&quot;&quot;&quot;</span>
                <span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
                <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;DELETE FROM responses WHERE cache_key = ?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">cache_key</span><span class="p">,))</span>
                <span class="n">total_size</span> <span class="o">-=</span> <span class="n">size</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
<span class="w">                </span><span class="sd">&quot;&quot;&quot;INSERT OR REPLACE INTO responses</span>
<span class="sd">(cache_key, status_code, headers, body, is_stream, encoding, size, time_created, time_last_accessed)</span>
<span class="sd">VALUES</span>
<span class="sd">(?, ?, ?, ?, ?, ?, ?, ?, ?)&quot;&quot;&quot;</span><span class="p">,</span>
                <span class="p">(</span><span class="n">get_cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">),)</span> <span class="o">+</span> <span class="n">dump</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">content</span><span class="p">),</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span>
        <span class="k">return</span> <span class="kc">True</span></div>

<div class="viewcode-block" id="Cache.delete"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.delete.html#tiled.client.cache.Cache.delete">[docs]</a>    <span class="k">def</span> <span class="nf">delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">:</span> <span class="n">httpx</span><span class="o">.</span><span class="n">Request</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Delete an entry from cache.</span>

<span class="sd">        Args:</span>
<span class="sd">            request: httpx.Request</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">readonly</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Cache is readonly&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">write_safe</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Write is not safe from another thread&quot;</span><span class="p">)</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span>
                <span class="s2">&quot;DELETE FROM responses WHERE cache_key=?&quot;</span><span class="p">,</span> <span class="p">(</span><span class="n">get_cache_key</span><span class="p">(</span><span class="n">request</span><span class="p">),)</span>
            <span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">commit</span><span class="p">()</span></div>

<div class="viewcode-block" id="Cache.size"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.size.html#tiled.client.cache.Cache.size">[docs]</a>    <span class="k">def</span> <span class="nf">size</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Size of response bodies in bytes (does not count headers and other auxiliary info)&quot;</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="p">(</span><span class="n">total_size</span><span class="p">,)</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT SUM(size) FROM responses&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">total_size</span> <span class="ow">or</span> <span class="mi">0</span>  <span class="c1"># If emtpy, total_size is None.</span></div>

<div class="viewcode-block" id="Cache.count"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.count.html#tiled.client.cache.Cache.count">[docs]</a>    <span class="k">def</span> <span class="nf">count</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="s2">&quot;Number of responses cached&quot;</span>
        <span class="k">with</span> <span class="n">closing</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">cursor</span><span class="p">())</span> <span class="k">as</span> <span class="n">cur</span><span class="p">:</span>
            <span class="p">(</span><span class="n">count</span><span class="p">,)</span> <span class="o">=</span> <span class="n">cur</span><span class="o">.</span><span class="n">execute</span><span class="p">(</span><span class="s2">&quot;SELECT COUNT(*) FROM responses&quot;</span><span class="p">)</span><span class="o">.</span><span class="n">fetchone</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">count</span> <span class="ow">or</span> <span class="mi">0</span>  <span class="c1"># If empty, count is None.</span></div>

<div class="viewcode-block" id="Cache.close"><a class="viewcode-back" href="../../../reference/generated/tiled.client.cache.Cache.close.html#tiled.client.cache.Cache.close">[docs]</a>    <span class="k">def</span> <span class="nf">close</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Close cache.&quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_conn</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div></div>
</pre></div>

           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Bluesky Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>