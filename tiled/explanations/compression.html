<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Compression &mdash; tiled 0.1.0a49.post16+ga80951f documentation</title>
      <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="../_static/plot_directive.css" type="text/css" />
      <link rel="stylesheet" href="../_static/copybutton.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/clipboard.min.js"></script>
        <script src="../_static/copybutton.js"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Reading and Exporting Specialized Formats" href="specialized-formats.html" />
    <link rel="prev" title="Security" href="security.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="../index.html" class="icon icon-home"> tiled
          </a>
              <div class="version">
                0.1.0a49.post16+ga80951f
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/navigation.html">Navigate with the Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/slicing.html">Load Slices of Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/caching.html">Keep a Local Copy</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/export.html">Deliberate Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/login.html">Log into an Authenticated Tiled Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/serving-files.html">Serve a Directory of Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/search.html">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/plotly-integration.html">Plot Data in Plotly Chart Studio</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/client-logger.html">Use Performance and Debug Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/configuration.html">Serve Data using Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/custom-export-formats.html">Add Custom Export Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/profiles.html">Use Profiles to streamline Python client setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/api-keys.html">Create and Use API Keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/direct-client.html">Use Tiled in Python without an HTTP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/tune-caches.html">Tune Caches to Balance Speed and Memory Usage</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/docker.html">Run Tiled using Docker</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="standards.html">Standards Used by Tiled</a></li>
<li class="toctree-l1"><a class="reference internal" href="structures.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Compression</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#considerations">Considerations</a></li>
<li class="toctree-l2"><a class="reference internal" href="#supported-compression-methods">Supported Compression Methods</a></li>
<li class="toctree-l2"><a class="reference internal" href="#example-requests-and-responses">Example Requests and Responses</a></li>
<li class="toctree-l2"><a class="reference internal" href="#design-acknowledgement">Design Acknowledgement</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="specialized-formats.html">Reading and Exporting Specialized Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="caching.html">Caching Design and Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="access-control.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="scaling-down.html">Scaling Tiled Down</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="lineage.html">How Tiled Fits into the Ecosystem</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/service.html">Service-side Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/http-api-overview.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/python-client.html">Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/authentication.html">Authentication Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/scopes.html">Scopes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/commandline.html">Command-line tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/service-configuration.html">Service Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/client-profiles.html">Client Profiles Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/min-versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tiled</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Compression</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/explanations/compression.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section class="tex2jax_ignore mathjax_ignore" id="compression">
<h1>Compression<a class="headerlink" href="#compression" title="Permalink to this headline">¶</a></h1>
<section id="considerations">
<h2>Considerations<a class="headerlink" href="#considerations" title="Permalink to this headline">¶</a></h2>
<p>The Tiled server factors in the following considerations when
determining whether and how to compress the data before transmitting it
to the client.</p>
<ul class="simple">
<li><p>Which compression methods can the client handle? Some of the more
efficient algorithms are not commonly understood by all clients.
The server implements standard HTTP
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Content_negotiation">proactive content negotiation</a>
to identify compatible compression methods (“encodings”).</p></li>
<li><p>Is this data format already compressed? For example, PNG has its own internal
compression built in, so additional compression would have low returns.
Formats like these will be sent without any additional compression.</p></li>
<li><p>Formats like a strided array (i.e. numpy) buffer have a natural item
size (bit width). Certain compression method can take advantage of this
knowledge to achieve faster compression and better compression ratios. Thus,
they should be preferred in these situations if both the server and the
client support them.</p></li>
<li><p>Is the data so small that it’s not worth compressing?
Compression is generally more effective on larger data because the compressor
has the opportunity to observe and take advantage of patterns in the data.
Also, if the data is small to begin with, reducing its size contributes little
to the overall time spent transferring the HTTP message.</p></li>
<li><p>Does the data compress well? Some scientific data, such as sparse images,
compresses very well. The time spent compressing and decompressing is
easily made up for by the time saved in transmitting a smaller payload. But
some scientific data, with high entropy, compresses poorly. If Tiled finds
that data does not compress well, it just sends the uncompressed original to
save the client the time of decompressing it.</p></li>
</ul>
</section>
<section id="supported-compression-methods">
<h2>Supported Compression Methods<a class="headerlink" href="#supported-compression-methods" title="Permalink to this headline">¶</a></h2>
<p>Tiled supports both common and specialized high-performance compression methods.</p>
<p>For broad compatibility, it supports <code class="docutils literal notranslate"><span class="pre">gzip</span></code> compression, which is
<a class="reference external" href="https://developer.mozilla.org/en-US/docs/Web/HTTP/Compression">the most common one</a>
used in HTTP clients—supported by web browsers, command-line tools like
<a class="reference external" href="https://curl.se/">curl</a> or <a class="reference external" href="https://httpie.io/">https://httpie.io/</a>, and
frameworks like <a class="reference external" href="https://docs.python-requests.org/">requests</a>,
<a class="reference external" href="https://www.python-httpx.org/">httpx</a>, and likely any other framework currently
maintained.</p>
<p>However, <code class="docutils literal notranslate"><span class="pre">gzip</span></code> is slow compared to newer alternatives. Therefore, the Tiled
server supports others if the relevant dependencies are installed. Compression
settings and availability vary by media type. In general Tiled prefers earlier
entries in this table above later ones.</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>Method</p></th>
<th class="head"><p>Accept-Encoding</p></th>
<th class="head"><p>Required Python Package</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><a class="reference external" href="https://www.blosc.org/">blosc</a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">blosc</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">blosc</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://en.wikipedia.org/wiki/LZ4_(compression_algorithm)">lz4</a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lz4</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">lz4</span></code></p></td>
</tr>
<tr class="row-even"><td><p><a class="reference external" href="https://facebook.github.io/zstd/">Zstandard</a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">zstd</span></code></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">zstandard</span></code></p></td>
</tr>
<tr class="row-odd"><td><p><a class="reference external" href="https://en.wikipedia.org/wiki/Gzip">gzip</a></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">gzip</span></code></p></td>
<td><p>none (built in)</p></td>
</tr>
</tbody>
</table>
<p>The Tiled Python <em>client</em> currently supports gzip and blosc (if the Python
package <code class="docutils literal notranslate"><span class="pre">blosc</span></code> is installed).</p>
</section>
<section id="example-requests-and-responses">
<h2>Example Requests and Responses<a class="headerlink" href="#example-requests-and-responses" title="Permalink to this headline">¶</a></h2>
<p>In these examples we’ll use the command-line HTTP client
<a class="reference external" href="https://httie.io/">httpie</a> to show just the <em>headers</em> of HTTP
requests and responses.</p>
<p>By default, it requests one of the standard encodings <code class="docutils literal notranslate"><span class="pre">gzip</span></code> or <code class="docutils literal notranslate"><span class="pre">deflate</span></code>. Of
those two, the Tiled server knows <code class="docutils literal notranslate"><span class="pre">gzip</span></code>, so it uses that.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http -p Hh :8000/array/full/A
GET /array/full/A HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: localhost:8000
User-Agent: HTTPie/1.0.3

HTTP/1.1 200 OK
content-encoding: gzip
content-length: 472
content-type: application/octet-stream
date: Mon, 26 Jul 2021 01:30:19 GMT
etag: a6a4697f732308159745eab706de8463
server: uvicorn
server-timing: compress;time=0.27;ratio=169.49, app;dur=6.7
set-cookie: tiled_csrf=gGgRTzuMpENi52p-imS0YTHkdRAZcZZf1H-3RJpQHog; HttpOnly; Path=/; SameSite=lax
vary: Accept-Encoding
</pre></div>
</div>
<p>The relevant line in the request is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Accept</span><span class="o">-</span><span class="n">Encoding</span><span class="p">:</span> <span class="n">gzip</span><span class="p">,</span> <span class="n">deflate</span>
</pre></div>
</div>
<p>where the client tells the server which compression algorithms it can decompress.</p>
<p>The relevant line in the response is</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">content</span><span class="o">-</span><span class="n">encoding</span><span class="p">:</span> <span class="n">gzip</span>
</pre></div>
</div>
<p>where the server tells us which, if any, compression algorithm it applied.
Also, notice the line</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">server</span><span class="o">-</span><span class="n">timing</span><span class="p">:</span> <span class="n">compress</span><span class="p">;</span><span class="n">time</span><span class="o">=</span><span class="mf">0.27</span><span class="p">;</span><span class="n">ratio</span><span class="o">=</span><span class="mf">169.49</span><span class="p">,</span> <span class="n">app</span><span class="p">;</span><span class="n">dur</span><span class="o">=</span><span class="mf">6.7</span>
</pre></div>
</div>
<p>where the server reports the compression ratio (higher is better) and the time
in milliseconds that it cost to compress it, beside other metrics.</p>
<p>In the next example, the server’s Python environment has the Python package
<code class="docutils literal notranslate"><span class="pre">zstandard</span></code> installed. It will prefer to use the superior algorithm <code class="docutils literal notranslate"><span class="pre">zstd</span></code> if
the client lists it as one that it supports. Here, the client lists <code class="docutils literal notranslate"><span class="pre">zstd</span></code> and
<code class="docutils literal notranslate"><span class="pre">gzip</span></code>.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http -p Hh :8000/node/full/C accept-encoding:zstd,gzip
GET /node/full/C HTTP/1.1
Accept: */*
Connection: keep-alive
Host: localhost:8000
User-Agent: HTTPie/1.0.3
accept-encoding: zstd

HTTP/1.1 200 OK
content-encoding: zstd
content-length: 558
content-type: application/vnd.apache.arrow.file
date: Mon, 26 Jul 2021 01:19:05 GMT
etag: 6389586cf110bbbc5e69a329ee07e763
server: uvicorn
server-timing: compress;time=0.10;ratio=8.06 app;dur=11.0
set-cookie: tiled_csrf=iRPOSCkpotnglSpyCwwG7GSof-DzfZBNGNDG3suhj8w; HttpOnly; Path=/; SameSite=lax
vary: Accept-Encoding
</pre></div>
</div>
<p>Finally, in this example. the server decides that the raw, compressed content is
so small (304 bytes) that is isn’t not worth compressing.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>$ http -p Hh :8000/node/metadata/
GET /node/metadata/ HTTP/1.1
Accept: */*
Accept-Encoding: gzip, deflate
Connection: keep-alive
Host: localhost:8000
User-Agent: HTTPie/1.0.3

HTTP/1.1 200 OK
content-length: 304
content-type: application/json
date: Mon, 26 Jul 2021 01:46:23 GMT
etag: 5ab946941f733dd41b485cec8afee8c9
server: uvicorn
server-timing: app;dur=4.0
set-cookie: tiled_csrf=DqqsY-w2dWsVt7EYA53VkEk8cATz_6jINCYhvu2eEls; HttpOnly; Path=/; SameSite=lax
</pre></div>
</div>
</section>
<section id="design-acknowledgement">
<h2>Design Acknowledgement<a class="headerlink" href="#design-acknowledgement" title="Permalink to this headline">¶</a></h2>
<p>Tiled’s compression implementation heavily influenced by the dask module
<code class="docutils literal notranslate"><span class="pre">distributed.protocol.compression</span></code>. The important difference is that
<code class="docutils literal notranslate"><span class="pre">distributed</span></code> is in control of both the server and the client, and they communicate
over its internal custom TCP protocol. We are operating over HTTP with a mixture
of clients we control (e.g. Tiled’s Python client) and clients we don’t (e.g.
curl).</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="security.html" class="btn btn-neutral float-left" title="Security" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="specialized-formats.html" class="btn btn-neutral float-right" title="Reading and Exporting Specialized Formats" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Bluesky Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>