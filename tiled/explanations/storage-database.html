

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Storage Database &mdash; tiled 0.0.1.dev2327+gccb3cc0fd documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=03e43079" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />
      <link rel="stylesheet" type="text/css" href="../_static/plot_directive.css" />
      <link rel="stylesheet" type="text/css" href="../_static/copybutton.css?v=76b2166b" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=913366e4"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
      <script src="../_static/clipboard.min.js?v=a7894cd8"></script>
      <script src="../_static/copybutton.js?v=f281be69"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="Service-side Components" href="../reference/service.html" />
    <link rel="prev" title="How Tiled Fits into the Ecosystem" href="lineage.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            tiled
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Tutorials</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/installation.html">Installation</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/navigation.html">Navigate with the Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/slicing.html">Load Slices of Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/export.html">Deliberate Export</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/login.html">Log into an Authenticated Tiled Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/serving-files.html">Serve a Directory of Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/search.html">Search</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/writing.html">Writing Data</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/streaming.html">Streaming</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/simple-server.html">Simple Tiled Server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/plotly-integration.html">Plot Data in Plotly Chart Studio</a></li>
<li class="toctree-l1"><a class="reference internal" href="../tutorials/zarr-integration.html">Serve Data as Zarr</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">How To Guides</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../how-to/authentication.html">Python Client Authentication</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/profiles.html">Use Profiles to streamline Python client setup</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/client-logger.html">Use Performance and Debug Logging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/docker.html">Run Tiled Server in a Container</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/helm.html">Run Tiled Server from the Helm chart</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/configuration.html">Serve Data using Configuration Files</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/read-custom-formats.html">Serve Files with Custom Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/custom-export-formats.html">Add Custom Export Formats</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/api-keys.html">Create and Use API Keys</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/custom-clients.html">Custom Python Client Objects</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/metrics.html">Prometheus Metrics</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/direct-client.html">Use Tiled in Python without an HTTP server</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/tiled-authn-database.html">Set up a database for a scaled authenticated deployment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/register.html">Register Content in Tiled</a></li>
<li class="toctree-l1"><a class="reference internal" href="../how-to/retries.html">Control Retries</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Explanations</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="architecture.html">Architecture</a></li>
<li class="toctree-l1"><a class="reference internal" href="standards.html">Standards Used by Tiled</a></li>
<li class="toctree-l1"><a class="reference internal" href="structures.html">Structures</a></li>
<li class="toctree-l1"><a class="reference internal" href="metadata.html">Metadata and “Specs”</a></li>
<li class="toctree-l1"><a class="reference internal" href="security.html">Security</a></li>
<li class="toctree-l1"><a class="reference internal" href="compression.html">Compression</a></li>
<li class="toctree-l1"><a class="reference internal" href="specialized-formats.html">Case Study: Reading and Exporting a Specialized Format</a></li>
<li class="toctree-l1"><a class="reference internal" href="caching.html">Caches</a></li>
<li class="toctree-l1"><a class="reference internal" href="access-control.html">Access Control</a></li>
<li class="toctree-l1"><a class="reference internal" href="catalog.html">Catalog Database</a></li>
<li class="toctree-l1"><a class="reference internal" href="faq.html">FAQ</a></li>
<li class="toctree-l1"><a class="reference internal" href="roadmap.html">Roadmap</a></li>
<li class="toctree-l1"><a class="reference internal" href="lineage.html">How Tiled Fits into the Ecosystem</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Storage Database</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#development-status">Development Status</a></li>
<li class="toctree-l2"><a class="reference internal" href="#why-a-storage-database-at-all">Why a storage database at all?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#which-database-management-system-dbms-should-i-use">Which database management system (DBMS) should I use?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#what-schema">What schema?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#why-partition">Why “partition”?</a></li>
<li class="toctree-l2"><a class="reference internal" href="#arrow-database-connectivity-adbc">Arrow Database Connectivity (ADBC)</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Reference</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../reference/service.html">Service-side Components</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/http-api-overview.html">HTTP API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/python-client.html">Python Client</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/queries.html">Queries</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/authentication.html">Authentication Details</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/scopes.html">Scopes</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/commandline.html">Command-line tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/service-configuration.html">Service Configuration Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/client-profiles.html">Client Profiles Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/release-history.html">Release History</a></li>
<li class="toctree-l1"><a class="reference internal" href="../reference/min-versions.html">Minimum Version of Python and NumPy</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">tiled</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">Storage Database</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/explanations/storage-database.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="storage-database">
<h1>Storage Database<a class="headerlink" href="#storage-database" title="Link to this heading"></a></h1>
<p>Tiled employs three SQL databases.</p>
<ol class="arabic simple">
<li><p>A “catalog” database of metadata, structure descriptions, and pointers to
data (e.g. filepaths);</p></li>
<li><p>A “storage” database for storing tabular data;</p></li>
<li><p>An authentication database, supporting Tiled’s authentication system.</p></li>
</ol>
<p><strong>This document addresses (2): The “storage” database.</strong></p>
<section id="development-status">
<h2>Development Status<a class="headerlink" href="#development-status" title="Link to this heading"></a></h2>
<p>The “storage” database is the least mature of the three databases. We
anticipate that our thinking is likely to evolve in response to use,
performance testing, and feedback from collaborators.</p>
</section>
<section id="why-a-storage-database-at-all">
<h2>Why a storage database at all?<a class="headerlink" href="#why-a-storage-database-at-all" title="Link to this heading"></a></h2>
<p>Tiled can store tabular data in Parquet, CSV, or Arrow IPC file formats. These
are suited for batch writing, such as uploading the result of some data
analysis. They are not well suited to <em>streaming</em> data, where writers are
appending rows while readers are reading.</p>
<p>When Tiled is deployed in a horizontally scaled fashion, distributed across
more than one node, any file-based storage needs to be backed by a networked
file system, such as GPFS or NFS. Concurrent writing and reading is at worst
unsafe (NFS v3) and at best slow, due to the challenges of file locking
(<code class="docutils literal notranslate"><span class="pre">fsync</span></code>) on distributed file systems. (Blob storage addresses some of these
problems, but at the cost of <em>eventual</em> consistency and append-only writes.)</p>
<p>This is a problem that databases solve: enabling atomic, concurrent writes and
reads. The storage database was introduced into Tiled to enable safe streaming
of tabular data with concurrent readers. This includes data from Bluesky Events
in particular, which will have one writer and potentially many concurrent readers.
But we also anticipate use cases for streaming <em>processed</em> data, which may have
multiple concurrent writers as well. Directly backing this with files would be
intractable: we need a database.</p>
</section>
<section id="which-database-management-system-dbms-should-i-use">
<h2>Which database management system (DBMS) should I use?<a class="headerlink" href="#which-database-management-system-dbms-should-i-use" title="Link to this heading"></a></h2>
<p>The “catalog” and authentication database are straightforward traditional OLTP
(OnLine Transaction Processing) databases. Most queries are looking for a
needle in a hackstack: querying for a single row or a page of ~100 rows.</p>
<p>The use case for Tiled’s “storage” database may include some OLAP (OnLine
Analytical Processing) workloads, fetching or performing reduction queries
on a large fraction of the rows in a table. The data tends to be numerical,
and expressing correct numerical precision (e.g. uint8 versus “integer”)
may be important for fidelity, speed, and storage efficiency.</p>
<p>The choice of “OLAP” database is a large and growing space, currently receiving
a lot of attention. Well-known projects include <a class="reference external" href="https://duckdb.org/">DuckDB</a>
and <a class="reference external" href="https://clickhouse.com/">ClickHouse</a>; there are many, many others in the
category.</p>
<p>To start, Tiled supports these three backends:</p>
<ul class="simple">
<li><p>PostgreSQL (recommended for production)</p></li>
<li><p>DuckDB (default for single-process dev)</p></li>
<li><p>SQLite</p></li>
</ul>
<p>Of these, only DuckDB is OLAP, and notably it can only be connected to a single
process at a time, so it is not compatible with production, horizontally-scaled
Tiled deployments.</p>
<p>We recommend PostgreSQL for production because the <em>stewardship</em> of the data is
the paramount concern, and PostgreSQL is extremely well trusted not to lose or
corrupt data. We received a strong recommendation from professional SQL developers
familiar with our use case to start with PostgreSQL. We are likely to stay there
for the next 1–2 years at least.</p>
<p>We are watching other projects, including the DuckDB integration with PostgreSQL
which would leverage DuckDB’s richer numerical type system within PostgreSQL.</p>
</section>
<section id="what-schema">
<h2>What schema?<a class="headerlink" href="#what-schema" title="Link to this heading"></a></h2>
<p>When Bluesky emits an Event Descriptor, it defines a schema for the Events (rows)
to follow. These schemas are often repeated, but can be unique, defined by
some arbitrary collection of measured signals.</p>
<p>Tiled receives this as an Arrow schema (names and data types) followed by
batches of rows. It supplements these rows with a <code class="docutils literal notranslate"><span class="pre">dataset_id</span></code> and a
<code class="docutils literal notranslate"><span class="pre">partition_id</span></code> and inserts them into a table. By default, it uses a table
with a name derived from the schema, <code class="docutils literal notranslate"><span class="pre">table_{arrow_schema_hash}</span></code>, and thus
<code class="docutils literal notranslate"><span class="pre">dataset_id</span></code> is necessary to identify the rows comprising logically related
data, e.g. coming from the same Bluesky run. The client has the option to
specify a meaningful, human-readable name if preferred. If a matching table
does not already exist, Tiled creates it. (This too, could be customized.
Perhaps some instruments would want to only use tables that are pre-declared
and purposefully named.)</p>
<p>table_{schema_hash}</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>dataset_id</p></th>
<th class="head"><p>partition_id</p></th>
<th class="head"><p>x</p></th>
<th class="head"><p>y</p></th>
<th class="head"><p>temp</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>42</p></td>
<td><p>1</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
<tr class="row-odd"><td><p>42</p></td>
<td><p>1</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
<tr class="row-even"><td><p>43</p></td>
<td><p>1</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
<tr class="row-odd"><td><p>43</p></td>
<td><p>1</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
<tr class="row-even"><td><p>44</p></td>
<td><p>1</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
<tr class="row-odd"><td><p>44</p></td>
<td><p>1</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
</tbody>
</table>
<p>table_{schema_hash}</p>
<table class="docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p>dataset_id</p></th>
<th class="head"><p>partition_id</p></th>
<th class="head"><p>y</p></th>
<th class="head"><p>temp</p></th>
<th class="head"><p>z</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>45</p></td>
<td><p>1</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
<tr class="row-odd"><td><p>45</p></td>
<td><p>1</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
<tr class="row-even"><td><p>45</p></td>
<td><p>1</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
<tr class="row-odd"><td><p>45</p></td>
<td><p>2</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
<tr class="row-even"><td><p>45</p></td>
<td><p>2</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
<td><p>.</p></td>
</tr>
</tbody>
</table>
<p>This means, the number of tables scales with the number of unique schemas—
roughly speaking, the number of distinct types of experiments.</p>
<p>Currently, Tiled merely fetches data, filtered by <code class="docutils literal notranslate"><span class="pre">dataset_id</span></code> and optionally
by <code class="docutils literal notranslate"><span class="pre">partition_id</span></code> (currently, we use a single partition for all datasets by
default). We foresee exposing the capability to query relations across columns
(<code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">...</span> <span class="pre">WHERE</span> <span class="pre">...</span></code>) or to do <em>limited</em> server-side
reductions (<code class="docutils literal notranslate"><span class="pre">SELECT</span> <span class="pre">MAX(...)</span> <span class="pre">WHERE</span> <span class="pre">...</span></code>). Filtering data based on value has
been a frequent request from users.</p>
</section>
<section id="why-partition">
<h2>Why “partition”?<a class="headerlink" href="#why-partition" title="Link to this heading"></a></h2>
<p>A partition is a “chunk” of a single dataset. Typically, many datasets may only
have a single partition.</p>
<p>For file-based storage, data is commonly partitioned into files, like
<code class="docutils literal notranslate"><span class="pre">data_01.csv</span></code>, <code class="docutils literal notranslate"><span class="pre">data_02.csv</span></code>, …. Tiled exposes APIs to fetch data by
partition, to facilitate partial and parallel access.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">partition_id</span></code> is designed to facilitate the same for data stored in
a database.</p>
<p>Potentially, row range slicing could be supported as well. But this is subtle.
Unlike array data, tabular data does not necessary come with a natural sorting
or fixed position for each row. On-disk formats like Parquet <em>do</em> have a
natural order -— the order the rows are stored in -— but data stored in SQL
does not necessarily have a default or even a unique order. For <em>Bluesky</em> data,
timestamps would be the obvious choice, but again we have in mind broader use
cases, including analysis results.</p>
<p>Thus, partitioning gives a way to unambiguously chunk a large dataset.</p>
<p>Notice that PostgreSQL table partitioning is a totally distinct concept. That
might also be useful, but has no relationship to Tiled’s application-level
<code class="docutils literal notranslate"><span class="pre">partition_id</span></code>.</p>
</section>
<section id="arrow-database-connectivity-adbc">
<h2>Arrow Database Connectivity (ADBC)<a class="headerlink" href="#arrow-database-connectivity-adbc" title="Link to this heading"></a></h2>
<p>Tiled describes tabular data, whether stored in files or in databases, using
<a class="reference external" href="https://arrow.apache.org/">Apache Arrow</a> semantics. Apache Arrow is the
industry standard for describing columnar data, and it is portable across
programming languages.</p>
<p>Arrow Database Connectivity provides a way to insert columnar data into SQL
databases without first transposing it into individual rows. The performance
of inserting a table of memory-contigous columnar buffers is far superior
to the performance of first “exploding” that table into individual records
(per row) and inserting those (even in a batch).</p>
<p>More performance testing is needed to measure the impact on our use cases, but
ADBC seems to be the right technology for using Arrow tables with SQL storage.</p>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="lineage.html" class="btn btn-neutral float-left" title="How Tiled Fits into the Ecosystem" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../reference/service.html" class="btn btn-neutral float-right" title="Service-side Components" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2021, Bluesky Collaboration.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>