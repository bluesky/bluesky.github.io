
<!DOCTYPE html>


<html lang="en" data-content_root="../../" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="viewport" content="width=device-width, initial-scale=1" />

    <title>K4CV : 4-circle kappa diffractometer example &#8212; hklpy 1.1</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../../_static/styles/theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/bootstrap.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
<link href="../../_static/styles/pydata-sphinx-theme.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />

  
  <link href="../../_static/vendor/fontawesome/6.5.1/css/all.min.css?digest=8d27b9dea8ad943066ae" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../../_static/vendor/fontawesome/6.5.1/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=a746c00c" />
    <link rel="stylesheet" type="text/css" href="../../_static/graphviz.css?v=fd3f3429" />
    <link rel="stylesheet" type="text/css" href="../../_static/tabs.css?v=a5c4661c" />
    <link rel="stylesheet" type="text/css" href="../../_static/design-style.1e8bd061cd6da7fc9cf755528e8ffc24.min.css?v=0a3b3ea7" />
    <link rel="stylesheet" type="text/css" href="../../_static/nbsphinx-code-cells.css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae" />
<link rel="preload" as="script" href="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae" />
  <script src="../../_static/vendor/fontawesome/6.5.1/js/all.min.js?digest=8d27b9dea8ad943066ae"></script>

    <script src="../../_static/documentation_options.js?v=cc1609e4"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../../_static/design-tabs.js?v=36754332"></script>
    <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
    <script>window.MathJax = {"tex": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true}, "options": {"ignoreHtmlClass": "tex2jax_ignore|mathjax_ignore|document", "processHtmlClass": "tex2jax_process|mathjax_process|math|output_area"}}</script>
    <script defer="defer" src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="How-to Guides" href="../howto.html" />
    <link rel="prev" title="E6C : 6-circle diffractometer example" href="geo_e6c.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a id="pst-skip-link" class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>
  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search the docs ..."
         aria-label="Search the docs ..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <header class="bd-header navbar navbar-expand-lg bd-navbar">
<div class="bd-header__inner bd-page-width">
  <label class="sidebar-toggle primary-toggle" for="__primary">
    <span class="fa-solid fa-bars"></span>
  </label>
  
  
  <div class="col-lg-3 navbar-header-items__start">
    
      <div class="navbar-item">

  

<a class="navbar-brand logo" href="../../index.html">
  
  
  
  
  
  
    <p class="title logo__title">hklpy 1.1</p>
  
</a></div>
    
  </div>
  
  <div class="col-lg-9 navbar-header-items">
    
    <div class="me-auto navbar-header-items__center">
      
        <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../../user_guide.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../install.html">
                        Install
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../api.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../release_notes.html">
                        Release History
                      </a>
                    </li>
                
  </ul>
</nav></div>
      
    </div>
    
    
    <div class="navbar-header-items__end">
      
        <div class="navbar-item navbar-persistent--container">
          

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
        </div>
      
      
        <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
      
    </div>
    
  </div>
  
  
    <div class="navbar-persistent--mobile">

 <script>
 document.write(`
   <button class="btn navbar-btn search-button-field search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass"></i>
    <span class="search-button__default-text">Search</span>
    <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd class="kbd-shortcut__modifier">K</kbd></span>
   </button>
 `);
 </script>
    </div>
  

  
    <label class="sidebar-toggle secondary-toggle" for="__secondary" tabindex="0">
      <span class="fa-solid fa-outdent"></span>
    </label>
  
</div>

    </header>
  

  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
      <div class="sidebar-header-items__center">
        
          <div class="navbar-item">
<nav class="navbar-nav">
  <ul class="bd-navbar-elements navbar-nav">
    
                    <li class="nav-item current active">
                      <a class="nav-link nav-internal" href="../../user_guide.html">
                        User Guide
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../install.html">
                        Install
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../api.html">
                        API Reference
                      </a>
                    </li>
                

                    <li class="nav-item">
                      <a class="nav-link nav-internal" href="../../release_notes.html">
                        Release History
                      </a>
                    </li>
                
  </ul>
</nav></div>
        
      </div>
    
    
    
      <div class="sidebar-header-items__end">
        
          <div class="navbar-item">

<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script></div>
        
      </div>
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
<nav class="bd-docs-nav bd-links"
     aria-label="Section Navigation">
  <p class="bd-links__title" role="heading" aria-level="1">Section Navigation</p>
  <div class="bd-toc-item navbar-nav"><ul class="current nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../../overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ready_to_use.html">Simulated Diffractometers</a></li>
<li class="toctree-l1 current active has-children"><a class="reference internal" href="../diffractometer.html">Diffractometer Geometries</a><input checked="" class="toctree-checkbox" id="toctree-checkbox-1" name="toctree-checkbox-1" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-1"><i class="fa-solid fa-chevron-down"></i></label><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="geo_e4cv.html">E4CV : 4-circle diffractometer example</a></li>
<li class="toctree-l2"><a class="reference internal" href="geo_e6c.html">E6C : 6-circle diffractometer example</a></li>
<li class="toctree-l2 current active"><a class="current reference internal" href="#">K4CV : 4-circle kappa diffractometer example</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../howto.html">How-to Guides</a><input class="toctree-checkbox" id="toctree-checkbox-2" name="toctree-checkbox-2" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-2"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="how_additional_parameters.html">Diffractometer “Parameters”</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_configuration.html">Sample orientation: export &amp; restore diffractometer configuration</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_extra_real_axis.html">How to add extra motors to a diffractometer class</a></li>
<li class="toctree-l2"><a class="reference internal" href="how_spec_commands.html">SPEC commands in Bluesky</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../t_and_c.html">Tests and Comparisons</a><input class="toctree-checkbox" id="toctree-checkbox-3" name="toctree-checkbox-3" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-3"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="tst_UB_in_descriptor_document.html"><strong>UB</strong> : Save and Restore Crystal Orientation</a></li>



<li class="toctree-l2"><a class="reference internal" href="tst_UB_in_stream.html">WIP: save reflection information in stream</a></li>
<li class="toctree-l2"><a class="reference internal" href="tst_e4cv_fourc.html">Compare E4CV 4-circle orientation with SPEC fourc</a></li>
<li class="toctree-l2"><a class="reference internal" href="tst_e6c_test_calculations.html">Non-exhaustive test of E6C calculations</a></li>
</ul>
</li>
<li class="toctree-l1 has-children"><a class="reference internal" href="../variations.html">Variations</a><input class="toctree-checkbox" id="toctree-checkbox-4" name="toctree-checkbox-4" type="checkbox"/><label class="toctree-toggle" for="toctree-checkbox-4"><i class="fa-solid fa-chevron-down"></i></label><ul>
<li class="toctree-l2"><a class="reference internal" href="var_e4cv_renamed_axes.html">Rename the axes of a 4-circle diffractometer</a></li>
<li class="toctree-l2"><a class="reference internal" href="var_engines.html">Use <code class="docutils literal notranslate"><span class="pre">E4CV</span></code>’s <span class="math notranslate nohighlight">\(Q\)</span> calculation engine</a></li>
<li class="toctree-l2"><a class="reference internal" href="var_nslsii_tardis.html">NSLS-II TARDIS Configuration</a></li>

</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../constraints.html">Constraints</a></li>
</ul>
</div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        
          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item">



<nav aria-label="Breadcrumb">
  <ul class="bd-breadcrumbs">
    
    <li class="breadcrumb-item breadcrumb-home">
      <a href="../../index.html" class="nav-link" aria-label="Home">
        <i class="fa-solid fa-home"></i>
      </a>
    </li>
    
    <li class="breadcrumb-item"><a href="../../user_guide.html" class="nav-link">User Guide</a></li>
    
    
    <li class="breadcrumb-item"><a href="../diffractometer.html" class="nav-link">Diffractometer Geometries</a></li>
    
    <li class="breadcrumb-item active" aria-current="page">K4CV :...</li>
  </ul>
</nav>
</div>
      
    </div>
  
  
</div>
</div>
              
              
              
                
<div id="searchbox"></div>
                <article class="bd-article">
                  
  <section id="K4CV-:-4-circle-kappa-diffractometer-example">
<h1>K4CV : 4-circle kappa diffractometer example<a class="headerlink" href="#K4CV-:-4-circle-kappa-diffractometer-example" title="Link to this heading">#</a></h1>
<p>The kappa geometry replaces the traditional <span class="math notranslate nohighlight">\(\chi\)</span>-ring on a 4-circle diffractometer with an alternative kappa stage that holds the phi stage. The kappa stage is tilted at angle <span class="math notranslate nohighlight">\(\alpha\)</span> (typically 50 degrees) from the <span class="math notranslate nohighlight">\(\omega\)</span> stage.</p>
<hr class="docutils" />
<p>Note: This example is available as a <a class="reference external" href="https://jupyter.org/">Jupyter notebook</a> from the <em>hklpy</em> source code website: <a class="github reference external" href="https://github.com/bluesky/hklpy/tree/main/docs/source/examples/notebooks">bluesky/hklpy</a></p>
<section id="Setup-the-K4CV-diffractometer-in-hklpy">
<h2>Setup the <em>K4CV</em> diffractometer in <em>hklpy</em><a class="headerlink" href="#Setup-the-K4CV-diffractometer-in-hklpy" title="Link to this heading">#</a></h2>
<p>In <em>hkl</em> <em>K4CV</em> geometry (<a class="reference external" href="https://people.debian.org/~picca/hkl/hkl.html#org723c5b9">https://people.debian.org/~picca/hkl/hkl.html#org723c5b9</a>):</p>
<p><img alt="K4CV geometry" src="../../_images/k4cv.png" /></p>
<p>For this geometry there is a special parameter <span class="math notranslate nohighlight">\(\alpha\)</span>, the angle between the kappa rotation axis and the <span class="math notranslate nohighlight">\(\vec{y}\)</span> direction.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>axis</p></th>
<th class="head"><p>moves</p></th>
<th class="head"><p>rotation axis</p></th>
<th class="head"><p>vector</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>komega</p></td>
<td><p>sample</p></td>
<td><p><span class="math notranslate nohighlight">\(-\vec{y}\)</span></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[0</span> <span class="pre">-1</span> <span class="pre">0]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>kappa</p></td>
<td><p>sample</p></td>
<td><p><span class="math notranslate nohighlight">\(\vec{x}\)</span></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[0</span> <span class="pre">-0.6428</span> <span class="pre">-0.7660]</span></code></p></td>
</tr>
<tr class="row-even"><td><p>kphi</p></td>
<td><p>sample</p></td>
<td><p><span class="math notranslate nohighlight">\(-\vec{y}\)</span></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[0</span> <span class="pre">-1</span> <span class="pre">0]</span></code></p></td>
</tr>
<tr class="row-odd"><td><p>tth</p></td>
<td><p>detector</p></td>
<td><p><span class="math notranslate nohighlight">\(-\vec{y}\)</span></p></td>
<td><p><code class="docutils literal notranslate"><span class="pre">[0</span> <span class="pre">-1</span> <span class="pre">0]</span></code></p></td>
</tr>
</tbody>
</table>
</section>
<section id="Define-this-diffractometer">
<h2>Define <em>this</em> diffractometer<a class="headerlink" href="#Define-this-diffractometer" title="Link to this heading">#</a></h2>
<p>Create a Python class that specifies the names of the real-space positioners. We call it <code class="docutils literal notranslate"><span class="pre">KappaFourCircle</span></code> here but that choice is arbitrary. Pick any valid Python name not already in use. The convention is to start Python class names with a capital letter and use CamelCase to mark word starts.</p>
<p>The argument to the <code class="docutils literal notranslate"><span class="pre">KappaFourCircle</span></code> class tells which <em>hklpy</em> base class will be used. This sets the geometry. (The class we show here could be replaced entirely with <code class="docutils literal notranslate"><span class="pre">hkl.geometries.SimulatedK4CV</span></code> but we choose to show here the complete steps to produce that class.) The <a class="reference external" href="https://blueskyproject.io/hklpy/geometries.html?highlight=geometries#module-hkl.geometries">hklpy documentation</a> provides a complete list of diffractometer geometries.</p>
<p>In <em>hklpy</em>, the reciprocal-space axes are known as <code class="docutils literal notranslate"><span class="pre">pseudo</span></code> positioners while the real-space axes are known as <code class="docutils literal notranslate"><span class="pre">real</span></code> positioners. For the real positioners, it is possible to use different names than the canonical names used internally by the <em>hkl</em> library. That is not covered here.</p>
<p>Note: The keyword argument <code class="docutils literal notranslate"><span class="pre">kind=&quot;hinted&quot;</span></code> is an indication that this signal may be plotted.</p>
<p>This <code class="docutils literal notranslate"><span class="pre">KappaFourCircle()</span></code> class example uses simulated motors. See the drop-down for an example how to use EPICS motors.</p>
<details><summary><p>KappaFourCircle() class using EPICS motors</p>
</summary><div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hkl</span> <span class="kn">import</span> <span class="n">K4CV</span>
<span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">EpicsMotor</span><span class="p">,</span> <span class="n">PseudoSingle</span>
<span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">Component</span> <span class="k">as</span> <span class="n">Cpt</span>

<span class="k">class</span> <span class="nc">KappaFourCircle</span><span class="p">(</span><span class="n">K4CV</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Our kappa 4-circle.  Vertical scattering orientation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the reciprocal axes are called &quot;pseudo&quot; in hklpy</span>
    <span class="n">h</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">PseudoSingle</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">)</span>
    <span class="n">k</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">PseudoSingle</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">)</span>
    <span class="n">l</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">PseudoSingle</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">)</span>

    <span class="c1"># the motor axes are called &quot;real&quot; in hklpy</span>
    <span class="n">komega</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">EpicsMotor</span><span class="p">,</span> <span class="s2">&quot;pv_prefix:m41&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">)</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">EpicsMotor</span><span class="p">,</span> <span class="s2">&quot;pv_prefix:m22&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">)</span>
    <span class="n">kphi</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">EpicsMotor</span><span class="p">,</span> <span class="s2">&quot;pv_prefix:m35&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">)</span>
    <span class="n">tth</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">EpicsMotor</span><span class="p">,</span> <span class="s2">&quot;pv_prefix:m7&quot;</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">)</span>
</pre></div>
</div>
</details><div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hkl</span> <span class="kn">import</span> <span class="n">K4CV</span><span class="p">,</span> <span class="n">SimMixin</span>
<span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">SoftPositioner</span>
<span class="kn">from</span> <span class="nn">ophyd</span> <span class="kn">import</span> <span class="n">Component</span> <span class="k">as</span> <span class="n">Cpt</span>

<span class="k">class</span> <span class="nc">KappaFourCircle</span><span class="p">(</span><span class="n">SimMixin</span><span class="p">,</span> <span class="n">K4CV</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Our kappa 4-circle.  Vertical scattering orientation.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># the reciprocal axes are defined by SimMixin</span>

    <span class="n">komega</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kappa</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">kphi</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">tth</span> <span class="o">=</span> <span class="n">Cpt</span><span class="p">(</span><span class="n">SoftPositioner</span><span class="p">,</span> <span class="n">kind</span><span class="o">=</span><span class="s2">&quot;hinted&quot;</span><span class="p">,</span> <span class="n">init_pos</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Create the Python diffractometer object (<code class="docutils literal notranslate"><span class="pre">sixc</span></code>) using the <code class="docutils literal notranslate"><span class="pre">SixCircle()</span></code> class. By convention, the <code class="docutils literal notranslate"><span class="pre">name</span></code> keyword is the same as the object name.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k4cv</span> <span class="o">=</span> <span class="n">KappaFourCircle</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;k4cv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Add-a-sample-with-a-crystal-structure">
<h2>Add a sample with a crystal structure<a class="headerlink" href="#Add-a-sample-with-a-crystal-structure" title="Link to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hkl</span> <span class="kn">import</span> <span class="n">Lattice</span>
<span class="kn">from</span> <span class="nn">hkl</span> <span class="kn">import</span> <span class="n">SI_LATTICE_PARAMETER</span>

<span class="c1"># add the sample to the calculation engine</span>
<span class="n">a0</span> <span class="o">=</span> <span class="n">SI_LATTICE_PARAMETER</span>
<span class="n">k4cv</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">new_sample</span><span class="p">(</span>
    <span class="s2">&quot;silicon&quot;</span><span class="p">,</span>
    <span class="n">lattice</span><span class="o">=</span><span class="n">Lattice</span><span class="p">(</span><span class="n">a</span><span class="o">=</span><span class="n">a0</span><span class="p">,</span> <span class="n">b</span><span class="o">=</span><span class="n">a0</span><span class="p">,</span> <span class="n">c</span><span class="o">=</span><span class="n">a0</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">beta</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
HklSample(name=&#39;silicon&#39;, lattice=LatticeTuple(a=5.431020511, b=5.431020511, c=5.431020511, alpha=90.0, beta=90.0, gamma=90.0), ux=Parameter(name=&#39;None (internally: ux)&#39;, limits=(min=-180.0, max=180.0), value=0.0, fit=True, inverted=False, units=&#39;Degree&#39;), uy=Parameter(name=&#39;None (internally: uy)&#39;, limits=(min=-180.0, max=180.0), value=0.0, fit=True, inverted=False, units=&#39;Degree&#39;), uz=Parameter(name=&#39;None (internally: uz)&#39;, limits=(min=-180.0, max=180.0), value=0.0, fit=True, inverted=False, units=&#39;Degree&#39;), U=array([[1., 0., 0.],
       [0., 1., 0.],
       [0., 0., 1.]]), UB=array([[ 1.15690694e+00, -7.08401189e-17, -7.08401189e-17],
       [ 0.00000000e+00,  1.15690694e+00, -7.08401189e-17],
       [ 0.00000000e+00,  0.00000000e+00,  1.15690694e+00]]), reflections=[])
</pre></div></div>
</div>
</section>
<section id="Setup-the-UB-orientation-matrix-using-hklpy">
<h2>Setup the UB orientation matrix using <em>hklpy</em><a class="headerlink" href="#Setup-the-UB-orientation-matrix-using-hklpy" title="Link to this heading">#</a></h2>
<p>Define the crystal’s orientation on the diffractometer using the 2-reflection method described by <a class="reference external" href="https://www.psi.ch/sites/default/files/import/sinq/zebra/PracticalsEN/1967-Busing-Levy-3-4-circle-Acta22.pdf">Busing &amp; Levy, Acta Cryst 22 (1967) 457</a>.</p>
<section id="Set-the-same-X-ray-wavelength-for-both-reflections,-by-setting-the-diffractometer-energy">
<h3>Set the same X-ray wavelength for both reflections, by setting the diffractometer energy<a class="headerlink" href="#Set-the-same-X-ray-wavelength-for-both-reflections,-by-setting-the-diffractometer-energy" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hkl</span> <span class="kn">import</span> <span class="n">A_KEV</span>
<span class="n">k4cv</span><span class="o">.</span><span class="n">energy</span><span class="o">.</span><span class="n">put</span><span class="p">(</span><span class="n">A_KEV</span> <span class="o">/</span> <span class="mf">1.54</span><span class="p">)</span>  <span class="c1"># (8.0509 keV)</span>
</pre></div>
</div>
</div>
</section>
<section id="Find-the-first-reflection-and-identify-its-Miller-indices:-(hkl)">
<h3>Find the first reflection and identify its Miller indices: (<em>hkl</em>)<a class="headerlink" href="#Find-the-first-reflection-and-identify-its-Miller-indices:-(hkl)" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r1</span> <span class="o">=</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">add_reflection</span><span class="p">(</span>
    <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">position</span><span class="o">=</span><span class="n">k4cv</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">Position</span><span class="p">(</span>
        <span class="n">tth</span><span class="o">=-</span><span class="mf">69.0966</span><span class="p">,</span>
        <span class="n">komega</span><span class="o">=</span><span class="mf">55.4507</span><span class="p">,</span>
        <span class="n">kappa</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
        <span class="n">kphi</span><span class="o">=-</span><span class="mi">90</span><span class="p">,</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Find-the-second-reflection">
<h3>Find the second reflection<a class="headerlink" href="#Find-the-second-reflection" title="Link to this heading">#</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">r2</span> <span class="o">=</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">add_reflection</span><span class="p">(</span>
    <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">position</span><span class="o">=</span><span class="n">k4cv</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">Position</span><span class="p">(</span>
        <span class="n">tth</span><span class="o">=-</span><span class="mf">69.0966</span><span class="p">,</span>
        <span class="n">komega</span><span class="o">=-</span><span class="mf">1.5950</span><span class="p">,</span>
        <span class="n">kappa</span><span class="o">=</span><span class="mf">134.7568</span><span class="p">,</span>
        <span class="n">kphi</span><span class="o">=</span><span class="mf">123.3554</span>
    <span class="p">)</span>
<span class="p">)</span>
</pre></div>
</div>
</div>
</section>
<section id="Compute-the-UB-orientation-matrix">
<h3>Compute the <em>UB</em> orientation matrix<a class="headerlink" href="#Compute-the-UB-orientation-matrix" title="Link to this heading">#</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">add_reflection()</span></code> method uses the current wavelength at the time it is called. (To add reflections at different wavelengths, change the wavelength <em>before</em> calling <code class="docutils literal notranslate"><span class="pre">add_reflection()</span></code> each time.) The <code class="docutils literal notranslate"><span class="pre">compute_UB()</span></code> method returns the computed <strong>UB</strong> matrix. Ignore it here.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k4cv</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">sample</span><span class="o">.</span><span class="n">compute_UB</span><span class="p">(</span><span class="n">r1</span><span class="p">,</span> <span class="n">r2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[ 2.01918352e-05, -7.20401174e-06, -1.15690694e+00],
       [ 0.00000000e+00, -1.15690694e+00,  7.20401174e-06],
       [-1.15690694e+00, -1.25733653e-10, -2.01918352e-05]])
</pre></div></div>
</div>
</section>
</section>
<section id="Report-what-we-have-setup">
<h2>Report what we have setup<a class="headerlink" href="#Report-what-we-have-setup" title="Link to this heading">#</a></h2>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k4cv</span><span class="o">.</span><span class="n">pa</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
===================== =================================================================================
term                  value
===================== =================================================================================
diffractometer        k4cv
geometry              K4CV
class                 KappaFourCircle
energy (keV)          8.05092
wavelength (angstrom) 1.54000
calc engine           hkl
mode                  bissector
positions             ====== =======
                      name   value
                      ====== =======
                      komega 0.00000
                      kappa  0.00000
                      kphi   0.00000
                      tth    0.00000
                      ====== =======
constraints           ====== ========= ========== ===== ====
                      axis   low_limit high_limit value fit
                      ====== ========= ========== ===== ====
                      komega -180.0    180.0      0.0   True
                      kappa  -180.0    180.0      0.0   True
                      kphi   -180.0    180.0      0.0   True
                      tth    -180.0    180.0      0.0   True
                      ====== ========= ========== ===== ====
sample: silicon       ================= ===============================================================
                      term              value
                      ================= ===============================================================
                      unit cell edges   a=5.431020511, b=5.431020511, c=5.431020511
                      unit cell angles  alpha=90.0, beta=90.0, gamma=90.0
                      ref 1 (hkl)       h=4.0, k=0.0, l=0.0
                      ref 1 positioners komega=55.45070, kappa=0.00000, kphi=-90.00000, tth=-69.09660
                      ref 2 (hkl)       h=0.0, k=4.0, l=0.0
                      ref 2 positioners komega=-1.59500, kappa=134.75680, kphi=123.35540, tth=-69.09660
                      [U]               [[ 1.74532925e-05 -6.22695871e-06 -1.00000000e+00]
                                         [ 0.00000000e+00 -1.00000000e+00  6.22695872e-06]
                                         [-1.00000000e+00 -1.08680932e-10 -1.74532925e-05]]
                      [UB]              [[ 2.01918352e-05 -7.20401174e-06 -1.15690694e+00]
                                         [ 0.00000000e+00 -1.15690694e+00  7.20401174e-06]
                                         [-1.15690694e+00 -1.25733653e-10 -2.01918352e-05]]
                      ================= ===============================================================
===================== =================================================================================

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;pyRestTable.rest_table.Table at 0x7eff90207950&gt;
</pre></div></div>
</div>
</section>
<section id="Check-the-orientation-matrix">
<h2>Check the orientation matrix<a class="headerlink" href="#Check-the-orientation-matrix" title="Link to this heading">#</a></h2>
<p>Perform checks with <em>forward</em> (hkl to angle) and <em>inverse</em> (angle to hkl) computations to verify the diffractometer will move to the same positions where the reflections were identified.</p>
<section id="Constrain-one-of-the-motors-to-a-limited-range">
<h3>Constrain one of the motors to a limited range<a class="headerlink" href="#Constrain-one-of-the-motors-to-a-limited-range" title="Link to this heading">#</a></h3>
<ul class="simple">
<li><p>keep <code class="docutils literal notranslate"><span class="pre">kphi</span></code> less than or equal to zero (allowing for small roundoff)</p></li>
</ul>
<p>First, we apply constraints directly to the <code class="docutils literal notranslate"><span class="pre">calc</span></code>-level support.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k4cv</span><span class="o">.</span><span class="n">calc</span><span class="p">[</span><span class="s2">&quot;kphi&quot;</span><span class="p">]</span><span class="o">.</span><span class="n">limits</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">180</span><span class="p">,</span> <span class="mf">0.001</span><span class="p">)</span>
<span class="n">k4cv</span><span class="o">.</span><span class="n">show_constraints</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
====== ========= ========== ===== ====
axis   low_limit high_limit value fit
====== ========= ========== ===== ====
komega -180.0    180.0      0.0   True
kappa  -180.0    180.0      0.0   True
kphi   -180.0    0.001      0.0   True
tth    -180.0    180.0      0.0   True
====== ========= ========== ===== ====

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;pyRestTable.rest_table.Table at 0x7eff902077d0&gt;
</pre></div></div>
</div>
<p>Next, we show how to use additional methods of <code class="docutils literal notranslate"><span class="pre">Diffractometer()</span></code> that support <em>undo</em> and <em>reset</em> features for applied constraints. The support is based on a <em>stack</em> (a Python list). A set of constraints is added (<code class="docutils literal notranslate"><span class="pre">apply_constraints()</span></code>) or removed (<code class="docutils literal notranslate"><span class="pre">undo_last_constraints()</span></code>) from the stack. Or, the stack can be cleared (<code class="docutils literal notranslate"><span class="pre">reset_constraints()</span></code>).</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>method</p></th>
<th class="head"><p>what happens</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">apply_constraints()</span></code></p></td>
<td><p>Add a set of constraints and use them</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">undo_last_constraints()</span></code></p></td>
<td><p>Remove the most-recent set of constraints and restore the previous one from the stack.</p></td>
</tr>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">reset_constraints()</span></code></p></td>
<td><p>Set constraints back to initial settings.</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">show_constraints()</span></code></p></td>
<td><p>Print the current constraints in a table.</p></td>
</tr>
</tbody>
</table>
<p>A set of constraints is a Python dictionary that uses the real positioner names (the motors) as the keys. Only those constraints with changes need be added to the dictionary but it is permissable to describe all the real positioners. Each value in the dictionary is a <a class="reference external" href="https://blueskyproject.io/hklpy/diffract.html#hkl.diffract.Constraint">hkl.diffract.Constraint</a>, where the values are specified in this order: <code class="docutils literal notranslate"><span class="pre">low_limit,</span> <span class="pre">high_limit,</span> <span class="pre">value,</span> <span class="pre">fit</span></code>.</p>
<p>Apply new constraints using the <a class="reference external" href="https://blueskyproject.io/hklpy/diffract.html#hkl.diffract.Diffractometer.apply_constraints">applyConstraints()</a> method. These <em>add</em> to the existing constraints, as shown in the table.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">hkl</span> <span class="kn">import</span> <span class="n">Constraint</span>
<span class="n">k4cv</span><span class="o">.</span><span class="n">apply_constraints</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;komega&quot;</span><span class="p">:</span> <span class="n">Constraint</span><span class="p">(</span><span class="o">-</span><span class="mf">0.001</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
        <span class="s2">&quot;kappa&quot;</span><span class="p">:</span> <span class="n">Constraint</span><span class="p">(</span><span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="mi">90</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">)</span>
<span class="n">k4cv</span><span class="o">.</span><span class="n">show_constraints</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
====== ========= ========== ===== ====
axis   low_limit high_limit value fit
====== ========= ========== ===== ====
komega -0.001    180.0      0.0   True
kappa  -90.0     90.0       0.0   True
kphi   -180.0    0.001      0.0   True
tth    -180.0    180.0      0.0   True
====== ========= ========== ===== ====

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;pyRestTable.rest_table.Table at 0x7eff90205c10&gt;
</pre></div></div>
</div>
<p>Then remove (undo) those new additions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k4cv</span><span class="o">.</span><span class="n">undo_last_constraints</span><span class="p">()</span>
<span class="n">k4cv</span><span class="o">.</span><span class="n">show_constraints</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
====== ========= ========== ===== ====
axis   low_limit high_limit value fit
====== ========= ========== ===== ====
komega -180.0    180.0      0.0   True
kappa  -180.0    180.0      0.0   True
kphi   -180.0    0.001      0.0   True
tth    -180.0    180.0      0.0   True
====== ========= ========== ===== ====

</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;pyRestTable.rest_table.Table at 0x7eff918640d0&gt;
</pre></div></div>
</div>
</section>
<section id="Use-bissector-mode">
<h3>Use <code class="docutils literal notranslate"><span class="pre">bissector</span></code> mode<a class="headerlink" href="#Use-bissector-mode" title="Link to this heading">#</a></h3>
<p>where <code class="docutils literal notranslate"><span class="pre">tth</span></code> = 2*<code class="docutils literal notranslate"><span class="pre">omega</span></code></p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k4cv</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;bissector&quot;</span>
</pre></div>
</div>
</div>
</section>
<section id="(400)-reflection-test">
<h3>(400) reflection test<a class="headerlink" href="#(400)-reflection-test" title="Link to this heading">#</a></h3>
<ol class="arabic simple">
<li><p>Check the <code class="docutils literal notranslate"><span class="pre">inverse</span></code> (angles -&gt; (<em>hkl</em>)) computation.</p></li>
<li><p>Check the <code class="docutils literal notranslate"><span class="pre">forward</span></code> ((<em>hkl</em>) -&gt; angles) computation.</p></li>
</ol>
</section>
<section id="Check-the-inverse-calculation:-(400)">
<h3>Check the inverse calculation: (400)<a class="headerlink" href="#Check-the-inverse-calculation:-(400)" title="Link to this heading">#</a></h3>
<p>To calculate the (<em>hkl</em>) corresponding to a given set of motor angles, call <code class="docutils literal notranslate"><span class="pre">k4cv.inverse((h,</span> <span class="pre">k,</span> <span class="pre">l))</span></code>. Note the second set of parentheses needed by this function.</p>
<p>The values are specified, without names, in the order specified by <code class="docutils literal notranslate"><span class="pre">k4cv.calc.physical_axis_names</span></code>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="nb">print</span><span class="p">(</span><span class="s2">&quot;axis names:&quot;</span><span class="p">,</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">physical_axis_names</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
axis names: [&#39;komega&#39;, &#39;kappa&#39;, &#39;kphi&#39;, &#39;tth&#39;]
</pre></div></div>
</div>
<p>Now, proceed with the inverse calculation.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sol</span> <span class="o">=</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">inverse</span><span class="p">((</span><span class="mf">55.4507</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">90</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.0966</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(4 0 0) ? </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">h</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">k</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">l</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(4 0 0) ? 4.00 -0.00 -0.00
</pre></div></div>
</div>
</section>
<section id="Check-the-forward-calculation:-(400)">
<h3>Check the forward calculation: (400)<a class="headerlink" href="#Check-the-forward-calculation:-(400)" title="Link to this heading">#</a></h3>
<p>Compute the angles necessary to position the diffractometer for the given reflection.</p>
<p>Note that for the forward computation, more than one set of angles may be used to reach the same crystal reflection. This test will report the <em>default</em> selection. The <em>default</em> selection (which may be changed through methods described in the <code class="docutils literal notranslate"><span class="pre">hkl.calc</span></code> module) is the first solution.</p>
<table class="table">
<thead>
<tr class="row-odd"><th class="head"><p>function</p></th>
<th class="head"><p>returns</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">k4cv.forward()</span></code></p></td>
<td><p>The <em>default</em> solution</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">k4cv.calc.forward()</span></code></p></td>
<td><p>List of all allowed solutions.</p></td>
</tr>
</tbody>
</table>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sol</span> <span class="o">=</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">forward</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;(400) :&quot;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;tth=</span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">tth</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;komega=</span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">komega</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;kappa=</span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">kappa</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;kphi=</span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">kphi</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(400) : tth=-69.0982 komega=55.4509 kappa=0.0000 kphi=-90.0010
</pre></div></div>
</div>
</section>
<section id="(040)-reflection-test">
<h3>(040) reflection test<a class="headerlink" href="#(040)-reflection-test" title="Link to this heading">#</a></h3>
<p>Repeat the <code class="docutils literal notranslate"><span class="pre">inverse</span></code> and <code class="docutils literal notranslate"><span class="pre">forward</span></code> calculations for the second orientation reflection.</p>
</section>
<section id="Check-the-inverse-calculation:-(040)">
<h3>Check the inverse calculation: (040)<a class="headerlink" href="#Check-the-inverse-calculation:-(040)" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sol</span> <span class="o">=</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">inverse</span><span class="p">((</span><span class="o">-</span><span class="mf">1.5950</span><span class="p">,</span> <span class="mf">134.7568</span><span class="p">,</span> <span class="mf">123.3554</span><span class="p">,</span> <span class="o">-</span><span class="mf">69.0966</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;(0 4 0) ? </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">h</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">k</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> </span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">l</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(0 4 0) ? -0.00 4.00 0.00
</pre></div></div>
</div>
</section>
<section id="Check-the-forward-calculation:-(040)">
<h3>Check the forward calculation: (040)<a class="headerlink" href="#Check-the-forward-calculation:-(040)" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">sol</span> <span class="o">=</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">forward</span><span class="p">((</span><span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span>
    <span class="s2">&quot;(040) :&quot;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;tth=</span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">tth</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;komega=</span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">komega</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;kappa=</span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">kappa</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">,</span>
    <span class="sa">f</span><span class="s2">&quot;kphi=</span><span class="si">{</span><span class="n">sol</span><span class="o">.</span><span class="n">kphi</span><span class="si">:</span><span class="s2">.4f</span><span class="si">}</span><span class="s2">&quot;</span>
    <span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(040) : tth=-69.0982 komega=-1.5937 kappa=134.7551 kphi=-57.0461
</pre></div></div>
</div>
</section>
</section>
<section id="Scan-in-reciprocal-space-using-Bluesky">
<h2>Scan in reciprocal space using Bluesky<a class="headerlink" href="#Scan-in-reciprocal-space-using-Bluesky" title="Link to this heading">#</a></h2>
<p>To scan with Bluesky, we need more setup.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="o">%</span><span class="k">matplotlib</span> inline

<span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">RunEngine</span>
<span class="kn">from</span> <span class="nn">bluesky</span> <span class="kn">import</span> <span class="n">SupplementalData</span>
<span class="kn">from</span> <span class="nn">bluesky.callbacks.best_effort</span> <span class="kn">import</span> <span class="n">BestEffortCallback</span>
<span class="kn">from</span> <span class="nn">bluesky.magics</span> <span class="kn">import</span> <span class="n">BlueskyMagics</span>
<span class="kn">import</span> <span class="nn">bluesky.plans</span> <span class="k">as</span> <span class="nn">bp</span>
<span class="kn">import</span> <span class="nn">bluesky.plan_stubs</span> <span class="k">as</span> <span class="nn">bps</span>
<span class="kn">import</span> <span class="nn">databroker</span>
<span class="kn">from</span> <span class="nn">IPython</span> <span class="kn">import</span> <span class="n">get_ipython</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="n">plt</span><span class="o">.</span><span class="n">ion</span><span class="p">()</span>

<span class="n">bec</span> <span class="o">=</span> <span class="n">BestEffortCallback</span><span class="p">()</span>
<span class="n">db</span> <span class="o">=</span> <span class="n">databroker</span><span class="o">.</span><span class="n">temp</span><span class="p">()</span><span class="o">.</span><span class="n">v1</span>
<span class="n">sd</span> <span class="o">=</span> <span class="n">SupplementalData</span><span class="p">()</span>

<span class="n">get_ipython</span><span class="p">()</span><span class="o">.</span><span class="n">register_magics</span><span class="p">(</span><span class="n">BlueskyMagics</span><span class="p">)</span>

<span class="n">RE</span> <span class="o">=</span> <span class="n">RunEngine</span><span class="p">({})</span>
<span class="n">RE</span><span class="o">.</span><span class="n">md</span> <span class="o">=</span> <span class="p">{}</span>
<span class="n">RE</span><span class="o">.</span><span class="n">preprocessors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sd</span><span class="p">)</span>
<span class="n">RE</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">db</span><span class="o">.</span><span class="n">insert</span><span class="p">)</span>
<span class="n">RE</span><span class="o">.</span><span class="n">subscribe</span><span class="p">(</span><span class="n">bec</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
1
</pre></div></div>
</div>
<section id="(h00)-scan-near-(400)">
<h3>(<em>h00</em>) scan near (400)<a class="headerlink" href="#(h00)-scan-near-(400)" title="Link to this heading">#</a></h3>
<p>In this example, we have no detector. Still, we add the diffractometer object in the detector list so that the <em>hkl</em> and motor positions will appear as columns in the table.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">([</span><span class="n">k4cv</span><span class="p">],</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


Transient Scan ID: 1     Time: 2023-11-20 21:59:43
Persistent Unique Scan ID: &#39;15166a92-8209-484a-af30-ee7ea176a796&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|   seq_num |       time |     k4cv_h |     k4cv_k |     k4cv_l | k4cv_komega | k4cv_kappa |  k4cv_kphi |   k4cv_tth |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|         1 | 21:59:43.4 |      3.900 |     -0.000 |     -0.000 |      56.431 |     -0.000 |    -90.001 |    -67.137 |
|         2 | 21:59:44.0 |      3.950 |     -0.000 |      0.000 |      55.943 |     -0.000 |    -90.001 |    -68.115 |
|         3 | 21:59:44.6 |      4.000 |     -0.000 |     -0.000 |      55.451 |      0.000 |    -90.001 |    -69.098 |
|         4 | 21:59:45.2 |      4.050 |     -0.000 |      0.000 |      54.956 |     -0.000 |    -90.001 |    -70.087 |
|         5 | 21:59:45.8 |      4.100 |      0.000 |      0.000 |      54.459 |     -0.000 |    -90.001 |    -71.083 |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
generator scan [&#39;15166a92&#39;] (scan num: 1)



</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;15166a92-8209-484a-af30-ee7ea176a796&#39;,)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebooks_geo_k4cv_42_2.png" src="../../_images/examples_notebooks_geo_k4cv_42_2.png" />
</div>
</div>
</section>
<section id="(hk0)-scan-from-(400)-to-(040)">
<h3>(<em>hk0</em>) scan from (400) to (040)<a class="headerlink" href="#(hk0)-scan-from-(400)-to-(040)" title="Link to this heading">#</a></h3>
<p>Scan between the two orientation reflections. Need to keep <span class="math notranslate nohighlight">\(\varphi\ge0\)</span> to avoid big jumps during the scan.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k4cv</span><span class="o">.</span><span class="n">calc</span><span class="o">.</span><span class="n">engine</span><span class="o">.</span><span class="n">mode</span> <span class="o">=</span> <span class="s2">&quot;constant_phi&quot;</span>
<span class="n">k4cv</span><span class="o">.</span><span class="n">apply_constraints</span><span class="p">(</span>
    <span class="p">{</span>
        <span class="s2">&quot;kphi&quot;</span><span class="p">:</span> <span class="n">Constraint</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">180</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="kc">True</span><span class="p">),</span>
    <span class="p">}</span>
<span class="p">)</span>

<span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">([</span><span class="n">k4cv</span><span class="p">],</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">10</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


Transient Scan ID: 2     Time: 2023-11-20 21:59:47
Persistent Unique Scan ID: &#39;9f4b12f0-94f7-46cd-a926-d564bbe1717f&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|   seq_num |       time |     k4cv_h |     k4cv_k |     k4cv_l | k4cv_komega | k4cv_kappa |  k4cv_kphi |   k4cv_tth |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|         1 | 21:59:47.6 |      4.000 |      0.000 |      0.000 |    -124.550 |     -0.000 |     90.000 |    -69.098 |
|         2 | 21:59:48.1 |      3.556 |      0.444 |      0.000 |    -117.539 |     -9.305 |     92.995 |    -61.064 |
|         3 | 21:59:48.5 |      3.111 |      0.889 |      0.000 |    -110.558 |    -20.863 |     96.749 |    -54.611 |
|         4 | 21:59:48.9 |      2.667 |      1.333 |     -0.000 |    -103.581 |    -34.906 |    101.425 |    -50.010 |
|         5 | 21:59:49.3 |      2.222 |      1.778 |      0.000 |     -96.678 |    -51.202 |    107.118 |    -47.591 |
|         6 | 21:59:49.8 |      1.778 |      2.222 |      0.000 |     -90.012 |    -68.872 |    113.784 |    -47.591 |
|         7 | 21:59:50.2 |      1.333 |      2.667 |     -0.000 |     -83.767 |    -86.675 |    121.238 |    -50.010 |
|         8 | 21:59:50.6 |      0.889 |      3.111 |      0.000 |     -78.039 |   -103.647 |    129.267 |    -54.611 |
|         9 | 21:59:51.0 |      0.444 |      3.556 |     -0.000 |     -72.737 |   -119.520 |    137.795 |    -61.064 |
|        10 | 21:59:51.4 |     -0.000 |      4.000 |      0.000 |     -67.504 |   -134.756 |    147.045 |    -69.098 |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
generator scan [&#39;9f4b12f0&#39;] (scan num: 2)



</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;9f4b12f0-94f7-46cd-a926-d564bbe1717f&#39;,)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebooks_geo_k4cv_44_2.png" src="../../_images/examples_notebooks_geo_k4cv_44_2.png" />
</div>
</div>
</section>
<section id="(0k0)-scan-near-(040)">
<h3>(<em>0k0</em>) scan near (040)<a class="headerlink" href="#(0k0)-scan-near-(040)" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">([</span><span class="n">k4cv</span><span class="p">],</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


Transient Scan ID: 3     Time: 2023-11-20 21:59:52
Persistent Unique Scan ID: &#39;d7406f6c-d8bb-4296-8443-dc811d6b511b&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|   seq_num |       time |     k4cv_k |     k4cv_h |     k4cv_l | k4cv_komega | k4cv_kappa |  k4cv_kphi |   k4cv_tth |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|         1 | 21:59:52.8 |      3.900 |     -0.000 |      0.000 |     -66.523 |   -134.756 |    147.045 |    -67.137 |
|         2 | 21:59:53.4 |      3.950 |     -0.000 |     -0.000 |     -67.012 |   -134.756 |    147.045 |    -68.115 |
|         3 | 21:59:54.0 |      4.000 |     -0.000 |      0.000 |     -67.504 |   -134.756 |    147.045 |    -69.098 |
|         4 | 21:59:54.6 |      4.050 |     -0.000 |      0.000 |     -67.998 |   -134.756 |    147.045 |    -70.087 |
|         5 | 21:59:55.2 |      4.100 |     -0.000 |      0.000 |     -68.496 |   -134.756 |    147.045 |    -71.083 |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
generator scan [&#39;d7406f6c&#39;] (scan num: 3)



</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;d7406f6c-d8bb-4296-8443-dc811d6b511b&#39;,)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebooks_geo_k4cv_46_2.png" src="../../_images/examples_notebooks_geo_k4cv_46_2.png" />
</div>
</div>
</section>
<section id="(hk0)-scan-near-(440)">
<h3>(<em>hk0</em>) scan near (440)<a class="headerlink" href="#(hk0)-scan-near-(440)" title="Link to this heading">#</a></h3>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">([</span><span class="n">k4cv</span><span class="p">],</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">,</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="mf">4.1</span><span class="p">,</span> <span class="mf">3.9</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


Transient Scan ID: 4     Time: 2023-11-20 21:59:56
Persistent Unique Scan ID: &#39;7351e671-a1ae-465d-8f77-e0b33efa8ea5&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|   seq_num |       time |     k4cv_h |     k4cv_k |     k4cv_l | k4cv_komega | k4cv_kappa |  k4cv_kphi |   k4cv_tth |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|         1 | 21:59:57.0 |      3.900 |      4.100 |      0.000 |    -122.253 |    -61.940 |    111.095 |   -106.695 |
|         2 | 21:59:57.4 |      3.950 |      4.050 |      0.000 |    -122.614 |    -60.940 |    110.715 |   -106.659 |
|         3 | 21:59:57.8 |      4.000 |      4.000 |     -0.000 |    -122.985 |    -59.941 |    110.339 |   -106.647 |
|         4 | 21:59:58.3 |      4.050 |      3.950 |      0.000 |    -123.365 |    -58.946 |    109.965 |   -106.659 |
|         5 | 21:59:58.7 |      4.100 |      3.900 |      0.000 |    -123.754 |    -57.952 |    109.593 |   -106.695 |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
generator scan [&#39;7351e671&#39;] (scan num: 4)



</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;7351e671-a1ae-465d-8f77-e0b33efa8ea5&#39;,)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebooks_geo_k4cv_48_2.png" src="../../_images/examples_notebooks_geo_k4cv_48_2.png" />
</div>
</div>
<p>Move to the (<em>440</em>) reflection.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">k4cv</span><span class="o">.</span><span class="n">move</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">0</span><span class="p">))</span>
<span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k4cv</span><span class="o">.</span><span class="n">position</span><span class="w"> </span><span class="si">= }</span><span class="s2">&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
k4cv.position = KappaFourCirclePseudoPos(h=4.000000003222204, k=3.999999988853611, l=-1.8832509383931196e-08)
</pre></div></div>
</div>
<p>Repeat the same scan about the (<em>440</em>) but use <em>relative</em> positions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">rel_scan</span><span class="p">([</span><span class="n">k4cv</span><span class="p">],</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="n">k4cv</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">5</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>


Transient Scan ID: 5     Time: 2023-11-20 22:00:00
Persistent Unique Scan ID: &#39;18ac1987-606c-4a33-9470-f276ecb1036f&#39;
New stream: &#39;primary&#39;
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|   seq_num |       time |     k4cv_h |     k4cv_k |     k4cv_l | k4cv_komega | k4cv_kappa |  k4cv_kphi |   k4cv_tth |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
|         1 | 22:00:00.2 |      3.900 |      3.900 |      0.000 |    -121.103 |    -59.941 |    110.339 |   -102.882 |
|         2 | 22:00:00.6 |      3.950 |      3.950 |     -0.000 |    -122.034 |    -59.941 |    110.339 |   -104.744 |
|         3 | 22:00:01.0 |      4.000 |      4.000 |     -0.000 |    -122.985 |    -59.941 |    110.339 |   -106.647 |
|         4 | 22:00:01.4 |      4.050 |      4.050 |     -0.000 |    -123.958 |    -59.941 |    110.339 |   -108.592 |
|         5 | 22:00:01.9 |      4.100 |      4.100 |     -0.000 |    -124.954 |    -59.941 |    110.339 |   -110.585 |
+-----------+------------+------------+------------+------------+-------------+------------+------------+------------+
generator rel_scan [&#39;18ac1987&#39;] (scan num: 5)



</pre></div></div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(&#39;18ac1987-606c-4a33-9470-f276ecb1036f&#39;,)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="../../_images/examples_notebooks_geo_k4cv_52_2.png" src="../../_images/examples_notebooks_geo_k4cv_52_2.png" />
</div>
</div>
</section>
</section>
</section>


                </article>
              
              
              
              
              
                <footer class="prev-next-footer">
                  
<div class="prev-next-area">
    <a class="left-prev"
       href="geo_e6c.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">E6C : 6-circle diffractometer example</p>
      </div>
    </a>
    <a class="right-next"
       href="../howto.html"
       title="next page">
      <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">How-to Guides</p>
      </div>
      <i class="fa-solid fa-angle-right"></i>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">


  <div class="sidebar-secondary-item">
<div
    id="pst-page-navigation-heading-2"
    class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> On this page
  </div>
  <nav class="bd-toc-nav page-toc" aria-labelledby="pst-page-navigation-heading-2">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Setup-the-K4CV-diffractometer-in-hklpy">Setup the <em>K4CV</em> diffractometer in <em>hklpy</em></a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Define-this-diffractometer">Define <em>this</em> diffractometer</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Add-a-sample-with-a-crystal-structure">Add a sample with a crystal structure</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Setup-the-UB-orientation-matrix-using-hklpy">Setup the UB orientation matrix using <em>hklpy</em></a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Set-the-same-X-ray-wavelength-for-both-reflections,-by-setting-the-diffractometer-energy">Set the same X-ray wavelength for both reflections, by setting the diffractometer energy</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Find-the-first-reflection-and-identify-its-Miller-indices:-(hkl)">Find the first reflection and identify its Miller indices: (<em>hkl</em>)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Find-the-second-reflection">Find the second reflection</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Compute-the-UB-orientation-matrix">Compute the <em>UB</em> orientation matrix</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Report-what-we-have-setup">Report what we have setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Check-the-orientation-matrix">Check the orientation matrix</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Constrain-one-of-the-motors-to-a-limited-range">Constrain one of the motors to a limited range</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Use-bissector-mode">Use <code class="docutils literal notranslate"><span class="pre">bissector</span></code> mode</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#(400)-reflection-test">(400) reflection test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Check-the-inverse-calculation:-(400)">Check the inverse calculation: (400)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Check-the-forward-calculation:-(400)">Check the forward calculation: (400)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#(040)-reflection-test">(040) reflection test</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Check-the-inverse-calculation:-(040)">Check the inverse calculation: (040)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#Check-the-forward-calculation:-(040)">Check the forward calculation: (040)</a></li>
</ul>
</li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#Scan-in-reciprocal-space-using-Bluesky">Scan in reciprocal space using Bluesky</a><ul class="nav section-nav flex-column">
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#(h00)-scan-near-(400)">(<em>h00</em>) scan near (400)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#(hk0)-scan-from-(400)-to-(040)">(<em>hk0</em>) scan from (400) to (040)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#(0k0)-scan-near-(040)">(<em>0k0</em>) scan near (040)</a></li>
<li class="toc-h3 nav-item toc-entry"><a class="reference internal nav-link" href="#(hk0)-scan-near-(440)">(<em>hk0</em>) scan near (440)</a></li>
</ul>
</li>
</ul>
  </nav></div>

  <div class="sidebar-secondary-item">

  <div class="tocsection sourcelink">
    <a href="../../_sources/examples/notebooks/geo_k4cv.ipynb.txt">
      <i class="fa-solid fa-file-lines"></i> Show Source
    </a>
  </div>
</div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
          </footer>
        
      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../../_static/scripts/bootstrap.js?digest=8d27b9dea8ad943066ae"></script>
<script src="../../_static/scripts/pydata-sphinx-theme.js?digest=8d27b9dea8ad943066ae"></script>

  <footer class="bd-footer">
<div class="bd-footer__inner bd-page-width">
  
    <div class="footer-items__start">
      
        <div class="footer-item">

  <p class="copyright">
    
      © Copyright 2014-2023, Brookhaven National Laboratory.
      <br/>
    
  </p>
</div>
      
        <div class="footer-item">

  <p class="sphinx-version">
    Created using <a href="https://www.sphinx-doc.org/">Sphinx</a> 7.3.7.
    <br/>
  </p>
</div>
      
    </div>
  
  
  
    <div class="footer-items__end">
      
        <div class="footer-item">
<p class="theme-version">
  Built with the <a href="https://pydata-sphinx-theme.readthedocs.io/en/stable/index.html">PyData Sphinx Theme</a> 0.15.2.
</p></div>
      
    </div>
  
</div>

  </footer>
  </body>
</html>