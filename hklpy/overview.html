<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17.1: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Overview &mdash; hklpy 0+untagged.1.g53bbbfd.dirty documentation</title>
      <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
      <link rel="stylesheet" href="_static/graphviz.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
        <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
    <script src="_static/js/theme.js"></script>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Ready-to-Use Devices" href="ready_to_use.html" />
    <link rel="prev" title="hklpy" href="index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
            <a href="index.html" class="icon icon-home"> hklpy
          </a>
              <div class="version">
                0+untagged.1.g53bbbfd.dirty
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <p class="caption" role="heading"><span class="caption-text">Core Functionality</span></p>
<ul class="current">
<li class="toctree-l1 current"><a class="current reference internal" href="#">Overview</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#definitions">Definitions</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#real-axis-positioner">real axis (positioner)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pseudo-axis-positioner">pseudo axis (positioner)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#forward-transformation">forward (transformation)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#inverse-transformation">inverse (transformation)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#libhkl-support-library"><em>libhkl</em> support library</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#parts-of-a-diffractometer-object">Parts of a <cite>Diffractometer</cite> object</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#name">name</a></li>
<li class="toctree-l3"><a class="reference internal" href="#geometry">geometry</a></li>
<li class="toctree-l3"><a class="reference internal" href="#calc">calc</a></li>
<li class="toctree-l3"><a class="reference internal" href="#energy">energy</a></li>
<li class="toctree-l3"><a class="reference internal" href="#sample">sample</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lattice">lattice</a></li>
<li class="toctree-l3"><a class="reference internal" href="#orientation">orientation</a></li>
<li class="toctree-l3"><a class="reference internal" href="#constraint">constraint</a></li>
<li class="toctree-l3"><a class="reference internal" href="#mode">mode</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#steps-to-define-a-diffractometer-object">Steps to define a diffractometer object</a></li>
<li class="toctree-l2"><a class="reference internal" href="#use-a-diffractometer-with-the-bluesky-runengine">Use a Diffractometer with the bluesky RunEngine</a></li>
</ul>
</li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Ready-to-Use Devices</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="ready_to_use.html">Ready-to-Use Devices</a></li>
<li class="toctree-l1"><a class="reference internal" href="examples/index.html">Examples</a></li>
</ul>
<p class="caption" role="heading"><span class="caption-text">Developer Notes</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="api.html">API Reference</a></li>
<li class="toctree-l1"><a class="reference internal" href="release_notes.html">Release History</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">hklpy</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
      <li>Overview</li>
      <li class="wy-breadcrumbs-aside">
            <a href="_sources/overview.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="overview">
<h1>Overview<a class="headerlink" href="#overview" title="Permalink to this headline">¶</a></h1>
<p>The <code class="docutils literal notranslate"><span class="pre">hklpy</span></code> package provides controls for using diffractometers within the
<a class="reference external" href="https://blueskyproject.io">Bluesky Framework</a>.
<a class="reference internal" href="diffract.html#hkl.diffract.Diffractometer" title="hkl.diffract.Diffractometer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Diffractometer()</span></code></a> is the base class from which all the
different diffractometer geometries are built.  Built on the
<a class="reference external" href="https://blueskyproject.io/ophyd/positioners.html#pseudopositioner">ophyd.PseudoPositioner</a> interface,
it defines all the components of a diffractometer.  The different geometries
specify the names and order for the real motor axes.</p>
<section id="definitions">
<h2>Definitions<a class="headerlink" href="#definitions" title="Permalink to this headline">¶</a></h2>
<p>Several terms used throughout are:</p>
<section id="real-axis-positioner">
<span id="index-0"></span><h3>real axis (positioner)<a class="headerlink" href="#real-axis-positioner" title="Permalink to this headline">¶</a></h3>
<p>A positioner (whether simulated or attached to hardware) that operates in
<em>real</em> space.  Typically an instance of <a class="reference external" href="https://blueskyproject.io/ophyd/builtin-devices.html#epicsmotor">ophyd.EpicsMotor</a>
or
<a class="reference external" href="https://blueskyproject.io/ophyd/positioners.html#softpositioner">ophyd.SoftPositioner</a>.</p>
</section>
<section id="pseudo-axis-positioner">
<span id="index-1"></span><h3>pseudo axis (positioner)<a class="headerlink" href="#pseudo-axis-positioner" title="Permalink to this headline">¶</a></h3>
<p>A positioner (whether simulated or attached to hardware) that operates in
<em>reciprocal</em> space.  Typically an instance of <a class="reference external" href="https://blueskyproject.io/ophyd/positioners.html#ophyd.pseudopos.PseudoSingle">ophyd.PseudoSingle</a>.</p>
</section>
<section id="forward-transformation">
<span id="index-2"></span><h3>forward (transformation)<a class="headerlink" href="#forward-transformation" title="Permalink to this headline">¶</a></h3>
<p>Compute the values of the real positioners given values of the pseudo
positioners.  Since more than one solution is possible, additional
constraints (limits on the real positioner and diffractometer mode) may be
added.</p>
</section>
<section id="inverse-transformation">
<span id="index-3"></span><h3>inverse (transformation)<a class="headerlink" href="#inverse-transformation" title="Permalink to this headline">¶</a></h3>
<p>Compute the values of the pseudo positioners given values of the real
positioners.</p>
</section>
<section id="libhkl-support-library">
<span id="index-4"></span><h3><em>libhkl</em> support library<a class="headerlink" href="#libhkl-support-library" title="Permalink to this headline">¶</a></h3>
<p>The transformation between real and reciprocal (_pseudo_) space are passed
(from <a class="reference internal" href="diffract.html#module-hkl.diffract" title="hkl.diffract"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hkl.diffract</span></code></a> through <a class="reference internal" href="calc.html#module-hkl.calc" title="hkl.calc"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hkl.calc</span></code></a>) to a support library
known here as <em>libhkl</em> (<a class="reference external" href="https://repo.or.cz/hkl.git">https://repo.or.cz/hkl.git</a>), written in C++.</p>
</section>
</section>
<section id="parts-of-a-diffractometer-object">
<h2>Parts of a <cite>Diffractometer</cite> object<a class="headerlink" href="#parts-of-a-diffractometer-object" title="Permalink to this headline">¶</a></h2>
<p>A <code class="docutils literal notranslate"><span class="pre">Diffractometer</span></code> object has several parts:</p>
<section id="name">
<h3>name<a class="headerlink" href="#name" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">name</span></code> of the <a class="reference internal" href="diffract.html#hkl.diffract.Diffractometer" title="hkl.diffract.Diffractometer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Diffractometer()</span></code></a> instance is
completely at the choice of the user and conveys no specific information to
the underlying Python support code.</p>
<p>One important convention is that the name given on the left side of the <code class="docutils literal notranslate"><span class="pre">=</span></code>
matches the name given by the <code class="docutils literal notranslate"><span class="pre">name=&quot;...&quot;</span></code> keyword, such as this example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">e4cv</span> <span class="o">=</span> <span class="n">E4CV</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;e4cv&quot;</span><span class="p">)</span>
</pre></div>
</div>
</section>
<section id="geometry">
<span id="index-5"></span><h3>geometry<a class="headerlink" href="#geometry" title="Permalink to this headline">¶</a></h3>
<p>The geometry describes the physical arrangement of real positioners that
make up the diffractometer.  The choices are limited to those geometries
provided in <a class="reference internal" href="geometries.html#module-hkl.geometries" title="hkl.geometries"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hkl.geometries</span></code></a> (which are the geometries provided by the
<em>libhkl</em> support library).  A geometry will provide a list of the real
positioners.  It is possible to use alternate names.</p>
</section>
<section id="calc">
<span id="index-6"></span><h3>calc<a class="headerlink" href="#calc" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">calc</span></code> attribute, set when the <a class="reference internal" href="diffract.html#hkl.diffract.Diffractometer" title="hkl.diffract.Diffractometer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Diffractometer</span></code></a>
object is defined, connects with the underlying <em>libhkl</em> support library.
While a user might call certain methods from this
<a class="reference internal" href="calc.html#hkl.calc.CalcRecip" title="hkl.calc.CalcRecip"><code class="xref py py-class docutils literal notranslate"><span class="pre">CalcRecip()</span></code></a> object, it is usually not necessary.  The
most common term from this layer would be the actual wavelength used for
computations.  Using from the example above, <code class="docutils literal notranslate"><span class="pre">DFRCT.calc.wavelength</span></code>
(where <code class="docutils literal notranslate"><span class="pre">DFRCT</span></code> is the diffractometer object, such as <code class="docutils literal notranslate"><span class="pre">e4cv</span></code> above),
expressed in Angstrom units. Normally, the user will set the energy in the
diffractometer object, <code class="docutils literal notranslate"><span class="pre">DFRCT.energy</span></code>, which will then set the wavelength.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">calc</span></code> contains the methods that convert between energy and
wavelength. To use this Python support at an instrument that does not use
X-rays (such as a neutron source), re-write these methods and also redefine
any classes that use <a class="reference internal" href="calc.html#hkl.calc.CalcRecip" title="hkl.calc.CalcRecip"><code class="xref py py-class docutils literal notranslate"><span class="pre">hkl.calc.CalcRecip()</span></code></a>.</p>
</section>
<section id="energy">
<span id="index-7"></span><h3>energy<a class="headerlink" href="#energy" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference internal" href="diffract.html#diffract-energy"><span class="std std-ref">energy</span></a> of the diffractometer sets the
wavelength, which is used when:</p>
<ol class="arabic simple">
<li><p>computing <code class="docutils literal notranslate"><span class="pre">forward()</span></code> and <code class="docutils literal notranslate"><span class="pre">inverse()</span></code> transformations</p></li>
<li><p>defining orientation reflections</p></li>
<li><p>documenting the state of the diffractometer</p></li>
</ol>
<p>It is more common for users to describe energy than wavelength.  The
high-level interface allows the energy to be expressed in any
<a class="reference internal" href="diffract.html#diffract-energy-units"><span class="std std-ref">engineering units</span></a> that are convertible to
the expected units (<cite>keV</cite>).  An offset may be applied, which is useful when
connecting the diffractometer energy with a control system variable.
(See the <a class="reference internal" href="diffract.html#diffract-energy-control-system"><span class="std std-ref">Control System Energy</span></a> section.)</p>
</section>
<section id="sample">
<span id="index-8"></span><h3>sample<a class="headerlink" href="#sample" title="Permalink to this headline">¶</a></h3>
<p>The point of a diffractometer is to position a sample for scientific
measurements. The <code class="docutils literal notranslate"><span class="pre">sample</span></code> attribute is an instance of
<a class="reference internal" href="sample.html#hkl.sample.HklSample" title="hkl.sample.HklSample"><code class="xref py py-class docutils literal notranslate"><span class="pre">hkl.sample.HklSample</span></code></a>. Behind the scenes, the
<a class="reference internal" href="diffract.html#hkl.diffract.Diffractometer" title="hkl.diffract.Diffractometer"><code class="xref py py-class docutils literal notranslate"><span class="pre">hkl.diffract.Diffractometer</span></code></a> object maintains a <em>dictionary</em> of
samples (keyed by <code class="docutils literal notranslate"><span class="pre">name</span></code>), each with its own <code class="xref py py-class docutils literal notranslate"><span class="pre">hkl.utils.Lattice</span></code>
and orientation (reflections) information.</p>
</section>
<section id="lattice">
<span id="index-9"></span><h3>lattice<a class="headerlink" href="#lattice" title="Permalink to this headline">¶</a></h3>
<p>Crystal <code class="xref py py-class docutils literal notranslate"><span class="pre">hkl.utils.Lattice</span></code> parameters of unit cell lengths and angles.</p>
</section>
<section id="orientation">
<span id="index-10"></span><h3>orientation<a class="headerlink" href="#orientation" title="Permalink to this headline">¶</a></h3>
<p>The <strong>UB</strong> matrix describes the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> and <code class="docutils literal notranslate"><span class="pre">inverse()</span></code> transformations
that allow precise positioning of a crystal’s atomic planes in the laboratory
reference system of the diffractometer.  Typically, the <strong>UB</strong> matrix is computed
(by <em>libhkl</em>) from two orientation reflections.</p>
</section>
<section id="constraint">
<span id="index-11"></span><h3>constraint<a class="headerlink" href="#constraint" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">forward()</span></code> transformation can have many solutions.  A
<code class="xref py py-class docutils literal notranslate"><span class="pre">Constraint</span></code> can be applied to a real positioner to
limit the range of solutions accepted for that positioner.</p>
</section>
<section id="mode">
<span id="index-12"></span><h3>mode<a class="headerlink" href="#mode" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">forward()</span></code> transformation can have many solutions.  The
diffractometer is set to a mode (chosen from a list specified by the
diffractometer geometry) that controls how values for each of the real
positioners will be controlled. A mode can control relationships between
real positioners in addition to limiting the motion of a real positioner.
Further, a mode can specify an additional reflection which will be used to
determine the outcome of the <code class="docutils literal notranslate"><span class="pre">forward()</span></code> transformation.</p>
<table class="docutils align-default">
<colgroup>
<col style="width: 50%" />
<col style="width: 50%" />
</colgroup>
<thead>
<tr class="row-odd"><th class="head"><p>object</p></th>
<th class="head"><p>meaning</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p><code class="docutils literal notranslate"><span class="pre">DFRCT.engine.mode</span></code></p></td>
<td><p>mode selected now</p></td>
</tr>
<tr class="row-odd"><td><p><code class="docutils literal notranslate"><span class="pre">DFRCT.engine.modes</span></code></p></td>
<td><p>list of possible modes</p></td>
</tr>
</tbody>
</table>
<p>Here, <code class="docutils literal notranslate"><span class="pre">DFRCT</span></code> is the diffractometer object (such as <code class="docutils literal notranslate"><span class="pre">e4cv</span></code> above).</p>
</section>
</section>
<section id="steps-to-define-a-diffractometer-object">
<h2>Steps to define a diffractometer object<a class="headerlink" href="#steps-to-define-a-diffractometer-object" title="Permalink to this headline">¶</a></h2>
<ol class="arabic simple">
<li><p>Identify the geometry.</p></li>
<li><p>Check that it is supported in  <a class="reference internal" href="geometries.html#module-hkl.geometries" title="hkl.geometries"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hkl.geometries</span></code></a>.</p></li>
<li><p>Create a custom subclass for the diffractometer.</p></li>
<li><p>Connect the real positioners with the control system motors.</p></li>
<li><p>(optional) Connect energy to the control system.</p></li>
<li><p>Define the diffractometer object from the custom subclass.</p></li>
</ol>
</section>
<section id="use-a-diffractometer-with-the-bluesky-runengine">
<h2>Use a Diffractometer with the bluesky RunEngine<a class="headerlink" href="#use-a-diffractometer-with-the-bluesky-runengine" title="Permalink to this headline">¶</a></h2>
<p>The positioners of a <a class="reference internal" href="diffract.html#hkl.diffract.Diffractometer" title="hkl.diffract.Diffractometer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Diffractometer</span></code></a> object may be
used with the <a class="reference external" href="https://blueskyproject.io/bluesky/generated/bluesky.run_engine.RunEngine.html?highlight=runengine">bluesky RunEngine</a>
with any of the <a class="reference external" href="https://blueskyproject.io/bluesky/plans.html#pre-assembled-plans">pre-assembled plans</a> or
in custom plans of your own.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fourc</span> <span class="o">=</span> <span class="n">hkl</span><span class="o">.</span><span class="n">geometries</span><span class="o">.</span><span class="n">SimulatedE4CV</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fourc&quot;</span><span class="p">)</span>
<span class="c1"># steps not shown here:</span>
<span class="c1">#   define a sample &amp; orientation reflections, and compute UB matrix</span>

<span class="c1"># record the diffractometer metadata to a run</span>
<span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">count</span><span class="p">([</span><span class="n">fourc</span><span class="p">]))</span>

<span class="c1"># relative *(h00)* scan</span>
<span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">rel_scan</span><span class="p">([</span><span class="n">scaler</span><span class="p">,</span> <span class="n">fourc</span><span class="p">],</span> <span class="n">fourc</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="o">-</span><span class="mf">0.1</span><span class="p">,</span> <span class="mf">0.1</span><span class="p">,</span> <span class="mi">21</span><span class="p">))</span>

<span class="c1"># absolute *(0kl)* scan</span>
<span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">([</span><span class="n">scaler</span><span class="p">,</span> <span class="n">fourc</span><span class="p">],</span> <span class="n">fourc</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">fourc</span><span class="o">.</span><span class="n">l</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">21</span><span class="p">))</span>

<span class="c1"># absolute ``chi`` scan</span>
<span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">([</span><span class="n">scaler</span><span class="p">,</span> <span class="n">fourc</span><span class="p">],</span> <span class="n">fourc</span><span class="o">.</span><span class="n">chi</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">31</span><span class="p">))</span>
</pre></div>
</div>
<p>Keep in mind these considerations:</p>
<ol class="arabic">
<li><p>Don’t mix axis types (pseudos <em>v.</em> reals) in a scan.  You can only
scan with either <em>pseudo</em> axes (<code class="docutils literal notranslate"><span class="pre">h</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span></code>, <code class="docutils literal notranslate"><span class="pre">l</span></code>, <code class="docutils literal notranslate"><span class="pre">q</span></code>, …) or <em>real</em>
axes (<code class="docutils literal notranslate"><span class="pre">omega</span></code>, <code class="docutils literal notranslate"><span class="pre">tth</span></code>, <code class="docutils literal notranslate"><span class="pre">chi</span></code>, …) at one time.  You cannot scan with
both types (such as <code class="docutils literal notranslate"><span class="pre">h</span></code> and <code class="docutils literal notranslate"><span class="pre">tth</span></code>) in a single scan (because the
<a class="reference internal" href="diffract.html#hkl.diffract.Diffractometer.forward" title="hkl.diffract.Diffractometer.forward"><code class="xref py py-meth docutils literal notranslate"><span class="pre">forward()</span></code></a> and
<a class="reference internal" href="diffract.html#hkl.diffract.Diffractometer.inverse" title="hkl.diffract.Diffractometer.inverse"><code class="xref py py-meth docutils literal notranslate"><span class="pre">inverse()</span></code></a> methods cannot
resolve).  Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Cannot scan both ``k`` and ``chi`` at the same time.</span>
<span class="c1"># This will raise a `ValueError` exception.</span>
<span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">([</span><span class="n">scaler</span><span class="p">,</span> <span class="n">fourc</span><span class="p">],</span> <span class="n">fourc</span><span class="o">.</span><span class="n">k</span><span class="p">,</span> <span class="mf">0.9</span><span class="p">,</span> <span class="mf">1.1</span><span class="p">,</span> <span class="n">fourc</span><span class="o">.</span><span class="n">chi</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">21</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p>When scanning with pseudo axes (<code class="docutils literal notranslate"><span class="pre">h</span></code>, <code class="docutils literal notranslate"><span class="pre">k</span></code>, <code class="docutils literal notranslate"><span class="pre">l</span></code>, <code class="docutils literal notranslate"><span class="pre">q</span></code>, …), first
check that all steps in the scan can be computed successfully with
the <a class="reference internal" href="diffract.html#hkl.diffract.Diffractometer.forward" title="hkl.diffract.Diffractometer.forward"><code class="xref py py-meth docutils literal notranslate"><span class="pre">forward()</span></code></a> computation:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fourc</span><span class="o">.</span><span class="n">forward</span><span class="p">(</span><span class="mf">1.9</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>Include the diffractometer object as an additional detector
to record the diffractometer metadata <a class="footnote-reference brackets" href="#id2" id="id1">1</a> as part of the scan.
For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fourc</span> <span class="o">=</span> <span class="n">hkl</span><span class="o">.</span><span class="n">geometries</span><span class="o">.</span><span class="n">SimulatedE4CV</span><span class="p">(</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s2">&quot;fourc&quot;</span><span class="p">)</span>
<span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">([</span><span class="n">scaler</span><span class="p">,</span> <span class="n">fourc</span><span class="p">],</span> <span class="n">fourc</span><span class="o">.</span><span class="n">h</span><span class="p">,</span> <span class="mf">1.9</span><span class="p">,</span> <span class="mf">2.1</span><span class="p">,</span> <span class="mi">21</span><span class="p">))</span>
</pre></div>
</div>
</li>
<li><p>To save crystal orientation and reflections for later use,
include the diffractometer object as an additional detector
(as stated in consideration 3 above):</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RE</span><span class="p">(</span><span class="n">bp</span><span class="o">.</span><span class="n">scan</span><span class="p">([</span><span class="n">scaler</span><span class="p">,</span> <span class="n">fourc</span><span class="p">],</span> <span class="n">fourc</span><span class="o">.</span><span class="n">chi</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">60</span><span class="p">,</span> <span class="mi">31</span><span class="p">))</span>
<span class="c1">#                   ^^^^^</span>
</pre></div>
</div>
</li>
<li><p>To restore crystal lattice and orientation reflections from a previous
run, first use the <a class="reference external" href="https://blueskyproject.io/databroker/tutorials/search-and-lookup.html#find-runs-in-a-catalog">databroker</a>
to find the run.  (The <a class="reference internal" href="util.html#hkl.util.list_orientation_runs" title="hkl.util.list_orientation_runs"><code class="xref py py-func docutils literal notranslate"><span class="pre">hkl.util.list_orientation_runs()</span></code></a> function
can list any recent runs with orientation information.  It needs
the databroker catalog object.)  With the run, use
<a class="reference internal" href="util.html#hkl.util.run_orientation_info" title="hkl.util.run_orientation_info"><code class="xref py py-func docutils literal notranslate"><span class="pre">hkl.util.run_orientation_info()</span></code></a> to obtain
the orientation information.
Then call <a class="reference internal" href="util.html#hkl.util.restore_orientation" title="hkl.util.restore_orientation"><code class="xref py py-func docutils literal notranslate"><span class="pre">hkl.util.restore_orientation()</span></code></a>
with the run’s orientation information.  Here is an example
with the <cite>fourc</cite> object created above and a previous run with
<code class="docutils literal notranslate"><span class="pre">scan_id</span> <span class="pre">=</span> <span class="pre">457</span></code>:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># find a run</span>
<span class="n">hkl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">list_orientation_runs</span><span class="p">(</span><span class="n">cat</span><span class="p">)</span>

<span class="c1"># get the run&#39;s orientation metadata</span>
<span class="n">info</span> <span class="o">=</span> <span class="n">hkl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">run_orientation_info</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="mi">457</span><span class="p">])</span>

<span class="c1"># restore the orientation</span>
<span class="n">hkl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">restore_orientation</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;fourc&quot;</span><span class="p">],</span> <span class="n">fourc</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>You should only restore orientation reflections from a <strong>matching</strong>
diffractometer geometry (such as <code class="docutils literal notranslate"><span class="pre">E4CV</span></code>).  A <cite>ValueError</cite>
exception will be raised if the geometry names (one of the names
in <a class="reference internal" href="geometries.html#module-hkl.geometries" title="hkl.geometries"><code class="xref py py-mod docutils literal notranslate"><span class="pre">hkl.geometries</span></code></a>) do not match.  To override this check
(at your own risk), replace <code class="xref py py-func docutils literal notranslate"><span class="pre">hkl.util._check_geometry()</span></code>
with your own code.</p></li>
<li><p>A sample lattice can be restored into any
<a class="reference internal" href="diffract.html#hkl.diffract.Diffractometer" title="hkl.diffract.Diffractometer"><code class="xref py py-class docutils literal notranslate"><span class="pre">Diffractometer</span></code></a> object, as long
as it has not already been defined (by name) in that object:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">info</span> <span class="o">=</span> <span class="n">hkl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">run_orientation_info</span><span class="p">(</span><span class="n">cat</span><span class="p">[</span><span class="mi">457</span><span class="p">])</span>
<span class="n">hkl</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">restore_sample</span><span class="p">(</span><span class="n">info</span><span class="p">[</span><span class="s2">&quot;fourc&quot;</span><span class="p">],</span> <span class="n">fourc</span><span class="p">)</span>
</pre></div>
</div>
</li>
<li><p>If you want to save other information during a run, or save
this information in a different format, it is suggested to
write that information as a separate stream using a custom plan.</p></li>
</ol>
<dl class="footnote brackets">
<dt class="label" id="id2"><span class="brackets"><a class="fn-backref" href="#id1">1</a></span></dt>
<dd><p>The diffractometer metadata will be recorded in the scan’s
descriptor document and can be retrieved later for analysis or use in
other scans.  Recorded data includes diffractometer name and
geometry, sample name and lattice, orientation reflections, …  A
complete list of the metadata keys is available from the
diffractometer object as either an ophyd
<a class="reference external" href="https://blueskyproject.io/ophyd/signals.html#signals">Signal</a>
(such as <code class="docutils literal notranslate"><span class="pre">fourc.orientation_attrs.get()</span></code>) or a direct attribute (such
as <code class="docutils literal notranslate"><span class="pre">fourc._orientation_attrs</span></code>).</p>
</dd>
</dl>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="index.html" class="btn btn-neutral float-left" title="hklpy" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="ready_to_use.html" class="btn btn-neutral float-right" title="Ready-to-Use Devices" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2014-2021, Brookhaven National Laboratory.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>